<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <!-- iOS Home Screen icon + PWA manifest (must exist at site root) -->
  <link rel="apple-touch-icon" href="/kai-icon.png?v=20" />
  <link rel="manifest" href="/manifest.webmanifest?v=20" />

  <title>KAI</title>

  <style>
    :root{
      --bg:#070708;
      --panel:#0b0b0c;
      --text:#f3f3f4;
      --muted:#b3b3b7;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --gold1:#c9a24a;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;
      --pad: 18px;
      --max: 1200px;
      --tap: 44px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --good:#52d07f;
      --warn:#ffcc66;
      --bad:#ff5b5b;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(201,162,74,.10), transparent 60%),
        radial-gradient(900px 600px at 85% 12%, rgba(201,162,74,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{ max-width:var(--max); margin:0 auto; padding:20px; }
    .top{
      display:flex; gap:18px; align-items:flex-start; justify-content:space-between;
      padding:18px 0 10px;
    }
    .brand h1{
      margin:0;
      font-size:44px;
      letter-spacing:.08em;
      font-weight:800;
      color:rgba(255,255,255,.92);
    }
    .brand .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
      letter-spacing:.02em;
      line-height:1.35;
    }
    .chips{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding-top:10px;
    }
    .chip{
      display:flex; gap:8px; align-items:center;
      padding:8px 12px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      font-size:13px;
      backdrop-filter: blur(8px);
    }
    .chip b{ color:rgba(255,255,255,.92); font-weight:700; }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 0 14px;
    }
    .tab{
      min-height:var(--tap);
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.80);
      font-size:14px;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
      cursor:pointer;
    }
    .tab.active{
      border-color:rgba(201,162,74,.40);
      background:linear-gradient(180deg, rgba(201,162,74,.16), rgba(255,255,255,.03));
      color:rgba(255,255,255,.95);
      box-shadow: 0 10px 30px rgba(201,162,74,.10);
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:var(--pad);
      box-shadow: var(--shadow);
    }
    .hide{ display:none !important; }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .card{
      background:rgba(0,0,0,.24);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
    }
    .title{
      font-size:16px;
      color:rgba(255,255,255,.92);
      font-weight:800;
      margin:0 0 10px 0;
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin:10px 0;
    }
    label{
      color:rgba(255,255,255,.80);
      font-size:13px;
    }
    input, select, textarea{
      width:100%;
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.35);
      color:rgba(255,255,255,.92);
      font-size:16px; /* iOS no-zoom threshold */
      outline:none;
    }
    textarea{ min-height:96px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color:rgba(255,255,255,.35); }

    .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }

    .btn{
      min-height:var(--tap);
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.92);
      font-size:14px;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn.primary{
      border-color:rgba(201,162,74,.55);
      background:linear-gradient(180deg, rgba(201,162,74,.22), rgba(0,0,0,.18));
    }
    .btn.danger{
      border-color:rgba(255,91,91,.45);
      background:linear-gradient(180deg, rgba(255,91,91,.18), rgba(0,0,0,.18));
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
    }

    .switchWrap{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .switchLabel{ display:flex; flex-direction:column; gap:4px; }
    .switchLabel b{ color:rgba(255,255,255,.92); }
    .toggle{
      width:54px; height:30px; border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid var(--line2);
      position:relative;
      cursor:pointer;
      touch-action: manipulation;
    }
    .knob{
      width:24px; height:24px;
      border-radius:999px;
      background:rgba(255,255,255,.88);
      position:absolute; top:2px; left:2px;
      transition: left .18s ease, background .18s ease;
    }
    .toggle.on{
      background:rgba(82,208,127,.20);
      border-color:rgba(82,208,127,.35);
    }
    .toggle.on .knob{ left:28px; background:rgba(82,208,127,.92); }

    .results{
      display:flex; flex-direction:column; gap:10px;
      margin-top:12px;
    }
    .result{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .meta{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    .mono{ font-family:var(--mono); }

    .callout{
      border:1px solid rgba(201,162,74,.35);
      background:linear-gradient(180deg, rgba(201,162,74,.10), rgba(255,255,255,.02));
    }
    .ok{ color:var(--good); }
    .warn{ color:var(--warn); }
    .bad{ color:var(--bad); }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      padding:10px 14px;
      border-radius:999px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display:none;
      z-index:9999;
      max-width:min(92vw, 720px);
      text-align:center;
      backdrop-filter: blur(10px);
      font-size:14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>KAI</h1>
        <div class="sub">Kabbalah Always Illuminates ‚Ä¢ Align ‚Üí Restrict ‚Üí Witness ‚Üí Illuminate ‚Üí Seal</div>
      </div>

      <div class="chips">
        <div class="chip">Date: <b id="chipDate">‚Äî</b></div>
        <div class="chip">Profile: <b id="chipProfile">‚Äî</b></div>
        <div class="chip">Streak: <b id="chipStreak">‚Äî</b></div>
        <div class="chip">Daily Restrict: <b id="chipDailyRestrict">‚Äî</b></div>
        <div class="chip">72 Name: <b id="chipName">‚Äî</b></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="start">Start</div>
      <div class="tab" data-tab="morning">Morning</div>
      <div class="tab" data-tab="restriction">Restriction</div>
      <div class="tab" data-tab="evening">Evening</div>
      <div class="tab" data-tab="share">Share Card</div>
      <div class="tab" data-tab="library">Library</div>
      <div class="tab" data-tab="tools">Tools</div>
      <div class="tab" data-tab="history">History</div>
    </div>

    <!-- START -->
    <section class="panel" data-pane="start">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">Profile + Intent</p>

          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="pFirst">First name</label>
              <input id="pFirst" placeholder="Bernard" />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="pLast">Last name</label>
              <input id="pLast" placeholder="Whitman" />
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="pBirth">Birthdate (optional timing lens)</label>
              <input id="pBirth" type="date" />
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="pFocus">Primary focus</label>
              <select id="pFocus">
                <option value="">Select‚Ä¶</option>
                <option>Certainty</option>
                <option>Restriction</option>
                <option>Reactivity</option>
                <option>Connection</option>
                <option>Trust</option>
                <option>Action</option>
                <option>Compassion</option>
              </select>
            </div>

            <div class="field" style="grid-column: span 12;">
              <label for="pOutcome">30-day outcome (one sentence)</label>
              <input id="pOutcome" placeholder="Increase certainty and reduce urgency." />
            </div>
          </div>

          <div class="bar">
            <button id="saveProfileBtn" type="button" class="btn primary">Save Profile</button>
            <button id="resetProfileBtn" type="button" class="btn">Reset Profile</button>
          </div>

          <div class="hint">Profile persists locally (localStorage). Built for iPad workflow.</div>
        </div>

        <div class="card" style="grid-column: span 12;">
          <div class="switchWrap">
            <div class="switchLabel">
              <b>Daily Restrict Mode</b>
              <span class="hint" style="margin:0;">One restriction per day. Streak tracked + celebrated.</span>
            </div>
            <div class="toggle" id="dailyToggle" role="switch" aria-checked="false"><div class="knob"></div></div>
          </div>
        </div>

        <div class="card callout" style="grid-column: span 12;">
          <p class="title">Ritual Loop</p>
          <div class="hint" style="margin:0;">
            <b>Align</b> (Morning) ‚Üí <b>Restrict</b> (Day) ‚Üí <b>Witness</b> (Evening) ‚Üí <b>Illuminate</b> (Tools) ‚Üí <b>Seal + Share</b> (Card)
          </div>
        </div>
      </div>
    </section>

    <!-- MORNING -->
    <section class="panel hide" data-pane="morning">
      <p class="title">Morning ‚Ä¢ Align</p>
      <div class="grid">
        <div class="card" style="grid-column: span 6;">
          <div class="field">
            <label for="mCertainty">Certainty (0‚Äì10)</label>
            <input id="mCertainty" type="number" min="0" max="10" step="1" placeholder="0-10" />
          </div>
          <div class="field">
            <label for="mEnergy">Energy (0‚Äì10)</label>
            <input id="mEnergy" type="number" min="0" max="10" step="1" placeholder="0-10" />
          </div>
          <div class="field">
            <label for="mIntention">Intention (one line)</label>
            <input id="mIntention" placeholder="What am I here to do today?" />
          </div>
        </div>
        <div class="card" style="grid-column: span 6;">
          <div class="field">
            <label for="mPattern">Pattern</label>
            <select id="mPattern">
              <option value="">Select‚Ä¶</option>
              <option>Urgency ‚Üí Certainty</option>
              <option>Reactivity ‚Üí Restriction</option>
              <option>Judgment ‚Üí Compassion</option>
              <option>Overthinking ‚Üí Action</option>
              <option>Fear ‚Üí Faith</option>
              <option>Control ‚Üí Trust</option>
              <option>Isolation ‚Üí Connection</option>
            </select>
          </div>
          <div class="field">
            <label for="mWitness">Witness (what will I watch for?)</label>
            <textarea id="mWitness" placeholder="What reaction pattern will appear? What will I observe without feeding it?"></textarea>
          </div>
        </div>
      </div>
      <div class="bar">
        <button id="saveMorningBtn" type="button" class="btn primary">Save Morning</button>
        <button id="copyMorningBtn" type="button" class="btn">Copy Morning Summary</button>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section class="panel hide" data-pane="restriction">
      <p class="title">Restriction ‚Ä¢ Restrict</p>
      <div class="grid">
        <div class="card" style="grid-column: span 6;">
          <div class="field">
            <label for="rMove">Restriction move (one sentence)</label>
            <input id="rMove" placeholder="Pause 3 breaths before replying." />
          </div>
          <div class="field">
            <label for="rTrigger">Likely trigger</label>
            <input id="rTrigger" placeholder="What normally hooks you?" />
          </div>
          <div class="field">
            <label for="rNote">Witness note</label>
            <textarea id="rNote" placeholder="Describe the moment, urge, and what you did instead."></textarea>
          </div>
        </div>
        <div class="card" style="grid-column: span 6;">
          <div class="switchWrap">
            <div class="switchLabel">
              <b>Completed today‚Äôs restriction?</b>
              <span class="hint" style="margin:0;">Counts toward streak when Daily Restrict Mode is ON.</span>
            </div>
            <div class="toggle" id="restrictDoneToggle" role="switch" aria-checked="false"><div class="knob"></div></div>
          </div>
          <div class="field" style="margin-top:14px;">
            <label for="rImpact">Impact (one line)</label>
            <input id="rImpact" placeholder="What shifted in body/mind?" />
          </div>
        </div>
      </div>
      <div class="bar">
        <button id="saveRestrictBtn" type="button" class="btn primary">Save Restriction</button>
        <button id="copyRestrictBtn" type="button" class="btn">Copy Restriction Summary</button>
      </div>
    </section>

    <!-- EVENING -->
    <section class="panel hide" data-pane="evening">
      <p class="title">Evening ‚Ä¢ Witness ‚Üí Seal</p>
      <div class="grid">
        <div class="card" style="grid-column: span 6;">
          <div class="field">
            <label for="eWin">Win (one sentence)</label>
            <input id="eWin" />
          </div>
          <div class="field">
            <label for="eLesson">Lesson (one sentence)</label>
            <input id="eLesson" />
          </div>
          <div class="field">
            <label for="eRepair">Repair (optional)</label>
            <input id="eRepair" />
          </div>
        </div>
        <div class="card" style="grid-column: span 6;">
          <div class="field">
            <label for="eSeal">Seal (closing vow)</label>
            <textarea id="eSeal" placeholder="Tomorrow I choose ____"></textarea>
          </div>
          <div class="field">
            <label for="eGratitude">Gratitude</label>
            <input id="eGratitude" placeholder="3 words minimum üòÑ" />
          </div>
        </div>
      </div>
      <div class="bar">
        <button id="saveEveningBtn" type="button" class="btn primary">Save Evening</button>
        <button id="copyEveningBtn" type="button" class="btn">Copy Evening Summary</button>
      </div>
    </section>

    <!-- SHARE -->
    <section class="panel hide" data-pane="share">
      <p class="title">Seal + Share ‚Ä¢ KAI Card</p>
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <div class="field">
            <label for="cardOut">KAI Card (paste-ready)</label>
            <textarea id="cardOut" placeholder="Tap Build Card‚Ä¶"></textarea>
          </div>
          <div class="bar">
            <button id="buildCardBtn" type="button" class="btn primary">Build Card</button>
            <button id="copyCardBtn" type="button" class="btn">Copy Card</button>
            <button id="saveCardBtn" type="button" class="btn">Save Card to Today</button>
          </div>
          <div class="hint">This is your share artifact: Pattern ‚Üí Restriction ‚Üí Outcome. Not journaling. Practice evidence.</div>
        </div>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="panel hide" data-pane="library">
      <p class="title">Library ‚Ä¢ 72 Names + Practices</p>
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="libSearch">Search</label>
              <input id="libSearch" placeholder="certainty, protection, healing‚Ä¶" />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="libPattern">Filter by Pattern</label>
              <select id="libPattern">
                <option value="">All patterns‚Ä¶</option>
                <option>Urgency ‚Üí Certainty</option>
                <option>Reactivity ‚Üí Restriction</option>
                <option>Judgment ‚Üí Compassion</option>
                <option>Overthinking ‚Üí Action</option>
                <option>Fear ‚Üí Faith</option>
                <option>Control ‚Üí Trust</option>
                <option>Isolation ‚Üí Connection</option>
              </select>
            </div>
          </div>

          <div class="bar">
            <button id="libPick" type="button" class="btn primary">Pick for me</button>
            <button id="libClear" type="button" class="btn">Clear</button>
            <button id="libUseSuggested" type="button" class="btn">Use Suggestion as Today‚Äôs Name</button>
            <span class="pill">Tap a result to load it</span>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="title">Suggested Practice</div>
            <textarea id="libSuggested" readonly placeholder="Tap Pick for me‚Ä¶"></textarea>
            <div class="bar">
              <button id="libCopySuggested" type="button" class="btn">Copy</button>
            </div>
          </div>

          <div class="results" id="libResults"></div>
        </div>
      </div>
    </section>

    <!-- TOOLS -->
    <section class="panel hide" data-pane="tools">
      <p class="title">Tools ‚Ä¢ Gematria Insight Engine + 72 Names Lookup</p>

      <div class="grid">
        <div class="card" style="grid-column: span 6;">
          <p class="title">Gematria</p>

          <div class="field">
            <label for="gText">Enter Hebrew (word / Name / concept)</label>
            <input id="gText" placeholder="◊ê◊î◊ë◊î / ◊ê◊ó◊ì / ◊§◊ó◊ì / ◊ê◊û◊™ ‚Ä¶" />
          </div>

          <div class="grid">
            <div class="field" style="grid-column: span 4;">
              <label for="gTotal">Total</label>
              <input id="gTotal" readonly />
            </div>
            <div class="field" style="grid-column: span 8;">
              <label for="gBreak">Breakdown</label>
              <input id="gBreak" readonly />
            </div>
          </div>

          <div class="field">
            <label for="gMode">Insight Style</label>
            <select id="gMode">
              <option value="ritual">Ritual (Align/Restrict/Witness)</option>
              <option value="pattern">Pattern (Shadow ‚Üí Light)</option>
              <option value="teacher">Teacher-safe (minimal claims)</option>
            </select>
          </div>

          <div class="bar">
            <button id="gCopyInsightBtn" type="button" class="btn">Copy Insight</button>
            <button id="gUseNameBtn" type="button" class="btn primary">Use Suggested 72 Name</button>
          </div>

          <div class="hint">Gematria here is not prophecy. It‚Äôs resonance detection + reflection prompts.</div>
        </div>

        <div class="card callout" style="grid-column: span 6;">
          <p class="title">Gematria Insight</p>
          <div class="field">
            <label for="gInsight">Interpretation + Prompt</label>
            <textarea id="gInsight" readonly placeholder="Type a Hebrew word above‚Ä¶"></textarea>
          </div>
          <div class="results" id="gMatches"></div>
        </div>

        <div class="card" style="grid-column: span 12;">
          <p class="title">72 Names Lookup</p>
          <div class="field">
            <label for="nSearch">Search by theme</label>
            <input id="nSearch" placeholder="certainty, protection, healing‚Ä¶" />
          </div>
          <div class="results" id="nResults"></div>
        </div>

        <div class="card" style="grid-column: span 12;">
          <p class="title">Export / Reset</p>
          <div class="bar">
            <button id="exportBtn" type="button" class="btn primary">Download JSON</button>
            <button id="copyExportBtn" type="button" class="btn">Copy JSON</button>
            <button id="resetTodayBtn" type="button" class="btn danger">Reset Today</button>
            <button id="resetAllBtn" type="button" class="btn danger">Reset All</button>
          </div>
          <div class="field">
            <label for="exportBox">Export box</label>
            <textarea id="exportBox" placeholder="Export will appear here (also copyable for iPad)"></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="panel hide" data-pane="history">
      <p class="title">History</p>
      <div class="card">
        <div class="hint">Saved days appear here.</div>
        <div class="results" id="hist"></div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__tmo);
      window.__tmo = setTimeout(()=> t.style.display="none", 2200);
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function safeJSONParse(s, fallback){
      try { return JSON.parse(s); } catch(e){ return fallback; }
    }

    // ---------- Storage keys ----------
    const keyProfile = "kai_profile_v3";
    const keyMeta    = "kai_meta_v3";
    const keyDay     = (iso) => `kai_day_${iso}_v3`;

    // ---------- Models ----------
    function defaultProfile(){
      return { first:"", last:"", birth:"", focus:"", outcome:"" };
    }
    function defaultMeta(){
      return {
        dailyRestrict:false,
        streak:0,
        lastTab:"start",
        selectedName:"",
        selectedPattern:"",
        lastGematria: { input:"", total:0, breakdown:"", insight:"", suggestedName:"" }
      };
    }
    function defaultDay(iso){
      return {
        date: iso,
        morning: { certainty:"", energy:"", intention:"", pattern:"", witness:"" },
        restriction: { move:"", trigger:"", note:"", impact:"", completed:false },
        evening: { win:"", lesson:"", repair:"", seal:"", gratitude:"" },
        shareCard: "",
        __streakCounted:false
      };
    }

    function getProfile(){ return safeJSONParse(localStorage.getItem(keyProfile), defaultProfile()); }
    function setProfile(p){ localStorage.setItem(keyProfile, JSON.stringify(p)); }

    function getMeta(){ return safeJSONParse(localStorage.getItem(keyMeta), defaultMeta()); }
    function setMeta(m){ localStorage.setItem(keyMeta, JSON.stringify(m)); }

    function getDay(iso=todayISO()){ return safeJSONParse(localStorage.getItem(keyDay(iso)), defaultDay(iso)); }
    function setDay(d){ localStorage.setItem(keyDay(d.date), JSON.stringify(d)); }

    function listSavedDays(){
      const days = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith("kai_day_") && k.endsWith("_v3")){
          const iso = k.replace("kai_day_","").replace("_v3","");
          days.push(iso);
        }
      }
      days.sort().reverse();
      return days;
    }

    // ---------- Tabs ----------
    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === tab);
      });
      document.querySelectorAll("[data-pane]").forEach(p=>{
        p.classList.toggle("hide", p.dataset.pane !== tab);
      });
      const m = getMeta();
      m.lastTab = tab;
      setMeta(m);
      hydrateChips();
    }

    function wireTabs(){
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          setActiveTab(btn.dataset.tab);
        }, { passive:false });
      });
    }

    // ---------- Switches ----------
    function setToggle(el, on){
      if(!el) return;
      el.classList.toggle("on", !!on);
      el.setAttribute("aria-checked", on ? "true" : "false");
    }
    function wireToggle(el, onChange){
      if(!el) return;
      el.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const isOn = el.classList.contains("on");
        setToggle(el, !isOn);
        onChange(!isOn);
      }, { passive:false });
    }

    // ---------- Hydrate ----------
    function hydrateChips(){
      const p = getProfile();
      const m = getMeta();
      const d = getDay();
      $("chipDate").textContent = d.date || "‚Äî";
      $("chipProfile").textContent = (p.first || p.last) ? `${p.first||""} ${p.last||""}`.trim() : "‚Äî";
      $("chipStreak").textContent = String(m.streak ?? 0);
      $("chipDailyRestrict").textContent = m.dailyRestrict ? "On" : "Off";
      $("chipName").textContent = m.selectedName || "‚Äî";
    }

    function hydrateProfileUI(){
      const p = getProfile();
      $("pFirst").value = p.first || "";
      $("pLast").value = p.last || "";
      $("pBirth").value = p.birth || "";
      $("pFocus").value = p.focus || "";
      $("pOutcome").value = p.outcome || "";
    }

    function hydrateDayUI(){
      const d = getDay();
      $("mCertainty").value = d.morning?.certainty ?? "";
      $("mEnergy").value = d.morning?.energy ?? "";
      $("mIntention").value = d.morning?.intention ?? "";
      $("mPattern").value = d.morning?.pattern ?? "";
      $("mWitness").value = d.morning?.witness ?? "";

      $("rMove").value = d.restriction?.move ?? "";
      $("rTrigger").value = d.restriction?.trigger ?? "";
      $("rNote").value = d.restriction?.note ?? "";
      $("rImpact").value = d.restriction?.impact ?? "";
      setToggle($("restrictDoneToggle"), !!d.restriction?.completed);

      $("eWin").value = d.evening?.win ?? "";
      $("eLesson").value = d.evening?.lesson ?? "";
      $("eRepair").value = d.evening?.repair ?? "";
      $("eSeal").value = d.evening?.seal ?? "";
      $("eGratitude").value = d.evening?.gratitude ?? "";

      $("cardOut").value = d.shareCard || "";
    }

    function hydrateDailyRestrictUI(){
      const m = getMeta();
      setToggle($("dailyToggle"), !!m.dailyRestrict);
    }

    function hydrateHistory(){
      const box = $("hist");
      if(!box) return;
      box.innerHTML = "";
      const days = listSavedDays();
      if(days.length === 0){
        box.innerHTML = `<div class="result">No saved days yet.</div>`;
        return;
      }
      days.forEach(iso=>{
        const d = getDay(iso);
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `
          <div><b>${iso}</b> <span class="meta">‚Ä¢ Pattern: ${d.morning?.pattern||"‚Äî"} ‚Ä¢ Restrict: ${d.restriction?.completed?"Yes":"No"}</span></div>
          <div class="meta">${(d.shareCard||"").slice(0,140)}${(d.shareCard||"").length>140?"‚Ä¶":""}</div>
        `;
        box.appendChild(el);
      });
    }

    function hydrateGematriaUI(){
      const m = getMeta();
      const lg = m.lastGematria || {};
      $("gText").value = lg.input || "";
      $("gTotal").value = lg.total ? String(lg.total) : "‚Äî";
      $("gBreak").value = lg.breakdown || "‚Äî";
      $("gInsight").value = lg.insight || "";
      // matches render from current input
      renderGematriaInsightsFromInput(lg.input || "");
    }

    function hydrateAll(){
      hydrateProfileUI();
      hydrateDailyRestrictUI();
      hydrateChips();
      hydrateDayUI();
      hydrateHistory();
      render72();
      renderLibrary();
      hydrateGematriaUI();
    }

    // ---------- Collectors ----------
    function collectProfileFromUI(){
      return {
        first: $("pFirst").value.trim(),
        last: $("pLast").value.trim(),
        birth: $("pBirth").value || "",
        focus: $("pFocus").value || "",
        outcome: $("pOutcome").value.trim()
      };
    }

    function collectMorningFromUI(d){
      d.morning = {
        certainty: $("mCertainty").value,
        energy: $("mEnergy").value,
        intention: $("mIntention").value.trim(),
        pattern: $("mPattern").value || "",
        witness: $("mWitness").value.trim()
      };
      return d;
    }

    function collectRestrictionFromUI(d){
      d.restriction = d.restriction || {};
      d.restriction.move = $("rMove").value.trim();
      d.restriction.trigger = $("rTrigger").value.trim();
      d.restriction.note = $("rNote").value.trim();
      d.restriction.impact = $("rImpact").value.trim();
      d.restriction.completed = $("restrictDoneToggle").classList.contains("on");
      return d;
    }

    function collectEveningFromUI(d){
      d.evening = {
        win: $("eWin").value.trim(),
        lesson: $("eLesson").value.trim(),
        repair: $("eRepair").value.trim(),
        seal: $("eSeal").value.trim(),
        gratitude: $("eGratitude").value.trim()
      };
      return d;
    }

    // ---------- Export ----------
    function buildExport(){
      return {
        exportedAt: new Date().toISOString(),
        profile: getProfile(),
        meta: getMeta(),
        today: getDay(),
        allDays: listSavedDays().map(iso => getDay(iso))
      };
    }

    function downloadJSON(obj, filename="kai-export.json"){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    }

    async function copyText(txt){
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(txt);
          toast("Copied ‚úÖ");
        }else{
          $("exportBox").value = txt;
          $("exportBox").focus();
          $("exportBox").select();
          document.execCommand("copy");
          toast("Copied ‚úÖ");
        }
      }catch(e){
        $("exportBox").value = txt;
        toast("Copy failed (see export box) ‚ö†Ô∏è");
      }
    }

    // ---------- Gematria Core ----------
    const gemMap = {
      "◊ê":1,"◊ë":2,"◊í":3,"◊ì":4,"◊î":5,"◊ï":6,"◊ñ":7,"◊ó":8,"◊ò":9,
      "◊ô":10,"◊õ":20,"◊ö":20,"◊ú":30,"◊û":40,"◊ù":40,"◊†":50,"◊ü":50,
      "◊°":60,"◊¢":70,"◊§":80,"◊£":80,"◊¶":90,"◊•":90,"◊ß":100,"◊®":200,"◊©":300,"◊™":400
    };

    function normalizeHebrew(s){
      return (s||"")
        .replace(/[^\u0590-\u05FF]/g, "") // keep Hebrew letters only
        .trim();
    }

    function calcGematria(s){
      const text = normalizeHebrew(s);
      let total = 0;
      const parts = [];
      for(const ch of text){
        const v = gemMap[ch] || 0;
        if(v){
          total += v;
          parts.push(`${ch}=${v}`);
        }
      }
      return { text, total, breakdown: parts.length ? parts.join("  ") : "" };
    }

    // ---------- Gematria Insight Engine ----------
    // Small starter ‚Äúresonance lexicon‚Äù (expand later)
    // Each entry: hebrew term + english key + tags + pattern suggestions
    const GEM_LEXICON = [
      { he:"◊ê◊î◊ë◊î", en:"love", tags:["love","unity","connection","chesed"], patterns:["Isolation ‚Üí Connection","Judgment ‚Üí Compassion"] },
      { he:"◊ê◊ó◊ì", en:"one/unity", tags:["unity","oneness","integration","tiferet"], patterns:["Isolation ‚Üí Connection","Control ‚Üí Trust"] },
      { he:"◊ê◊û◊™", en:"truth", tags:["truth","clarity","alignment","tiferet"], patterns:["Urgency ‚Üí Certainty","Overthinking ‚Üí Action"] },
      { he:"◊©◊ú◊ï◊ù", en:"peace/wholeness", tags:["peace","wholeness","repair","balance"], patterns:["Reactivity ‚Üí Restriction","Fear ‚Üí Faith"] },
      { he:"◊ó◊ô◊ô◊ù", en:"life", tags:["life","vitality","movement","renewal"], patterns:["Fear ‚Üí Faith"] },
      { he:"◊ë◊ò◊ó◊ï◊ü", en:"trust/security", tags:["trust","security","certainty"], patterns:["Control ‚Üí Trust","Urgency ‚Üí Certainty"] },
      { he:"◊§◊ó◊ì", en:"fear", tags:["fear","contraction","avoidance"], patterns:["Fear ‚Üí Faith"] },
      { he:"◊í◊ë◊ï◊®◊î", en:"discipline/strength", tags:["discipline","boundaries","restriction","gevurah"], patterns:["Reactivity ‚Üí Restriction"] },
      { he:"◊ó◊°◊ì", en:"kindness", tags:["kindness","softening","compassion","chesed"], patterns:["Judgment ‚Üí Compassion"] },
      { he:"◊™◊§◊ê◊®◊™", en:"balance/beauty", tags:["balance","truth","harmony","tiferet"], patterns:["Urgency ‚Üí Certainty","Control ‚Üí Trust"] }
    ].map(x => ({...x, g: calcGematria(x.he).total}));

    // ‚Äú72 Names‚Äù starter set (expand later)
    const NAMES72 = [
      { name:"◊ê◊ï◊ù", tags:["discipline","gevurah","strength","restriction"], blurb:"Stabilize willpower; choose restraint over impulse." },
      { name:"◊ú◊î◊ó", tags:["chesed","kindness","softening","compassion"], blurb:"Soften judgment and reopen the heart." },
      { name:"◊û◊†◊ì", tags:["tiferet","balance","truth","harmony"], blurb:"Balance: truth with warmth; action with humility." },
      { name:"◊°◊ê◊ú", tags:["protection","boundaries","shield","no"], blurb:"Clean boundaries. Protection without aggression." },
      { name:"◊û◊î◊©", tags:["healing","repair","restoration"], blurb:"Support repair and steady recovery." },
      { name:"◊†◊ß◊î", tags:["clarity","certainty","clean mind","truth"], blurb:"Cut fog; move from urgency to certainty." },
      { name:"◊î◊î◊î", tags:["breath","calm","nervous system"], blurb:"Return to breath; reduce reactivity." },
      { name:"◊¢◊©◊™", tags:["action","courage","momentum"], blurb:"Turn insight into action with courage." }
    ];

    // Library starter (practice suggestions)
    const LIB = [
      { id:"urgency-certainty-1", pattern:"Urgency ‚Üí Certainty", name:"◊†◊ß◊î", title:"3-breath delay", text:"Before any reply: 3 breaths. Name the urge. Choose clarity.", tags:["certainty","delay","calm"] },
      { id:"reactivity-restriction-1", pattern:"Reactivity ‚Üí Restriction", name:"◊ê◊ï◊ù", title:"Micro-vow", text:"Pick one micro-vow for 12 hours. Hold it cleanly. No speeches.", tags:["restriction","discipline"] },
      { id:"judgment-compassion-1", pattern:"Judgment ‚Üí Compassion", name:"◊ú◊î◊ó", title:"Blessing shift", text:"Silently bless the person you‚Äôre judging. Find one redeeming detail.", tags:["compassion","soften"] },
      { id:"overthinking-action-1", pattern:"Overthinking ‚Üí Action", name:"◊¢◊©◊™", title:"One action now", text:"Write the smallest next action. Do it in 2 minutes. Then reassess.", tags:["action","momentum"] },
      { id:"fear-faith-1", pattern:"Fear ‚Üí Faith", name:"◊û◊†◊ì", title:"Trust act", text:"Ask: what would trust do? Do one trust-aligned act.", tags:["faith","trust"] },
      { id:"control-trust-1", pattern:"Control ‚Üí Trust", name:"◊°◊ê◊ú", title:"Boundary + release", text:"Say one clean boundary. Then release the outcome.", tags:["boundaries","trust"] },
      { id:"isolation-connection-1", pattern:"Isolation ‚Üí Connection", name:"◊ú◊î◊ó", title:"One reach-out", text:"Send one message of warmth without agenda.", tags:["connection","warmth"] }
    ];

    function pickTopMatchesByTotal(total, limit=5){
      if(!total) return [];
      return GEM_LEXICON
        .filter(x => x.g === total)
        .slice(0, limit);
    }

    function scoreNameByTags(nameObj, tags){
      // Simple score: count overlapping tags
      const set = new Set((tags||[]).map(t=>t.toLowerCase()));
      let score = 0;
      for(const t of nameObj.tags){
        if(set.has(String(t).toLowerCase())) score += 1;
      }
      return score;
    }

    function suggestNamesFromTags(tags, limit=3){
      const scored = NAMES72
        .map(n => ({...n, score: scoreNameByTags(n, tags)}))
        .sort((a,b)=> b.score - a.score);
      return scored.filter(x => x.score > 0).slice(0, limit);
    }

    function inferTagsFromInputAndMatches(inputText, total){
      const tags = [];
      // tags from direct lexicon match by text
      const direct = GEM_LEXICON.find(x => x.he === inputText);
      if(direct) tags.push(...direct.tags);

      // tags from same-total resonance words
      const same = pickTopMatchesByTotal(total, 6);
      same.forEach(x => tags.push(...x.tags));

      // mild heuristics based on common words (optional)
      if(inputText.includes("◊§◊ó◊ì")) tags.push("fear");
      if(inputText.includes("◊ê◊û◊™")) tags.push("truth","clarity");
      if(inputText.includes("◊©◊ú◊ï◊ù")) tags.push("peace","repair");
      if(inputText.includes("◊ê◊î◊ë")) tags.push("love","connection");

      // unique
      return Array.from(new Set(tags.map(t=>t.toLowerCase())));
    }

    function chooseSuggestedPattern(tags){
      // Map tags ‚Üí preferred pattern(s)
      const tagToPattern = [
        { tag:"certainty", pattern:"Urgency ‚Üí Certainty" },
        { tag:"clarity", pattern:"Urgency ‚Üí Certainty" },
        { tag:"truth", pattern:"Urgency ‚Üí Certainty" },
        { tag:"restriction", pattern:"Reactivity ‚Üí Restriction" },
        { tag:"discipline", pattern:"Reactivity ‚Üí Restriction" },
        { tag:"compassion", pattern:"Judgment ‚Üí Compassion" },
        { tag:"kindness", pattern:"Judgment ‚Üí Compassion" },
        { tag:"action", pattern:"Overthinking ‚Üí Action" },
        { tag:"momentum", pattern:"Overthinking ‚Üí Action" },
        { tag:"fear", pattern:"Fear ‚Üí Faith" },
        { tag:"trust", pattern:"Control ‚Üí Trust" },
        { tag:"connection", pattern:"Isolation ‚Üí Connection" }
      ];
      for(const m of tagToPattern){
        if(tags.includes(m.tag)) return m.pattern;
      }
      return "";
    }

    function buildInsightText({inputText, total, breakdown}, mode){
      if(!inputText){
        return { insight:"", suggestedName:"", suggestedPattern:"", tags:[], matches:[] };
      }

      const matches = pickTopMatchesByTotal(total, 6);
      const tags = inferTagsFromInputAndMatches(inputText, total);

      const suggestedPattern = chooseSuggestedPattern(tags);
      const suggestedNames = suggestNamesFromTags(tags, 3);
      const suggestedName = suggestedNames[0]?.name || "";

      // Teacher-safe framing: no destiny claims, just prompts
      const oneLiner = (() => {
        if(mode === "teacher"){
          return `Gematria reveals resonance. Use it as a reflection lens, not a decision engine.`;
        }
        if(tags.includes("clarity") || tags.includes("truth") || tags.includes("certainty")){
          return `This number clusters around clarity: use it to move from urgency to certainty.`;
        }
        if(tags.includes("restriction") || tags.includes("discipline")){
          return `This number clusters around restraint: choose one clean restriction and hold it.`;
        }
        if(tags.includes("compassion") || tags.includes("kindness")){
          return `This number clusters around softening: reduce judgment and reopen the heart.`;
        }
        if(tags.includes("action") || tags.includes("momentum")){
          return `This number clusters around action: turn insight into one small move now.`;
        }
        if(tags.includes("fear") || tags.includes("trust")){
          return `This number touches contraction: practice trust, then act from expansion.`;
        }
        return `This number forms a resonance field. Let it point you to your next restriction.`;
      })();

      const prompt = (() => {
        if(mode === "pattern"){
          return `Prompt: What is the shadow move here, and what is the Light move? Name both in one sentence.`;
        }
        if(mode === "teacher"){
          return `Prompt: What inner reaction is loudest right now, and what would restriction look like for 60 seconds?`;
        }
        // ritual
        return `Prompt: (Align) What am I feeling? (Restrict) What will I not do? (Witness) What shifts when I hold?`;
      })();

      const resonanceLine = matches.length
        ? `Resonance (same total ${total}): ` + matches.map(m=> `${m.he} (${m.en})`).join(", ")
        : `Resonance: no built-in same-total matches yet (expand lexicon later).`;

      const nameLine = suggestedName
        ? `Suggested 72 Name: ${suggestedName} (based on theme tags: ${tags.slice(0,6).join(", ") || "‚Äî"})`
        : `Suggested 72 Name: (none yet)`;

      const patLine = suggestedPattern ? `Suggested Pattern: ${suggestedPattern}` : `Suggested Pattern: (none)`;

      const insight = [
        `Input: ${inputText}`,
        `Gematria: ${total}  ‚Ä¢  ${breakdown || "‚Äî"}`,
        ``,
        oneLiner,
        resonanceLine,
        patLine,
        nameLine,
        ``,
        prompt
      ].join("\n");

      return { insight, suggestedName, suggestedPattern, tags, matches, suggestedNames };
    }

    function renderGematriaMatchesUI(total, matches, suggestedNames){
      const box = $("gMatches");
      if(!box) return;
      box.innerHTML = "";

      const sec1 = document.createElement("div");
      sec1.className = "result";
      sec1.innerHTML = `<b>Resonance matches (same total)</b><div class="meta">These are structural echoes, not ‚Äúpredictions.‚Äù</div>`;
      box.appendChild(sec1);

      if(!total){
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `Enter Hebrew above to see matches.`;
        box.appendChild(el);
        return;
      }

      if(matches && matches.length){
        matches.forEach(m=>{
          const el = document.createElement("div");
          el.className = "result";
          el.innerHTML = `<div class="mono" style="font-size:18px;"><b>${m.he}</b> <span class="meta">(${m.en})</span></div>
                          <div class="meta">tags: ${m.tags.join(", ")}</div>`;
          box.appendChild(el);
        });
      } else {
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `No same-total matches in the starter lexicon yet. (We expand this next.)`;
        box.appendChild(el);
      }

      const sec2 = document.createElement("div");
      sec2.className = "result";
      sec2.innerHTML = `<b>72 Name resonance</b><div class="meta">Suggested by overlapping theme tags.</div>`;
      box.appendChild(sec2);

      if(suggestedNames && suggestedNames.length){
        suggestedNames.forEach(n=>{
          const el = document.createElement("div");
          el.className = "result";
          el.innerHTML = `
            <div class="mono" style="font-size:20px;"><b>${n.name}</b></div>
            <div>${n.blurb}</div>
            <div class="meta">tags: ${n.tags.join(", ")}</div>
            <div class="bar" style="margin-top:10px;">
              <button type="button" class="btn primary" data-use-name="${n.name}">Use</button>
              <button type="button" class="btn" data-copy-name="${n.name}">Copy</button>
            </div>
          `;
          el.querySelector(`[data-use-name="${n.name}"]`).addEventListener("click",(e)=>{
            e.preventDefault(); e.stopPropagation();
            const meta = getMeta();
            meta.selectedName = n.name;
            setMeta(meta);
            hydrateChips();
            toast(`Selected ${n.name} ‚úÖ`);
          }, { passive:false });

          el.querySelector(`[data-copy-name="${n.name}"]`).addEventListener("click",(e)=>{
            e.preventDefault(); e.stopPropagation();
            copyText(`${n.name} ‚Ä¢ ${n.blurb} (tags: ${n.tags.join(", ")})`);
          }, { passive:false });

          box.appendChild(el);
        });
      } else {
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `No resonance suggestions yet. Try a word like ◊ê◊û◊™ / ◊©◊ú◊ï◊ù / ◊ê◊î◊ë◊î / ◊í◊ë◊ï◊®◊î / ◊§◊ó◊ì.`;
        box.appendChild(el);
      }
    }

    function renderGematriaInsightsFromInput(raw){
      const mode = $("gMode")?.value || "ritual";
      const { text, total, breakdown } = calcGematria(raw);
      // Update calc UI
      $("gTotal").value = total ? String(total) : "‚Äî";
      $("gBreak").value = breakdown || "‚Äî";

      if(!text){
        $("gInsight").value = "";
        renderGematriaMatchesUI(0, [], []);
        const meta = getMeta();
        meta.lastGematria = { input:"", total:0, breakdown:"", insight:"", suggestedName:"" };
        setMeta(meta);
        return;
      }

      const out = buildInsightText({inputText:text, total, breakdown}, mode);
      $("gInsight").value = out.insight;

      renderGematriaMatchesUI(total, out.matches, out.suggestedNames);

      // Persist last gematria session
      const meta = getMeta();
      meta.lastGematria = {
        input: text,
        total,
        breakdown,
        insight: out.insight,
        suggestedName: out.suggestedName,
        suggestedPattern: out.suggestedPattern
      };
      setMeta(meta);
    }

function wireShareCard(){
  const buildBtn = document.getElementById("buildCardBtn");
  const copyBtn  = document.getElementById("copyCardBtn");
  const saveBtn  = document.getElementById("saveCardBtn");
  const outBox   = document.getElementById("cardOut");

  // If the Share Card UI isn't present, don't crash the whole app
  if (!buildBtn || !copyBtn || !saveBtn || !outBox) {
    // toast("Share Card UI missing ‚ö†Ô∏è"); // optional
    return;
  }

  function buildCardText(){
    const p = getProfile?.() || {};
    const m = getMeta?.() || {};
    const d = getDay?.() || { date: new Date().toISOString().slice(0,10) };

    const fullName = `${p.first||""} ${p.last||""}`.trim() || (p.name || "‚Äî");

    return `KAI ‚Ä¢ ${d.date}
Name: ${fullName}
Focus: ${p.focus || "‚Äî"}
Pattern: ${d.morning?.pattern || m.selectedPattern || "‚Äî"}
72 Name: ${m.selectedName || "‚Äî"}

ALIGN (Morning)
‚Ä¢ Certainty: ${d.morning?.certainty ?? "‚Äî"}  Energy: ${d.morning?.energy ?? "‚Äî"}
‚Ä¢ Intention: ${d.morning?.intention || "‚Äî"}

RESTRICT (Day)
‚Ä¢ Move: ${d.restriction?.move || "‚Äî"}
‚Ä¢ Witness: ${d.restriction?.note || "‚Äî"}
‚Ä¢ Completed: ${d.restriction?.completed ? "Yes" : "No"}

WITNESS (Evening)
‚Ä¢ Win: ${d.evening?.win || "‚Äî"}
‚Ä¢ Lesson: ${d.evening?.lesson || "‚Äî"}

SEAL
‚Ä¢ ${d.evening?.seal || "‚Äî"}`;
  }

  buildBtn.addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    outBox.value = buildCardText();
    toast?.("Card built ‚úÖ");
  }, { passive:false });

  copyBtn.addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    const txt = outBox.value || "";
    (navigator.clipboard?.writeText?.(txt) || Promise.resolve())
      .then(()=>toast?.("Copied ‚úÖ"))
      .catch(()=>toast?.("Copy blocked ‚ö†Ô∏è"));
  }, { passive:false });

  saveBtn.addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    const d = getDay?.() || {};
    d.shareCard = outBox.value || "";
    setDay?.(d);
    toast?.("Card saved ‚úÖ");
  }, { passive:false });

  // Optional: prove wiring happened
  // toast?.("Share wired ‚úÖ");
}
    
    function wireGematriaInsightEngine(){
      const inp = $("gText");
      const mode = $("gMode");
      const copyBtn = $("gCopyInsightBtn");
      const useBtn = $("gUseNameBtn");
      if(!inp || !mode) return;

      inp.addEventListener("input", ()=> renderGematriaInsightsFromInput(inp.value), { passive:true });
      mode.addEventListener("change", ()=> renderGematriaInsightsFromInput(inp.value), { passive:true });

      if(copyBtn){
        copyBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText($("gInsight").value || "");
        }, { passive:false });
      }

      if(useBtn){
        useBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const meta = getMeta();
          const n = meta.lastGematria?.suggestedName || "";
          if(!n){
            toast("No suggested Name yet ‚ùå");
            return;
          }
          meta.selectedName = n;
          if(meta.lastGematria?.suggestedPattern){
            meta.selectedPattern = meta.lastGematria.suggestedPattern;
          }
          setMeta(meta);
          hydrateChips();
          toast(`Used suggested Name: ${n} ‚úÖ`);
          setActiveTab("start");
        }, { passive:false });
      }
    }

    // ---------- 72 Names Lookup ----------
    function render72(){
      const box = $("nResults");
      if(!box) return;
      const q = ($("nSearch")?.value || "").toLowerCase().trim();
      const items = NAMES72.filter(x=>{
        if(!q) return true;
        return x.name.includes(q) || x.tags.join(" ").toLowerCase().includes(q) || x.blurb.toLowerCase().includes(q);
      });
      box.innerHTML = "";
      if(items.length === 0){
        box.innerHTML = `<div class="result">No matches.</div>`;
        return;
      }
      items.slice(0,30).forEach(x=>{
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `
          <div class="mono" style="font-size:20px;"><b>${x.name}</b></div>
          <div>${x.blurb}</div>
          <div class="meta">tags: ${x.tags.join(", ")}</div>
          <div class="bar" style="margin-top:10px;">
            <button type="button" class="btn primary">Use</button>
            <button type="button" class="btn">Copy</button>
          </div>
        `;
        const [useBtn, copyBtn] = el.querySelectorAll("button");
        useBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const m = getMeta();
          m.selectedName = x.name;
          setMeta(m);
          hydrateChips();
          toast(`Selected ${x.name} ‚úÖ`);
          setActiveTab("start");
        }, { passive:false });

        copyBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText(`${x.name} ‚Ä¢ ${x.blurb} (tags: ${x.tags.join(", ")})`);
        }, { passive:false });

        box.appendChild(el);
      });
    }

    // ---------- Library ----------
    function libFilterItems(q, pat){
      q = (q||"").toLowerCase().trim();
      pat = (pat||"").trim();
      return LIB.filter(x=>{
        const okPat = pat ? x.pattern === pat : true;
        const hay = `${x.pattern} ${x.name} ${x.title} ${x.text} ${x.tags.join(" ")}`.toLowerCase();
        const okQ = q ? hay.includes(q) : true;
        return okPat && okQ;
      });
    }

    function libRenderResults(items){
      const box = $("libResults");
      if(!box) return;
      box.innerHTML = "";
      if(items.length === 0){
        box.innerHTML = `<div class="result">No results.</div>`;
        return;
      }
      items.slice(0,30).forEach(x=>{
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `
          <div><b>${x.title}</b> <span class="meta">‚Ä¢ ${x.pattern} ‚Ä¢ <span class="mono">${x.name}</span></span></div>
          <div style="margin-top:6px;">${x.text}</div>
          <div class="meta">tags: ${x.tags.join(", ")}</div>
        `;
        el.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          $("libSuggested").value = `${x.pattern}\n72 Name: ${x.name}\nPractice: ${x.title}\n\n${x.text}`;
          toast("Suggestion loaded ‚úÖ");
        }, { passive:false });
        box.appendChild(el);
      });
    }

    function libPickForMe(pat){
      const items = libFilterItems($("libSearch").value, pat);
      if(items.length === 0){
        toast("Nothing to pick from ‚ùå");
        return;
      }
      const x = items[Math.floor(Math.random()*items.length)];
      $("libSuggested").value = `${x.pattern}\n72 Name: ${x.name}\nPractice: ${x.title}\n\n${x.text}`;
      toast("Picked ‚úÖ");
    }

    function renderLibrary(){
      const search = $("libSearch");
      const pat = $("libPattern");
      if(!search || !pat) return;
      libRenderResults(libFilterItems(search.value, pat.value));
    }

    function wireLibrary(){
      const search = $("libSearch");
      const pat = $("libPattern");
      const pick = $("libPick");
      const clr = $("libClear");
      const copySug = $("libCopySuggested");
      const useSug = $("libUseSuggested");

      if(!search || !pat || !pick || !clr) return;

      function refresh(){
        libRenderResults(libFilterItems(search.value, pat.value));
      }

      search.addEventListener("input", refresh);
      pat.addEventListener("change", refresh);

      pick.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        libPickForMe(pat.value);
      }, { passive:false });

      clr.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        search.value = "";
        pat.value = "";
        $("libSuggested").value = "";
        refresh();
      }, { passive:false });

      if(copySug){
        copySug.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText($("libSuggested").value || "");
        }, { passive:false });
      }

      if(useSug){
        useSug.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const txt = ($("libSuggested").value||"").trim();
          if(!txt){ toast("No suggestion loaded ‚ùå"); return; }
          const m = getMeta();
          const line = txt.split("\n").find(x=> x.toLowerCase().startsWith("72 name:"));
          if(line) m.selectedName = line.split(":").slice(1).join(":").trim();
          const pLine = txt.split("\n")[0] || "";
          m.selectedPattern = pLine.trim();
          setMeta(m);
          hydrateChips();
          toast("Set as today‚Äôs Name ‚úÖ");
          setActiveTab("start");
        }, { passive:false });
      }

      refresh();
    }

    // ---------- Buttons ----------
    function wireButtons(){
      // profile
      $("saveProfileBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI());
        toast("Profile saved ‚úÖ");
        hydrateChips();
      }, { passive:false });

      $("resetProfileBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        localStorage.removeItem(keyProfile);
        hydrateProfileUI();
        toast("Profile reset ‚úÖ");
        hydrateChips();
      }, { passive:false });

      // morning
      $("saveMorningBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI()); // keep profile sticky
        const d = getDay();
        setDay(collectMorningFromUI(d));
        const m = getMeta();
        m.selectedPattern = d.morning.pattern || m.selectedPattern || "";
        setMeta(m);
        toast("Morning saved ‚úÖ");
        hydrateChips();
        hydrateHistory();
      }, { passive:false });

      $("copyMorningBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        const txt = `Morning ‚Ä¢ ${d.date}
Certainty: ${d.morning?.certainty || "‚Äî"}
Energy: ${d.morning?.energy || "‚Äî"}
Intention: ${d.morning?.intention || "‚Äî"}
Pattern: ${d.morning?.pattern || "‚Äî"}
Witness: ${d.morning?.witness || "‚Äî"}`;
        copyText(txt);
      }, { passive:false });

      // restriction
      $("saveRestrictBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        collectRestrictionFromUI(d);
        setDay(d);

        const meta = getMeta();
        if(meta.dailyRestrict){
          if(d.restriction.completed && !d.__streakCounted){
            meta.streak = (meta.streak || 0) + 1;
            d.__streakCounted = true;
            setMeta(meta);
            setDay(d);
            toast("Restriction saved ‚úÖ + streak +1 üéâ");
          }else{
            toast("Restriction saved ‚úÖ");
          }
        } else {
          toast("Restriction saved ‚úÖ");
        }
        hydrateChips();
        hydrateHistory();
      }, { passive:false });

      $("copyRestrictBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        const txt = `Restriction ‚Ä¢ ${d.date}
Move: ${d.restriction?.move || "‚Äî"}
Trigger: ${d.restriction?.trigger || "‚Äî"}
Witness: ${d.restriction?.note || "‚Äî"}
Impact: ${d.restriction?.impact || "‚Äî"}
Completed: ${d.restriction?.completed ? "Yes" : "No"}`;
        copyText(txt);
      }, { passive:false });

      // evening
      $("saveEveningBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        setDay(collectEveningFromUI(d));
        toast("Evening saved ‚úÖ");
        hydrateHistory();
      }, { passive:false });

      $("copyEveningBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        const txt = `Evening ‚Ä¢ ${d.date}
Win: ${d.evening?.win || "‚Äî"}
Lesson: ${d.evening?.lesson || "‚Äî"}
Repair: ${d.evening?.repair || "‚Äî"}
Seal: ${d.evening?.seal || "‚Äî"}
Gratitude: ${d.evening?.gratitude || "‚Äî"}`;
        copyText(txt);
      }, { passive:false });

      // card
      $("buildCardBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const p = getProfile();
        const m = getMeta();
        const d = getDay();
        const txt = `KAI ‚Ä¢ ${d.date}
Name: ${(`${p.first||""} ${p.last||""}`).trim() || "‚Äî"}
Focus: ${p.focus || "‚Äî"}
Pattern: ${d.morning?.pattern || m.selectedPattern || "‚Äî"}
72 Name: ${m.selectedName || "‚Äî"}

ALIGN
‚Ä¢ Certainty: ${d.morning?.certainty || "‚Äî"}  Energy: ${d.morning?.energy || "‚Äî"}
‚Ä¢ Intention: ${d.morning?.intention || "‚Äî"}

RESTRICT
‚Ä¢ Move: ${d.restriction?.move || "‚Äî"}
‚Ä¢ Witness: ${d.restriction?.note || "‚Äî"}

WITNESS
‚Ä¢ Win: ${d.evening?.win || "‚Äî"}
‚Ä¢ Lesson: ${d.evening?.lesson || "‚Äî"}

SEAL
‚Ä¢ ${d.evening?.seal || "‚Äî"}`;
        $("cardOut").value = txt;
        toast("Card built ‚úÖ");
      }, { passive:false });

      $("copyCardBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        copyText($("cardOut").value || "");
      }, { passive:false });

      // export/reset
      $("exportBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const obj = buildExport();
        $("exportBox").value = JSON.stringify(obj, null, 2);
        downloadJSON(obj, `kai-export-${todayISO()}.json`);
        toast("Downloaded ‚úÖ");
      }, { passive:false });

      $("copyExportBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const obj = buildExport();
        const txt = JSON.stringify(obj, null, 2);
        $("exportBox").value = txt;
        copyText(txt);
      }, { passive:false });

      $("resetTodayBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        localStorage.removeItem(keyDay(todayISO()));
        setDay(defaultDay(todayISO()));
        hydrateAll();
        toast("Today reset ‚úÖ");
      }, { passive:false });

      $("resetAllBtn").addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const kill = [];
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.startsWith("kai_")) kill.push(k);
        }
        kill.forEach(k=> localStorage.removeItem(k));
        setDay(defaultDay(todayISO()));
        hydrateAll();
        toast("All reset ‚úÖ");
      }, { passive:false });

      // 72 search
      $("nSearch").addEventListener("input", ()=> render72(), { passive:true });
    }

    function wireDailyRestrictSwitch(){
      const el = $("dailyToggle");
      wireToggle(el, (on)=>{
        const m = getMeta();
        m.dailyRestrict = on;
        setMeta(m);
        hydrateChips();
        toast(on ? "Daily Restrict ON ‚úÖ" : "Daily Restrict OFF");
      });
    }

    function wireRestrictionDoneSwitch(){
      const el = $("restrictDoneToggle");
      wireToggle(el, (on)=>{
        toast(on ? "Marked completed ‚úÖ" : "Marked not completed");
      });
    }

    // ---------- Boot ----------
    (function boot(){
      // ensure today's day exists
      const iso = todayISO();
      if(!localStorage.getItem(keyDay(iso))) setDay(defaultDay(iso));

      wireTabs();
      wireButtons();
      wireShareCard();
      wireDailyRestrictSwitch();
      wireRestrictionDoneSwitch();
      wireLibrary();
      wireGematriaInsightEngine();

      hydrateAll();

      const m = getMeta();
      if(m.lastTab) setActiveTab(m.lastTab);

      toast("BOOT ‚úÖ");
    })();
  </script>
</body>
</html>
