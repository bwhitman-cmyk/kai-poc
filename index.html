<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <title>KAI</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --panel2:#0f0f0f;
      --text:#f4f1e6;
      --muted:#b8b2a3;
      --gold:#d6b25e;
      --gold2:#b9923b;
      --danger:#ff6464;
      --ok:#7CFF9B;
      --line:rgba(214,178,94,.22);
      --shadow: 0 12px 30px rgba(0,0,0,.55);
      --r:18px;
      --pad:16px;
      --tap:52px;
      --max:980px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, system-ui, sans-serif;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 900px at 50% -10%, rgba(214,178,94,.18), transparent 55%),
                  radial-gradient(900px 700px at 20% 10%, rgba(214,178,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{ color:var(--gold); text-decoration:none; }
    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding: env(safe-area-inset-top) var(--pad) calc(88px + env(safe-area-inset-bottom)) var(--pad);
    }
    header{
      position: sticky;
      top:0;
      z-index: 20;
      background: linear-gradient(to bottom, rgba(0,0,0,.92), rgba(0,0,0,.62), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: env(safe-area-inset-top) var(--pad) 10px var(--pad);
      border-bottom: 1px solid rgba(214,178,94,.10);
    }
    .headRow{
      max-width:var(--max);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .logo{
      font-weight:800;
      letter-spacing:.22em;
      color:var(--gold);
      font-size:22px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,94,.26);
      background: rgba(15,15,15,.65);
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .pill b{ color:var(--gold); font-weight:700; }
    .btn{
      min-height: var(--tap);
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(214,178,94,.28);
      background: linear-gradient(180deg, rgba(214,178,94,.14), rgba(214,178,94,.06));
      color: var(--text);
      font-weight: 650;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(15,15,15,.65);
      border:1px solid rgba(214,178,94,.20);
      color: var(--muted);
      font-weight: 600;
    }
    .btn.danger{
      border:1px solid rgba(255,100,100,.35);
      background: rgba(255,100,100,.10);
      color:#ffd6d6;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top: 14px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1.3fr .7fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(15,15,15,.85), rgba(10,10,10,.70));
      border:1px solid rgba(214,178,94,.16);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(214,178,94,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      font-size:15px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--gold);
      font-weight:800;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.02em;
      line-height:1.35;
    }
    .body{ padding:14px; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.04em;
      margin: 12px 0 6px;
      text-transform:uppercase;
    }
    input, textarea, select{
      width:100%;
      font: inherit;
      color: var(--text);
      background: rgba(0,0,0,.35);
      border:1px solid rgba(214,178,94,.18);
      border-radius: 14px;
      padding: 14px 14px;
      outline:none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus{ border-color: rgba(214,178,94,.48); }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .row > *{ flex: 1 1 auto; }

    .tabs{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:30;
      padding: 10px var(--pad) calc(10px + env(safe-area-inset-bottom)) var(--pad);
      background: linear-gradient(to top, rgba(0,0,0,.95), rgba(0,0,0,.74), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(214,178,94,.10);
    }
    .tabbar{
      max-width:var(--max);
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .tab{
      min-height:54px;
      border-radius:16px;
      border:1px solid rgba(214,178,94,.16);
      background: rgba(12,12,12,.65);
      color: var(--muted);
      font-weight:650;
      letter-spacing:.02em;
      cursor:pointer;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(214,178,94,.38);
      background: linear-gradient(180deg, rgba(214,178,94,.14), rgba(214,178,94,.06));
    }

    .section{ display:none; }
    .section.active{ display:block; }

    .mini{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(244,241,230,.82);
      background: rgba(0,0,0,.25);
      border:1px solid rgba(214,178,94,.14);
      padding: 10px 12px;
      border-radius: 14px;
      line-height:1.45;
      white-space: pre-wrap;
    }
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .kpi .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(214,178,94,.18);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      letter-spacing:.02em;
    }
    .kpi .chip b{ color: var(--gold); }
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 90px;
      z-index: 99;
      background: rgba(0,0,0,.88);
      border:1px solid rgba(214,178,94,.22);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: min(92vw, 680px);
      display:none;
      font-size: 13px;
    }
    .divider{
      height:1px;
      background: rgba(214,178,94,.10);
      margin: 12px 0;
    }
    .small{ font-size:12px; color: var(--muted); line-height:1.4; }
    .rightCol .card{ position: sticky; top: 86px; }

    canvas{ width:100%; height:auto; border-radius: 16px; border:1px solid rgba(214,178,94,.16); background:#000; }

  </style>
</head>

<body>
  <header>
    <div class="headRow">
      <div class="brand">
        <div class="logo">KAI</div>
        <div class="sub">Kabbalah Always Illuminates</div>
      </div>
      <div class="pill" title="Local mode only (no servers, no accounts)">
        <span>Today</span>
        <b id="todayLabel">...</b>
      </div>
    </div>
  </header>

  <div class="wrap">

    <!-- MAIN GRID -->
    <div class="grid">

      <!-- LEFT: RITUAL -->
      <div class="leftCol">

        <section id="sec-ritual" class="section active">
          <div class="card">
            <div class="hd">
              <div>
                <div class="title">Daily Ritual</div>
                <div class="hint">Align → Restrict → Witness → Illuminate → Seal</div>
              </div>
              <div class="row" style="justify-content:flex-end;">
                <button class="btn secondary" id="btnLoad">Load</button>
                <button class="btn" id="btnSave">Save</button>
              </div>
            </div>
            <div class="body">

              <!-- STATE CHECK -->
              <label for="state">State Check</label>
              <select id="state">
                <option value="stable">Stable</option>
                <option value="tight">Tight</option>
                <option value="overstimulated">Overstimulated</option>
                <option value="doubting">Doubting</option>
                <option value="heavy">Heavy</option>
                <option value="clear">Clear</option>
                <option value="expansive">Expansive</option>
              </select>

              <div class="divider"></div>

              <!-- ALIGN -->
              <div class="kpi" style="margin-top:2px;">
                <div class="chip"><b>ALIGN</b> intention + source</div>
                <div class="chip"><b>RESTRICT</b> dignified restraint</div>
                <div class="chip"><b>WITNESS</b> truth over story</div>
                <div class="chip"><b>ILLUMINATE</b> next 4 hours</div>
                <div class="chip"><b>SEAL</b> 72 name + breath</div>
              </div>

              <label for="kavanah">Kavanah (One sentence)</label>
              <input id="kavanah" placeholder="Example: I choose momentum through alignment, not force." />

              <label for="zoharHeb">Zohar (Hebrew)</label>
              <textarea id="zoharHeb" placeholder="Paste Hebrew source here (short)."></textarea>

              <label for="zoharEng">Zohar (Translation / meaning)</label>
              <textarea id="zoharEng" placeholder="Short translation or paraphrase."></textarea>

              <label for="leadershipFrame">Leadership frame (today)</label>
              <textarea id="leadershipFrame" placeholder="How does this apply to leadership, decisions, team, structure, momentum?"></textarea>

              <label for="nervousFrame">Nervous system frame (today)</label>
              <textarea id="nervousFrame" placeholder="How does this apply to your body, PD rhythm, overstimulation, tightness, steadiness?"></textarea>

              <div class="divider"></div>

              <!-- RESTRICT -->
              <label for="reactive">Where is reactive energy trying to drive you today?</label>
              <select id="reactive">
                <option value="">Select…</option>
                <option value="control">Control</option>
                <option value="impatience">Impatience</option>
                <option value="fear">Fear</option>
                <option value="overdrive">Overdrive</option>
                <option value="withdrawal">Withdrawal</option>
                <option value="ego">Ego</option>
                <option value="chaos">Chaos</option>
                <option value="other">Other</option>
              </select>

              <label for="restriction">Restriction (dignified restraint)</label>
              <textarea id="restriction" placeholder="What would dignified restraint look like? Where do you hold the line, softly but firmly?"></textarea>

              <div class="divider"></div>

              <!-- WITNESS -->
              <label for="physical">Witness: What is physically happening?</label>
              <textarea id="physical" placeholder="Body, movement, breath, tightness, fatigue, overstimulation…"></textarea>

              <label for="emotional">Witness: What is emotionally happening?</label>
              <textarea id="emotional" placeholder="Mood, shame, rage, fear, pride, hope, tenderness…"></textarea>

              <label for="story">Witness: What is the story?</label>
              <textarea id="story" placeholder="The narrative that wants to run the show…"></textarea>

              <label for="truth">Witness: What is the truth?</label>
              <textarea id="truth" placeholder="A cleaner, simpler truth. No drama."></textarea>

              <label for="tiferet">What would Tiferet do?</label>
              <textarea id="tiferet" placeholder="What is the balanced move? What does harmony look like in action?"></textarea>

              <div class="divider"></div>

              <!-- ILLUMINATE -->
              <label for="next4">Illuminate: One concrete move in the next 4 hours</label>
              <input id="next4" placeholder="Example: Send Parker the model request + schedule 30 min review." />

              <label for="notes">Notes (optional)</label>
              <textarea id="notes" placeholder="Any extra thoughts, but keep it clean."></textarea>

              <div class="divider"></div>

              <!-- SEAL -->
              <label for="name72">Seal: 72 Name focus</label>
              <input id="name72" placeholder="Example: וול (Defying Gravity)" />

              <label for="breath">Seal: Breath / Shirah cue</label>
              <input id="breath" placeholder="Example: inhale 4, hold 2, exhale 6. Hum on exhale." />

              <div class="row" style="margin-top:12px;">
                <button class="btn" id="btnShare">Generate Share Card</button>
                <button class="btn secondary" id="btnClear">Clear Fields</button>
              </div>

              <div class="small" style="margin-top:10px;">
                Everything saves locally on this device only. If iOS clears storage, data can disappear. Export/share cards for anything mission-critical.
              </div>

            </div>
          </div>
        </section>

        <!-- SHARE -->
        <section id="sec-share" class="section">
          <div class="card">
            <div class="hd">
              <div>
                <div class="title">Share Card</div>
                <div class="hint">A clean artifact of today’s alignment.</div>
              </div>
              <div class="row" style="justify-content:flex-end;">
                <button class="btn secondary" id="btnBackToRitual">Back</button>
                <button class="btn" id="btnDownload">Save Image</button>
              </div>
            </div>
            <div class="body">
              <canvas id="cardCanvas" width="1200" height="1600"></canvas>
              <div class="small" style="margin-top:10px;">
                On iPad: tap “Save Image”, then share or save to Photos. If the share sheet appears, choose what you want.
              </div>
              <div class="mini" id="shareDebug" style="margin-top:10px; display:none;"></div>
            </div>
          </div>
        </section>

        <!-- LIBRARY -->
        <section id="sec-library" class="section">
          <div class="card">
            <div class="hd">
              <div>
                <div class="title">Library</div>
                <div class="hint">Sources, themes, and anchors. (We expand this next.)</div>
              </div>
              <button class="btn secondary" id="btnLibSeed">Load Starter Library</button>
            </div>
            <div class="body">
              <label for="libQuery">Search</label>
              <input id="libQuery" placeholder="Try: Atika, Din, Tiferet, Vav, Restriction…" />
              <div class="divider"></div>
              <div id="libList" class="mini">Library is empty. Tap “Load Starter Library”.</div>
            </div>
          </div>
        </section>

        <!-- HISTORY -->
        <section id="sec-history" class="section">
          <div class="card">
            <div class="hd">
              <div>
                <div class="title">History</div>
                <div class="hint">Your saved days on this device.</div>
              </div>
              <button class="btn secondary" id="btnRefreshHistory">Refresh</button>
            </div>
            <div class="body">
              <div id="historyList" class="mini">No history yet.</div>
              <div class="small" style="margin-top:10px;">
                Tip: if you want “export all”, we can add it in the next pass.
              </div>
            </div>
          </div>
        </section>

      </div>

      <!-- RIGHT: STATUS / QUICK VIEW -->
      <div class="rightCol">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Status</div>
              <div class="hint">Fast pulse-check.</div>
            </div>
            <button class="btn secondary" id="btnQuickFill">Quick Fill (demo)</button>
          </div>
          <div class="body">
            <div class="kpi">
              <div class="chip"><b>State</b> <span id="kState">…</span></div>
              <div class="chip"><b>Saved</b> <span id="kSaved">No</span></div>
              <div class="chip"><b>Version</b> <span id="kVer">v2</span></div>
            </div>
            <div class="divider"></div>
            <div class="small">Kavanah</div>
            <div id="kKavanah" class="mini" style="margin-top:6px;">…</div>
            <div class="divider"></div>
            <div class="small">Next 4 hours</div>
            <div id="kNext4" class="mini" style="margin-top:6px;">…</div>
            <div class="divider"></div>
            <div class="small">Seal</div>
            <div id="kSeal" class="mini" style="margin-top:6px;">…</div>
          </div>
        </div>
      </div>

    </div><!-- /grid -->
  </div><!-- /wrap -->

  <!-- BOTTOM TABS -->
  <div class="tabs">
    <div class="tabbar">
      <button class="tab active" data-tab="ritual">Ritual</button>
      <button class="tab" data-tab="share">Share</button>
      <button class="tab" data-tab="library">Library</button>
      <button class="tab" data-tab="history">History</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // KAI 2.0 - Zero-dependency
    // =========================

    const APP_VERSION = "kai_day_v2";
    const LIB_KEY = "kai_library_v1";

    // ---------- Crash visibility ----------
    window.addEventListener("error", (e)=>{
      try { toast("JS error: " + (e?.message || "unknown")); } catch {}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try { toast("Promise error: " + (e?.reason?.message || e?.reason || "unknown")); } catch {}
    });

    // ---------- Helpers ----------
    const $ = (id)=> document.getElementById(id);
    const todayISO = ()=> {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    };
    const dayKey = (iso)=> `${APP_VERSION}_${iso}`;

    function safeJSONParse(s, fallback){
      try { return JSON.parse(s); } catch { return fallback; }
    }
    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = String(msg);
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>{ t.style.display="none"; }, 2800);
    }

    // ---------- Elements ----------
    const fields = [
      "state","kavanah","zoharHeb","zoharEng","leadershipFrame","nervousFrame",
      "reactive","restriction","physical","emotional","story","truth","tiferet",
      "next4","notes","name72","breath"
    ];

    function snapshot(){
      const obj = {};
      for(const f of fields){
        const el = $(f);
        obj[f] = el ? el.value : "";
      }
      obj._iso = todayISO();
      obj._savedAt = new Date().toISOString();
      return obj;
    }

    function applySnapshot(obj){
      if(!obj) return;
      for(const f of fields){
        if($(f)) $(f).value = obj[f] ?? "";
      }
      refreshStatus(true);
    }

    function clearFields(){
      for(const f of fields){
        if($(f)){
          if($(f).tagName === "SELECT") $(f).value = $(f).querySelector("option")?.value ?? "";
          else $(f).value = "";
        }
      }
      refreshStatus(false);
      toast("Cleared.");
    }

    // ---------- Storage ----------
    function saveToday(){
      const iso = todayISO();
      const key = dayKey(iso);
      const data = snapshot();
      try{
        localStorage.setItem(key, JSON.stringify(data));
        localStorage.setItem(`${APP_VERSION}_last`, key);
        toast("Saved.");
        refreshStatus(true);
        refreshHistory();
      }catch(err){
        toast("Save failed (storage full?)");
        console.error(err);
      }
    }

    function loadToday(){
      const iso = todayISO();
      const key = dayKey(iso);
      const raw = localStorage.getItem(key);
      if(!raw){
        toast("No saved entry for today.");
        refreshStatus(false);
        return;
      }
      const data = safeJSONParse(raw, null);
      if(!data){ toast("Corrupt save."); return; }
      applySnapshot(data);
      toast("Loaded.");
    }

    function refreshHistory(){
      const out = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith(APP_VERSION + "_20")){ // crude: only date keys
          const obj = safeJSONParse(localStorage.getItem(k), null);
          const iso = (obj && obj._iso) ? obj._iso : k.slice(APP_VERSION.length+1);
          const kav = (obj && obj.kavanah) ? obj.kavanah : "";
          out.push({iso, k, kav});
        }
      }
      out.sort((a,b)=> (a.iso < b.iso ? 1 : -1));
      if(out.length === 0){
        $("historyList").textContent = "No history yet.";
        return;
      }
      const lines = out.map(x=> `• ${x.iso}  |  ${x.kav ? x.kav : "(no kavanah)"}\n   key: ${x.k}`);
      $("historyList").textContent = lines.join("\n\n");
    }

    // ---------- Tabs ----------
    function setTab(name){
      const tabs = document.querySelectorAll(".tab");
      tabs.forEach(t=> t.classList.toggle("active", t.dataset.tab === name));
      const secMap = {
        ritual: "sec-ritual",
        share: "sec-share",
        library: "sec-library",
        history: "sec-history",
      };
      for(const k in secMap){
        $(secMap[k]).classList.toggle("active", k === name);
      }
      if(name === "history") refreshHistory();
      if(name === "library") renderLibrary();
    }

    // ---------- Status panel ----------
    function refreshStatus(saved){
      $("kState").textContent = $("state").value || "…";
      $("kSaved").textContent = saved ? "Yes" : "No";
      $("kKavanah").textContent = $("kavanah").value || "…";
      $("kNext4").textContent = $("next4").value || "…";
      const seal = [ $("name72").value, $("breath").value ].filter(Boolean).join(" | ");
      $("kSeal").textContent = seal || "…";
    }

    function checkSavedToday(){
      const key = dayKey(todayISO());
      return !!localStorage.getItem(key);
    }

    // ---------- Share Card (Canvas) ----------
    function drawShareCard(){
      const c = $("cardCanvas");
      const ctx = c.getContext("2d");
      const W = c.width, H = c.height;

      // background
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,W,H);

      // subtle gold aura
      const g = ctx.createRadialGradient(W*0.5, H*0.15, 10, W*0.5, H*0.15, W*0.6);
      g.addColorStop(0, "rgba(214,178,94,0.28)");
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);

      // frame
      ctx.strokeStyle = "rgba(214,178,94,0.55)";
      ctx.lineWidth = 4;
      roundRect(ctx, 48, 48, W-96, H-96, 34);
      ctx.stroke();

      // header
      ctx.fillStyle = "#d6b25e";
      ctx.font = "800 56px -apple-system, BlinkMacSystemFont, Arial";
      ctx.letterSpacing = "2px";
      ctx.fillText("KAI", 92, 140);

      ctx.fillStyle = "rgba(244,241,230,0.78)";
      ctx.font = "500 24px -apple-system, BlinkMacSystemFont, Arial";
      ctx.fillText("Kabbalah Always Illuminates", 92, 180);

      ctx.fillStyle = "rgba(184,178,163,0.9)";
      ctx.font = "600 22px ui-monospace, Menlo, monospace";
      ctx.fillText(todayISO() + "  |  state: " + ($("state").value || "—"), 92, 220);

      // sections
      const blocks = [
        ["KAVANAH", $("kavanah").value],
        ["RESTRICTION", $("restriction").value],
        ["TRUTH", $("truth").value],
        ["NEXT 4 HOURS", $("next4").value],
        ["SEAL", [ $("name72").value, $("breath").value ].filter(Boolean).join(" | ")]
      ];

      let y = 280;
      for(const [label, text] of blocks){
        y = drawBlock(ctx, 92, y, W-184, label, text);
        y += 18;
      }

      // footer
      ctx.fillStyle = "rgba(184,178,163,0.75)";
      ctx.font = "500 18px -apple-system, BlinkMacSystemFont, Arial";
      ctx.fillText("Align • Restrict • Witness • Illuminate • Seal", 92, H-92);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function drawBlock(ctx, x, y, w, label, text){
      // label
      ctx.fillStyle = "rgba(214,178,94,0.95)";
      ctx.font = "800 22px -apple-system, BlinkMacSystemFont, Arial";
      ctx.fillText(label, x, y);

      // text box
      y += 18;
      const boxY = y + 18;

      ctx.strokeStyle = "rgba(214,178,94,0.22)";
      ctx.lineWidth = 2;
      roundRect(ctx, x, boxY, w, 170, 22);
      ctx.stroke();

      ctx.fillStyle = "rgba(244,241,230,0.92)";
      ctx.font = "500 26px -apple-system, BlinkMacSystemFont, Arial";

      const content = (text || "—").trim();
      const lines = wrapText(ctx, content, w-40);
      let ty = boxY + 46;
      const maxLines = 4;
      for(let i=0;i<Math.min(lines.length, maxLines);i++){
        ctx.fillText(lines[i], x+20, ty);
        ty += 34;
      }
      if(lines.length > maxLines){
        ctx.fillStyle = "rgba(184,178,163,0.85)";
        ctx.font = "500 22px -apple-system, BlinkMacSystemFont, Arial";
        ctx.fillText("…", x+20, ty);
      }
      return boxY + 200;
    }

    function wrapText(ctx, text, maxWidth){
      const words = text.split(/\s+/);
      const lines = [];
      let line = "";
      for(const w of words){
        const test = line ? (line + " " + w) : w;
        if(ctx.measureText(test).width <= maxWidth){
          line = test;
        }else{
          if(line) lines.push(line);
          line = w;
        }
      }
      if(line) lines.push(line);
      return lines;
    }

    function downloadCanvas(){
      const c = $("cardCanvas");
      try{
        const url = c.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = `KAI_${todayISO()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast("Saved image (or opened share).");
      }catch(err){
        toast("Could not save image.");
        console.error(err);
      }
    }

    // ---------- Library ----------
    function getLibrary(){
      return safeJSONParse(localStorage.getItem(LIB_KEY), []);
    }
    function setLibrary(items){
      localStorage.setItem(LIB_KEY, JSON.stringify(items));
    }

    function seedLibrary(){
      const starter = [
        {
          title: "Atika Kadisha (Holy Ancient One)",
          tags: ["Atika", "Keter", "concealment", "mercy"],
          body: "Atika is the concealed root of mercy behind judgment. When Din tightens, remember: the root is deeper than the reaction. Practice: pause, soften jaw, exhale long, choose the central column."
        },
        {
          title: "Din → Rachamim (Judgment into Mercy)",
          tags: ["Din", "Rachamim", "Gevurah", "Tiferet"],
          body: "Judgment is a tool, not a throne. The work is not to erase Gevurah but to harmonize it. Practice: name the boundary, then ask what love requires."
        },
        {
          title: "The Central Column (Tiferet as decision)",
          tags: ["Tiferet", "balance", "alignment"],
          body: "Tiferet is not compromise. It is alignment: truth plus love, structure plus breath, momentum without force. Practice: one clean move in the next 4 hours."
        },
        {
          title: "Restriction (Tzimtzum as power)",
          tags: ["restriction", "tzimtzum", "discipline"],
          body: "Restriction is how Light becomes usable. Practice: identify the reactive impulse, then choose dignified restraint that protects the mission."
        }
      ];
      setLibrary(starter);
      toast("Starter library loaded.");
      renderLibrary();
    }

    function renderLibrary(){
      const q = ($("libQuery").value || "").trim().toLowerCase();
      const items = getLibrary();
      if(items.length === 0){
        $("libList").textContent = "Library is empty. Tap “Load Starter Library”.";
        return;
      }
      const filtered = items.filter(it=>{
        const blob = (it.title + " " + it.body + " " + (it.tags||[]).join(" ")).toLowerCase();
        return q ? blob.includes(q) : true;
      });
      if(filtered.length === 0){
        $("libList").textContent = "No matches.";
        return;
      }
      const lines = filtered.map(it=>{
        return `• ${it.title}\n  tags: ${(it.tags||[]).join(", ")}\n  ${it.body}`;
      });
      $("libList").textContent = lines.join("\n\n");
    }

    // ---------- Wire up ----------
    function init(){
      $("todayLabel").textContent = todayISO();

      // tab clicks
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
      });

      // save/load
      $("btnSave").addEventListener("click", saveToday);
      $("btnLoad").addEventListener("click", loadToday);

      // clear
      $("btnClear").addEventListener("click", ()=>{
        if(confirm("Clear all fields?")) clearFields();
      });

      // live status updates
      fields.forEach(f=>{
        const el = $(f);
        if(el) el.addEventListener("input", ()=> refreshStatus(checkSavedToday()));
      });

      // share
      $("btnShare").addEventListener("click", ()=>{
        drawShareCard();
        setTab("share");
      });
      $("btnBackToRitual").addEventListener("click", ()=> setTab("ritual"));
      $("btnDownload").addEventListener("click", downloadCanvas);

      // history
      $("btnRefreshHistory").addEventListener("click", refreshHistory);

      // library
      $("btnLibSeed").addEventListener("click", seedLibrary);
      $("libQuery").addEventListener("input", renderLibrary);

      // demo quick fill
      $("btnQuickFill").addEventListener("click", ()=>{
        $("state").value = "clear";
        $("kavanah").value = "I choose momentum through alignment, not force.";
        $("restriction").value = "No reactive control. One clean boundary, then proceed with steadiness.";
        $("truth").value = "I can move slowly and still be unstoppable.";
        $("next4").value = "Send one decisive note, then 20 minutes of quiet execution.";
        $("name72").value = "וול";
        $("breath").value = "Inhale 4 • Hold 2 • Exhale 6 (hum on exhale)";
        refreshStatus(checkSavedToday());
        toast("Demo filled.");
      });

      // initial status
      refreshStatus(checkSavedToday());
      refreshHistory();

      // try auto-load last
      const lastKey = localStorage.getItem(`${APP_VERSION}_last`);
      if(lastKey){
        const raw = localStorage.getItem(lastKey);
        const obj = safeJSONParse(raw, null);
        if(obj && obj._iso === todayISO()){
          applySnapshot(obj);
        }
      }

      // service worker (optional)
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      }
    }

    init();
  </script>
</body>
</html>
