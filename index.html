<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- iOS standalone app -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />

  <title>KAI</title>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <style>
    :root{
      --bg:#070708;
      --card:#141416;
      --muted:#a7a7ad;
      --text:#f3f3f5;
      --line:#2a2a2f;
      --gold:#d6b36a;
      --gold2:#f2d9a6;
      --ok:#66d17a;
      --bad:#ff6b6b;
      --shadow: rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(214,179,106,.10), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(214,179,106,.08), transparent 50%),
                  linear-gradient(180deg,#050506,#0a0a0c 25%, #070708);
      color:var(--text);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 16px 130px; }

    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:14px;
      margin:10px 0 12px;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size:28px; letter-spacing:.4px; }
    .sub{ color:var(--muted); font-size:13px; }

    .badgeRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      color:var(--gold);
      font-size:12px;
      border:1px solid rgba(214,179,106,.35);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
    }
    .badge.ok{ border-color: rgba(102,209,122,.45); color: var(--ok); }
    .badge.bad{ border-color: rgba(255,107,107,.45); color: var(--bad); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 14px; }
    .tab{
      background:transparent; color:var(--muted);
      border:1px solid var(--line);
      padding:10px 12px; border-radius:12px; font-size:14px;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(214,179,106,.55);
      box-shadow:0 0 0 1px rgba(214,179,106,.20) inset;
    }

    .card{
      background:rgba(20,20,22,.92);
      border:1px solid rgba(42,42,47,.85);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
    }
    .card h3{
      margin:0 0 10px;
      font-size:15px;
      letter-spacing:.2px;
      color: var(--gold2);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ flex:1; min-width:220px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 8px; }
    input, textarea, select{
      width:100%;
      background:#0f0f11;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .small textarea{ min-height:84px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      background: rgba(0,0,0,.18);
    }
    .pill strong{ color: var(--gold2); font-weight:650; }
    .muted{ color:var(--muted); font-size:13px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 820px){ .grid2{ grid-template-columns:1fr; } }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
      white-space:pre-wrap;
      color:#e9e9ee;
      background:#0f0f11;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }

    .historyList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .hitem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#0f0f11;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .hmeta{ color:var(--muted); font-size:12px; }
    .hdate{ font-weight:650; }
    .hbtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      white-space:nowrap;
    }

    .actions{
      position:fixed;
      left:0; right:0; bottom:0;
      background:rgba(10,10,12,.88);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(42,42,47,.85);
      padding:12px 14px;
    }
    .actions .inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-size:15px;
      color:#0b0b0c;
      background:var(--gold);
      font-weight:700;
      box-shadow: 0 12px 20px rgba(0,0,0,.25);
    }
    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      font-weight:600;
      box-shadow:none;
    }
    .btn.danger{
      background:transparent;
      color: var(--bad);
      border:1px solid rgba(255,107,107,.35);
      font-weight:650;
    }
    .status{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .dot{ width:9px; height:9px; border-radius:50%; background:var(--muted); display:inline-block; }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--bad); }

    .glow{
      animation: glowPulse 900ms ease-out 1;
    }
    @keyframes glowPulse{
      0%{ box-shadow: 0 0 0 rgba(214,179,106,0); }
      35%{ box-shadow: 0 0 22px rgba(214,179,106,.22); }
      100%{ box-shadow: 0 0 0 rgba(214,179,106,0); }
    }

    .mini{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .kicker{ font-size:12px; color:var(--muted); }
    .bigHeb{ font-size:26px; letter-spacing:1px; color: var(--gold2); font-weight:800; }
    .tiny{ font-size:12px; color:var(--muted); }

    .divider{
      height:1px; background:rgba(42,42,47,.85); margin:12px 0;
    }

    .toast{
      position:fixed;
      top:14px; left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(214,179,106,.25);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:none;
      z-index:999;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">Saved.</div>

  <div class="wrap">
    <header>
      <div class="title">
        <h1>KAI</h1>
        <div class="sub">Kabbalah Always Illuminates · Alignment · Restriction · Witnessing</div>
      </div>

      <div class="badgeRow">
        <div class="badge" id="todayBadge">Date: —</div>
        <div class="badge" id="profileBadge">Profile: —</div>
        <div class="badge ok" id="streakBadge">Streak: 0</div>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <button class="tab active" data-screen="start">Start</button>
      <button class="tab" data-screen="morning">Morning</button>
      <button class="tab" data-screen="restriction">Restriction</button>
      <button class="tab" data-screen="evening">Evening</button>
      <button class="tab" data-screen="tools">Tools</button>
      <button class="tab" data-screen="learn">Learn</button>
      <button class="tab" data-screen="history">History</button>
    </div>

    <!-- START / PROFILE -->
    <section id="screen-start" class="screen">
      <div class="card">
        <h3>Profile and Intent</h3>
        <div class="row">
          <div class="field">
            <label>Your name</label>
            <input id="p_name" placeholder="Bernard" />
          </div>
          <div class="field">
            <label>Birthdate (for astrology layer)</label>
            <input id="p_birth" type="date" />
          </div>
          <div class="field">
            <label>Primary focus</label>
            <select id="p_focus">
              <option value="">Select…</option>
              <option>Leadership</option>
              <option>Relationship</option>
              <option>Health / nervous system</option>
              <option>Spiritual discipline</option>
              <option>Work / money / control</option>
              <option>Family</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>30-day outcome (one sentence)</label>
            <input id="p_outcome" placeholder="Increase certainty and reduce urgency reactivity." />
          </div>
          <div class="field">
            <label>Preferred intensity</label>
            <select id="p_intensity">
              <option>Simple</option>
              <option selected>Simple + Powerful</option>
              <option>Deep Work Mode</option>
            </select>
          </div>
          <div class="field">
            <label>Enable</label>
            <select id="p_features">
              <option value="core">Core only</option>
              <option value="core_tools" selected>Core + Tools (72 Names, Gematria, Astrology)</option>
              <option value="core_tools_learn">Core + Tools + Learn</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="mini">
          <span class="pill"><strong>Today’s Sun sign:</strong> <span id="sunSign">—</span></span>
          <span class="pill"><strong>Today’s KAI mode:</strong> <span id="kaiMode">—</span></span>
          <span class="pill"><strong>Personal prompt:</strong> <span id="personalPrompt">—</span></span>
        </div>

        <div class="divider"></div>
        <div class="muted">
          KAI is designed as a feedback loop: <strong>pattern → restriction → tool → witness → measurement</strong>.
          Your teacher can refine mappings; this POC demonstrates the engine.
        </div>
      </div>

      <div class="card">
        <h3>Daily KAI Guidance Preview</h3>
        <div class="grid2">
          <div>
            <div class="kicker">Your current dominant pattern (from today’s Morning input)</div>
            <div class="pill"><strong>Pattern:</strong> <span id="dominantPattern">—</span></div>
            <div style="height:8px"></div>

            <div class="kicker">72 Name tool (pattern-mapped)</div>
            <div class="mini">
              <div class="bigHeb" id="nameHeb">—</div>
              <div>
                <div class="pill"><strong>Meaning:</strong> <span id="nameMeaning">—</span></div>
                <div class="tiny" id="nameHow">Select a pattern to see a tool.</div>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="kicker">Zohar lens (teaching bite)</div>
            <div class="mono" id="zoharLens">—</div>
          </div>

          <div>
            <div class="kicker">Suggested restriction (one actionable move)</div>
            <div class="mono" id="suggestedRestriction">—</div>
            <div style="height:10px"></div>

            <div class="kicker">Shareable “KAI Card” (copy/share/export)</div>
            <div class="mono" id="kaiCard">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- MORNING -->
    <section id="screen-morning" class="screen" hidden>
      <div class="card">
        <h3>Morning Intake</h3>
        <div class="row">
          <div class="field">
            <label>Where are you reactive today?</label>
            <input id="reactive_where" placeholder="Work / relationship / body / money / control / etc" />
          </div>
          <div class="field">
            <label>What is the pattern?</label>
            <select id="pattern">
              <option value="">Select…</option>
              <option value="urgency">Urgency / speed / forcing</option>
              <option value="anger">Anger / sharpness / attack</option>
              <option value="avoidance">Avoidance / delay / dissociation</option>
              <option value="approval">Approval-seeking / people-pleasing</option>
              <option value="control">Control / micromanage / certainty-grab</option>
              <option value="shame">Shame / unworthiness / collapse</option>
              <option value="scarcity">Scarcity / fear / contraction</option>
              <option value="judgment">Judgment / criticism / superiority</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Certainty (0–10)</label>
            <input id="certainty" inputmode="numeric" placeholder="0–10" />
          </div>
          <div class="field">
            <label>Energy (0–10)</label>
            <input id="energy" inputmode="numeric" placeholder="0–10" />
          </div>
          <div class="field">
            <label>One intention</label>
            <input id="intention" placeholder="What is my soul trying to do today?" />
          </div>
        </div>

        <div class="row small">
          <div class="field">
            <label>Trigger forecast (optional)</label>
            <textarea id="trigger_forecast" placeholder="When will it try to grab me today?"></textarea>
          </div>
          <div class="field">
            <label>One courageous micro-choice (optional)</label>
            <textarea id="micro_choice" placeholder="One small action that breaks the pattern."></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Today’s Tool and Teaching</h3>
        <div class="grid2">
          <div>
            <div class="pill"><strong>72 Name Tool:</strong> <span id="m_nameBrief">—</span></div>
            <div style="height:10px"></div>
            <div class="mono" id="m_namePractice">Choose a pattern to see your tool.</div>
          </div>
          <div>
            <div class="pill"><strong>Zohar Lens:</strong> <span id="m_zoharTag">—</span></div>
            <div style="height:10px"></div>
            <div class="mono" id="m_zoharText">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section id="screen-restriction" class="screen" hidden>
      <div class="card">
        <h3>Restriction</h3>
        <div class="row">
          <div class="field">
            <label>Restriction (choose one action)</label>
            <select id="restriction_action">
              <option value="">Select one…</option>
              <option>Pause before speaking (3 breaths)</option>
              <option>Delay response 10 minutes</option>
              <option>Ask 1 curious question</option>
              <option>Lower volume / soften face</option>
              <option>Do not interrupt</option>
              <option>Choose dignity over victory</option>
              <option>Let go of control once</option>
              <option>Say: “Let me sit with that”</option>
              <option>Give before you take</option>
            </select>
          </div>
          <div class="field">
            <label>Where will you apply it?</label>
            <input id="restriction_where" placeholder="Meeting / text thread / family / commute / self-talk" />
          </div>
          <div class="field">
            <label>Confidence (0–10)</label>
            <input id="restriction_conf" inputmode="numeric" placeholder="0–10" />
          </div>
        </div>

        <div class="row small">
          <div class="field">
            <label>Replacement behavior (make it concrete)</label>
            <textarea id="replacement" placeholder="What do I do instead, specifically?"></textarea>
          </div>
          <div class="field">
            <label>Mini script (optional)</label>
            <textarea id="mini_script" placeholder='Example: “I hear you. Give me 10 minutes to respond with clarity.”'></textarea>
          </div>
        </div>

        <div class="divider"></div>
        <div class="pill"><strong>Suggested (from your pattern):</strong> <span id="r_suggested">—</span></div>
      </div>
    </section>

    <!-- EVENING -->
    <section id="screen-evening" class="screen" hidden>
      <div class="card">
        <h3>Evening Witness</h3>
        <div class="row small">
          <div class="field">
            <label>Did you witness illumination?</label>
            <textarea id="evening_witness" placeholder="Where did you restrict? What changed? What did you notice?"></textarea>
          </div>
          <div class="field">
            <label>One insight / message</label>
            <textarea id="insight" placeholder="What did Light show you today?"></textarea>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Certainty now (0–10)</label>
            <input id="certainty_pm" inputmode="numeric" placeholder="0–10" />
          </div>
          <div class="field">
            <label>Gratitude (one line)</label>
            <input id="gratitude" placeholder="I appreciate…" />
          </div>
          <div class="field">
            <label>Tomorrow’s micro-commitment</label>
            <input id="tomorrow" placeholder="One tiny action I will repeat tomorrow" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Shareable Output</h3>
        <div class="grid2">
          <div>
            <div class="kicker">Teacher Packet (structured)</div>
            <div class="mono" id="packetPreview">—</div>
          </div>
          <div>
            <div class="kicker">KAI Card (short, fun, shareable)</div>
            <div class="mono" id="cardPreview">—</div>
            <div class="tiny">Tip: use Share button below to send to Eitan, Constantin, Notes, WhatsApp, etc.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TOOLS -->
    <section id="screen-tools" class="screen" hidden>
      <div class="card">
        <h3>72 Names Tool</h3>
        <div class="muted">Pattern-driven. A tool for restriction, not a vibe. Your teacher can adjust mappings later.</div>
        <div style="height:10px"></div>
        <div class="pill"><strong>Current pattern:</strong> <span id="t_pattern">—</span></div>
        <div style="height:10px"></div>

        <div class="mini">
          <div class="bigHeb" id="t_nameHeb">—</div>
          <div>
            <div class="pill"><strong>Meaning:</strong> <span id="t_nameMeaning">—</span></div>
            <div class="tiny" id="t_nameNote">Select a pattern in Morning.</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="mono" id="t_namePractice">—</div>
      </div>

      <div class="card">
        <h3>Gematria</h3>
        <div class="row">
          <div class="field">
            <label>Enter Hebrew word/name (e.g., אהבה)</label>
            <input id="g_input" placeholder="אהבה" />
          </div>
          <div class="field">
            <label>Result</label>
            <input id="g_total" readonly placeholder="—" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="mono" id="g_breakdown">Type Hebrew letters above to see breakdown.</div>
      </div>

      <div class="card">
        <h3>Astrology (simple + useful)</h3>
        <div class="muted">Sun sign from your birthdate. This is a light personalization layer, not destiny.</div>
        <div style="height:10px"></div>
        <div class="mini">
          <span class="pill"><strong>Sun sign:</strong> <span id="a_sign">—</span></span>
          <span class="pill"><strong>Prompt:</strong> <span id="a_prompt">—</span></span>
        </div>
        <div style="height:10px"></div>
        <div class="mono" id="a_teaching">—</div>
      </div>
    </section>

    <!-- LEARN -->
    <section id="screen-learn" class="screen" hidden>
      <div class="card">
        <h3>Learn (micro-lessons)</h3>
        <div class="muted">Short, applied teachings. Designed to make KAI fun and educational without becoming a book.</div>
        <div style="height:10px"></div>
        <div class="pill"><strong>Today’s lesson:</strong> <span id="l_title">—</span></div>
        <div style="height:10px"></div>
        <div class="mono" id="l_body">—</div>
        <div style="height:12px"></div>
        <div class="mini">
          <button class="btn secondary" id="lessonNext">New lesson</button>
          <span class="tiny">Tip: lessons rotate; teachers can later curate a canonical library.</span>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="screen-history" class="screen" hidden>
      <div class="card">
        <h3>History Intelligence</h3>
        <div class="grid2">
          <div>
            <div class="pill"><strong>Most frequent pattern (14 days):</strong> <span id="h_topPattern">—</span></div>
            <div style="height:10px"></div>
            <div class="mono" id="h_insights">Save a few days and KAI will surface trend insights here.</div>
          </div>
          <div>
            <div class="pill"><strong>Pattern counts:</strong> <span id="h_countsTag">—</span></div>
            <div style="height:10px"></div>
            <div class="mono" id="h_counts">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Saved Days</h3>
        <div class="historyList" id="historyList"></div>
      </div>
    </section>
  </div>

  <div class="actions">
    <div class="inner">
      <div class="status">
        <span class="dot" id="saveDot"></span>
        <span id="saveStatus">Not saved yet.</span>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn secondary" id="copyBtn">Copy</button>
        <button class="btn secondary" id="shareBtn">Share</button>
        <button class="btn secondary" id="exportBtn">Export</button>
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn danger" id="resetBtn">Reset Day</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   KAI POC v0.3 (single-file)
   - Profile personalization
   - Pattern → Sefirah lens → 72 Name tool → restriction suggestion
   - Zohar lens (short “teaching bites”, not long quotes)
   - Gematria + Astrology tools
   - Shareable content (KAI Card) + Teacher packet
   - History intelligence (pattern counts + insights)
   ========================================================= */

  // Storage keys
  const STORAGE_ENTRIES = "kai_entries";
  const STORAGE_PROFILE = "kai_profile";
  const STORAGE_STREAK  = "kai_streak";

  const $ = (id) => document.getElementById(id);

  // Date key (local)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  const todayKey = `${yyyy}-${mm}-${dd}`;
  $("todayBadge").textContent = `Date: ${todayKey}`;

  // --- Core data: pattern mappings (teacher can later refine) ---
  const PATTERNS = {
    urgency: {
      label: "Urgency / speed / forcing",
      sefirah: "Netzach (push) imbalance",
      zohar: "When we force outcomes, we shrink the vessel. True victory comes through restraint and timing.",
      restriction: "Delay response 3 breaths. Replace speed with presence. Ask: “What would certainty do?”",
      name: { heb:"והו", meaning:"Release pressure / soften forcing", practice:"60 seconds: breathe slowly. Visualize your urgency dissolving into calm clarity. Then act once, cleanly." }
    },
    anger: {
      label: "Anger / sharpness / attack",
      sefirah: "Gevurah needs sweetening",
      zohar: "Judgment becomes medicine only when blended with compassion. Sweeten the moment before you speak.",
      restriction: "Lower volume, soften face, reduce words. Speak half as much as you want to.",
      name: { heb:"ילי", meaning:"Sweeten judgment", practice:"Place attention on throat/heart. Inhale, soften. Exhale: release the need to punish. Choose dignity over victory." }
    },
    avoidance: {
      label: "Avoidance / delay / dissociation",
      sefirah: "Yesod (foundation) destabilized",
      zohar: "Avoidance looks like peace but breeds chaos. The smallest truthful step rebuilds the foundation.",
      restriction: "One tiny action now. Do the next right step for 3 minutes.",
      name: { heb:"מהש", meaning:"Courage to face", practice:"Name the avoided thing. Commit to 3 minutes. The goal is contact, not completion." }
    },
    approval: {
      label: "Approval-seeking / people-pleasing",
      sefirah: "Tiferet distorted into performance",
      zohar: "When we trade truth for approval, we exile our light. Restore inner certainty first.",
      restriction: "Tell the truth gently once. No over-explaining.",
      name: { heb:"סאל", meaning:"Inner certainty", practice:"Ask: “What is true even if nobody claps?” Speak that, calmly, without defense." }
    },
    control: {
      label: "Control / micromanage / certainty-grab",
      sefirah: "Hod (submission) missing",
      zohar: "Control is fear wearing a crown. Trust is the real sovereignty.",
      restriction: "Let one thing be imperfect. Delegate or release one lever.",
      name: { heb:"ההע", meaning:"Trust / surrender", practice:"Choose one lever to release today. Replace control with a clear request, then let it unfold." }
    },
    shame: {
      label: "Shame / unworthiness / collapse",
      sefirah: "Malchut dimmed",
      zohar: "Shame is concealment pretending to be humility. True humility restores dignity and action.",
      restriction: "Stand tall. One action that proves worthiness is earned through doing.",
      name: { heb:"נלך", meaning:"Restore dignity", practice:"Put feet on ground. Shoulders back. Say: “I am not my story.” Then do one brave action." }
    },
    scarcity: {
      label: "Scarcity / fear / contraction",
      sefirah: "Chesed blocked",
      zohar: "Contraction convinces us the world is smaller than it is. Expand the vessel with generosity.",
      restriction: "Give first: a message, a kindness, a contribution.",
      name: { heb:"ללה", meaning:"Expansion / abundance", practice:"Do one generous act today with no credit. Expansion follows giving." }
    },
    judgment: {
      label: "Judgment / criticism / superiority",
      sefirah: "Gevurah without compassion",
      zohar: "Criticism is often self-protection. Curiosity opens a gate where judgment closes it.",
      restriction: "Ask one curious question before you conclude.",
      name: { heb:"כהת", meaning:"Transform criticism", practice:"When criticism appears, pause and ask: “What am I not seeing?” Then ask them." }
    },
    other: {
      label: "Other",
      sefirah: "Unknown",
      zohar: "Name the pattern clearly. A named pattern can be corrected.",
      restriction: "Choose one restriction move and witness the effect.",
      name: { heb:"—", meaning:"Choose a tool", practice:"Pick the closest pattern above, or write yours. Then select a restriction." }
    }
  };

  // --- Profile / astrology ---
  function sunSignFromBirthdate(iso){
    if(!iso) return "—";
    const d = new Date(iso + "T00:00:00");
    const m = d.getMonth()+1;
    const day = d.getDate();
    // Western sun signs (approx)
    if((m==3 && day>=21) || (m==4 && day<=19)) return "Aries";
    if((m==4 && day>=20) || (m==5 && day<=20)) return "Taurus";
    if((m==5 && day>=21) || (m==6 && day<=20)) return "Gemini";
    if((m==6 && day>=21) || (m==7 && day<=22)) return "Cancer";
    if((m==7 && day>=23) || (m==8 && day<=22)) return "Leo";
    if((m==8 && day>=23) || (m==9 && day<=22)) return "Virgo";
    if((m==9 && day>=23) || (m==10 && day<=22)) return "Libra";
    if((m==10 && day>=23) || (m==11 && day<=21)) return "Scorpio";
    if((m==11 && day>=22) || (m==12 && day<=21)) return "Sagittarius";
    if((m==12 && day>=22) || (m==1 && day<=19)) return "Capricorn";
    if((m==1 && day>=20) || (m==2 && day<=18)) return "Aquarius";
    return "Pisces";
  }

  const ASTRO_PROMPTS = {
    Aries: "Choose courageous restriction: act without forcing.",
    Taurus: "Stability through patience: slow the moment, deepen certainty.",
    Gemini: "Clarity through fewer words: say less, mean more.",
    Cancer: "Witness emotion without obeying it. Protect the vessel.",
    Leo: "Lead with dignity, not dominance. Warmth without performance.",
    Virgo: "Refine one thing only. Perfection is not the practice.",
    Libra: "Balance through truth: stop bargaining for approval.",
    Scorpio: "Transform intensity into devotion. Sweeten judgment.",
    Sagittarius: "Aim higher, but move smaller. One aligned step.",
    Capricorn: "Structure brings freedom. Keep a promise to yourself today.",
    Aquarius: "Detach from reactivity. Choose the future you want to live.",
    Pisces: "Compassion with boundaries. Soft heart, strong spine."
  };

  // --- Gematria (Mispar Hechrechi) ---
  const GEMATRIA = {
    "א":1,"ב":2,"ג":3,"ד":4,"ה":5,"ו":6,"ז":7,"ח":8,"ט":9,
    "י":10,"כ":20,"ך":20,"ל":30,"מ":40,"ם":40,"נ":50,"ן":50,"ס":60,"ע":70,
    "פ":80,"ף":80,"צ":90,"ץ":90,"ק":100,"ר":200,"ש":300,"ת":400
  };
  function gematriaCalc(s){
    const chars = [...(s||"")];
    let total = 0;
    const parts = [];
    for(const ch of chars){
      const v = GEMATRIA[ch];
      if(v){
        total += v;
        parts.push(`${ch}=${v}`);
      }
    }
    return { total, parts };
  }

  // --- Storage helpers ---
  function readJSON(key, fallback){
    try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }
    catch{ return fallback; }
  }
  function writeJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
  }

  // --- Fields (daily entry) ---
  const fields = [
    "reactive_where","pattern","certainty","energy","intention","trigger_forecast","micro_choice",
    "restriction_action","restriction_where","restriction_conf","replacement","mini_script",
    "evening_witness","insight","certainty_pm","gratitude","tomorrow"
  ];

  function getTodayEntry(){
    const all = readJSON(STORAGE_ENTRIES, {});
    return all[todayKey] || {};
  }
  function setTodayEntry(entry){
    const all = readJSON(STORAGE_ENTRIES, {});
    all[todayKey] = entry;
    writeJSON(STORAGE_ENTRIES, all);
  }

  // --- Profile ---
  function getProfile(){ return readJSON(STORAGE_PROFILE, {}); }
  function setProfile(p){ writeJSON(STORAGE_PROFILE, p); }

  function collectProfile(){
    const p = {
      name: ($("p_name").value || "").trim(),
      birth: $("p_birth").value || "",
      focus: $("p_focus").value || "",
      outcome: ($("p_outcome").value || "").trim(),
      intensity: $("p_intensity").value || "Simple + Powerful",
      features: $("p_features").value || "core_tools",
      _updatedAt: new Date().toISOString()
    };
    return p;
  }

  // --- UI / screens ---
  function showScreen(name){
    document.querySelectorAll(".screen").forEach(s => s.hidden = true);
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(`screen-${name}`).hidden = false;
    document.querySelector(`.tab[data-screen="${name}"]`).classList.add("active");
    // Recompute on screen switch (keeps it feeling alive)
    refreshGuidance();
  }
  document.querySelectorAll(".tab").forEach(btn => btn.addEventListener("click", () => showScreen(btn.dataset.screen)));

  // --- Toast ---
  let toastTimer = null;
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ t.style.display="none"; }, 1100);
  }

  // --- Save status ---
  function setSavedUI(isSaved, msg){
    $("saveDot").classList.toggle("ok", isSaved);
    $("saveDot").classList.toggle("bad", !isSaved && !!msg);
    $("saveStatus").textContent = msg ? msg : (isSaved ? "Saved." : "Not saved yet.");
  }

  // --- Streak ---
  function updateStreakOnSave(){
    const streak = readJSON(STORAGE_STREAK, { lastSaved:"", count:0 });
    // If saving today and yesterday was lastSaved, increment
    const last = streak.lastSaved;
    if(last === todayKey){
      // already counted
    } else {
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate()-1);
      const yKey = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,"0")}-${String(yesterday.getDate()).padStart(2,"0")}`;

      if(last === yKey) streak.count = (streak.count || 0) + 1;
      else streak.count = 1;

      streak.lastSaved = todayKey;
      writeJSON(STORAGE_STREAK, streak);
    }
    const s2 = readJSON(STORAGE_STREAK, {count:0});
    $("streakBadge").textContent = `Streak: ${s2.count || 0}`;
  }

  // --- Collect entry ---
  function collectEntry(){
    const e = {};
    fields.forEach(f => e[f] = (($(f)?.value ?? "") + "").trim());
    e._updatedAt = new Date().toISOString();
    return e;
  }

  // --- Guidance engine ---
  function currentPatternKey(){
    const k = ($("pattern").value || "").trim();
    return k || "";
  }

  function pickLessonSeed(){
    // stable-ish daily seed
    const p = getProfile();
    const seed = `${todayKey}|${p.name||"anon"}|${p.birth||"0"}`;
    let h = 0;
    for (let i=0;i<seed.length;i++) h = (h*31 + seed.charCodeAt(i)) >>> 0;
    return h;
  }

  function guidanceFor(patternKey){
    const p = PATTERNS[patternKey] || PATTERNS.other;
    return p;
  }

  function buildKaiCard(entry, profile){
    const g = guidanceFor(entry.pattern || currentPatternKey() || "other");
    const sign = sunSignFromBirthdate(profile.birth);

    const certAM = entry.certainty || "—";
    const certPM = entry.certainty_pm || "—";
    const delta = (isFinite(+certAM) && isFinite(+certPM)) ? (Number(certPM)-Number(certAM)) : null;
    const deltaTxt = (delta===null) ? "—" : (delta>0 ? `+${delta}` : `${delta}`);

    const focus = profile.focus ? ` · Focus: ${profile.focus}` : "";
    const outcome = profile.outcome ? ` · 30d: ${profile.outcome}` : "";

    return [
      `KAI · ${todayKey}`,
      `${profile.name ? "From " + profile.name : "Daily"}${focus}${outcome}`,
      ``,
      `Pattern: ${g.label}`,
      `Tool (72 Name): ${g.name.heb} · ${g.name.meaning}`,
      `Restriction: ${entry.restriction_action || g.restriction}`,
      `Witness: ${entry.evening_witness ? entry.evening_witness.slice(0,140) + (entry.evening_witness.length>140?"…":"") : "—"}`,
      `Certainty: AM ${certAM} → PM ${certPM} (Δ ${deltaTxt})`,
      `Astro: ${sign} · ${ASTRO_PROMPTS[sign] || "—"}`
    ].join("\n");
  }

  function buildTeacherPacket(entry, profile){
    const g = guidanceFor(entry.pattern || currentPatternKey() || "other");
    const sign = sunSignFromBirthdate(profile.birth);

    return [
      `KAI · ${todayKey}`,
      `Name: ${profile.name || "—"} · Focus: ${profile.focus || "—"} · Sun: ${sign}`,
      ``,
      `Morning`,
      `• Reactive: ${entry.reactive_where || "—"}`,
      `• Pattern: ${g.label}`,
      `• Certainty: ${entry.certainty || "—"} / 10`,
      `• Energy: ${entry.energy || "—"} / 10`,
      `• Intention: ${entry.intention || "—"}`,
      `• Trigger forecast: ${entry.trigger_forecast || "—"}`,
      ``,
      `Tooling`,
      `• Sefirah lens: ${g.sefirah}`,
      `• 72 Name: ${g.name.heb} (${g.name.meaning})`,
      `• Practice: ${g.name.practice}`,
      `• Zohar lens: ${g.zohar}`,
      ``,
      `Restriction`,
      `• Chosen action: ${entry.restriction_action || "—"}`,
      `• Where: ${entry.restriction_where || "—"}`,
      `• Confidence: ${entry.restriction_conf || "—"} / 10`,
      `• Replacement: ${entry.replacement || "—"}`,
      `• Mini script: ${entry.mini_script || "—"}`,
      ``,
      `Evening`,
      `• Witness: ${entry.evening_witness || "—"}`,
      `• Insight: ${entry.insight || "—"}`,
      `• Certainty now: ${entry.certainty_pm || "—"} / 10`,
      `• Gratitude: ${entry.gratitude || "—"}`,
      `• Tomorrow: ${entry.tomorrow || "—"}`
    ].join("\n");
  }

  function refreshGuidance(){
    // Profile UI
    const profile = collectProfile();
    const savedProfile = getProfile();
    // show saved name if no edits yet
    const effective = (profile.name || profile.birth || profile.focus || profile.outcome) ? profile : savedProfile;

    const sign = sunSignFromBirthdate(effective.birth);
    $("sunSign").textContent = sign;
    $("a_sign").textContent = sign;
    $("a_prompt").textContent = ASTRO_PROMPTS[sign] || "—";
    $("a_teaching").textContent = sign==="—"
      ? "Set your birthdate in Start to activate this layer."
      : `Astrology layer is used as a gentle personalization prompt. Practice is still: pattern → restriction → witness. Today: ${ASTRO_PROMPTS[sign]}`;

    // KAI mode
    const intensity = effective.intensity || "Simple + Powerful";
    $("kaiMode").textContent = intensity;
    $("profileBadge").textContent = `Profile: ${effective.name || "—"}`;

    // Pattern guidance
    const pKey = currentPatternKey() || "other";
    const g = guidanceFor(pKey);

    $("dominantPattern").textContent = g.label;
    $("t_pattern").textContent = g.label;

    // 72 Name
    $("nameHeb").textContent = g.name.heb;
    $("nameMeaning").textContent = g.name.meaning;
    $("nameHow").textContent = `Why this: pattern → ${g.sefirah} → tool for restriction.`;
    $("t_nameHeb").textContent = g.name.heb;
    $("t_nameMeaning").textContent = g.name.meaning;
    $("t_namePractice").textContent = g.name.practice;
    $("t_nameNote").textContent = (pKey && pKey!=="") ? "Use this during the moment of trigger." : "Select a pattern in Morning.";

    $("m_nameBrief").textContent = `${g.name.heb} · ${g.name.meaning}`;
    $("m_namePractice").textContent = g.name.practice;

    // Zohar lens (short teaching bite, no long quotes)
    $("zoharLens").textContent = `Sefirah lens: ${g.sefirah}\n\n${g.zohar}\n\n(Teacher can later attach an exact Zohar reference + passage.)`;
    $("m_zoharTag").textContent = g.sefirah;
    $("m_zoharText").textContent = `${g.zohar}\n\nSuggested reflection: “What would restriction look like in this moment?”`;

    // Suggested restriction
    $("suggestedRestriction").textContent = g.restriction;
    $("r_suggested").textContent = g.restriction;

    // Personal prompt
    const focus = effective.focus ? `Focus: ${effective.focus}. ` : "";
    $("personalPrompt").textContent = `${focus}${g.restriction}`;

    // Build share outputs from current entry state
    const entry = collectEntry();
    const card = buildKaiCard(entry, effective);
    const packet = buildTeacherPacket(entry, effective);
    $("kaiCard").textContent = card;
    $("cardPreview").textContent = card;
    $("packetPreview").textContent = packet;

    // History intelligence refresh
    renderHistoryIntelligence();

    // Features gating (simple)
    const feat = effective.features || "core_tools";
    const toolsTab = document.querySelector('.tab[data-screen="tools"]');
    const learnTab = document.querySelector('.tab[data-screen="learn"]');
    toolsTab.style.display = (feat==="core") ? "none" : "inline-block";
    learnTab.style.display = (feat==="core_tools_learn") ? "inline-block" : "none";
  }

  // --- Load today into fields ---
  function loadToday(){
    const entry = getTodayEntry();
    fields.forEach(f => { if($(f)) $(f).value = entry[f] ?? ""; });

    // load profile
    const p = getProfile();
    $("p_name").value = p.name ?? "";
    $("p_birth").value = p.birth ?? "";
    $("p_focus").value = p.focus ?? "";
    $("p_outcome").value = p.outcome ?? "";
    $("p_intensity").value = p.intensity ?? "Simple + Powerful";
    $("p_features").value = p.features ?? "core_tools";

    // badges
    const streak = readJSON(STORAGE_STREAK, {count:0});
    $("streakBadge").textContent = `Streak: ${streak.count || 0}`;

    setSavedUI(!!Object.keys(entry).length, !!Object.keys(entry).length ? "Loaded saved entry." : "Not saved yet.");
    refreshGuidance();
    renderSavedDays();
    updateGematria();
    refreshLesson(true);
  }

  // --- Save ---
  function saveAll(){
    const entry = collectEntry();
    setTodayEntry(entry);

    const p = collectProfile();
    setProfile(p);

    setSavedUI(true, "Saved.");
    toast("Saved.");
    updateStreakOnSave();

    // visual glow
    $("saveBtn").classList.add("glow");
    setTimeout(()=>$("saveBtn").classList.remove("glow"), 900);

    refreshGuidance();
    renderSavedDays();
  }

  // --- Reset day (does not delete history, only clears current inputs) ---
  function resetDay(){
    fields.forEach(f => { if($(f)) $(f).value = ""; });
    setSavedUI(false, "Cleared inputs. (Tap Save to overwrite today.)");
    refreshGuidance();
  }

  // --- Copy / Export / Share ---
  async function copyText(){
    const profile = getProfile();
    const entry = collectEntry();
    const text = buildKaiCard(entry, profile) + "\n\n" + buildTeacherPacket(entry, profile);
    try{
      await navigator.clipboard.writeText(text);
      toast("Copied.");
      setSavedUI(true, "Copied to clipboard.");
    } catch {
      window.prompt("Copy this:", text);
    }
  }

  function exportText(){
    const profile = getProfile();
    const entry = collectEntry();
    const text = buildKaiCard(entry, profile) + "\n\n" + buildTeacherPacket(entry, profile);

    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `KAI_${todayKey}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Exported.");
    setSavedUI(true, "Exported .txt");
  }

  async function shareText(){
    const profile = getProfile();
    const entry = collectEntry();
    const card = buildKaiCard(entry, profile);
    const packet = buildTeacherPacket(entry, profile);
    const text = card + "\n\n" + packet;

    if(navigator.share){
      try{
        await navigator.share({ title:"KAI", text });
        toast("Shared.");
      } catch {
        // user canceled
      }
    } else {
      // fallback to copy
      await copyText();
      toast("Share not supported; copied instead.");
    }
  }

  // --- History intelligence ---
  function renderHistoryIntelligence(){
    const all = readJSON(STORAGE_ENTRIES, {});
    const dates = Object.keys(all).sort().reverse();
    const lookback = dates.slice(0, 14);

    const counts = {};
    let certDeltaSum = 0, certDeltaN = 0;

    for(const d of lookback){
      const e = all[d] || {};
      const pk = (e.pattern || "").trim();
      if(pk){
        counts[pk] = (counts[pk]||0) + 1;
      }
      // certainty delta
      const am = +e.certainty;
      const pm = +e.certainty_pm;
      if(isFinite(am) && isFinite(pm)){
        certDeltaSum += (pm-am);
        certDeltaN += 1;
      }
    }

    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const top = sorted[0]?.[0] || "";
    const topLabel = top ? (PATTERNS[top]?.label || top) : "—";
    $("h_topPattern").textContent = topLabel;

    const countsLines = sorted.length
      ? sorted.map(([k,v]) => `${PATTERNS[k]?.label || k}: ${v}`).join("\n")
      : "No pattern data yet. Save a few days.";

    $("h_counts").textContent = countsLines;
    $("h_countsTag").textContent = sorted.length ? `${sorted.length} patterns tracked` : "—";

    const avgDelta = certDeltaN ? (certDeltaSum / certDeltaN) : null;
    const avgTxt = (avgDelta===null) ? "—" : (avgDelta>0 ? `+${avgDelta.toFixed(1)}` : `${avgDelta.toFixed(1)}`);

    let insight = "Save a few days and KAI will surface trend insights here.\n\n";
    if(sorted.length){
      insight += `• Top pattern: ${topLabel}\n`;
      insight += `• Average certainty change (AM→PM): ${avgTxt}\n`;
      if(top){
        const g = guidanceFor(top);
        insight += `\nSuggestion:\n${g.restriction}\n\nTool:\n${g.name.heb} · ${g.name.meaning}\n${g.name.practice}`;
      }
    }
    $("h_insights").textContent = insight;
  }

  function renderSavedDays(){
    const all = readJSON(STORAGE_ENTRIES, {});
    const dates = Object.keys(all).sort().reverse();
    const list = $("historyList");
    list.innerHTML = "";

    if(dates.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No saved days yet. Tap Save.";
      list.appendChild(empty);
      return;
    }

    dates.forEach(date => {
      const e = all[date] || {};
      const g = guidanceFor((e.pattern||"other").trim() || "other");
      const item = document.createElement("div");
      item.className = "hitem";

      const left = document.createElement("div");
      const am = e.certainty || "—";
      const pm = e.certainty_pm || "—";
      left.innerHTML = `
        <div class="hdate">${date}</div>
        <div class="hmeta">Pattern: ${(g.label || "—")} · Tool: ${g.name.heb || "—"} · Cert: ${am}→${pm}</div>
      `;

      const btn = document.createElement("button");
      btn.className = "hbtn";
      btn.textContent = "Load";
      btn.onclick = () => loadDate(date);

      item.appendChild(left);
      item.appendChild(btn);
      list.appendChild(item);
    });
  }

  function loadDate(date){
    const all = readJSON(STORAGE_ENTRIES, {});
    const e = all[date] || {};
    fields.forEach(f => { if($(f)) $(f).value = e[f] ?? ""; });
    refreshGuidance();
    showScreen("evening");
    toast(`Loaded ${date}`);
    setSavedUI(true, `Loaded ${date} (review).`);
  }

  // --- Gematria UI ---
  function updateGematria(){
    const s = ($("g_input").value || "").trim();
    const { total, parts } = gematriaCalc(s);
    $("g_total").value = s ? total : "";
    $("g_breakdown").textContent = s
      ? `Total: ${total}\nBreakdown: ${parts.join(" + ")}`
      : "Type Hebrew letters above to see breakdown.";
  }

  // --- Learn / micro-lessons ---
  const LESSONS = [
    { title:"Restriction is the engine", body:"Restriction is not suppression. It is choosing response over reflex. One small restriction can unlock a new timeline." },
    { title:"Pattern naming creates power", body:"A named pattern becomes workable. Without naming, you will repeat it. With naming, you can choose." },
    { title:"Certainty is a measurable spiritual metric", body:"Certainty is not mood. It is inner alignment. Track it like a vital sign, not like a compliment." },
    { title:"72 Names as tools, not talismans", body:"A Name is not a charm. It is a focus that helps you access a correction in the moment of trigger." },
    { title:"Sweetening Gevurah", body:"Discipline becomes holiness when blended with compassion. Sharpness without warmth is judgment, not strength." },
    { title:"Witnessing creates future memory", body:"Evening witness is the mind’s edit. You teach your nervous system what you want to become real." }
  ];

  let lessonIndex = 0;
  function refreshLesson(useDaily){
    if(useDaily){
      const seed = pickLessonSeed();
      lessonIndex = seed % LESSONS.length;
    }
    const L = LESSONS[lessonIndex];
    $("l_title").textContent = L.title;
    $("l_body").textContent = L.body + "\n\nPractice: Identify today’s pattern, choose one restriction, and witness the shift.";
  }

  $("lessonNext").addEventListener("click", () => {
    lessonIndex = (lessonIndex + 1) % LESSONS.length;
    refreshLesson(false);
  });

  // --- Wire events ---
  fields.forEach(f => {
    const el = $(f);
    if(!el) return;
    el.addEventListener("input", () => {
      setSavedUI(false, "Unsaved changes.");
      refreshGuidance();
    });
  });

  ["p_name","p_birth","p_focus","p_outcome","p_intensity","p_features"].forEach(id => {
    $(id).addEventListener("input", () => {
      setSavedUI(false, "Profile changed (unsaved).");
      refreshGuidance();
    });
  });

  $("g_input").addEventListener("input", updateGematria);

  $("saveBtn").addEventListener("click", saveAll);
  $("resetBtn").addEventListener("click", resetDay);
  $("copyBtn").addEventListener("click", copyText);
  $("exportBtn").addEventListener("click", exportText);
  $("shareBtn").addEventListener("click", shareText);

  // Initial load
  loadToday();
</script>
</body>
</html>
