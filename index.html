<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KAI – Prototype v2</title>
<style>
  :root{
    --bg:#0e0e0e; --panel:#151515; --btn:#1c1c1c; --muted:#b9b9b9; --gold:#ffd54a;
    --line:#252525; --danger:#ff5b5b;
  }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff;margin:0;padding:16px;}
  h1{font-size:30px;margin:8px 0 6px;text-align:center;}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 14px;}
  .tab{background:#202020;color:#fff;border:none;border-radius:12px;padding:10px 12px;font-size:14px;}
  .tab.active{background:var(--gold);color:#000;}
  .wrap{max-width:860px;margin:0 auto;}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:10px 0 14px;}
  .card{background:var(--panel);border-radius:14px;padding:14px;width:min(410px,94vw);text-align:left;border:1px solid var(--line);}
  .label{font-size:13px;color:var(--muted);margin-bottom:6px;}
  .big{font-size:42px;color:var(--gold);line-height:1.0;}
  .sub{font-size:13px;color:var(--muted);margin-top:6px;line-height:1.35;}
  .btn{width:100%;padding:18px;margin:8px 0;font-size:20px;border-radius:14px;border:none;background:var(--btn);color:#fff;}
  .btn:active{background:var(--gold);color:#000;}
  .btn:disabled{background:#2a2a2a;color:#666;}
  .btn.active{background:var(--gold);color:#000;}
  .overlay{position:fixed;top:36%;left:50%;transform:translate(-50%,-50%);font-size:22px;background:rgba(0,0,0,0.92);
    padding:16px 18px;border-radius:14px;color:var(--gold);display:none;max-width:88vw;text-align:center;border:1px solid #333;}
  .sinai{margin:10px 0 0;font-size:18px;color:var(--gold);text-align:center;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0;}
  .smallbtn{padding:11px 12px;font-size:14px;border-radius:12px;border:none;background:#232323;color:#fff;}
  .smallbtn:active{background:#333;}
  .danger{background:#2b1717;color:#fff;border:1px solid #4b1e1e;}
  .grid{display:grid;grid-template-columns:1fr;gap:10px;}
  @media (min-width:860px){ .grid{grid-template-columns:1fr 1fr;} }
  input, textarea, select{
    width:100%; padding:12px; border-radius:12px; border:1px solid #2f2f2f; background:#101010; color:#fff; font-size:16px;
    box-sizing:border-box;
  }
  textarea{min-height:110px; resize:vertical;}
  .mini{font-size:12px;color:var(--muted);}
  .list{margin-top:10px;border-top:1px solid var(--line);padding-top:10px;}
  .item{padding:10px;border:1px solid var(--line);border-radius:12px;margin:8px 0;background:#101010;}
  .item .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
  .pill{font-size:12px;color:#000;background:var(--gold);padding:4px 8px;border-radius:999px;white-space:nowrap;}
  .hr{height:1px;background:var(--line);margin:12px 0;}
  .right{float:right;}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
  .muted{color:var(--muted);}
  .two{display:grid;grid-template-columns:1fr;gap:10px;}
  @media (min-width:740px){ .two{grid-template-columns:1fr 1fr;} }
  .nowrap{white-space:nowrap;}
</style>
</head>

<body>
<div class="wrap">
  <h1>KAI</h1>

  <div class="tabs">
    <button class="tab active" data-view="practice" onclick="setView('practice')">Practice</button>
    <button class="tab" data-view="names" onclick="setView('names')">72 Names</button>
    <button class="tab" data-view="gematria" onclick="setView('gematria')">Gematria</button>
    <button class="tab" data-view="zohar" onclick="setView('zohar')">Zohar Library</button>
    <button class="tab" data-view="history" onclick="setView('history')">History</button>
    <button class="tab" data-view="settings" onclick="setView('settings')">Settings</button>
  </div>

  <div id="view_practice">
    <div class="row">
      <div class="card">
        <div class="label">Pillars (CONNECT taps)</div>
        <div class="big" id="pillarsStat">0 / 100</div>
        <div class="sub">Counts every CONNECT. Frequency builds the vessel.</div>
      </div>
      <div class="card">
        <div class="label">Cycles (full sequence completions)</div>
        <div class="big" id="cyclesStat">0 / 10</div>
        <div class="sub">Counts when you finish SEAL after the sequence.</div>
      </div>
    </div>

    <div class="card" style="width:min(860px,94vw);margin:0 auto;">
      <div class="label">Sequence</div>
      <button class="btn" id="connect" onclick="pressConnect()">CONNECT</button>
      <button class="btn" id="align" onclick="pressStep(2)" disabled>ALIGN</button>
      <button class="btn" id="restrict" onclick="pressStep(3)" disabled>RESTRICT</button>
      <button class="btn" id="elevate" onclick="pressStep(4)" disabled>ELEVATE</button>
      <button class="btn" id="seal" onclick="pressStep(5)" disabled>SEAL</button>

      <div id="sinaiMessage"></div>

      <div class="controls">
        <button class="smallbtn" onclick="undoConnect()">Undo CONNECT</button>
        <button class="smallbtn" onclick="resetSequence()">Reset Sequence</button>
      </div>

      <div class="mini" id="meta"></div>
    </div>

    <div class="overlay" id="overlay"></div>
  </div>

  <div id="view_names" style="display:none;">
    <div class="grid">
      <div class="card">
        <div class="label">Today’s 72 Name</div>
        <div class="big mono" id="todayName">---</div>
        <div class="sub" id="todayNameMeta"></div>
        <div class="controls">
          <button class="smallbtn" onclick="prevName()">Prev</button>
          <button class="smallbtn" onclick="nextName()">Next</button>
          <button class="smallbtn" onclick="addNameToHistory()">Log Today’s Name</button>
        </div>
      </div>

      <div class="card">
        <div class="label">Find a Name</div>
        <div class="two">
          <div>
            <label class="mini">By number (1–72)</label>
            <input id="nameNumber" inputmode="numeric" placeholder="e.g., 12" />
          </div>
          <div>
            <label class="mini">Search letters</label>
            <input id="nameSearch" placeholder="e.g., וול" />
          </div>
        </div>
        <div class="controls">
          <button class="smallbtn" onclick="goToNameNumber()">Go</button>
          <button class="smallbtn" onclick="searchName()">Search</button>
          <button class="smallbtn" onclick="randomName()">Random</button>
        </div>
        <div class="list" id="nameResults"></div>
      </div>
    </div>

    <div class="card" style="width:min(860px,94vw);margin:12px auto 0;">
      <div class="label">Browse All 72</div>
      <div class="two">
        <div>
          <label class="mini">Jump to</label>
          <select id="nameJump" onchange="jumpName()"></select>
        </div>
        <div>
          <label class="mini">Display format</label>
          <select id="nameFormat" onchange="renderTodayName()">
            <option value="triplet">Triplet only</option>
            <option value="numbered">Number + triplet</option>
          </select>
        </div>
      </div>
      <div class="list" id="allNames"></div>
    </div>
  </div>

  <div id="view_gematria" style="display:none;">
    <div class="grid">
      <div class="card">
        <div class="label">Gematria Calculator</div>
        <input id="gemInput" placeholder="Enter Hebrew word or phrase (e.g., שלום)" />
        <div class="controls">
          <button class="smallbtn" onclick="calcGematria()">Calculate</button>
          <button class="smallbtn" onclick="saveGematria()">Save</button>
          <button class="smallbtn" onclick="clearGematria()">Clear</button>
        </div>
        <div class="hr"></div>
        <div class="label">Result</div>
        <div class="big" id="gemValue">—</div>
        <div class="sub" id="gemBreakdown"></div>
        <div class="hr"></div>
        <div class="label">Practice Prompt (Centre-aligned)</div>
        <div class="sub" id="gemPrompt">
          Use this number as a trigger for consciousness: Connect, restrict reactivity, and reveal Light through a concrete act of sharing.
        </div>
      </div>

      <div class="card">
        <div class="label">Saved Gematria</div>
        <input id="gemSavedSearch" placeholder="Search saved…" oninput="renderSavedGematria()" />
        <div class="list" id="gemSavedList"></div>
      </div>
    </div>
  </div>

  <div id="view_zohar" style="display:none;">
    <div class="grid">
      <div class="card">
        <div class="label">Add Zohar Passage (Your curated library)</div>
        <input id="zTitle" placeholder="Title (e.g., Terumah, Section 39)" />
        <div class="two">
          <div>
            <label class="mini">Parsha / Source</label>
            <input id="zSource" placeholder="e.g., Zohar Terumah" />
          </div>
          <div>
            <label class="mini">Tags (comma-separated)</label>
            <input id="zTags" placeholder="e.g., restriction, certainty, mishkan" />
          </div>
        </div>
        <textarea id="zText" placeholder="Paste a short excerpt or your own paraphrase/notes here."></textarea>
        <div class="controls">
          <button class="smallbtn" onclick="saveZohar()">Save</button>
          <button class="smallbtn" onclick="clearZoharForm()">Clear</button>
        </div>
        <div class="mini muted">
          Note: This library is designed for your curated passages and notes. Avoid pasting large copyrighted text.
        </div>
      </div>

      <div class="card">
        <div class="label">Zohar Library</div>
        <input id="zSearch" placeholder="Search by title, source, tags, text…" oninput="renderZohar()" />
        <div class="controls">
          <button class="smallbtn" onclick="seedZoharTemplates()">Add Templates</button>
          <button class="smallbtn" onclick="exportZohar()">Export JSON</button>
          <button class="smallbtn danger" onclick="clearZoharAll()">Clear Library</button>
        </div>
        <div class="list" id="zList"></div>
      </div>
    </div>
  </div>

  <div id="view_history" style="display:none;">
    <div class="card" style="width:min(860px,94vw);margin:0 auto;">
      <div class="label">Today’s History</div>
      <div class="controls">
        <button class="smallbtn" onclick="exportHistory()">Export JSON</button>
        <button class="smallbtn danger" onclick="clearHistory()">Clear History</button>
      </div>
      <div class="list" id="historyList"></div>
    </div>
  </div>

  <div id="view_settings" style="display:none;">
    <div class="card" style="width:min(860px,94vw);margin:0 auto;">
      <div class="label">Daily Goals</div>
      <div class="two">
        <div>
          <label class="mini">Pillars goal (default 100)</label>
          <input id="goalPillars" inputmode="numeric" />
        </div>
        <div>
          <label class="mini">Cycles goal</label>
          <input id="goalCycles" inputmode="numeric" />
        </div>
      </div>
      <div class="controls">
        <button class="smallbtn" onclick="saveGoals()">Save Goals</button>
        <button class="smallbtn" onclick="resetToday()">Reset Today (counts)</button>
      </div>

      <div class="hr"></div>

      <div class="label">Data</div>
      <div class="controls">
        <button class="smallbtn" onclick="exportAll()">Export All (JSON)</button>
        <button class="smallbtn danger" onclick="clearAllData()">Clear ALL Data</button>
      </div>

      <div class="mini muted" id="storageNote"></div>
    </div>
  </div>

</div>

<script>
/* -------------------- Date + storage keys -------------------- */
const today = new Date().toISOString().split("T")[0];
const baseKey = "kai_" + today;

const KEY = {
  pillars: baseKey + "_pillars",
  cycles:  baseKey + "_cycles",
  history: baseKey + "_history",
  goals:   "kai_goals_v1",
  zohar:   "kai_zohar_v1",
  gem:     "kai_gem_v1",
  namesLog: baseKey + "_nameslog"
};

const DEFAULT_GOALS = { pillars: 100, cycles: 10 };

let goals = safeParse(localStorage.getItem(KEY.goals), DEFAULT_GOALS);
if (!goals || typeof goals !== "object") goals = DEFAULT_GOALS;

let pillars = parseInt(localStorage.getItem(KEY.pillars) || "0", 10);
let cycles  = parseInt(localStorage.getItem(KEY.cycles)  || "0", 10);

let history = safeParse(localStorage.getItem(KEY.history), []);
let zoharLib = safeParse(localStorage.getItem(KEY.zohar), []);
let gemSaved = safeParse(localStorage.getItem(KEY.gem), []);
let namesLog = safeParse(localStorage.getItem(KEY.namesLog), []);

function safeParse(str, fallback){
  try { return str ? JSON.parse(str) : fallback; }
  catch(e){ return fallback; }
}

function saveAll(){
  localStorage.setItem(KEY.goals, JSON.stringify(goals));
  localStorage.setItem(KEY.pillars, String(pillars));
  localStorage.setItem(KEY.cycles, String(cycles));
  localStorage.setItem(KEY.history, JSON.stringify(history));
  localStorage.setItem(KEY.zohar, JSON.stringify(zoharLib));
  localStorage.setItem(KEY.gem, JSON.stringify(gemSaved));
  localStorage.setItem(KEY.namesLog, JSON.stringify(namesLog));
}

function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

function logEvent(type, detail){
  history.unshift({ t: nowTime(), type, detail });
  if (history.length > 400) history.pop();
  saveAll();
}

/* -------------------- Tabs -------------------- */
function setView(name){
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab[data-view="${name}"]`).classList.add("active");

  ["practice","names","gematria","zohar","history","settings"].forEach(v=>{
    document.getElementById("view_"+v).style.display = (v===name) ? "" : "none";
  });

  if (name === "history") renderHistory();
  if (name === "names") { renderTodayName(); renderAllNames(); }
  if (name === "gematria") renderSavedGematria();
  if (name === "zohar") renderZohar();
  if (name === "settings") loadSettingsForm();
}

/* -------------------- Overlay -------------------- */
function showOverlay(text){
  const overlay = document.getElementById("overlay");
  overlay.innerText = text;
  overlay.style.display = "block";
  setTimeout(()=> overlay.style.display="none", 1200);
}

/* -------------------- Practice engine -------------------- */
let currentStep = 0; // 0 none, 1 connect, 2 align, 3 restrict, 4 elevate, 5 seal
const LINES = {
  1: "The Light of the Creator is here.",
  2: "I align myself with the Light.",
  3: "I restrict my reactive desire.",
  4: "I elevate this moment.",
  5: "Thank you for this Light."
};

function updateStats(){
  document.getElementById("pillarsStat").innerText = `${pillars} / ${goals.pillars}`;
  document.getElementById("cyclesStat").innerText  = `${cycles} / ${goals.cycles}`;
  document.getElementById("meta").innerText = `Today: ${today} | Stored locally (this device)`;
  document.getElementById("storageNote").innerText =
    "Everything is saved on this device via localStorage. Export JSON if you want portability.";

  const sinai = (pillars >= goals.pillars);
  document.getElementById("sinaiMessage").innerHTML = sinai
    ? `<div class="sinai">Sinai Mode Activated. Clarity Stabilizing.</div>`
    : "";
}

function setButtonStates(){
  const ids = ["connect","align","restrict","elevate","seal"];
  ids.forEach(id=>{
    const b = document.getElementById(id);
    b.disabled = true;
    b.classList.remove("active");
  });

  // CONNECT always enabled
  document.getElementById("connect").disabled = false;

  // enable next step if in sequence
  if (currentStep >= 1 && currentStep < 5){
    const nextId = ids[currentStep]; // step 1 -> align, step 2 -> restrict, etc
    document.getElementById(nextId).disabled = false;
  }

  // highlight progressed steps
  if (currentStep >= 1) document.getElementById("connect").classList.add("active");
  if (currentStep >= 2) document.getElementById("align").classList.add("active");
  if (currentStep >= 3) document.getElementById("restrict").classList.add("active");
  if (currentStep >= 4) document.getElementById("elevate").classList.add("active");
  if (currentStep >= 5) document.getElementById("seal").classList.add("active");
}

function pressConnect(){
  // B: each CONNECT counts as a pillar
  if (pillars < goals.pillars) pillars++;
  showOverlay(LINES[1]);
  currentStep = 1;

  logEvent("CONNECT", "pillar +1");
  saveAll();
  updateStats();
  setButtonStates();
}

function pressStep(stepNum){
  if (stepNum !== currentStep + 1) return;

  currentStep = stepNum;
  showOverlay(LINES[stepNum]);

  const label = ["","CONNECT","ALIGN","RESTRICT","ELEVATE","SEAL"][stepNum];
  logEvent(label, "step");

  if (stepNum === 5){
    // A: full cycle counts when SEAL completed
    cycles++;
    logEvent("CYCLE", "completed +1");
    saveAll();
    updateStats();
    setTimeout(()=>{ currentStep = 0; setButtonStates(); }, 500);
    return;
  }

  saveAll();
  updateStats();
  setButtonStates();
}

function undoConnect(){
  if (pillars > 0) pillars--;
  logEvent("UNDO", "pillar -1");
  saveAll();
  updateStats();
}

function resetSequence(){
  currentStep = 0;
  logEvent("RESET", "sequence reset");
  saveAll();
  setButtonStates();
}

function resetToday(){
  pillars = 0; cycles = 0; currentStep = 0;
  history = [];
  namesLog = [];
  localStorage.removeItem(KEY.pillars);
  localStorage.removeItem(KEY.cycles);
  localStorage.removeItem(KEY.history);
  localStorage.removeItem(KEY.namesLog);
  saveAll();
  updateStats();
  setButtonStates();
  renderHistory();
}

function exportHistory(){
  const payload = { date: today, goals, pillars, cycles, history };
  downloadJSON(payload, `kai_history_${today}.json`);
}

function clearHistory(){
  history = [];
  logEvent("CLEAR", "history cleared");
  saveAll();
  renderHistory();
}

function renderHistory(){
  const el = document.getElementById("historyList");
  if (!history.length){
    el.innerHTML = `<div class="mini muted">No events yet today.</div>`;
    return;
  }
  el.innerHTML = history.map(h => `
    <div class="item">
      <div class="top">
        <div><span class="mono">${h.t}</span> <span class="muted">•</span> <strong>${escapeHtml(h.type)}</strong></div>
        <span class="pill">${escapeHtml(h.detail || "")}</span>
      </div>
    </div>
  `).join("");
}

/* -------------------- 72 Names -------------------- */
/* Full 72 triplets (standard list). */
const NAMES72 = [
  "והו","ילי","סיט","עלם","מהש","ללה","אכא","כהת","הזי","אלד","לאו","ההה",
  "יזל","מבה","הרי","הקם","לאו","כלי","לוו","פהל","נלכ","ייי","מלה","חהו",
  "נתה","האא","ירת","שאה","ריי","אומ","לכב","ושר","יחו","להח","כוק","מנד",
  "אני","חעם","רהע","ייז","ההו","מיכ","וול","ילה","סאל","ערי","עשא","מיה",
  "והו","דני","החש","עמם","ננא","נית","מבה","פוי","נמם","ייל","הרח","מצר",
  "ומב","יהה","ענו","מחי","דמב","מנק","איע","חבו","ראה","יבמ","היי","מום"
];

let currentNameIndex = dailyNameIndex();

function dailyNameIndex(){
  // deterministic "daily" pick: date number mod 72
  const d = new Date();
  const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
  const n = (y*10000 + m*100 + day) % 72;
  return n; // 0..71
}

function renderTodayName(){
  const triplet = NAMES72[currentNameIndex];
  const fmt = document.getElementById("nameFormat")?.value || "triplet";
  const display = (fmt === "numbered") ? `${currentNameIndex+1}. ${triplet}` : triplet;

  document.getElementById("todayName").innerText = display;
  document.getElementById("todayNameMeta").innerHTML =
    `Name <span class="mono">${currentNameIndex+1}</span> of 72. Use it as a consciousness cue: connect, restrict reactivity, reveal Light through sharing.`;
}

function prevName(){ currentNameIndex = (currentNameIndex+71)%72; renderTodayName(); }
function nextName(){ currentNameIndex = (currentNameIndex+1)%72; renderTodayName(); }

function randomName(){
  currentNameIndex = Math.floor(Math.random()*72);
  renderTodayName();
  document.getElementById("nameResults").innerHTML = `<div class="mini muted">Randomly selected.</div>`;
}

function goToNameNumber(){
  const n = parseInt((document.getElementById("nameNumber").value || "").trim(), 10);
  if (!Number.isFinite(n) || n < 1 || n > 72) return;
  currentNameIndex = n-1;
  renderTodayName();
  document.getElementById("nameResults").innerHTML = `<div class="mini muted">Jumped to #${n}.</div>`;
}

function searchName(){
  const q = (document.getElementById("nameSearch").value || "").trim();
  const el = document.getElementById("nameResults");
  if (!q){ el.innerHTML = `<div class="mini muted">Enter letters to search.</div>`; return; }
  const hits = [];
  for (let i=0;i<72;i++){
    if (NAMES72[i].includes(q)) hits.push(i);
  }
  if (!hits.length){ el.innerHTML = `<div class="mini muted">No matches.</div>`; return; }
  el.innerHTML = hits.map(i=>`
    <div class="item">
      <div class="top">
        <div><strong>#${i+1}</strong> <span class="mono">${NAMES72[i]}</span></div>
        <button class="smallbtn" onclick="selectName(${i})">Select</button>
      </div>
    </div>
  `).join("");
}

function selectName(i){
  currentNameIndex = i;
  renderTodayName();
  document.getElementById("nameResults").innerHTML = `<div class="mini muted">Selected #${i+1}.</div>`;
}

function addNameToHistory(){
  const triplet = NAMES72[currentNameIndex];
  namesLog.unshift({ t: nowTime(), idx: currentNameIndex+1, triplet });
  if (namesLog.length > 120) namesLog.pop();
  logEvent("72NAME", `#${currentNameIndex+1} ${triplet}`);
  saveAll();
  showOverlay(`Logged: ${currentNameIndex+1}. ${triplet}`);
}

function renderAllNames(){
  const jump = document.getElementById("nameJump");
  if (jump && !jump.options.length){
    for (let i=0;i<72;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `${i+1}. ${NAMES72[i]}`;
      jump.appendChild(opt);
    }
  }
  const el = document.getElementById("allNames");
  el.innerHTML = NAMES72.map((t,i)=>`
    <div class="item">
      <div class="top">
        <div><strong>#${i+1}</strong> <span class="mono">${t}</span></div>
        <button class="smallbtn" onclick="selectName(${i})">Set</button>
      </div>
    </div>
  `).join("");
}

function jumpName(){
  const i = parseInt(document.getElementById("nameJump").value,10);
  if (!Number.isFinite(i)) return;
  currentNameIndex = i;
  renderTodayName();
}

/* -------------------- Gematria -------------------- */
// Standard (mispar hechrechi) values. Final letters map to same values.
const GEM = {
  "א":1,"ב":2,"ג":3,"ד":4,"ה":5,"ו":6,"ז":7,"ח":8,"ט":9,
  "י":10,"כ":20,"ך":20,"ל":30,"מ":40,"ם":40,"נ":50,"ן":50,"ס":60,"ע":70,
  "פ":80,"ף":80,"צ":90,"ץ":90,"ק":100,"ר":200,"ש":300,"ת":400
};

function calcGematria(){
  const s = (document.getElementById("gemInput").value || "").trim();
  const { total, breakdown } = gematriaOf(s);
  document.getElementById("gemValue").innerText = (s ? String(total) : "—");
  document.getElementById("gemBreakdown").innerHTML = s
    ? `<span class="mono">${escapeHtml(breakdown)}</span>`
    : `<span class="muted">Enter Hebrew to calculate.</span>`;
}

function gematriaOf(s){
  let total = 0;
  const parts = [];
  for (const ch of s){
    if (GEM[ch]){
      total += GEM[ch];
      parts.push(`${ch}(${GEM[ch]})`);
    }
  }
  return { total, breakdown: parts.join(" + ") + (parts.length ? ` = ${total}` : "") };
}

function saveGematria(){
  const s = (document.getElementById("gemInput").value || "").trim();
  if (!s) return;
  const { total } = gematriaOf(s);
  gemSaved.unshift({ t: nowTime(), text: s, value: total });
  if (gemSaved.length > 200) gemSaved.pop();
  logEvent("GEMATRIA", `${s} = ${total}`);
  saveAll();
  renderSavedGematria();
  showOverlay(`Saved: ${total}`);
}

function clearGematria(){
  document.getElementById("gemInput").value = "";
  document.getElementById("gemValue").innerText = "—";
  document.getElementById("gemBreakdown").innerText = "";
}

function renderSavedGematria(){
  const q = (document.getElementById("gemSavedSearch")?.value || "").trim();
  const el = document.getElementById("gemSavedList");
  const rows = gemSaved.filter(r=>{
    if (!q) return true;
    return (r.text || "").includes(q) || String(r.value).includes(q);
  });
  if (!rows.length){
    el.innerHTML = `<div class="mini muted">No saved items.</div>`;
    return;
  }
  el.innerHTML = rows.map((r,idx)=>`
    <div class="item">
      <div class="top">
        <div>
          <div><strong class="mono">${escapeHtml(r.text)}</strong></div>
          <div class="mini muted">${escapeHtml(r.t)} • value ${r.value}</div>
        </div>
        <div>
          <button class="smallbtn" onclick="loadGem(${idx})">Load</button>
          <button class="smallbtn danger" onclick="delGem(${idx})">Del</button>
        </div>
      </div>
    </div>
  `).join("");
}

function loadGem(idx){
  const item = gemSaved[idx];
  if (!item) return;
  document.getElementById("gemInput").value = item.text;
  calcGematria();
  showOverlay("Loaded");
}

function delGem(idx){
  gemSaved.splice(idx,1);
  saveAll();
  renderSavedGematria();
}

/* -------------------- Zohar Library -------------------- */
function saveZohar(){
  const title = (document.getElementById("zTitle").value || "").trim();
  const source = (document.getElementById("zSource").value || "").trim();
  const tags = (document.getElementById("zTags").value || "").trim();
  const text = (document.getElementById("zText").value || "").trim();
  if (!title && !text) return;

  zoharLib.unshift({
    id: String(Date.now()),
    t: nowTime(),
    title, source,
    tags: tags.split(",").map(x=>x.trim()).filter(Boolean),
    text
  });
  if (zoharLib.length > 300) zoharLib.pop();

  logEvent("ZOHAR", title || "(untitled)");
  saveAll();
  clearZoharForm();
  renderZohar();
  showOverlay("Saved");
}

function clearZoharForm(){
  document.getElementById("zTitle").value = "";
  document.getElementById("zSource").value = "";
  document.getElementById("zTags").value = "";
  document.getElementById("zText").value = "";
}

function renderZohar(){
  const q = (document.getElementById("zSearch")?.value || "").trim().toLowerCase();
  const el = document.getElementById("zList");
  const rows = zoharLib.filter(r=>{
    if (!q) return true;
    const blob = [
      r.title || "", r.source || "", (r.tags||[]).join(","), r.text || ""
    ].join(" ").toLowerCase();
    return blob.includes(q);
  });
  if (!rows.length){
    el.innerHTML = `<div class="mini muted">No passages yet. Add one, or tap “Add Templates”.</div>`;
    return;
  }
  el.innerHTML = rows.map(r=>`
    <div class="item">
      <div class="top">
        <div>
          <div><strong>${escapeHtml(r.title || "Untitled")}</strong></div>
          <div class="mini muted">${escapeHtml(r.source || "")} ${r.source ? "•" : ""} ${escapeHtml(r.t || "")}</div>
        </div>
        <div>
          <button class="smallbtn" onclick="copyZohar('${r.id}')">Copy</button>
          <button class="smallbtn danger" onclick="delZohar('${r.id}')">Del</button>
        </div>
      </div>
      <div class="mini" style="margin-top:8px;">
        ${(r.tags||[]).map(t=>`<span class="pill" style="margin-right:6px;">${escapeHtml(t)}</span>`).join("")}
      </div>
      <div class="hr"></div>
      <div class="sub">${escapeHtml(r.text || "").replace(/\n/g,"<br>")}</div>
    </div>
  `).join("");
}

function delZohar(id){
  zoharLib = zoharLib.filter(x=>x.id !== id);
  saveAll();
  renderZohar();
}

function copyZohar(id){
  const r = zoharLib.find(x=>x.id===id);
  if (!r) return;
  const txt = `${r.title || ""}\n${r.source || ""}\n\n${r.text || ""}`.trim();
  navigator.clipboard?.writeText(txt);
  showOverlay("Copied");
}

function clearZoharAll(){
  if (!confirm("Clear entire Zohar Library?")) return;
  zoharLib = [];
  saveAll();
  renderZohar();
}

function exportZohar(){
  downloadJSON({ zoharLib }, `kai_zohar_library.json`);
}

function seedZoharTemplates(){
  // Templates that are Centre-aligned prompts, not copyrighted text
  const templates = [
    {
      title:"Template: Restriction in a Trigger Moment",
      source:"Zohar (your notes)",
      tags:["restriction","reactivity","vessel"],
      text:"Where did I feel reactive desire today? What is one concrete restriction I can do right now to create a vessel for the Light?"
    },
    {
      title:"Template: Mishkan Training (100 pillars)",
      source:"Parsha Terumah / your teaching notes",
      tags:["mishkan","100","certainty"],
      text:"A day is built on 100 moments of consciousness. I pause, acknowledge the Light, and return. Frequency over intensity."
    },
    {
      title:"Template: Desire to Run",
      source:"Zohar (your notes)",
      tags:["desire","run","awakening"],
      text:"Where did I feel desire to run toward spiritual work today? Where was I indifferent? Ask for renewed desire to pursue connection."
    }
  ];
  templates.forEach(t=>{
    zoharLib.unshift({ id:String(Date.now()+Math.random()), t: nowTime(), ...t });
  });
  saveAll();
  renderZohar();
  showOverlay("Templates added");
}

/* -------------------- Settings + export -------------------- */
function loadSettingsForm(){
  document.getElementById("goalPillars").value = String(goals.pillars ?? 100);
  document.getElementById("goalCycles").value = String(goals.cycles ?? 10);
}

function saveGoals(){
  const gp = parseInt(document.getElementById("goalPillars").value,10);
  const gc = parseInt(document.getElementById("goalCycles").value,10);
  if (Number.isFinite(gp) && gp > 0) goals.pillars = gp;
  if (Number.isFinite(gc) && gc > 0) goals.cycles = gc;
  saveAll();
  updateStats();
  showOverlay("Saved");
}

function exportAll(){
  downloadJSON({
    date: today, goals, pillars, cycles,
    history, namesLog,
    gemSaved, zoharLib
  }, `kai_export_${today}.json`);
}

function clearAllData(){
  if (!confirm("Clear ALL KAI data on this device?")) return;
  Object.values(KEY).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem("kai_goals_v1");
  location.reload();
}

/* -------------------- Utilities -------------------- */
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* -------------------- Init -------------------- */
saveAll();
updateStats();
setButtonStates();
renderTodayName();
renderAllNames();
renderHistory();
</script>
</body>
</html>
