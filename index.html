<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <!-- iOS Home Screen icon (must exist at site root) -->
  <link rel="apple-touch-icon" href="/kai-icon.png?v=10" />
  <!-- PWA manifest (must exist at site root) -->
  <link rel="manifest" href="/manifest.webmanifest?v=10" />

  <title>KAI</title>

  <style>
    :root{
      --bg:#070708;
      --panel1:#0b0b0c;
      --panel2:#0f0f12;
      --text:#f3f3f4;
      --muted:#b3b3b7;
      --line:rgba(255,255,255,.09);
      --line2:rgba(255,255,255,.14);
      --gold1:#caa24a;
      --gold2:#8f6f2a;
      --good:#7dff66;
      --bad:#ff5b5b;
      --shadow:0 18px 70px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --pad:18px;
      --max:1200px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% 0%, rgba(202,162,74,.07), transparent 55%),
                  radial-gradient(900px 700px at 90% 10%, rgba(143,111,42,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }
    a{ color:inherit; }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 18px 14px 80px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(15,15,18,.92), rgba(11,11,12,.92));
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 5;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand .name{
      font-weight:800;
      letter-spacing:.2px;
      font-size:18px;
    }
    .brand .sub{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.2px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .chip b{
      color: var(--text);
      font-weight: 700;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 14px 2px 8px;
      margin-top: 12px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      user-select:none;
      -webkit-user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(202,162,74,.5);
      background: rgba(202,162,74,.10);
    }

    .panel{
      display:none;
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(15,15,18,.85), rgba(11,11,12,.85));
      box-shadow: var(--shadow);
      padding: var(--pad);
    }
    .panel.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      background: rgba(255,255,255,.02);
    }
    .title{
      margin:0 0 10px;
      font-size: 14px;
      letter-spacing:.2px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.25);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
    }
    textarea{
      min-height: 110px;
      resize: vertical;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      margin-top: 8px;
    }
    .bar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .btn{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 14px;
      font-weight:700;
      font-size: 14px;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn.primary{
      border-color: rgba(202,162,74,.6);
      background: rgba(202,162,74,.12);
    }
    .btn.danger{
      border-color: rgba(255,91,91,.55);
      background: rgba(255,91,91,.10);
    }

    .kpi{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
      border: 1px dashed rgba(255,255,255,.18);
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .row{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.02);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .row .meta{
      display:flex; flex-direction:column; gap:2px;
    }
    .row .meta b{ font-size: 13px; }
    .row .meta span{ font-size: 12px; color: var(--muted); }
    .row .actions{ display:flex; gap:8px; }

    #toast{
      display:none;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      z-index: 9999;
      background: rgba(0,0,0,.85);
      border:1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
      max-width: 92vw;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 13px;
    }

    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="name">KAI</div>
        <div class="sub">Align → Restrict → Witness → Illuminate → Seal</div>
      </div>

      <div class="chips">
        <div class="chip">Date: <b id="chipDate">—</b></div>
        <div class="chip">Profile: <b id="chipProfile">—</b></div>
        <div class="chip">Streak: <b id="chipStreak">—</b></div>
        <div class="chip">Daily Restrict: <b id="chipDailyRestrict">—</b></div>
        <div class="chip">72 Name: <b id="chipName">—</b></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="start">Start</div>
      <div class="tab" data-tab="morning">Morning</div>
      <div class="tab" data-tab="restriction">Restriction</div>
      <div class="tab" data-tab="evening">Evening</div>
      <div class="tab" data-tab="share">Share Card</div>
      <div class="tab" data-tab="library">Library</div>
      <div class="tab" data-tab="tools">Tools</div>
      <div class="tab" data-tab="history">History</div>
    </div>

    <!-- START -->
    <section class="panel active" data-pane="start">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">Active Date (this controls saving + history)</p>
          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="activeDate">Active date</label>
              <input id="activeDate" type="date" />
              <div class="hint">Change this date, then save Morning/Restriction/Evening. History will show entries for all saved dates.</div>
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="focus">Focus (one-line north star)</label>
              <input id="focus" placeholder="Clarity, courage, restriction, love..." />
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="saveAllBtn" type="button">Save All</button>
            <button class="btn" id="copySummaryBtn" type="button">Copy Summary</button>
            <button class="btn" id="exportBtn" type="button">Export JSON</button>
            <button class="btn" id="copyExportBtn" type="button">Copy Export</button>
            <button class="btn danger" id="resetDayBtn" type="button">Reset Active Day</button>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="exportBox">Export output</label>
            <textarea id="exportBox" placeholder="Export appears here..." readonly></textarea>
          </div>
        </div>

        <div class="card" style="grid-column: span 12;">
          <p class="title">Profile</p>
          <div class="grid">
            <div class="field" style="grid-column: span 4;">
              <label for="pFirst">First name</label>
              <input id="pFirst" placeholder="Bernard" />
            </div>
            <div class="field" style="grid-column: span 4;">
              <label for="pLast">Last name</label>
              <input id="pLast" placeholder="Whitman" />
            </div>
            <div class="field" style="grid-column: span 4;">
              <label for="pBirth">Birthdate</label>
              <input id="pBirth" type="date" />
            </div>
          </div>
          <div class="bar">
            <button class="btn primary" id="saveProfileBtn" type="button">Save Profile</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MORNING -->
    <section class="panel" data-pane="morning">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">ALIGN (Morning)</p>

          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="mCertainty">Certainty (0–10 or word)</label>
              <input id="mCertainty" placeholder="7 / steady / clear" />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="mEnergy">Energy (0–10 or word)</label>
              <input id="mEnergy" placeholder="6 / low / electric" />
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="mPattern">Pattern (what’s the trap?)</label>
              <input id="mPattern" placeholder="Control, overthinking, urgency..." />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="mWitness">Witness (one sentence)</label>
              <input id="mWitness" placeholder="I notice my mind chasing certainty..." />
            </div>

            <div class="field" style="grid-column: span 12;">
              <label for="mIntention">Intention (what do you choose?)</label>
              <textarea id="mIntention" placeholder="Today I choose restriction, humility, alignment..."></textarea>
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="saveMorningBtn" type="button">Save Morning</button>
            <button class="btn" id="copyMorningBtn" type="button">Copy Morning</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section class="panel" data-pane="restriction">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">RESTRICT (Day)</p>

          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="rMove">Restriction move (one action)</label>
              <input id="rMove" placeholder="Pause. Don’t text. Don’t interrupt. Breathe..." />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="rTrigger">Trigger (what activates reactivity?)</label>
              <input id="rTrigger" placeholder="Uncertainty, delay, ego, fear..." />
            </div>

            <div class="field" style="grid-column: span 12;">
              <label for="rNote">Witness note (what happened, without drama)</label>
              <textarea id="rNote" placeholder="I noticed X, felt Y, chose Z..."></textarea>
            </div>
          </div>

          <div class="bar">
            <button class="btn" id="dailyRestrictToggle" type="button" aria-checked="false">Daily Restrict: Off</button>
            <button class="btn primary" id="saveRestrictionBtn" type="button">Save Restriction</button>
            <button class="btn" id="copyRestrictionBtn" type="button">Copy Restriction</button>
            <button class="btn" id="completeRestrictionBtn" type="button">Mark Completed</button>
          </div>

          <div class="hint">“Daily Restrict” is a global mode. If ON, your next days will default to practicing restriction as your main move.</div>
        </div>
      </div>
    </section>

    <!-- EVENING -->
    <section class="panel" data-pane="evening">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">WITNESS (Evening)</p>

          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="eWin">Win (what worked?)</label>
              <input id="eWin" placeholder="I paused. I didn’t react. I chose love..." />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="eLesson">Lesson (what did you learn?)</label>
              <input id="eLesson" placeholder="My urgency is fear wearing cologne..." />
            </div>

            <div class="field" style="grid-column: span 12;">
              <label for="eSeal">Seal (one line closing blessing)</label>
              <input id="eSeal" placeholder="May I carry this clarity into tomorrow." />
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="saveEveningBtn" type="button">Save Evening</button>
            <button class="btn" id="copyEveningBtn" type="button">Copy Evening</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SHARE CARD -->
    <section class="panel" data-pane="share">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">SHARE CARD</p>

          <div class="bar">
            <button class="btn primary" id="buildCardBtn" type="button">Build Card</button>
            <button class="btn" id="copyCardBtn" type="button">Copy Card</button>
            <button class="btn" id="saveCardBtn" type="button">Save Card</button>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="cardOut">Share text</label>
            <textarea id="cardOut" placeholder="Build card to generate text..." ></textarea>
          </div>

          <div class="hint">This is the “send to Eitan” artifact. Build → Copy → paste into text/email.</div>
        </div>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="panel" data-pane="library">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">LIBRARY (Themes, Patterns, 72 Names, Letters)</p>

          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="libSearch">Search</label>
              <input id="libSearch" placeholder="Try: clarity, certainty, protection, healing, אהבה..." />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="libPattern">Filter by pattern</label>
              <select id="libPattern">
                <option value="">All patterns</option>
                <option>Urgency → Certainty</option>
                <option>Reactivity → Restriction</option>
                <option>Judgment → Compassion</option>
                <option>Overthinking → Action</option>
                <option>Fear → Faith</option>
                <option>Control → Trust</option>
                <option>Isolation → Connection</option>
              </select>
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="libPick" type="button">Pick for me</button>
            <button class="btn" id="libClear" type="button">Clear</button>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="libSuggested">Suggested practice</label>
            <textarea id="libSuggested" placeholder="Pick for me will generate a suggestion..." readonly></textarea>
          </div>

          <div class="bar">
            <button class="btn" id="libCopySuggested" type="button">Copy suggestion</button>
          </div>

          <div class="hint">Notes: This library is a working scaffold. We’ll expand it into a proper “KAI canon” later, but it’s useful now.</div>

          <div class="list" id="libResults"></div>
        </div>
      </div>
    </section>

    <!-- TOOLS -->
    <section class="panel" data-pane="tools">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">Gematria + Insight Engine</p>
          <div class="grid">
            <div class="field" style="grid-column: span 8;">
              <label for="gText">Text (Hebrew or English)</label>
              <input id="gText" placeholder="Type a Hebrew word/phrase (or English)..." />
            </div>
            <div class="field" style="grid-column: span 4;">
              <label for="gMode">Mode</label>
              <select id="gMode">
                <option value="he">Hebrew (standard)</option>
                <option value="az">English (A1Z26)</option>
              </select>
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="gCalcBtn" type="button">Calculate + Insight</button>
            <button class="btn" id="gCopyBtn" type="button">Copy Result</button>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="gOut">Output</label>
            <textarea id="gOut" readonly placeholder="Gematria + insights will appear here..."></textarea>
          </div>
        </div>

        <div class="card" style="grid-column: span 12;">
          <p class="title">72 Name Lookup (mini)</p>
          <div class="grid">
            <div class="field" style="grid-column: span 6;">
              <label for="nQuery">Search by #, letters, or keyword</label>
              <input id="nQuery" placeholder="e.g. 1, והו, protection, calm..." />
            </div>
            <div class="field" style="grid-column: span 6;">
              <label for="nOut">Result</label>
              <textarea id="nOut" readonly placeholder="Results appear here..."></textarea>
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="nFindBtn" type="button">Find</button>
            <button class="btn" id="nCopyBtn" type="button">Copy</button>
          </div>

          <div class="hint">This is a starter set (enough to demo). We can load the full 72 later once you’re out of offsite battle-mode.</div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="panel" data-pane="history">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <p class="title">History (saved days)</p>
          <div class="bar">
            <button class="btn" id="refreshHistoryBtn" type="button">Refresh</button>
          </div>
          <div class="list" id="historyList"></div>
          <div class="hint">Tap a day to set it as Active Date, then switch tabs to view/edit it.</div>
        </div>
      </div>
    </section>

  </div>

  <div id="toast"></div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__tmo);
      window.__tmo = setTimeout(()=> t.style.display="none", 2400);
    }

    function safeJSONParse(s, fallback){
      try { return JSON.parse(s); } catch(e){ return fallback; }
    }

    function todayISO(){
      // timezone-safe YYYY-MM-DD
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }

    // ---------- Storage keys ----------
    const keyProfile = "kai_profile_v3";
    const keyMeta    = "kai_meta_v3";
    const keyDay     = (iso) => `kai_day_${iso}_v3`;
    const keyActiveDate = "kai_active_date_v1";
    const keyLastTab = "kai_last_tab_v1";
    const keyDailyRestrict = "kai_daily_restrict_v1";

    // ---------- Defaults ----------
    function defaultProfile(){
      return {
        first: "",
        last: "",
        birth: "",
        focus: ""
      };
    }

    function defaultMeta(){
      return {
        selectedPattern: "",
        selectedName: "",
        lastGematria: "",
        lastGematriaInsight: ""
      };
    }

    function defaultDay(iso){
      return {
        date: iso,
        morning: { certainty:"", energy:"", intention:"", pattern:"", witness:"" },
        restriction: { move:"", trigger:"", note:"", completed:false },
        evening: { win:"", lesson:"", seal:"" },
        shareCard: ""
      };
    }

    // ---------- Getters/Setters ----------
    function getProfile(){
      return safeJSONParse(localStorage.getItem(keyProfile), defaultProfile());
    }
    function setProfile(p){
      localStorage.setItem(keyProfile, JSON.stringify(p));
    }

    function getMeta(){
      return safeJSONParse(localStorage.getItem(keyMeta), defaultMeta());
    }
    function setMeta(m){
      localStorage.setItem(keyMeta, JSON.stringify(m));
    }

    function getActiveDate(){
      return localStorage.getItem(keyActiveDate) || todayISO();
    }
    function setActiveDate(iso){
      const v = iso || todayISO();
      localStorage.setItem(keyActiveDate, v);
      // ensure there's at least a day object created
      const d = getDay(v);
      if(!d || !d.date) setDay(defaultDay(v));
    }

    function getDay(iso = getActiveDate()){
      const realIso = iso || getActiveDate();
      return safeJSONParse(localStorage.getItem(keyDay(realIso)), defaultDay(realIso));
    }
    function setDay(d){
      if(!d || !d.date) return;
      localStorage.setItem(keyDay(d.date), JSON.stringify(d));
    }

    function getDailyRestrict(){
      return (localStorage.getItem(keyDailyRestrict) === "1");
    }
    function setDailyRestrict(on){
      localStorage.setItem(keyDailyRestrict, on ? "1" : "0");
    }

    function listSavedDays(){
      const days = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith("kai_day_") && k.endsWith("_v3")){
          const iso = k.replace("kai_day_","").replace("_v3","");
          days.push(iso);
        }
      }
      days.sort().reverse();
      return days;
    }

    // ---------- UI collect/hydrate ----------
    function collectProfileFromUI(){
      const p = getProfile();
      p.first = ($("pFirst")?.value || "").trim();
      p.last  = ($("pLast")?.value || "").trim();
      p.birth = ($("pBirth")?.value || "").trim();
      p.focus = ($("focus")?.value || "").trim();
      return p;
    }

    function collectMorningFromUI(){
      return {
        certainty: ($("mCertainty")?.value || "").trim(),
        energy:    ($("mEnergy")?.value || "").trim(),
        intention: ($("mIntention")?.value || "").trim(),
        pattern:   ($("mPattern")?.value || "").trim(),
        witness:   ($("mWitness")?.value || "").trim()
      };
    }

    function collectRestrictionFromUI(){
      return {
        move:    ($("rMove")?.value || "").trim(),
        trigger: ($("rTrigger")?.value || "").trim(),
        note:    ($("rNote")?.value || "").trim(),
        completed: getDay().restriction?.completed ? true : false
      };
    }

    function collectEveningFromUI(){
      return {
        win:   ($("eWin")?.value || "").trim(),
        lesson:($("eLesson")?.value || "").trim(),
        seal:  ($("eSeal")?.value || "").trim()
      };
    }

    function hydrateProfileUI(){
      const p = getProfile();
      if($("pFirst")) $("pFirst").value = p.first || "";
      if($("pLast"))  $("pLast").value  = p.last || "";
      if($("pBirth")) $("pBirth").value = p.birth || "";
      if($("focus"))  $("focus").value  = p.focus || "";
    }

    function hydrateDayUI(){
      const d = getDay();
      if($("mCertainty")) $("mCertainty").value = d.morning?.certainty || "";
      if($("mEnergy"))    $("mEnergy").value    = d.morning?.energy || "";
      if($("mIntention")) $("mIntention").value = d.morning?.intention || "";
      if($("mPattern"))   $("mPattern").value   = d.morning?.pattern || "";
      if($("mWitness"))   $("mWitness").value   = d.morning?.witness || "";

      if($("rMove"))      $("rMove").value      = d.restriction?.move || "";
      if($("rTrigger"))   $("rTrigger").value   = d.restriction?.trigger || "";
      if($("rNote"))      $("rNote").value      = d.restriction?.note || "";

      if($("eWin"))       $("eWin").value       = d.evening?.win || "";
      if($("eLesson"))    $("eLesson").value    = d.evening?.lesson || "";
      if($("eSeal"))      $("eSeal").value      = d.evening?.seal || "";

      if($("cardOut"))    $("cardOut").value    = d.shareCard || "";
    }

    function computeStreak(){
      // simple streak: consecutive saved days (has any non-empty field)
      const days = listSavedDays().sort(); // ascending
      if(days.length === 0) return 0;

      const hasContent = (iso) => {
        const d = getDay(iso);
        const m = d.morning || {};
        const r = d.restriction || {};
        const e = d.evening || {};
        const s = (x)=> (x||"").trim().length > 0;
        return s(m.certainty)||s(m.energy)||s(m.intention)||s(m.pattern)||s(m.witness)||
               s(r.move)||s(r.trigger)||s(r.note)||
               s(e.win)||s(e.lesson)||s(e.seal)||
               s(d.shareCard);
      };

      // streak up to active date
      const active = getActiveDate();
      let streak = 0;
      // walk backwards from active date
      let cursor = new Date(active + "T00:00:00");
      for(;;){
        const iso = cursor.toISOString().slice(0,10);
        if(!localStorage.getItem(keyDay(iso))) break;
        if(!hasContent(iso)) break;
        streak++;
        cursor.setDate(cursor.getDate()-1);
      }
      return streak;
    }

    function hydrateChips(){
      const p = getProfile();
      const m = getMeta();
      const d = getDay();
      const full = `${p.first||""} ${p.last||""}`.trim() || "—";

      if($("chipDate")) $("chipDate").textContent = d.date || "—";
      if($("chipProfile")) $("chipProfile").textContent = full;
      if($("chipStreak")) $("chipStreak").textContent = String(computeStreak() || 0);
      if($("chipDailyRestrict")) $("chipDailyRestrict").textContent = getDailyRestrict() ? "On" : "Off";
      if($("chipName")) $("chipName").textContent = m.selectedName || "—";

      // active date input
      if($("activeDate")) $("activeDate").value = getActiveDate();
    }

    function hydrateDailyRestrictToggle(){
      const btn = $("dailyRestrictToggle");
      if(!btn) return;
      const on = getDailyRestrict();
      btn.textContent = on ? "Daily Restrict: On" : "Daily Restrict: Off";
      btn.setAttribute("aria-checked", on ? "true" : "false");
      btn.classList.toggle("primary", on);
    }

    function hydrateHistory(){
      const box = $("historyList");
      if(!box) return;
      box.innerHTML = "";

      const days = listSavedDays();
      if(days.length === 0){
        const div = document.createElement("div");
        div.className = "kpi";
        div.textContent = "No saved days yet.\nSave Morning/Restriction/Evening on any date and they’ll appear here.";
        box.appendChild(div);
        return;
      }

      days.forEach(iso=>{
        const d = getDay(iso);
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "meta";

        const b = document.createElement("b");
        b.textContent = iso;

        const s = document.createElement("span");
        const m = d.morning || {};
        const r = d.restriction || {};
        const e = d.evening || {};
        const brief = [
          (m.pattern ? `Pattern: ${m.pattern}` : ""),
          (r.move ? `Move: ${r.move}` : ""),
          (e.win ? `Win: ${e.win}` : "")
        ].filter(Boolean).slice(0,2).join(" • ") || "Saved day";

        s.textContent = brief;

        left.appendChild(b);
        left.appendChild(s);

        const actions = document.createElement("div");
        actions.className = "actions";

        const openBtn = document.createElement("button");
        openBtn.className = "btn";
        openBtn.type = "button";
        openBtn.textContent = "Set Active";
        openBtn.addEventListener("click", (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          setActiveDate(iso);
          hydrateUI();
          toast("Active date set ✅");
          setActiveTab("start");
        }, {passive:false});

        actions.appendChild(openBtn);

        row.appendChild(left);
        row.appendChild(actions);

        row.addEventListener("click", (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          setActiveDate(iso);
          hydrateUI();
          toast("Active date set ✅");
          setActiveTab("start");
        }, {passive:false});

        box.appendChild(row);
      });
    }

    function hydrateUI(){
      hydrateProfileUI();
      hydrateDayUI();
      hydrateChips();
      hydrateDailyRestrictToggle();
      hydrateHistory();
      libRefresh();
    }

    // ---------- Tabs ----------
    function setActiveTab(name){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === name);
      });
      document.querySelectorAll(".panel").forEach(p=>{
        p.classList.toggle("active", p.dataset.pane === name);
      });
      localStorage.setItem(keyLastTab, name);
      // on tab switch, re-hydrate so you see current active date
      hydrateUI();
    }

    function wireTabs(){
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          setActiveTab(btn.dataset.tab);
        }, {passive:false});
      });
    }

    // ---------- Active date wiring ----------
    function wireActiveDate(){
      const input = $("activeDate");
      if(!input) return;

      // initialize if empty
      input.value = getActiveDate();

      input.addEventListener("change",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const iso = (input.value || "").trim() || todayISO();
        setActiveDate(iso);
        hydrateUI();
        toast("Date set ✅");
      }, {passive:false});
    }

    // ---------- Copy helper ----------
    function copyText(txt){
      const t = (txt || "").toString();
      (navigator.clipboard?.writeText(t) || Promise.resolve())
        .then(()=>toast("Copied ✅"))
        .catch(()=>toast("Copy blocked ⚠️"));
    }

    function downloadJSON(obj, filename){
      try{
        const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }catch(e){
        toast("Download blocked ⚠️");
      }
    }

    // ---------- Buttons (Start page actions) ----------
    function buildExport(){
      const p = getProfile();
      const m = getMeta();
      const d = getDay();
      return { profile:p, meta:m, day:d, exportedAt: new Date().toISOString() };
    }

    function wireButtons(){
      $("saveProfileBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI());
        hydrateUI();
        toast("Profile saved ✅");
      }, {passive:false});

      $("saveAllBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI());
        const d = getDay();
        d.morning = collectMorningFromUI();
        d.restriction = collectRestrictionFromUI();
        d.evening = collectEveningFromUI();
        setDay(d);
        hydrateUI();
        toast("All saved ✅");
      }, {passive:false});

      $("copySummaryBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const p = getProfile();
        const d = getDay();
        const full = `${p.first||""} ${p.last||""}`.trim() || "—";
        const txt =
`KAI • ${d.date}
Name: ${full}
Focus: ${p.focus || "—"}

Morning:
• Certainty: ${d.morning?.certainty || "—"}  Energy: ${d.morning?.energy || "—"}
• Intention: ${d.morning?.intention || "—"}

Restriction:
• Move: ${d.restriction?.move || "—"}
• Witness: ${d.restriction?.note || "—"}
• Completed: ${d.restriction?.completed ? "Yes" : "No"}

Evening:
• Win: ${d.evening?.win || "—"}
• Lesson: ${d.evening?.lesson || "—"}
• Seal: ${d.evening?.seal || "—"}`;
        copyText(txt);
      }, {passive:false});

      $("exportBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const obj = buildExport();
        if($("exportBox")) $("exportBox").value = JSON.stringify(obj, null, 2);
        downloadJSON(obj, `kai-export-${getActiveDate()}.json`);
        toast("Exported ✅");
      }, {passive:false});

      $("copyExportBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const obj = buildExport();
        const txt = JSON.stringify(obj, null, 2);
        if($("exportBox")) $("exportBox").value = txt;
        copyText(txt);
      }, {passive:false});

      $("resetDayBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const iso = getActiveDate();
        setDay(defaultDay(iso));
        hydrateUI();
        toast("Active day reset ✅");
      }, {passive:false});

      $("refreshHistoryBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        hydrateHistory();
        toast("History refreshed ✅");
      }, {passive:false});
    }

    // ---------- Morning / Restriction / Evening wiring ----------
    function wireMorning(){
      $("saveMorningBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI());
        const d = getDay();
        d.morning = collectMorningFromUI();
        setDay(d);
        hydrateUI();
        toast("Morning saved ✅");
      }, {passive:false});

      $("copyMorningBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        const txt =
`Morning • ${d.date}
Certainty: ${d.morning?.certainty || "—"}
Energy: ${d.morning?.energy || "—"}
Intention: ${d.morning?.intention || "—"}
Pattern: ${d.morning?.pattern || "—"}
Witness: ${d.morning?.witness || "—"}`;
        copyText(txt);
      }, {passive:false});
    }

    function wireRestriction(){
      $("dailyRestrictToggle")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const on = !getDailyRestrict();
        setDailyRestrict(on);
        hydrateDailyRestrictToggle();
        hydrateChips();
        toast(on ? "Daily Restrict ON ✅" : "Daily Restrict OFF ✅");
      }, {passive:false});

      $("saveRestrictionBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI());
        const d = getDay();
        const r = collectRestrictionFromUI();
        // preserve completed flag if already set
        r.completed = d.restriction?.completed ? true : false;
        d.restriction = r;
        setDay(d);
        hydrateUI();
        toast("Restriction saved ✅");
      }, {passive:false});

      $("copyRestrictionBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        const txt =
`Restriction • ${d.date}
Move: ${d.restriction?.move || "—"}
Trigger: ${d.restriction?.trigger || "—"}
Witness: ${d.restriction?.note || "—"}
Completed: ${d.restriction?.completed ? "Yes" : "No"}`;
        copyText(txt);
      }, {passive:false});

      $("completeRestrictionBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        d.restriction = d.restriction || {move:"",trigger:"",note:"",completed:false};
        d.restriction.completed = true;
        setDay(d);
        hydrateUI();
        toast("Marked completed ✅");
      }, {passive:false});
    }

    function wireEvening(){
      $("saveEveningBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        setProfile(collectProfileFromUI());
        const d = getDay();
        d.evening = collectEveningFromUI();
        setDay(d);
        hydrateUI();
        toast("Evening saved ✅");
      }, {passive:false});

      $("copyEveningBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const d = getDay();
        const txt =
`Evening • ${d.date}
Win: ${d.evening?.win || "—"}
Lesson: ${d.evening?.lesson || "—"}
Seal: ${d.evening?.seal || "—"}`;
        copyText(txt);
      }, {passive:false});
    }

    // ---------- Share Card ----------
    function buildShareCardText(){
      const p = getProfile();
      const m = getMeta();
      const d = getDay();

      const fullName = `${p.first||""} ${p.last||""}`.trim() || "—";

      return `KAI • ${d.date}
Name: ${fullName}
Focus: ${p.focus || "—"}
Pattern: ${d.morning?.pattern || m.selectedPattern || "—"}
72 Name: ${m.selectedName || "—"}

ALIGN (Morning)
• Certainty: ${d.morning?.certainty || "—"}  Energy: ${d.morning?.energy || "—"}
• Intention: ${d.morning?.intention || "—"}

RESTRICT (Day)
• Move: ${d.restriction?.move || "—"}
• Witness: ${d.restriction?.note || "—"}
• Completed: ${d.restriction?.completed ? "Yes" : "No"}

WITNESS (Evening)
• Win: ${d.evening?.win || "—"}
• Lesson: ${d.evening?.lesson || "—"}

SEAL
• ${d.evening?.seal || "—"}`;
    }

    function wireShareCard(){
      const buildBtn = $("buildCardBtn");
      const copyBtn  = $("copyCardBtn");
      const saveBtn  = $("saveCardBtn");
      const outBox   = $("cardOut");

      if(buildBtn && outBox){
        buildBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          outBox.value = buildShareCardText();
          toast("Card built ✅");
        }, {passive:false});
      }

      if(copyBtn && outBox){
        copyBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText(outBox.value || "");
        }, {passive:false});
      }

      if(saveBtn && outBox){
        saveBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const d = getDay();
          d.shareCard = outBox.value || "";
          setDay(d);
          hydrateUI();
          toast("Card saved ✅");
        }, {passive:false});
      }
    }

    // ---------- Library dataset + wiring ----------
    const LIB = [
      { type:"theme", title:"Clarity", tags:["clarity","certainty","alignment"], pattern:"Urgency → Certainty",
        text:"Return to the next true step. Don’t solve the whole world. Choose the next clean action." },
      { type:"theme", title:"Restriction", tags:["restriction","reactivity","pause"], pattern:"Reactivity → Restriction",
        text:"One breath before response. One extra second before speech. That second is a doorway." },
      { type:"theme", title:"Trust", tags:["trust","faith","surrender"], pattern:"Control → Trust",
        text:"Release control of outcome. Invest in right action. Let the Light do the logistics." },
      { type:"72", title:"#1 והו (Vav-Heh-Vav)", tags:["protection","calm","certainty"], pattern:"Fear → Faith",
        text:"Protective clearing. Stabilize the nervous system. Return to steadiness." },
      { type:"72", title:"#2 ילי (Yod-Lamed-Yod)", tags:["healing","release","repair"], pattern:"Judgment → Compassion",
        text:"Healing and repair. Softens harsh judgment. Encourages compassionate perception." },
      { type:"72", title:"#6 מבה (Mem-Bet-Heh)", tags:["certainty","truth","ground"], pattern:"Urgency → Certainty",
        text:"Certainty over chaos. A grounded recalibration when your mind sprints ahead." },
      { type:"practice", title:"3-breath reset", tags:["breath","pause","witness"], pattern:"Reactivity → Restriction",
        text:"Inhale: witness. Exhale: release. Inhale: choose. Exhale: seal. Inhale: act. Exhale: trust." }
    ];

    function libFilterItems(q, pattern){
      const qq = (q||"").trim().toLowerCase();
      const pp = (pattern||"").trim().toLowerCase();

      return LIB.filter(it=>{
        const inPattern = !pp || (it.pattern||"").toLowerCase() === pp;
        if(!inPattern) return false;

        if(!qq) return true;

        const hay = [
          it.type, it.title, it.pattern, it.text,
          ...(it.tags||[])
        ].join(" ").toLowerCase();

        return hay.includes(qq);
      });
    }

    function libRenderResults(items){
      const box = $("libResults");
      if(!box) return;
      box.innerHTML = "";

      if(items.length === 0){
        const div = document.createElement("div");
        div.className = "kpi";
        div.textContent = "No matches. Try a different keyword.";
        box.appendChild(div);
        return;
      }

      items.slice(0,20).forEach(it=>{
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "meta";
        const b = document.createElement("b");
        b.textContent = it.title;
        const s = document.createElement("span");
        s.textContent = `${it.type.toUpperCase()} • ${it.pattern || "—"}`;
        left.appendChild(b);
        left.appendChild(s);

        const actions = document.createElement("div");
        actions.className = "actions";

        const useBtn = document.createElement("button");
        useBtn.className = "btn";
        useBtn.type = "button";
        useBtn.textContent = "Use";
        useBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          // apply to meta + morning pattern if empty
          const m = getMeta();
          m.selectedPattern = it.pattern || m.selectedPattern || "";
          if(it.type === "72") m.selectedName = it.title;
          setMeta(m);

          const d = getDay();
          d.morning = d.morning || {};
          if(!d.morning.pattern) d.morning.pattern = it.pattern || "";
          setDay(d);

          hydrateUI();
          toast("Applied ✅");
        }, {passive:false});

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn";
        copyBtn.type = "button";
        copyBtn.textContent = "Copy";
        copyBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText(`${it.title}\n${it.pattern || ""}\n\n${it.text}`);
        }, {passive:false});

        actions.appendChild(useBtn);
        actions.appendChild(copyBtn);

        row.appendChild(left);
        row.appendChild(actions);

        row.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          if($("libSuggested")) $("libSuggested").value = `${it.title}\n${it.pattern || ""}\n\n${it.text}`;
          toast("Loaded suggestion ✅");
        }, {passive:false});

        box.appendChild(row);
      });
    }

    function libPickForMe(pattern){
      const items = libFilterItems("", pattern);
      if(items.length === 0){
        toast("Nothing to pick ⚠️");
        return;
      }
      const pick = items[Math.floor(Math.random()*items.length)];
      if($("libSuggested")) $("libSuggested").value = `${pick.title}\n${pick.pattern || ""}\n\n${pick.text}`;
      toast("Picked ✅");
    }

    function libRefresh(){
      const search = $("libSearch");
      const pat = $("libPattern");
      const q = search?.value || "";
      const p = pat?.value || "";
      const items = libFilterItems(q, p);
      libRenderResults(items);
    }

    function wireLibrary(){
      const search = $("libSearch");
      const pat = $("libPattern");
      const pick = $("libPick");
      const clr = $("libClear");
      const copySug = $("libCopySuggested");

      if(search) search.addEventListener("input", libRefresh, {passive:true});
      if(pat) pat.addEventListener("change", libRefresh, {passive:true});

      if(pick){
        pick.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          libPickForMe(pat?.value || "");
        }, {passive:false});
      }

      if(clr){
        clr.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          if(search) search.value = "";
          if(pat) pat.value = "";
          if($("libSuggested")) $("libSuggested").value = "";
          libRefresh();
          toast("Cleared ✅");
        }, {passive:false});
      }

      if(copySug){
        copySug.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText($("libSuggested")?.value || "");
        }, {passive:false});
      }
    }

    // ---------- Gematria + Insight Engine ----------
    const GEM_HE = {
      "א":1,"ב":2,"ג":3,"ד":4,"ה":5,"ו":6,"ז":7,"ח":8,"ט":9,
      "י":10,"כ":20,"ך":20,"ל":30,"מ":40,"ם":40,"נ":50,"ן":50,"ס":60,
      "ע":70,"פ":80,"ף":80,"צ":90,"ץ":90,"ק":100,"ר":200,"ש":300,"ת":400
    };

    function gematriaHebrew(text){
      let sum = 0;
      const letters = [];
      for(const ch of (text||"")){
        if(GEM_HE[ch]){
          sum += GEM_HE[ch];
          letters.push(ch);
        }
      }
      return { sum, letters: letters.join("") };
    }

    function gematriaA1Z26(text){
      let sum = 0;
      const letters = [];
      for(const ch of (text||"").toUpperCase()){
        const code = ch.charCodeAt(0);
        if(code >= 65 && code <= 90){
          const v = code - 64;
          sum += v;
          letters.push(ch);
        }
      }
      return { sum, letters: letters.join("") };
    }

    function gematriaInsights(n){
      const hits = [];
      const add = (title, body)=> hits.push(`• ${title}: ${body}`);

      if(!Number.isFinite(n) || n<=0){
        return "Type letters to calculate.\n";
      }

      // Common anchor numbers (lightweight, non-pretend)
      if(n === 18) add("18 (Chai)", "Life-force. Ask: what choice increases life, not drama?");
      if(n === 26) add("26 (YHVH)", "Alignment with the Name. Ask: where do you soften into trust?");
      if(n === 72) add("72", "Channel clarity. Ask: what is the cleanest restriction you can do today?");
      if(n === 45) add("45 (Adam)", "Humility and human-scale alignment. Less performing, more being.");
      if(n === 90) add("90", "Tzadi energy. Integrity, right action, unshakable inner spine.");
      if(n === 216) add("216", "Intensity of manifestation. Keep intention pure, action simple.");

      // Number texture
      const mod9 = n % 9;
      const mod7 = n % 7;

      add("Texture", `Digital root (mod 9): ${mod9} • Mod 7: ${mod7}`);
      add("Prompt", "Turn this into one sentence: “Because this is the number, I choose ____ today.”");

      return hits.join("\n");
    }

    function renderGematria(){
      const txt = ($("gText")?.value || "").trim();
      const mode = $("gMode")?.value || "he";
      const p = getProfile();
      const active = getActiveDate();

      let res;
      if(mode === "az"){
        res = gematriaA1Z26(txt);
      }else{
        res = gematriaHebrew(txt);
      }

      const n = res.sum;
      const insight = gematriaInsights(n);

      const out =
`Gematria (${mode === "az" ? "A1Z26" : "Hebrew standard"})
Date: ${active}
Focus: ${p.focus || "—"}

Input: ${txt || "—"}
Letters counted: ${res.letters || "—"}
Value: ${n || 0}

Insight:
${insight || "—"}`;

      if($("gOut")) $("gOut").value = out;

      const m = getMeta();
      m.lastGematria = String(n || 0);
      m.lastGematriaInsight = insight || "";
      setMeta(m);

      toast("Gematria ready ✅");
    }

    function wireGematria(){
      $("gCalcBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        renderGematria();
      }, {passive:false});

      $("gCopyBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        copyText($("gOut")?.value || "");
      }, {passive:false});
    }

    // ---------- 72 Name mini lookup ----------
    const N72 = [
      { n:1, letters:"והו", keywords:["protection","calm","certainty"], note:"Protective clearing, steadying." },
      { n:2, letters:"ילי", keywords:["healing","repair","release"], note:"Healing and repair, softens judgment." },
      { n:6, letters:"מבה", keywords:["certainty","truth","ground"], note:"Certainty, anchored action." },
      { n:14, letters:"מזי", keywords:["memory","insight","learning"], note:"Learning, integration." },
      { n:32, letters:"הקם", keywords:["gratitude","humility","repair"], note:"Return to humility, repair through gratitude." }
    ];

    function find72(query){
      const q = (query||"").trim().toLowerCase();
      if(!q) return null;

      const asNum = Number(q);
      if(Number.isFinite(asNum) && asNum>0){
        return N72.find(x=>x.n === asNum) || null;
      }

      // letters
      const byLetters = N72.find(x=>x.letters.toLowerCase() === q);
      if(byLetters) return byLetters;

      // keyword
      return N72.find(x=>x.keywords.some(k=>k.includes(q))) || null;
    }

    function wire72(){
      $("nFindBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        const q = $("nQuery")?.value || "";
        const hit = find72(q);
        if(!hit){
          if($("nOut")) $("nOut").value = "No match yet. Try a number (1–72), letters (e.g. והו), or a keyword.";
          toast("No match ⚠️");
          return;
        }
        const txt =
`72 Name #${hit.n}
Letters: ${hit.letters}
Keywords: ${hit.keywords.join(", ")}
Note: ${hit.note}`;
        if($("nOut")) $("nOut").value = txt;

        // also set as selected
        const m = getMeta();
        m.selectedName = `#${hit.n} ${hit.letters}`;
        setMeta(m);

        hydrateChips();
        toast("Selected ✅");
      }, {passive:false});

      $("nCopyBtn")?.addEventListener("click",(e)=>{
        e.preventDefault(); e.stopPropagation();
        copyText($("nOut")?.value || "");
      }, {passive:false});
    }

    // ---------- Crash visibility (so "static photo" tells us why) ----------
    function wireCrashVisibility(){
      window.addEventListener("error", (e)=>{
        try { toast("JS error: " + (e?.message || "unknown")); } catch {}
      });
      window.addEventListener("unhandledrejection", (e)=>{
        try { toast("Promise error: " + (e?.reason?.message || e?.reason || "unknown")); } catch {}
      });
    }

    // ---------- Boot ----------
    (function boot(){
      wireCrashVisibility();

      // ensure active date exists on first launch
      setActiveDate(getActiveDate());

      wireTabs();
      wireActiveDate();
      wireButtons();
      wireMorning();
      wireRestriction();
      wireEvening();
      wireShareCard();
      wireLibrary();
      wireGematria();
      wire72();

      hydrateUI();

      // restore last tab
      const last = localStorage.getItem(keyLastTab);
      if(last) setActiveTab(last);

      toast("KAI is alive ✅");
    })();
  </script>
</body>
</html>
