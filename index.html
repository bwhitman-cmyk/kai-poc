<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>KAI</title>

  <style>
    :root{
      --bg:#070707;
      --panel:#0e0e0e;
      --panel2:#121212;
      --text:#f3f1ea;
      --muted:#bdb8ab;
      --gold:#d7b45a;
      --gold2:#f0d28a;
      --line:rgba(215,180,90,.22);
      --shadow:0 20px 50px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:26px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 900px at 50% -10%, rgba(215,180,90,.08), transparent 55%),
                  radial-gradient(900px 800px at 90% 20%, rgba(215,180,90,.06), transparent 55%),
                  radial-gradient(900px 800px at 10% 35%, rgba(215,180,90,.05), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      position:fixed; left:0; right:0; top:0;
      padding: env(safe-area-inset-top) 16px 12px 16px;
      background: linear-gradient(to bottom, rgba(0,0,0,.82), rgba(0,0,0,.55), transparent);
      z-index:20;
      pointer-events:none;
    }
    .topbar .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; pointer-events:auto;
    }
    .brand{
      display:flex; align-items:baseline; gap:10px;
      letter-spacing:.28em;
      text-transform:uppercase;
      font-weight:800;
      user-select:none;
    }
    .brand .kai{
      font-size:18px;
      color:var(--gold2);
    }
    .brand .tag{
      font-size:11px;
      color:rgba(243,241,234,.72);
      letter-spacing:.32em;
      font-weight:700;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:rgba(16,16,16,.7);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      font-size:12px;
      color:rgba(243,241,234,.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background:rgba(215,180,90,.95);
      box-shadow: 0 0 0 3px rgba(215,180,90,.18);
    }

    /* App shell */
    .app{
      position:absolute; inset:0;
      padding-top: calc(env(safe-area-inset-top) + 62px);
      padding-bottom: calc(env(safe-area-inset-bottom) + 78px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .container{
      width:min(980px, 100%);
      margin:0 auto;
      padding:14px 14px 22px;
    }

    .card{
      background:linear-gradient(180deg, rgba(18,18,18,.9), rgba(12,12,12,.85));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(215,180,90,.14);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .hgroup .h1{
      font-weight:900;
      letter-spacing:.02em;
      font-size:18px;
      margin:0;
    }
    .hgroup .sub{
      margin-top:6px;
      font-size:13px;
      color:rgba(243,241,234,.72);
      line-height:1.35;
    }
    .card .bd{ padding:14px 16px 16px; }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }

    /* Buttons + inputs */
    button, input, textarea, select{ font:inherit; }
    .btn{
      appearance:none; -webkit-appearance:none;
      border:1px solid rgba(215,180,90,.35);
      color:rgba(0,0,0,.92);
      background: linear-gradient(180deg, rgba(240,210,138,.98), rgba(215,180,90,.95));
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      box-shadow: 0 18px 45px rgba(215,180,90,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      color:rgba(243,241,234,.92);
      background: rgba(20,20,20,.75);
      border:1px solid rgba(215,180,90,.22);
      box-shadow:none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn.ghost{
      color:rgba(243,241,234,.85);
      background: transparent;
      border:1px solid rgba(215,180,90,.18);
      box-shadow:none;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .field{
      display:flex; flex-direction:column; gap:8px;
      margin:12px 0;
    }
    .label{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(243,241,234,.65);
      font-weight:800;
    }
    .input, .textarea, .select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(215,180,90,.18);
      background: rgba(8,8,8,.65);
      color:rgba(243,241,234,.92);
      outline:none;
    }
    .textarea{ min-height:110px; resize:vertical; }
    .help{
      font-size:12px;
      color:rgba(243,241,234,.62);
      line-height:1.35;
    }

    /* List */
    .listWrap{
      border:1px solid rgba(215,180,90,.16);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(10,10,10,.55);
    }
    .listTop{
      padding:12px 12px;
      border-bottom:1px solid rgba(215,180,90,.14);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background: rgba(0,0,0,.25);
    }
    .list{
      max-height: 56vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .item{
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:12px;
      padding:12px 12px;
      border-bottom:1px solid rgba(215,180,90,.10);
      cursor:pointer;
      user-select:none;
    }
    .item:last-child{ border-bottom:none; }
    .item:hover{ background: rgba(215,180,90,.06); }
    .nbox{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      border:1px solid rgba(215,180,90,.18);
      border-radius:14px;
      background: rgba(12,12,12,.8);
      padding:8px 6px;
      gap:6px;
    }
    .nbox .num{
      font-weight:900;
      color:rgba(243,241,234,.95);
      font-size:13px;
    }
    .nbox .tri{
      font-family: "Times New Roman", Georgia, serif;
      direction: rtl;
      color: var(--gold2);
      font-weight:800;
      font-size:15px;
      letter-spacing:.06em;
      line-height:1;
    }
    .itTitle{
      font-weight:900;
      font-size:15px;
      margin:0;
    }
    .itSub{
      margin-top:4px;
      font-size:12px;
      color:rgba(243,241,234,.70);
      line-height:1.3;
    }

    /* Detail */
    .detail{
      border:1px solid rgba(215,180,90,.16);
      border-radius: 18px;
      background: rgba(10,10,10,.55);
      overflow:hidden;
    }
    .detail .top{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(215,180,90,.14);
      display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }
    .bigTri{
      font-family: "Times New Roman", Georgia, serif;
      direction: rtl;
      font-size:42px;
      letter-spacing:.08em;
      line-height:1.1;
      color: var(--gold2);
      text-shadow: 0 18px 65px rgba(215,180,90,.18);
      font-weight:900;
    }
    .kTitle{ font-size:18px; font-weight:950; margin:0; }
    .kSub{ margin-top:6px; color:rgba(243,241,234,.72); font-size:13px; line-height:1.35; }

    .steps{
      padding:12px 14px 14px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .step{
      border:1px solid rgba(215,180,90,.14);
      border-radius: 16px;
      padding:12px;
      background: rgba(8,8,8,.55);
    }
    .step .st{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:rgba(243,241,234,.62);
      font-weight:900;
      margin-bottom:8px;
    }
    .step .tx{
      font-size:13px;
      color:rgba(243,241,234,.84);
      line-height:1.45;
    }

    /* Bottom nav */
    .nav{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
      z-index:30;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,.65), transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top:1px solid rgba(215,180,90,.12);
    }
    .tabs{
      width:min(980px,100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .tab{
      border:1px solid rgba(215,180,90,.14);
      background: rgba(12,12,12,.65);
      color:rgba(243,241,234,.72);
      border-radius: 16px;
      padding:10px 10px;
      text-align:center;
      font-weight:900;
      font-size:12px;
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(215,180,90,.12);
      border-color: rgba(215,180,90,.28);
      color: rgba(243,241,234,.92);
      box-shadow: 0 12px 40px rgba(215,180,90,.10);
    }

    /* Splash / Connect gate */
    .gate{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 900px at 50% -10%, rgba(215,180,90,.16), transparent 55%),
        radial-gradient(900px 800px at 70% 30%, rgba(215,180,90,.10), transparent 55%),
        radial-gradient(700px 700px at 30% 40%, rgba(215,180,90,.08), transparent 55%),
        #000;
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .gateCard{
      width:min(820px, 100%);
      border:1px solid rgba(215,180,90,.22);
      border-radius: 28px;
      background: rgba(8,8,8,.72);
      box-shadow: 0 30px 90px rgba(0,0,0,.72);
      overflow:hidden;
    }
    .gateCard .gTop{
      padding:18px 18px 14px;
      border-bottom:1px solid rgba(215,180,90,.14);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .seal{
      display:flex; flex-direction:column; gap:6px;
    }
    .seal .big{
      font-weight:1000;
      letter-spacing:.32em;
      text-transform:uppercase;
      color: var(--gold2);
      font-size:18px;
    }
    .seal .small{
      font-size:12px;
      color:rgba(243,241,234,.68);
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:900;
    }
    .gateCard .gBody{
      padding:18px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .gateCard .gBody{ grid-template-columns:1fr; }
    }
    .kavanah{
      border:1px solid rgba(215,180,90,.14);
      border-radius: 22px;
      padding:14px;
      background: rgba(0,0,0,.25);
    }
    .kavanah .line{
      font-size:15px;
      line-height:1.45;
      color:rgba(243,241,234,.88);
    }
    .kavanah .mut{
      margin-top:10px;
      font-size:12px;
      color:rgba(243,241,234,.62);
      line-height:1.4;
    }
    .breath{
      border:1px solid rgba(215,180,90,.14);
      border-radius: 22px;
      padding:14px;
      background: rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .breath .meter{
      height:10px;
      border-radius:999px;
      background: rgba(215,180,90,.10);
      overflow:hidden;
      border:1px solid rgba(215,180,90,.16);
    }
    .breath .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(240,210,138,.95), rgba(215,180,90,.95));
      border-radius:999px;
      transition: width .25s ease;
    }
    .breath .hint{
      font-size:12px;
      color:rgba(243,241,234,.68);
      line-height:1.35;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 92px);
      z-index:9999;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(215,180,90,.22);
      background: rgba(0,0,0,.78);
      color: rgba(243,241,234,.92);
      font-size:12px;
      box-shadow: 0 20px 70px rgba(0,0,0,.6);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      max-width:min(680px, 92vw);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ opacity:1; }

    /* Error overlay */
    .err{
      position:fixed;
      left:12px; right:12px;
      top: calc(env(safe-area-inset-top) + 68px);
      z-index:9998;
      display:none;
      border:1px solid rgba(255,120,120,.35);
      background: rgba(30,0,0,.65);
      color: rgba(255,235,235,.95);
      border-radius: 18px;
      padding:12px;
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .err pre{
      margin:10px 0 0;
      font-family: var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      color: rgba(255,235,235,.9);
    }

    /* Canvas preview */
    .canvasWrap{
      border:1px solid rgba(215,180,90,.16);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,.35);
    }
    canvas{ display:block; width:100%; height:auto; }

    /* Hide/Show sections */
    .screen{ display:none; }
    .screen.active{ display:block; }
  </style>
</head>

<body>
  <!-- error overlay -->
  <div id="err" class="err">
    <div style="display:flex; gap:10px; align-items:center;">
      <div style="font-weight:950;">KAI caught an error</div>
      <div class="spacer"></div>
      <button class="btn secondary" id="btnErrHide" type="button">Hide</button>
    </div>
    <pre id="errTxt"></pre>
  </div>

  <!-- top bar -->
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <div class="kai">KAI</div>
        <div class="tag">Kabbalah Always Illuminates</div>
      </div>
      <div class="pill" title="Current selection">
        <span class="dot"></span>
        <span id="pillText">Ready</span>
      </div>
    </div>
  </div>

  <!-- connect gate -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gateCard">
      <div class="gTop">
        <div class="seal">
          <div class="big">KAI</div>
          <div class="small">Connect, then study</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnGateSkip" type="button">Skip</button>
          <button class="btn" id="btnGateEnter" type="button">Connect</button>
        </div>
      </div>

      <div class="gBody">
        <div class="kavanah">
          <div class="line" style="font-weight:900; color:rgba(243,241,234,.94);">
            One breath. One restriction. One choice.
          </div>
          <div class="line" style="margin-top:10px;">
            I pause. I soften. I connect to the Light.
          </div>
          <div class="mut">
            This is the door. The app is the study.  
            You‚Äôre building a global Mishkan by making the work repeatable.
          </div>
        </div>

        <div class="breath">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div style="font-weight:950; letter-spacing:.08em;">Breath cycle</div>
            <div id="breathLabel" style="font-size:12px; color:rgba(243,241,234,.70);">Idle</div>
          </div>
          <div class="meter"><div id="breathBar" class="bar"></div></div>
          <div class="hint" id="breathHint">
            Tap <b>Connect</b>. We‚Äôll do a short inhale, hold, exhale. Then you enter.
          </div>
          <div class="row">
            <button class="btn secondary" id="btnGateRestart" type="button">Restart</button>
            <div class="spacer"></div>
            <div style="font-size:12px; color:rgba(243,241,234,.62);">
              Target: <b>one clean connection</b> ‚úÖ
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- main app -->
  <div class="app" id="app">
    <div class="container">

      <!-- STUDY -->
      <div id="screenStudy" class="screen active">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <h2 class="h1">Study</h2>
              <div class="sub">Choose a Name. Scan right-to-left. Read. Practice. Repeat. üîÅ</div>
            </div>
            <div class="row">
              <button class="btn secondary" id="btnRandom" type="button">Random</button>
              <button class="btn secondary" id="btnResume" type="button">Resume</button>
            </div>
          </div>

          <div class="bd">
            <div class="grid">
              <div>
                <div class="listWrap">
                  <div class="listTop">
                    <input id="q" class="input" placeholder="Search (e.g., Unity, Fear, Prosperity)..." />
                    <select id="filter" class="select" style="max-width:220px;">
                      <option value="all">All 72</option>
                      <option value="saved">Only with notes</option>
                    </select>
                  </div>
                  <div id="list" class="list"></div>
                </div>
                <div class="help" style="margin-top:10px;">
                  Tip: your meeting mode is ‚Äúclean demo.‚Äù Pick 3 Names quickly, generate 3 share cards, done. ‚ú®
                </div>
              </div>

              <div>
                <div id="detail" class="detail">
                  <div class="top">
                    <div style="min-width:110px;">
                      <div class="bigTri" id="dTri">◊ï◊î◊ï</div>
                    </div>
                    <div style="flex:1; min-width:240px;">
                      <div class="row" style="align-items:center;">
                        <div style="font-weight:1000; color:rgba(243,241,234,.92);">#<span id="dNum">1</span></div>
                        <div class="spacer"></div>
                        <button class="btn secondary" id="btnToCard" type="button">To Share Card</button>
                      </div>
                      <p class="kTitle" id="dTitle">Time Travel</p>
                      <div class="kSub" id="dSub">How to fix the past</div>
                    </div>
                  </div>

                  <div class="steps">
                    <div class="step">
                      <div class="st">How to use (Centre-style)</div>
                      <div class="tx">
                        1) Set aside 10 minutes. <br/>
                        2) Scan the letters right-to-left. <br/>
                        3) Close your eyes and visualize the letters. <br/>
                        4) Read the wisdom. Choose a physical action that matches it.
                      </div>
                    </div>

                    <div class="step">
                      <div class="st">Practice prompt</div>
                      <div class="tx" id="dPrompt">
                        What is one thing I can restrict today so the Light can pass through?
                      </div>
                    </div>

                    <div class="step">
                      <div class="st">Notes</div>
                      <textarea id="dNotes" class="textarea" placeholder="Write what you witnessed. Keep it practical."></textarea>
                      <div class="row">
                        <button class="btn" id="btnSaveNotes" type="button">Save</button>
                        <button class="btn secondary" id="btnClearNotes" type="button">Clear</button>
                        <div class="spacer"></div>
                        <button class="btn ghost" id="btnCopyTriplet" type="button">Copy letters</button>
                      </div>
                      <div class="help">Notes are saved on-device (localStorage). No account. No drama.</div>
                    </div>
                  </div>
                </div>

              </div>
            </div><!-- grid -->
          </div><!-- bd -->
        </div><!-- card -->
      </div><!-- screenStudy -->

      <!-- SHARE CARD -->
      <div id="screenCard" class="screen">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <h2 class="h1">Share Card</h2>
              <div class="sub">Luxury black + gold. Export as JPEG. Share from iPhone/iPad. üñ§‚ú®</div>
            </div>
            <div class="row">
              <button class="btn secondary" id="btnCardLoadSelected" type="button">Use selected</button>
              <button class="btn secondary" id="btnCardRandom" type="button">Random</button>
            </div>
          </div>

          <div class="bd">
            <div class="grid">
              <div>
                <div class="field">
                  <div class="label">Name</div>
                  <select id="cardPick" class="select"></select>
                </div>

                <div class="field">
                  <div class="label">Five-word vibe</div>
                  <input id="cardVibe" class="input" placeholder="e.g., Pause. Restrict. Listen. Choose. Light." />
                  <div class="help">Five words. Clean. Commanding. No sermon.</div>
                </div>

                <div class="field">
                  <div class="label">Reflection (optional)</div>
                  <textarea id="cardNote" class="textarea" placeholder="One practical insight or action."></textarea>
                </div>

                <div class="row">
                  <button class="btn" id="btnRender" type="button">Generate</button>
                  <button class="btn secondary" id="btnShareJpg" type="button">Share JPEG</button>
                  <button class="btn ghost" id="btnDownloadJpg" type="button">Save JPEG</button>
                </div>

                <div class="help" style="margin-top:10px;">
                  If Share fails on iPad: use ‚ÄúSave JPEG‚Äù then share from Photos.
                </div>
              </div>

              <div>
                <div class="canvasWrap">
                  <canvas id="cardCanvas" width="1200" height="1500"></canvas>
                </div>
                <div class="help" style="margin-top:10px;">
                  Canvas is rendered locally. No uploads. No tracking.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- screenCard -->

      <!-- LIBRARY -->
      <div id="screenLibrary" class="screen">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <h2 class="h1">Library</h2>
              <div class="sub">Pre-meeting content: clear, Centre-neutral, Atika-forward. üìö</div>
            </div>
          </div>
          <div class="bd">
            <div class="card" style="background:rgba(10,10,10,.40); box-shadow:none;">
              <div class="hd" style="border-bottom:1px solid rgba(215,180,90,.14);">
                <div class="hgroup">
                  <h3 class="h1" style="font-size:16px;">Atika Kadisha</h3>
                  <div class="sub">A placeholder shelf (so the architecture is obvious in demo).</div>
                </div>
              </div>
              <div class="bd">
                <div class="help">
                  This build keeps Library lightweight and stable.  
                  Next step (post-Eitan): swap these placeholders with verified Zohar excerpts + your preferred translations.
                </div>

                <div class="field">
                  <div class="label">Focus list</div>
                  <div class="step">
                    <div class="tx">
                      ‚Ä¢ Atika Kadisha (Ancient of Days) as ‚Äúsource layer‚Äù concept<br/>
                      ‚Ä¢ Alignment ‚Üí Restriction ‚Üí Witness ‚Üí Illuminate ‚Üí Seal<br/>
                      ‚Ä¢ ‚ÄúPersonally witness the power of the work‚Äù at scale (repeatable reps)
                    </div>
                  </div>
                </div>

                <div class="field">
                  <div class="label">Add a note (saved locally)</div>
                  <textarea id="libNote" class="textarea" placeholder="What do I want Eitan to react to?"></textarea>
                  <div class="row">
                    <button class="btn" id="btnLibSave" type="button">Save</button>
                    <button class="btn secondary" id="btnLibClear" type="button">Clear</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div><!-- screenLibrary -->

      <!-- SETTINGS -->
      <div id="screenSettings" class="screen">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <h2 class="h1">Settings</h2>
              <div class="sub">Reset, export, and stability controls. ‚öôÔ∏è</div>
            </div>
          </div>

          <div class="bd">
            <div class="step">
              <div class="st">Storage</div>
              <div class="tx">
                Notes + last selection are saved locally on this device.
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn secondary" id="btnResetNotes" type="button">Clear all notes</button>
                <button class="btn secondary" id="btnResetAll" type="button">Factory reset</button>
                <div class="spacer"></div>
                <button class="btn ghost" id="btnExport" type="button">Export JSON</button>
              </div>
              <div class="help" style="margin-top:10px;">
                Export gives you a single JSON file containing notes + last selections.
              </div>
            </div>

            <div class="step" style="margin-top:14px;">
              <div class="st">Connect gate</div>
              <div class="tx">
                If you want the Connect gate every time, enable it below.
              </div>
              <div class="row" style="margin-top:10px;">
                <label class="pill" style="cursor:pointer;">
                  <input id="alwaysGate" type="checkbox" style="accent-color: var(--gold);" />
                  Always show Connect gate
                </label>
              </div>
            </div>

            <div class="step" style="margin-top:14px;">
              <div class="st">About</div>
              <div class="tx">
                KAI is a ritual engine: not content-first, practice-first.  
                Build reps. Create proof. Scale the witness.
              </div>
            </div>
          </div>
        </div>
      </div><!-- screenSettings -->

    </div><!-- container -->
  </div><!-- app -->

  <!-- bottom nav -->
  <div class="nav">
    <div class="tabs">
      <div class="tab active" data-tab="Study">Study</div>
      <div class="tab" data-tab="Card">Share</div>
      <div class="tab" data-tab="Library">Library</div>
      <div class="tab" data-tab="Settings">Settings</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    "use strict";

    /* ---------------------------
       Tiny helpers
    ----------------------------*/
    const $ = (id)=>document.getElementById(id);
    const nowISO = ()=> new Date().toISOString();

    function toast(msg){
      const t = $("toast");
      t.textContent = String(msg || "");
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), 2200);
    }

    function showErr(msg){
      const box = $("err");
      $("errTxt").textContent = String(msg || "");
      box.style.display = "block";
    }
    function clearErr(){ $("err").style.display="none"; $("errTxt").textContent=""; }

    // Crash visibility
    window.addEventListener("error", (e)=>{
      try{
        const m = "JS ERROR: " + (e?.message || "unknown") + "\n" + (e?.error?.stack || "");
        showErr(m);
      }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{
        const m = "PROMISE ERROR: " + (e?.reason?.message || String(e?.reason || "unknown"));
        showErr(m);
      }catch{}
    });

    $("btnErrHide").addEventListener("click", clearErr);

    /* ---------------------------
       Data (Interpretations)
       Titles/subtitles are from your provided screenshots.
       Hebrew triplets: standard ordering used broadly for the 72 Names.
    ----------------------------*/

    // Standard 72 triplets (right-to-left scanning). If you already have a verified list, swap it here.
    const TRIPLETS = [
      "◊ï◊î◊ï","◊ô◊ú◊ô","◊°◊ô◊ò","◊¢◊ú◊ù","◊û◊î◊©","◊ú◊ú◊î","◊ê◊õ◊ê","◊õ◊î◊™","◊î◊ñ◊ô","◊ê◊ú◊ì","◊ú◊ê◊ï","◊î◊î◊¢",
      "◊ô◊ñ◊ú","◊û◊ë◊î","◊î◊®◊ô","◊î◊ß◊ù","◊ú◊ê◊ï","◊õ◊ú◊ô","◊ú◊ï◊ï","◊§◊î◊ú","◊†◊ú◊ö","◊ô◊ô◊ô","◊û◊ú◊î","◊ó◊î◊ï",
      "◊†◊™◊î","◊î◊ê◊ê","◊ô◊®◊™","◊©◊ê◊î","◊®◊ô◊ô","◊ê◊ï◊ù","◊ú◊õ◊ë","◊ï◊©◊ô◊®","◊ô◊ó◊®","◊ú◊ô◊î","◊õ◊ï◊ß","◊û◊†◊ñ",
      "◊ê◊†◊ô","◊ó◊¢◊ô◊ù","◊®◊î◊¢","◊ô◊ô◊ñ","◊î◊î◊î","◊û◊ô◊õ","◊ï◊ï◊ú","◊ô◊ú◊î","◊°◊ê◊ú","◊¢◊®◊ô","◊¢◊©◊ú","◊û◊ô◊î",
      "◊ï◊î◊ï","◊ì◊†◊ô","◊î◊ó◊©","◊¢◊û◊®","◊†◊†◊ê","◊†◊ô◊™","◊û◊ë◊î","◊§◊ï◊ô","◊†◊û◊©","◊ô◊ô◊ú","◊î◊®◊ó","◊û◊¶◊®",
      "◊ï◊û◊ë","◊ô◊î◊î","◊¢◊†◊ï◊ô","◊û◊ó◊ô","◊ì◊û◊ë","◊û◊†◊ß","◊ê◊ô◊¢◊ú","◊ó◊ë◊ï","◊®◊ê◊î","◊ô◊ë◊û","◊î◊ô◊ô","◊û◊ï◊ù"
    ];

    const NAMES = [
      {n:1,  t:"Time Travel", s:"How to fix the past"},
      {n:2,  t:"Recapturing the Sparks", s:"Recharging when you are depleted"},
      {n:3,  t:"Miracle Making", s:"A recipe"},
      {n:4,  t:"Eliminating Negative Thoughts", s:"When and how"},
      {n:5,  t:"Healing", s:"Meditation for yourself and others"},
      {n:6,  t:"Dream State", s:"Activating messages from the subconscious"},
      {n:7,  t:"DNA of Soul", s:"Restoring to their perfect state"},
      {n:8,  t:"Defusing Negative Energy and Stress", s:"Releasing the pressure"},
      {n:9,  t:"Angelic Influences", s:"Harnessing help from above"},
      {n:10, t:"Looks Can Kill", s:"Protecting yourself from the evil-eye"},
      {n:11, t:"Banishing the Remnants of Evil", s:"Purifying places and spaces"},
      {n:12, t:"Unconditional Love", s:"How to awaken love, especially when you don‚Äôt feel it"},
      {n:13, t:"Heaven on Earth", s:"Creating harmony within and without"},
      {n:14, t:"Farewell to Arms", s:"Diffusing conflict"},
      {n:15, t:"Long-Range Vision", s:"Seeing the effect of decisions before you make them"},
      {n:16, t:"Dumping Depression", s:"How to pick yourself up when you fall"},
      {n:17, t:"Great Escape", s:"Breaking the limits of ego"},
      {n:18, t:"Fertility", s:"When conception is difficult"},
      {n:19, t:"Dialing God", s:"Receiving answers to your prayers"},
      {n:20, t:"Victory Over Addictions", s:"Overcoming your negative self"},
      {n:21, t:"Eradicate Plague", s:"Effecting change in the physical world"},
      {n:22, t:"Stop Fatal Attraction", s:"How to stop drawing the wrong people into your life"},
      {n:23, t:"Sharing the Flame", s:"Passing the wisdom along"},
      {n:24, t:"Jealousy", s:"Undoing chaos resulting from our jealousy"},
      {n:25, t:"Speak Your Mind", s:"For those times when you need help expressing yourself"},
      {n:26, t:"Order from Chaos", s:"Reversing Murphy‚Äôs Law"},
      {n:27, t:"Silent Partner", s:"Choosing positivity as your partner"},
      {n:28, t:"Soul Mate", s:"Attracting ‚ÄúThe One‚Äù"},
      {n:29, t:"Removing Hatred", s:"Drawing out the poison"},
      {n:30, t:"Building Bridges", s:"Mending broken relationships"},
      {n:31, t:"Finish What You Start", s:"Finding the power to finish what you start"},
      {n:32, t:"Memories", s:"Breaking the cycle"},
      {n:33, t:"Revealing the Dark Side", s:"Removing the obstacles you create"},
      {n:34, t:"Forget Thyself", s:"Opening up to another view"},
      {n:35, t:"Sexual Energy", s:"How to get more from your sexual experience"},
      {n:36, t:"Fear(less)", s:"Overcoming the ties that bind"},
      {n:37, t:"The Big Picture", s:"Seeing the opportunity for good hidden in every challenge"},
      {n:38, t:"Circuitry", s:"Sharing so you can truly receive"},
      {n:39, t:"Diamond in the Rough", s:"Turning the coal in your life into diamonds"},
      {n:40, t:"Speaking the Right Words", s:"Using language to make good things happen"},
      {n:41, t:"Self-Esteem", s:"Finding the power to lift yourself up"},
      {n:42, t:"Revealing the Concealed", s:"Seeing the truth and handling it"},
      {n:43, t:"Defying Gravity", s:"Achieving mind over matter"},
      {n:44, t:"Sweetening Judgment", s:"Ducking the boomerang you send out there"},
      {n:45, t:"The Power of Prosperity", s:"What to do when you need money"},
      {n:46, t:"Absolute Certainty", s:"What to do when doubts creep in"},
      {n:47, t:"Global Transformation", s:"Helping to bring about world peace"},
      {n:48, t:"Unity", s:"When there is conflict and only togetherness will do"},
      {n:49, t:"Happiness", s:"When you need the power to choose happiness"},
      {n:50, t:"Enough Is Never Enough", s:"When you need the passion to keep from settling for less"},
      {n:51, t:"No Guilt", s:"Removing negativity aspects of your nature while you repair the damage they cause"},
      {n:52, t:"Passion", s:"Awaken the yearning in your heart"},
      {n:53, t:"No Agenda", s:"Giving with no strings attached"},
      {n:54, t:"The Death of Death", s:"When things are good and you want them to stay that way"},
      {n:55, t:"Thought into Action", s:"The power to make it happen"},
      {n:56, t:"Dispelling Anger", s:"Overcoming it before it overcomes you"},
      {n:57, t:"Listen to Your Soul", s:"Increasing the volume of the soft voice within"},
      {n:58, t:"Letting Go", s:"When you need the power to walk away"},
      {n:59, t:"Umbilical Cord", s:"Connecting to the Light Force"},
      {n:60, t:"Freedom", s:"Passing the test and going to the next level"},
      {n:61, t:"Water", s:"Removing negativity from the source of life"},
      {n:62, t:"Parent‚ÄìTeacher, Not Preacher", s:"When you need to teach your children"},
      {n:63, t:"Appreciation", s:"How to keep what you have and get more"},
      {n:64, t:"Casting Yourself in a Favorable Light", s:"Revealing the best you"},
      {n:65, t:"Fear of God", s:"When you need to remember that there is a purpose"},
      {n:66, t:"Accountability", s:"The power to take accountability for your life"},
      {n:67, t:"Great Expectations", s:"How to stop getting disappointed"},
      {n:68, t:"Contacting Departed Souls", s:"Making positive connections with people who have passed on"},
      {n:69, t:"Lost and Found", s:"What to do when you are lost and confused"},
      {n:70, t:"Recognizing Design Beneath the Surface", s:"Finding the solution within the problem"},
      {n:71, t:"Prophecy and Parallel Universes", s:"Switching your universe for a better one"},
      {n:72, t:"Spiritual Cleansing", s:"Purging yourself of negativity"},
    ].map(x=>({ ...x, h: TRIPLETS[x.n-1] || "‚Äî" }));

    /* ---------------------------
       Storage
    ----------------------------*/
    const KEY = {
      lastN: "kai_last_n_v1",
      notes: (n)=>`kai_note_${n}_v1`,
      lib: "kai_lib_note_v1",
      alwaysGate: "kai_always_gate_v1"
    };

    function saveLast(n){ localStorage.setItem(KEY.lastN, String(n)); }
    function loadLast(){ return Number(localStorage.getItem(KEY.lastN) || "1") || 1; }

    function saveNote(n, txt){ localStorage.setItem(KEY.notes(n), txt ?? ""); }
    function loadNote(n){ return localStorage.getItem(KEY.notes(n)) || ""; }

    function anyNote(n){
      const v = (localStorage.getItem(KEY.notes(n)) || "").trim();
      return v.length>0;
    }

    /* ---------------------------
       State
    ----------------------------*/
    let currentN = loadLast();
    let breathTimer = null;

    /* ---------------------------
       UI: Tabs
    ----------------------------*/
    function setTab(tab){
      // tabs highlight
      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("active", el.dataset.tab === tab);
      });

      // screens
      const map = {
        Study: $("screenStudy"),
        Card: $("screenCard"),
        Library: $("screenLibrary"),
        Settings: $("screenSettings"),
      };
      Object.values(map).forEach(s=>s.classList.remove("active"));
      map[tab].classList.add("active");

      // scroll to top for clarity
      $("app").scrollTo({top:0, behavior:"smooth"});
    }

    document.querySelectorAll(".tab").forEach(el=>{
      el.addEventListener("click", ()=>setTab(el.dataset.tab));
    });

    /* ---------------------------
       Study list render
    ----------------------------*/
    function renderList(){
      const q = ($("q").value || "").trim().toLowerCase();
      const mode = $("filter").value;

      const rows = NAMES.filter(x=>{
        const hit = !q || (String(x.n).includes(q) || x.t.toLowerCase().includes(q) || x.s.toLowerCase().includes(q));
        const keep = mode === "all" ? true : anyNote(x.n);
        return hit && keep;
      });

      const list = $("list");
      list.innerHTML = "";

      rows.forEach(x=>{
        const div = document.createElement("div");
        div.className = "item";
        div.setAttribute("role","button");
        div.setAttribute("tabindex","0");

        div.innerHTML = `
          <div class="nbox">
            <div class="num">${x.n}</div>
            <div class="tri">${escapeHtml(x.h)}</div>
          </div>
          <div>
            <div class="itTitle">${escapeHtml(x.t)}</div>
            <div class="itSub">${escapeHtml(x.s)}</div>
          </div>
        `;

        div.addEventListener("click", ()=>selectName(x.n));
        div.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"||e.key===" "){ e.preventDefault(); selectName(x.n); }
        });

        list.appendChild(div);
      });

      if(rows.length===0){
        const empty = document.createElement("div");
        empty.style.padding="14px";
        empty.style.color="rgba(243,241,234,.70)";
        empty.textContent="No matches.";
        list.appendChild(empty);
      }
    }

    $("q").addEventListener("input", renderList);
    $("filter").addEventListener("change", renderList);

    /* ---------------------------
       Detail panel
    ----------------------------*/
    function promptFor(n){
      // Simple, stable prompt that still feels intelligent without hallucinating content.
      const name = NAMES[n-1];
      const base = [
        "What is one reaction I can restrict today?",
        "What is one physical action that proves the change?",
        "Where can I choose certainty over doubt?",
        "What would love do right now?",
        "What‚Äôs the smallest step with the highest Light?"
      ];
      // deterministic-ish variation
      const idx = (n * 7) % base.length;
      return `${name.t}: ${base[idx]}`;
    }

    function selectName(n){
      n = Math.max(1, Math.min(72, Number(n)||1));
      currentN = n;
      saveLast(n);

      const x = NAMES[n-1];
      $("dNum").textContent = String(x.n);
      $("dTri").textContent = x.h;
      $("dTitle").textContent = x.t;
      $("dSub").textContent = x.s;
      $("dPrompt").textContent = promptFor(n);

      $("dNotes").value = loadNote(n);

      $("pillText").textContent = `#${x.n} ‚Ä¢ ${x.t}`;
      // keep card pick synced
      $("cardPick").value = String(n);
      // load notes into card note lightly
      const note = loadNote(n).trim();
      if(note && ($("cardNote").value||"").trim().length===0){
        $("cardNote").value = note;
      }

      toast(`Selected #${x.n}: ${x.t}`);
    }

    $("btnSaveNotes").addEventListener("click", ()=>{
      saveNote(currentN, $("dNotes").value || "");
      toast("Saved");
      renderList();
    });

    $("btnClearNotes").addEventListener("click", ()=>{
      $("dNotes").value = "";
      saveNote(currentN, "");
      toast("Cleared");
      renderList();
    });

    $("btnCopyTriplet").addEventListener("click", async ()=>{
      try{
        const txt = (NAMES[currentN-1]?.h || "").trim();
        await navigator.clipboard.writeText(txt);
        toast("Copied letters");
      }catch{
        toast("Copy not available");
      }
    });

    $("btnRandom").addEventListener("click", ()=>{
      const n = 1 + Math.floor(Math.random()*72);
      selectName(n);
    });

    $("btnResume").addEventListener("click", ()=>{
      selectName(loadLast());
    });

    $("btnToCard").addEventListener("click", ()=>{
      setTab("Card");
      $("cardPick").value = String(currentN);
      // default vibe if empty
      if(!($("cardVibe").value||"").trim()){
        $("cardVibe").value = "Pause. Restrict. Listen. Choose. Light.";
      }
      renderCard();
      toast("Card ready");
    });

    /* ---------------------------
       Share card
    ----------------------------*/
    function fillCardPick(){
      const sel = $("cardPick");
      sel.innerHTML = "";
      NAMES.forEach(x=>{
        const opt = document.createElement("option");
        opt.value = String(x.n);
        opt.textContent = `#${x.n} ‚Ä¢ ${x.t}`;
        sel.appendChild(opt);
      });
      sel.value = String(currentN);
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = (text||"").split(/\s+/).filter(Boolean);
      let line = "";
      const lines = [];
      for(const w of words){
        const test = line ? (line + " " + w) : w;
        const m = ctx.measureText(test).width;
        if(m > maxWidth && line){
          lines.push(line);
          line = w;
        }else{
          line = test;
        }
      }
      if(line) lines.push(line);
      lines.forEach((ln,i)=>ctx.fillText(ln, x, y + i*lineHeight));
      return lines.length;
    }

    function renderCard(){
      const n = Number($("cardPick").value || currentN) || currentN;
      const x = NAMES[n-1];

      const vibe = ($("cardVibe").value || "").trim();
      const note = ($("cardNote").value || "").trim();

      const canvas = $("cardCanvas");
      const ctx = canvas.getContext("2d");

      // Background
      ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.fillStyle = "#050505";
      ctx.fillRect(0,0,canvas.width, canvas.height);

      // Soft gold aura
      const g1 = ctx.createRadialGradient(canvas.width*0.50, canvas.height*0.10, 10, canvas.width*0.50, canvas.height*0.10, canvas.width*0.75);
      g1.addColorStop(0, "rgba(215,180,90,0.20)");
      g1.addColorStop(1, "rgba(215,180,90,0.00)");
      ctx.fillStyle = g1;
      ctx.fillRect(0,0,canvas.width, canvas.height);

      // Frame
      ctx.strokeStyle = "rgba(215,180,90,0.55)";
      ctx.lineWidth = 4;
      const pad = 48;
      roundRect(ctx, pad, pad, canvas.width-pad*2, canvas.height-pad*2, 36);
      ctx.stroke();

      ctx.strokeStyle = "rgba(215,180,90,0.18)";
      ctx.lineWidth = 2;
      roundRect(ctx, pad+18, pad+18, canvas.width-(pad+18)*2, canvas.height-(pad+18)*2, 30);
      ctx.stroke();

      // Header
      ctx.fillStyle = "rgba(240,210,138,0.92)";
      ctx.font = "900 30px " + cssFont();
      ctx.textAlign = "left";
      ctx.fillText("KAI", pad+28, pad+66);

      ctx.fillStyle = "rgba(243,241,234,0.62)";
      ctx.font = "800 18px " + cssFont();
      ctx.fillText("Kabbalah Always Illuminates", pad+28, pad+96);

      // Name number
      ctx.textAlign = "right";
      ctx.fillStyle = "rgba(243,241,234,0.75)";
      ctx.font = "900 20px " + cssFont();
      ctx.fillText(`#${x.n}`, canvas.width-pad-28, pad+76);

      // Triplet big
      ctx.textAlign = "center";
      ctx.fillStyle = "rgba(240,210,138,0.98)";
      ctx.font = "900 118px Times New Roman";
      ctx.direction = "rtl";
      ctx.fillText(x.h, canvas.width/2, pad+240);
      ctx.direction = "ltr";

      // Title + subtitle
      ctx.textAlign = "center";
      ctx.fillStyle = "rgba(243,241,234,0.95)";
      ctx.font = "950 52px " + cssFont();
      wrapText(ctx, x.t, canvas.width/2, pad+330, canvas.width-(pad*2)-60, 60);

      ctx.fillStyle = "rgba(243,241,234,0.70)";
      ctx.font = "800 26px " + cssFont();
      wrapText(ctx, x.s, canvas.width/2, pad+420, canvas.width-(pad*2)-90, 34);

      // Divider
      ctx.strokeStyle = "rgba(215,180,90,0.18)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(pad+90, pad+510);
      ctx.lineTo(canvas.width-pad-90, pad+510);
      ctx.stroke();

      // Vibe block
      const vibeText = vibe || "Pause. Restrict. Witness. Choose. Light.";
      ctx.fillStyle = "rgba(240,210,138,0.95)";
      ctx.font = "900 34px " + cssFont();
      wrapText(ctx, vibeText, canvas.width/2, pad+590, canvas.width-(pad*2)-120, 42);

      // Note block
      if(note){
        ctx.fillStyle = "rgba(243,241,234,0.84)";
        ctx.font = "700 26px " + cssFont();
        ctx.textAlign = "center";
        const used = wrapText(ctx, note, canvas.width/2, pad+700, canvas.width-(pad*2)-130, 34);

        // If note is long, softly fade bottom
        if(used > 9){
          const fade = ctx.createLinearGradient(0, canvas.height-260, 0, canvas.height-120);
          fade.addColorStop(0,"rgba(5,5,5,0)");
          fade.addColorStop(1,"rgba(5,5,5,1)");
          ctx.fillStyle = fade;
          ctx.fillRect(pad, canvas.height-260, canvas.width-pad*2, 220);
        }
      }

      // Footer
      ctx.textAlign = "left";
      ctx.fillStyle = "rgba(243,241,234,0.55)";
      ctx.font = "800 18px " + cssFont();
      ctx.fillText("Scan right-to-left ‚Ä¢ Restrict reactivity ‚Ä¢ Take one action", pad+28, canvas.height-pad-54);

      ctx.textAlign = "right";
      ctx.fillStyle = "rgba(243,241,234,0.45)";
      ctx.font = "700 16px " + cssFont();
      ctx.fillText(new Date().toLocaleDateString(), canvas.width-pad-28, canvas.height-pad-54);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function cssFont(){
      // ensures spaces are fine in canvas font string
      return 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    }

    $("btnRender").addEventListener("click", ()=>{
      renderCard();
      toast("Generated");
    });

    $("btnCardLoadSelected").addEventListener("click", ()=>{
      $("cardPick").value = String(currentN);
      const note = loadNote(currentN).trim();
      if(note) $("cardNote").value = note;
      if(!($("cardVibe").value||"").trim()){
        $("cardVibe").value = "Pause. Restrict. Listen. Choose. Light.";
      }
      renderCard();
      toast("Loaded selection");
    });

    $("btnCardRandom").addEventListener("click", ()=>{
      const n = 1 + Math.floor(Math.random()*72);
      $("cardPick").value = String(n);
      $("cardNote").value = "";
      $("cardVibe").value = "Pause. Restrict. Witness. Choose. Light.";
      renderCard();
      toast("Random card");
    });

    $("cardPick").addEventListener("change", ()=>{
      renderCard();
    });

    async function canvasToJpegBlob(){
      const canvas = $("cardCanvas");
      return await new Promise((resolve)=>{
        canvas.toBlob((blob)=>resolve(blob), "image/jpeg", 0.92);
      });
    }

    $("btnDownloadJpg").addEventListener("click", async ()=>{
      try{
        const blob = await canvasToJpegBlob();
        if(!blob){ toast("Could not create JPEG"); return; }
        const n = Number($("cardPick").value||currentN);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `KAI_${String(n).padStart(2,"0")}.jpg`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
        toast("Saved JPEG");
      }catch(e){
        showErr(String(e?.stack || e));
      }
    });

    $("btnShareJpg").addEventListener("click", async ()=>{
      try{
        const blob = await canvasToJpegBlob();
        if(!blob){ toast("Could not create JPEG"); return; }

        const n = Number($("cardPick").value||currentN);
        const file = new File([blob], `KAI_${String(n).padStart(2,"0")}.jpg`, {type:"image/jpeg"});

        // iOS supports navigator.share with files on modern versions
        if(navigator.share && (!navigator.canShare || navigator.canShare({files:[file]}))){
          await navigator.share({
            title: "KAI Share Card",
            text: "KAI",
            files: [file]
          });
          toast("Shared");
        }else{
          // fallback: save
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `KAI_${String(n).padStart(2,"0")}.jpg`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
          toast("Share not supported here. Saved instead.");
        }
      }catch(e){
        toast("Share cancelled or blocked");
      }
    });

    /* ---------------------------
       Library notes
    ----------------------------*/
    $("btnLibSave").addEventListener("click", ()=>{
      localStorage.setItem(KEY.lib, $("libNote").value || "");
      toast("Saved");
    });
    $("btnLibClear").addEventListener("click", ()=>{
      $("libNote").value = "";
      localStorage.setItem(KEY.lib, "");
      toast("Cleared");
    });

    /* ---------------------------
       Settings
    ----------------------------*/
    $("btnResetNotes").addEventListener("click", ()=>{
      try{
        for(let i=1;i<=72;i++) localStorage.removeItem(KEY.notes(i));
        toast("All notes cleared");
        renderList();
      }catch(e){ showErr(String(e?.stack||e)); }
    });

    $("btnResetAll").addEventListener("click", ()=>{
      try{
        localStorage.clear();
        toast("Factory reset");
        location.reload();
      }catch(e){ showErr(String(e?.stack||e)); }
    });

    $("btnExport").addEventListener("click", ()=>{
      try{
        const out = {
          exported_at: nowISO(),
          last_n: loadLast(),
          always_gate: localStorage.getItem(KEY.alwaysGate) === "1",
          library_note: localStorage.getItem(KEY.lib) || "",
          notes: {}
        };
        for(let i=1;i<=72;i++){
          const v = (localStorage.getItem(KEY.notes(i)) || "").trim();
          if(v) out.notes[i] = v;
        }
        const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "KAI_export.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
        toast("Exported");
      }catch(e){ showErr(String(e?.stack||e)); }
    });

    $("alwaysGate").addEventListener("change", ()=>{
      localStorage.setItem(KEY.alwaysGate, $("alwaysGate").checked ? "1" : "0");
      toast($("alwaysGate").checked ? "Gate enabled" : "Gate disabled");
    });

    /* ---------------------------
       Connect gate breath cycle
    ----------------------------*/
    function stopBreath(){
      if(breathTimer){ clearInterval(breathTimer); breathTimer=null; }
      $("breathBar").style.width = "0%";
      $("breathLabel").textContent = "Idle";
      $("breathHint").innerHTML = "Tap <b>Connect</b>. We‚Äôll do a short inhale, hold, exhale. Then you enter.";
    }

    function runBreathThenEnter(){
      stopBreath();
      let t = 0;
      const total = 12; // seconds
      const phases = [
        {name:"Inhale", from:0, to:4},
        {name:"Hold",   from:4, to:6},
        {name:"Exhale", from:6, to:12}
      ];

      $("breathHint").innerHTML = "Follow the cue. Keep it simple. When you finish, you enter. ‚úÖ";

      breathTimer = setInterval(()=>{
        t += 0.25;
        const pct = Math.min(100, (t/total)*100);
        $("breathBar").style.width = pct.toFixed(1) + "%";

        const ph = phases.find(p=>t>=p.from && t<p.to) || phases[phases.length-1];
        $("breathLabel").textContent = ph.name;

        if(t >= total){
          stopBreath();
          hideGate();
          toast("Connected");
        }
      }, 250);
    }

    function hideGate(){
      $("gate").style.display = "none";
      $("gate").setAttribute("aria-hidden","true");
    }
    function showGate(){
      $("gate").style.display = "flex";
      $("gate").setAttribute("aria-hidden","false");
    }

    $("btnGateEnter").addEventListener("click", runBreathThenEnter);
    $("btnGateRestart").addEventListener("click", runBreathThenEnter);
    $("btnGateSkip").addEventListener("click", ()=>{
      stopBreath();
      hideGate();
      toast("Skipped");
    });

    /* ---------------------------
       Utilities
    ----------------------------*/
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* ---------------------------
       Boot
    ----------------------------*/
    function boot(){
      clearErr();

      // Gate preference
      const always = localStorage.getItem(KEY.alwaysGate) === "1";
      $("alwaysGate").checked = always;

      if(always){
        showGate();
      }else{
        // show once per load, but user can skip quickly
        showGate();
      }

      // load library note
      $("libNote").value = localStorage.getItem(KEY.lib) || "";

      // fill selects
      fillCardPick();

      // list + selection
      renderList();
      selectName(loadLast());

      // initial card render
      $("cardVibe").value = "Pause. Restrict. Listen. Choose. Light.";
      renderCard();

      toast("KAI online");
    }

    boot();
  </script>
</body>
</html>
