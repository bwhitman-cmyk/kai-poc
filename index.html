<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <!-- iOS Home Screen icon (must exist at site root) -->
<link rel="apple-touch-icon" href="/kai-icon.png?v=9" />
  <!-- PWA manifest (must exist at site root) -->
  <link rel="manifest" href="/manifest.webmanifest?v=9" />

  <title>KAI</title>

  <style>
    :root{
      --bg:#070708;
      --panel:#0e0f12;
      --panel2:#0b0c0e;
      --text:#f3f3f4;
      --muted:#b3b3b7;
      --gold:#c8a24a;
      --gold2:#8f6f2a;
      --line:rgba(255,255,255,.08);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius:18px;

      /* BIGGER BASE TYPE (fixes tiny UI) */
      --base: 19px;
      --h1: 38px;
      --h2: 18px;
      --label: 15px;
      --input: 18px;
      --btn: 17px;

      --pad: 18px;
      --gap: 14px;
    }

    @media (min-width: 900px){
      :root{
        --base: 20px;
        --h1: 40px;
        --input: 19px;
        --btn: 18px;
        --pad: 20px;
      }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 15%, rgba(200,162,74,.15), transparent 55%),
                  radial-gradient(900px 520px at 85% 10%, rgba(200,162,74,.08), transparent 55%),
                  linear-gradient(180deg, #060607, #070708 50%, #050506);
      color:var(--text);
      font-size: var(--base);
      line-height: 1.35;
      -webkit-font-smoothing: antialiased;
      padding: calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 18px);
    }

    .wrap{ max-width: 1150px; margin: 0 auto; }

    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 16px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      margin:0;
      font-size: var(--h1);
      letter-spacing:.08em;
    }
    .brand .sub{
      color:var(--muted);
      font-size: 15px;
    }

    .chips{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      margin-top: 6px;
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 8px 12px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 14px;
    }
    .chip b{ color: var(--gold); font-weight: 700; }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 14px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-size: 15px;
    }
    .tab.active{
      border-color: rgba(200,162,74,.6);
      box-shadow: 0 0 0 2px rgba(200,162,74,.15) inset;
      background: rgba(200,162,74,.08);
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }
    .panel + .panel{ margin-top: 14px; }

    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      margin-bottom: 10px;
    }
    .panel h2{
      margin:0;
      font-size: 18px;
      color: var(--gold);
      letter-spacing:.02em;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--gap);
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      color: var(--muted);
      font-size: var(--label);
      margin: 0 0 6px;
    }

    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.35);
      color: var(--text);
      padding: 14px 14px;
      font-size: var(--input);
      outline:none;
    }
    textarea{ min-height: 86px; resize: vertical; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    @media (max-width: 980px){
      .row2{ grid-template-columns: 1fr; }
    }

    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 14px;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border-radius: 999px;
      padding: 12px 16px;
      font-size: var(--btn);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(200,162,74,.65);
      background: rgba(200,162,74,.14);
      color: #fff;
      font-weight: 700;
    }
    .btn.danger{
      border-color: rgba(255,80,80,.45);
      background: rgba(255,80,80,.10);
      color:#fff;
    }
    .btn:active{ transform: translateY(1px); }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
    }

    .split{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: var(--gap);
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      background: rgba(0,0,0,.28);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 14px;
      color: #e8e8ea;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }

    .toggleRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.22);
    }
    .toggleRow b{ color: var(--gold); }

    .switch{
      position:relative; width: 56px; height: 32px;
    }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background: rgba(255,255,255,.12);
      border:1px solid var(--line);
      border-radius: 999px;
      transition: .2s;
    }
    .slider:before{
      content:"";
      position:absolute;
      width: 26px; height: 26px;
      left: 3px; top: 2px;
      background: #fff;
      border-radius: 50%;
      transition: .2s;
      box-shadow: 0 10px 25px rgba(0,0,0,.45);
    }
    .switch input:checked + .slider{
      background: rgba(200,162,74,.26);
      border-color: rgba(200,162,74,.55);
    }
    .switch input:checked + .slider:before{
      transform: translateX(24px);
      background: #fff;
    }

    .oneTapGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .oneTapGrid{ grid-template-columns: 1fr; }
    }
    .oneTap{
      text-align:left;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
    }
    .oneTap .k{ color: var(--gold); font-weight: 800; }
    .oneTap .s{ color: var(--muted); font-size: 14px; margin-top: 4px; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 14px);
      background: rgba(10,10,12,.88);
      border: 1px solid rgba(200,162,74,.35);
      padding: 10px 14px;
      border-radius: 999px;
      color: #fff;
      font-size: 14px;
      display:none;
      z-index: 50;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }

    /* Celebration modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 18px;
    }
    .modal{
      width: min(760px, 100%);
      background: radial-gradient(900px 420px at 30% 20%, rgba(200,162,74,.20), transparent 58%),
                  linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(200,162,74,.35);
      border-radius: 22px;
      padding: 18px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .modal h3{
      margin:0 0 6px;
      font-size: 22px;
      color: #fff;
      letter-spacing:.02em;
    }
    .modal p{ margin:0 0 12px; color: var(--muted); }
    .spark{
      position:absolute;
      width: 10px; height: 10px;
      background: rgba(200,162,74,.9);
      border-radius: 2px;
      filter: blur(.2px);
      animation: fall 1.25s linear infinite;
      opacity:.9;
    }
    @keyframes fall{
      0%{ transform: translateY(-30px) rotate(0deg); opacity:0; }
      10%{ opacity: .95; }
      100%{ transform: translateY(420px) rotate(320deg); opacity: 0; }
    }
    .xClose{
      position:absolute; right:12px; top:10px;
      background: transparent;
      border: 1px solid var(--line);
      color: #fff;
      border-radius: 999px;
      width: 38px; height: 38px;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>KAI</h1>
        <div class="sub">Kabbalah Always Illuminates ‚Ä¢ Alignment ‚Ä¢ Restriction ‚Ä¢ Witnessing</div>
      </div>
      <div class="chips">
        <div class="chip">Date: <b id="chipDate">‚Äî</b></div>
        <div class="chip">Profile: <b id="chipProfile">‚Äî</b></div>
        <div class="chip">Streak: <b id="chipStreak">‚Äî</b></div>
        <div class="chip">Daily Restrict: <b id="chipDailyRestrict">‚Äî</b></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="start">Start</div>
      <div class="tab" data-tab="morning">Morning</div>
      <div class="tab" data-tab="restriction">Restriction</div>
      <div class="tab" data-tab="evening">Evening</div>
      <div class="tab" data-tab="share">Share Card</div>
      <div class="tab" data-tab="library">Library</div>
      <div class="tab" data-tab="tools">Tools</div>
      <div class="tab" data-tab="history">History</div>
    </div>

    <!-- START -->
    <section class="panel" data-pane="start">
      <div class="titleRow">
        <h2>Profile and Intent</h2>
      </div>

      <div class="grid">
        <div>
          <label>Your name</label>
          <input id="pName" placeholder="Bernard" />
        </div>

        <div>
          <label>Birthdate (astrology layer)</label>
          <input id="pBirth" type="date" />
        </div>

        <div>
          <label>Primary focus</label>
          <select id="pFocus">
            <option value="">Select‚Ä¶</option>
            <option>Certainty</option>
            <option>Restriction</option>
            <option>Love / Achdut</option>
            <option>Leadership</option>
            <option>Healing / Energy</option>
            <option>Communication</option>
          </select>
        </div>

        <div>
          <label>30-day outcome (one sentence)</label>
          <input id="pOutcome" placeholder="Increase certainty and reduce urgency reactivity‚Ä¶" />
        </div>

        <div>
          <label>Preferred intensity</label>
          <select id="pMode">
            <option>Simple + Powerful</option>
            <option>Guided (more prompts)</option>
            <option>Deep (study + tools)</option>
          </select>
        </div>

        <div>
          <label>Enable</label>
          <select id="pEnable">
            <option>Core + Tools</option>
            <option>Core only</option>
            <option>Core + Library</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px" class="toggleRow">
        <div>
          <b>Daily Restrict Mode</b>
          <div class="hint" style="margin:4px 0 0">One restriction per day, celebrated + streak tracked. üî•</div>
        </div>
        <label class="switch" aria-label="Daily Restrict">
          <input id="dailyRestrictToggle" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="titleRow">
          <h2>Daily Guidance Preview</h2>
        </div>

        <div class="split">
          <div class="card">
            <label>Pattern (choose in Morning)</label>
            <div class="chip" style="display:inline-block;margin-bottom:10px">Pattern: <b id="prevPattern">‚Äî</b></div>

            <label>72 Name tool (pattern-mapped or chosen in Library)</label>
            <div class="chip" style="display:inline-block;margin-bottom:10px">Meaning: <b id="prevNameMeaning">Choose a tool</b></div>

            <label>Zohar lens (teaching bite)</label>
            <textarea id="prevZohar" placeholder="Sefirah lens: ‚Ä¶&#10;Teaching bite: ‚Ä¶&#10;(Teacher can later attach exact Zohar references.)"></textarea>

            <div class="hint">This POC keeps Zohar references high-level on purpose. Exact citations can be teacher-attached later.</div>
          </div>

          <div class="card">
            <label>Suggested restriction</label>
            <input id="prevSuggest" placeholder="Choose one restriction move and witness the effect." />

            <label style="margin-top:10px">KAI Card (shareable text)</label>
            <div class="card mono" id="shareTextBox" style="min-height: 170px"></div>

            <div class="hint">Tap **Share Text** below to copy a clean share version.</div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn" id="btnCopy">Copy</button>
          <button class="btn" id="btnShareText">Share Text</button>
          <button class="btn" id="btnExport">Export</button>
          <button class="btn primary" id="btnSave">Save</button>
          <button class="btn danger" id="btnResetDay">Reset Day</button>
        </div>

        <div class="hint" id="saveState">‚óè Not saved yet.</div>
      </div>
    </section>

    <!-- MORNING -->
    <section class="panel" data-pane="morning" style="display:none">
      <div class="titleRow"><h2>Morning</h2></div>

      <div class="grid">
        <div style="grid-column: 1 / -1">
          <label>Where are you reactive today?</label>
          <input id="mWhere" placeholder="Work / relationship / body / money / control / etc" />
        </div>

        <div style="grid-column: 1 / -1">
          <label>What is the pattern?</label>
          <input id="mPattern" placeholder="Urgency / anger / avoidance / approval-seeking / scarcity / etc" />
        </div>

        <div>
          <label>Certainty (0‚Äì10)</label>
          <input id="mCert" inputmode="decimal" placeholder="0‚Äì10" />
        </div>

        <div>
          <label>Energy (0‚Äì10)</label>
          <input id="mEnergy" inputmode="decimal" placeholder="0‚Äì10" />
        </div>

        <div>
          <label>One intention</label>
          <input id="mIntent" placeholder="What is my soul trying to do today" />
        </div>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="titleRow"><h2>One-Tap Restriction (fast + fun)</h2></div>
        <div class="hint">Tap one, it auto-fills Restriction + suggested mini-script. Then hit Save. ‚ö°Ô∏è</div>

        <div class="oneTapGrid" id="oneTapGrid"></div>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section class="panel" data-pane="restriction" style="display:none">
      <div class="titleRow"><h2>Restriction</h2></div>

      <div class="grid">
        <div>
          <label>Restriction action</label>
          <select id="rAction">
            <option value="">Select one‚Ä¶</option>
            <option>Pause (10 seconds)</option>
            <option>Delay response (10 minutes)</option>
            <option>Lower volume (voice/text)</option>
            <option>Ask a question first</option>
            <option>One breath before sending</option>
            <option>Choose dignity over victory</option>
            <option>Name the feeling (no story)</option>
            <option>Do the opposite (small)</option>
          </select>
        </div>

        <div>
          <label>Where will you apply it?</label>
          <input id="rWhere" placeholder="Meeting / text thread / family / commute / self-talk" />
        </div>

        <div>
          <label>Confidence (0‚Äì10)</label>
          <input id="rConf" inputmode="decimal" placeholder="0‚Äì10" />
        </div>

        <div style="grid-column: 1 / -1">
          <label>Replacement behavior (specific)</label>
          <textarea id="rReplace" placeholder="What do I do instead, specifically?"></textarea>
        </div>

        <div style="grid-column: 1 / -1">
          <label>Mini script (optional)</label>
          <input id="rScript" placeholder='Example: "I hear you. Give me 10 minutes to respond with clarity."' />
        </div>
      </div>

      <div class="hint" id="rSuggested">Suggested (from tool): Choose one restriction move and witness the effect.</div>
    </section>

    <!-- EVENING -->
    <section class="panel" data-pane="evening" style="display:none">
      <div class="titleRow"><h2>Evening Witness</h2></div>

      <div class="row2">
        <div>
          <label>Did you witness illumination?</label>
          <textarea id="eWitness" placeholder="What did you witness? Where did Light show up?"></textarea>
        </div>
        <div>
          <label>What changed in certainty/energy?</label>
          <textarea id="eShift" placeholder="Certainty: AM ‚Üí PM‚Ä¶&#10;Energy: AM ‚Üí PM‚Ä¶"></textarea>
        </div>
      </div>
    </section>

    <!-- SHARE -->
    <section class="panel" data-pane="share" style="display:none">
      <div class="titleRow"><h2>Daily Share Card (PNG)</h2></div>

      <div class="grid">
        <div>
          <label>Card style</label>
          <select id="sStyle">
            <option>Black + Gold (KAI)</option>
            <option>Minimal (Ink)</option>
            <option>Bright (Light)</option>
          </select>
        </div>
        <div>
          <label>Include</label>
          <select id="sInclude">
            <option>Balanced</option>
            <option>Only restriction</option>
            <option>Only 72 Name</option>
            <option>Full</option>
          </select>
        </div>
        <div>
          <label>Tagline</label>
          <input id="sTag" value="Kabbalah Always Illuminates" />
        </div>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="titleRow"><h2>Preview</h2></div>
        <canvas id="cardCanvas" width="1400" height="800" style="width:100%;border-radius:16px;border:1px solid var(--line);background:#000"></canvas>
        <div class="btnRow">
          <button class="btn" id="btnRender">Render Card</button>
          <button class="btn primary" id="btnDownload">Download PNG</button>
        </div>
        <div class="hint">Tip: after Download, use iOS Share to Messages/WhatsApp/etc.</div>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="panel" data-pane="library" style="display:none">
      <div class="titleRow"><h2>72 Names Library</h2></div>
      <div class="hint">Curated starter set now. Expand to full 72 next. Search by meaning/use-case.</div>

      <div class="grid" style="margin-top:12px">
        <div style="grid-column: 1 / -1">
          <label>Search</label>
          <input id="libSearch" placeholder="Type meaning or use-case (e.g., anger, urgency, dignity)" />
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="chip" style="display:inline-block">Chosen Name for today: <b id="libChosen">‚Äî</b></div>
        <div class="hint" id="libPractice" style="margin-top:8px">Select a Name to see its practice.</div>
        <div class="btnRow" style="justify-content:flex-start">
          <button class="btn primary" id="btnUseToday">Use Today</button>
          <button class="btn" id="btnClearName">Clear</button>
        </div>
      </div>

      <div class="grid" id="libGrid" style="margin-top:12px"></div>
    </section>

    <!-- TOOLS -->
    <section class="panel" data-pane="tools" style="display:none">
      <div class="titleRow"><h2>Tools</h2></div>

      <div class="panel">
        <div class="titleRow"><h2>Gematria</h2></div>
        <div class="grid">
          <div>
            <label>Enter Hebrew (e.g., ◊ê◊î◊ë◊î)</label>
            <input id="gText" placeholder="◊ê◊î◊ë◊î" dir="rtl" />
          </div>
          <div>
            <label>Total</label>
            <input id="gTotal" placeholder="‚Äî" readonly />
          </div>
          <div style="grid-column: 1 / -1">
            <label>Breakdown</label>
            <input id="gBreak" placeholder="Type Hebrew letters above to see breakdown." readonly />
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="titleRow"><h2>Astrology (light personalization)</h2></div>
        <div class="hint">Prompt layer, not destiny. Your birthdate in Start activates this.</div>
        <div class="grid" style="margin-top:10px">
          <div class="chip">Sun sign: <b id="aSign">‚Äî</b></div>
          <div class="chip">Prompt: <b id="aPrompt">‚Äî</b></div>
        </div>
        <div class="hint" style="margin-top:10px">This can later evolve into: monthly arc, Omer, and teacher-attached tikkun work.</div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="panel" data-pane="history" style="display:none">
      <div class="titleRow"><h2>History</h2></div>
      <div class="hint">Saved days live on this device (local storage) for now. Later: sync + teacher view.</div>

      <div class="card" style="margin-top:12px">
        <div class="btnRow" style="justify-content:flex-start">
          <button class="btn" id="btnLoadToday">Load Today</button>
          <button class="btn" id="btnListDays">List Saved Days</button>
          <button class="btn danger" id="btnNukeAll">Delete ALL Data</button>
        </div>
        <div class="mono" id="historyBox" style="margin-top:12px;min-height:140px"></div>
      </div>
    </section>

    <div class="toast" id="toast"></div>

    <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal" id="modal">
        <button class="xClose" id="modalClose" aria-label="Close">‚úï</button>
        <h3 id="modalTitle">üî• Streak!</h3>
        <p id="modalBody">You did today‚Äôs restriction. Light recorded. Keep going.</p>
        <div class="btnRow" style="justify-content:flex-start">
          <button class="btn primary" id="modalOk">Ok</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (id)=>document.getElementById(id);
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const keyProfile = "kai_profile_v1";
    const keyStreak  = "kai_streak_v1";
    const keyDailyRestrict = "kai_daily_restrict_v1";
    const dayKey = (d) => "kai_day_" + d + "_v1";

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__tmo);
      window.__tmo = setTimeout(()=> t.style.display="none", 2200);
    }

    function safeJSONParse(s, fallback){
      try{ return JSON.parse(s); }catch{ return fallback; }
    }

    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("active", el.dataset.tab === tab);
      });
      document.querySelectorAll("[data-pane]").forEach(p=>{
        p.style.display = (p.dataset.pane === tab) ? "" : "none";
      });
      // remember last tab
      localStorage.setItem("kai_last_tab_v1", tab);
    }

    function computeSunSign(dateStr){
      if(!dateStr) return "";
      const d = new Date(dateStr + "T12:00:00");
      const m = d.getUTCMonth()+1, day = d.getUTCDate();
      // Simple western sun sign ranges
      const ranges = [
        ["Capricorn", 12, 22, 1, 19],
        ["Aquarius", 1, 20, 2, 18],
        ["Pisces", 2, 19, 3, 20],
        ["Aries", 3, 21, 4, 19],
        ["Taurus", 4, 20, 5, 20],
        ["Gemini", 5, 21, 6, 20],
        ["Cancer", 6, 21, 7, 22],
        ["Leo", 7, 23, 8, 22],
        ["Virgo", 8, 23, 9, 22],
        ["Libra", 9, 23, 10, 22],
        ["Scorpio", 10, 23, 11, 21],
        ["Sagittarius", 11, 22, 12, 21]
      ];
      // handle Capricorn spanning year end
      if((m===12 && day>=22) || (m===1 && day<=19)) return "Capricorn";
      for(const [name, sm, sd, em, ed] of ranges){
        if(m===sm && day>=sd) return name;
        if(m===em && day<=ed) return name;
        if(m>sm && m<em) return name;
      }
      return "";
    }

    function astroPrompt(sign){
      if(!sign) return "";
      const map = {
        "Taurus":"Steady certainty: slow down, choose one clean restriction, then act.",
        "Aries":"Don‚Äôt sprint first. Pause, then choose precision over speed.",
        "Gemini":"Name the pattern in one sentence. Reduce words, increase truth.",
        "Cancer":"Hold the heart without gripping. Respond from care, not fear.",
        "Leo":"Lead with dignity, not dominance. Make the Light bigger than the ego.",
        "Virgo":"Simplify. Choose the smallest restriction that changes the day.",
        "Libra":"Choose balance over approval. One boundary is love.",
        "Scorpio":"Transmute intensity. Use restriction to turn heat into clarity.",
        "Sagittarius":"Aim the arrow carefully. Delay response before sending.",
        "Capricorn":"Structure wins. Commit to one restriction and track the streak.",
        "Aquarius":"Detach from reactivity. Ask a question first.",
        "Pisces":"Breathe first. Let the wave pass, then speak."
      };
      return map[sign] || "Choose one restriction move and witness the effect.";
    }

    function loadProfile(){
      const p = safeJSONParse(localStorage.getItem(keyProfile), {
        name:"Bernard",
        birth:"",
        focus:"",
        outcome:"",
        mode:"Simple + Powerful",
        enable:"Core + Tools"
      });
      $("pName").value = p.name || "";
      $("pBirth").value = p.birth || "";
      $("pFocus").value = p.focus || "";
      $("pOutcome").value = p.outcome || "";
      $("pMode").value = p.mode || "Simple + Powerful";
      $("pEnable").value = p.enable || "Core + Tools";
      return p;
    }

    function saveProfile(){
      const p = {
        name: $("pName").value.trim() || "‚Äî",
        birth: $("pBirth").value || "",
        focus: $("pFocus").value || "",
        outcome: $("pOutcome").value.trim() || "",
        mode: $("pMode").value || "Simple + Powerful",
        enable: $("pEnable").value || "Core + Tools"
      };
      localStorage.setItem(keyProfile, JSON.stringify(p));
      return p;
    }

    function loadDay(d){
      return safeJSONParse(localStorage.getItem(dayKey(d)), {
        date:d,
        morning:{},
        restriction:{},
        evening:{},
        chosenName:null,
        zohar:"",
        savedAt:null
      });
    }

    function saveDay(d, obj){
      obj.savedAt = new Date().toISOString();
      localStorage.setItem(dayKey(d), JSON.stringify(obj));
    }

    function loadStreak(){
      return safeJSONParse(localStorage.getItem(keyStreak), {
        count:0,
        lastCompletedDate:null,
        lastCelebratedDate:null
      });
    }

    function saveStreak(s){
      localStorage.setItem(keyStreak, JSON.stringify(s));
    }

    function isYesterday(a,b){
      // true if b is exactly 1 day after a (YYYY-MM-DD)
      const da = new Date(a+"T12:00:00Z").getTime();
      const db = new Date(b+"T12:00:00Z").getTime();
      const diff = Math.round((db-da)/(1000*60*60*24));
      return diff === 1;
    }

    function bumpStreakIfCompleted(d){
      // Completed means: Restriction action chosen (or one-tap used) AND saved day.
      const day = loadDay(d);
      const action = (day.restriction && day.restriction.action) ? day.restriction.action : "";
      if(!action) return {changed:false, streak: loadStreak()};

      const s = loadStreak();
      if(s.lastCompletedDate === d){
        return {changed:false, streak:s};
      }
      if(!s.lastCompletedDate){
        s.count = 1;
      }else if(isYesterday(s.lastCompletedDate, d)){
        s.count += 1;
      }else{
        s.count = 1;
      }
      s.lastCompletedDate = d;
      saveStreak(s);
      return {changed:true, streak:s};
    }

    function openCelebration(streakCount){
      // avoid repeating celebration on refresh
      const s = loadStreak();
      const d = todayISO();
      if(s.lastCelebratedDate === d) return;
      s.lastCelebratedDate = d;
      saveStreak(s);

      $("modalTitle").textContent = `üî• Streak: ${streakCount}`;
      $("modalBody").textContent = "You did today‚Äôs restriction. Light recorded. Keep going.";

      const back = $("modalBackdrop");
      back.style.display = "flex";

      // confetti-ish sparks
      const modal = $("modal");
      // remove old sparks
      modal.querySelectorAll(".spark").forEach(x=>x.remove());
      for(let i=0;i<18;i++){
        const sp = document.createElement("div");
        sp.className = "spark";
        sp.style.left = Math.random()*100 + "%";
        sp.style.top = "-20px";
        sp.style.animationDelay = (Math.random()*0.8) + "s";
        sp.style.opacity = (0.65 + Math.random()*0.35).toFixed(2);
        sp.style.transform = `translateY(-30px) rotate(${Math.random()*180}deg)`;
        modal.appendChild(sp);
      }
    }

    function closeCelebration(){
      $("modalBackdrop").style.display = "none";
    }

    // ---------- 72 Names starter set (curated) ----------
    const NAMES = [
      {he:"◊ï◊î◊ï", en:"Soften forcing", use:["urgency","pressure","forcing"], practice:"Breathe slow for 60s. Release the need to force. Take one clean action."},
      {he:"◊ô◊ú◊ô", en:"Sweeten judgment", use:["anger","judgment","critic"], practice:"Soften throat/face. Reduce words. Choose dignity over victory."},
      {he:"◊û◊î◊©", en:"Courage to face", use:["avoidance","fear","clarity"], practice:"Name the avoided thing. Do 3 minutes now. Contact over completion."},
      {he:"◊°◊ê◊ú", en:"Inner certainty", use:["doubt","noise","certainty"], practice:"One sentence truth. Then one step. No extra explanations today."},
      {he:"◊î◊®◊ó", en:"Trust / surrender", use:["control","anxiety","grip"], practice:"Relax hands/feet. Say: ‚ÄòI don‚Äôt need to win this moment.‚Äô Choose one restriction."},
      {he:"◊†◊ú◊®", en:"Restore dignity", use:["shame","reactivity","self-talk"], practice:"Speak to yourself as a soul. Replace attack with instruction."}
    ];

    const ONE_TAPS = [
      {k:"Pause 10s", action:"Pause (10 seconds)", replace:"Count 10 breaths before responding. Let the first heat pass.", script:"‚ÄúGive me a moment to respond clearly.‚Äù"},
      {k:"Delay 10m", action:"Delay response (10 minutes)", replace:"Set a 10-minute timer. Respond only after it ends.", script:"‚ÄúI hear you. Give me 10 minutes to reply with clarity.‚Äù"},
      {k:"Lower volume", action:"Lower volume (voice/text)", replace:"Shorten the message by 50%. Remove ‚Äòbecause.‚Äô", script:"‚ÄúGot it. Here‚Äôs what I can do next:‚Äù"},
      {k:"Ask first", action:"Ask a question first", replace:"Ask one clarifying question before stating your position.", script:"‚ÄúQuick question so I understand: what outcome do you want?‚Äù"},
      {k:"One breath", action:"One breath before sending", replace:"One full inhale + exhale before pressing send.", script:"(silent)"},
      {k:"Choose dignity", action:"Choose dignity over victory", replace:"Drop the sharp line. Keep the boundary.", script:"‚ÄúI‚Äôm not available for that, and I care about us.‚Äù"}
    ];

    // ---------- State ----------
    const state = {
      date: todayISO(),
      profile: null,
      day: null,
      dailyRestrict: false
    };

    function hydrateUI(){
      $("chipDate").textContent = state.date;
      $("chipProfile").textContent = state.profile?.name || "‚Äî";

      const s = loadStreak();
      $("chipStreak").textContent = s.count || 0;

      $("chipDailyRestrict").textContent = state.dailyRestrict ? "ON" : "OFF";

      // Load day into fields
      const d = state.day;

      $("mWhere").value = d.morning.where || "";
      $("mPattern").value = d.morning.pattern || "";
      $("mCert").value = d.morning.certainty || "";
      $("mEnergy").value = d.morning.energy || "";
      $("mIntent").value = d.morning.intention || "";

      $("rAction").value = d.restriction.action || "";
      $("rWhere").value = d.restriction.where || "";
      $("rConf").value = d.restriction.confidence || "";
      $("rReplace").value = d.restriction.replace || "";
      $("rScript").value = d.restriction.script || "";

      $("eWitness").value = d.evening.witness || "";
      $("eShift").value = d.evening.shift || "";

      $("prevZohar").value = d.zohar || "";

      // Preview data
      const pattern = (d.morning.pattern || "‚Äî").trim() || "‚Äî";
      $("prevPattern").textContent = pattern;

      // chosen name
      if(d.chosenName){
        $("prevNameMeaning").textContent = `${d.chosenName.he} ‚Ä¢ ${d.chosenName.en}`;
        $("libChosen").textContent = `${d.chosenName.he} ‚Ä¢ ${d.chosenName.en}`;
        $("libPractice").textContent = d.chosenName.practice;
      }else{
        $("prevNameMeaning").textContent = "Choose a tool";
        $("libChosen").textContent = "‚Äî";
        $("libPractice").textContent = "Select a Name to see its practice.";
      }

      // Suggested restriction
      $("prevSuggest").value = d.suggestedRestriction || "Choose one restriction move and witness the effect.";
      $("rSuggested").textContent = `Suggested (from tool): ${$("prevSuggest").value}`;

      // Astrology
      const sign = computeSunSign(state.profile?.birth || "");
      $("aSign").textContent = sign || "‚Äî";
      $("aPrompt").textContent = sign ? astroPrompt(sign) : "‚Äî";

      // Share text box
      $("shareTextBox").textContent = buildShareText();

      // Save state indicator
      $("saveState").textContent = d.savedAt ? `‚óè Saved. (${new Date(d.savedAt).toLocaleTimeString()})` : "‚óè Not saved yet.";

      // Toggle
      $("dailyRestrictToggle").checked = state.dailyRestrict;
    }

    function buildShareText(){
      const d = state.day;
      const p = state.profile || {};
      const sign = computeSunSign(p.birth || "");
      const nameLine = p.name ? `${p.name}` : "‚Äî";

      const pattern = d.morning.pattern ? d.morning.pattern : "‚Äî";
      const action  = d.restriction.action ? d.restriction.action : "‚Äî";
      const tool    = d.chosenName ? `${d.chosenName.he} ‚Ä¢ ${d.chosenName.en}` : "‚Äî";
      const restrict = d.restriction.replace ? d.restriction.replace : "‚Äî";

      return [
        `KAI ‚Ä¢ ${state.date}`,
        `Name: ${nameLine}`,
        `Pattern: ${pattern}`,
        `Tool: ${tool}`,
        `Restriction: ${action}`,
        `Replacement: ${restrict}`,
        `Certainty: ${d.morning.certainty || "‚Äî"} ‚Ä¢ Energy: ${d.morning.energy || "‚Äî"}`,
        `Astro: ${sign || "‚Äî"}`
      ].join("\n");
    }

    function renderLibrary(filterText=""){
      const grid = $("libGrid");
      grid.innerHTML = "";
      const q = (filterText || "").trim().toLowerCase();

      const shown = NAMES.filter(n=>{
        if(!q) return true;
        return (
          n.he.includes(q) ||
          n.en.toLowerCase().includes(q) ||
          n.use.some(u=>u.includes(q))
        );
      });

      shown.forEach(n=>{
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="display:flex;gap:10px;align-items:baseline;justify-content:space-between">
            <div>
              <div style="font-size:24px;font-weight:900;color:var(--gold);letter-spacing:.04em">${n.he}</div>
              <div style="font-weight:700">${n.en}</div>
              <div class="hint" style="margin:6px 0 0">Use-case: ${n.use.join(" ‚Ä¢ ")}</div>
            </div>
            <button class="btn" style="height:44px">Select</button>
          </div>
          <div class="mono" style="margin-top:10px">${n.practice}</div>
        `;
        card.querySelector("button").onclick = ()=>{
          state.day.chosenName = n;
          toast(`Selected ${n.he} ‚Ä¢ ${n.en}`);
          hydrateUI();
        };
        grid.appendChild(card);
      });
    }

    function renderOneTaps(){
      const g = $("oneTapGrid");
      g.innerHTML = "";
      ONE_TAPS.forEach(t=>{
        const b = document.createElement("button");
        b.className = "oneTap";
        b.innerHTML = `<div class="k">${t.k}</div><div class="s">${t.action}</div>`;
        b.onclick = ()=>{
          // auto-fill restriction
          state.day.restriction.action = t.action;
          state.day.restriction.replace = t.replace;
          state.day.restriction.script = t.script;
          state.day.suggestedRestriction = t.replace;
          toast(`One-tap set: ${t.action}`);
          // Jump to restriction tab so it feels ‚Äúreal‚Äù
          setActiveTab("restriction");
          hydrateUI();
        };
        g.appendChild(b);
      });
    }

    function setDailyRestrict(on){
      state.dailyRestrict = !!on;
      localStorage.setItem(keyDailyRestrict, state.dailyRestrict ? "1" : "0");
      hydrateUI();
      toast(`Daily Restrict ${state.dailyRestrict ? "ON" : "OFF"}`);
    }

    // ---------- Save / Reset ----------
    function collectFromFields(){
      // Morning
      state.day.morning = {
        where: $("mWhere").value.trim(),
        pattern: $("mPattern").value.trim(),
        certainty: $("mCert").value.trim(),
        energy: $("mEnergy").value.trim(),
        intention: $("mIntent").value.trim()
      };
      // Restriction
      state.day.restriction = {
        action: $("rAction").value,
        where: $("rWhere").value.trim(),
        confidence: $("rConf").value.trim(),
        replace: $("rReplace").value.trim(),
        script: $("rScript").value.trim()
      };
      // Evening
      state.day.evening = {
        witness: $("eWitness").value.trim(),
        shift: $("eShift").value.trim()
      };
      state.day.zohar = $("prevZohar").value.trim();
      state.day.suggestedRestriction = $("prevSuggest").value.trim();
    }

    function doSave(){
      state.profile = saveProfile();
      collectFromFields();
      saveDay(state.date, state.day);

      // Streak logic (only celebrate when restriction exists + saved)
      const {changed, streak} = bumpStreakIfCompleted(state.date);

      hydrateUI();
      toast("Saved.");

      if(state.dailyRestrict && changed){
        openCelebration(streak.count);
      }
    }

    function doResetDay(){
      // clears TODAY only
      const d = state.date;
      localStorage.removeItem(dayKey(d));
      state.day = loadDay(d);
      // also clear ‚Äúnot saved‚Äù state
      state.day.savedAt = null;
      hydrateUI();
      toast("Reset today.");
    }

    // ---------- Export ----------
    function doExport(){
      collectFromFields();
      const payload = {
        date: state.date,
        profile: state.profile,
        dailyRestrict: state.dailyRestrict,
        day: state.day,
        streak: loadStreak()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `KAI_${state.date}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast("Exported JSON.");
    }

    // ---------- Share text ----------
    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        toast("Copied.");
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        toast("Copied.");
      }
    }

    // ---------- Share card PNG ----------
    function renderCard(){
      const c = $("cardCanvas");
      const ctx = c.getContext("2d");
      const W = c.width, H = c.height;

      // background
      ctx.fillStyle = "#08080a";
      ctx.fillRect(0,0,W,H);

      // soft gold glow
      const grd = ctx.createRadialGradient(260,160,20,260,160,700);
      grd.addColorStop(0,"rgba(200,162,74,.22)");
      grd.addColorStop(1,"rgba(200,162,74,0)");
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,W,H);

      // frame
      ctx.strokeStyle = "rgba(200,162,74,.35)";
      ctx.lineWidth = 4;
      roundRect(ctx, 32, 32, W-64, H-64, 28);
      ctx.stroke();

      // header
      ctx.fillStyle = "#ffffff";
      ctx.font = "900 56px system-ui, -apple-system";
      ctx.fillText("KAI", 86, 125);

      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.font = "500 24px system-ui, -apple-system";
      ctx.fillText(($("sTag").value || "Kabbalah Always Illuminates"), 86, 162);

      // content
      const d = state.day;
      const p = state.profile || {};
      const tool = d.chosenName ? `${d.chosenName.he} ‚Ä¢ ${d.chosenName.en}` : "‚Äî";
      const pattern = d.morning.pattern || "‚Äî";
      const action = d.restriction.action || "‚Äî";
      const replace = d.restriction.replace || "‚Äî";

      const blocks = [
        ["Date", state.date],
        ["Name", p.name || "‚Äî"],
        ["Pattern", pattern],
        ["Tool", tool],
        ["Restriction", action],
        ["Replacement", replace]
      ];

      const leftX = 86, topY = 230, boxW = W-172, boxH = H-290;
      ctx.fillStyle = "rgba(255,255,255,.03)";
      ctx.strokeStyle = "rgba(255,255,255,.08)";
      ctx.lineWidth = 2;
      roundRect(ctx, leftX, topY, boxW, boxH, 22);
      ctx.fill();
      ctx.stroke();

      let y = topY + 62;
      blocks.forEach(([k,v], idx)=>{
        ctx.fillStyle = "rgba(200,162,74,.95)";
        ctx.font = "800 22px system-ui, -apple-system";
        ctx.fillText(k.toUpperCase(), leftX + 34, y);

        ctx.fillStyle = "rgba(255,255,255,.92)";
        ctx.font = "600 30px system-ui, -apple-system";
        wrapText(ctx, v, leftX + 34, y + 38, boxW - 68, 38);

        y += 108;
      });

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "500 20px system-ui, -apple-system";
      ctx.fillText("kabbalah always illuminates", W-430, H-82);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = String(text).split(" ");
      let line = "";
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + " ";
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && n > 0){
          ctx.fillText(line, x, y);
          line = words[n] + " ";
          y += lineHeight;
        }else{
          line = testLine;
        }
      }
      ctx.fillText(line, x, y);
    }

    function downloadPNG(){
      renderCard();
      const c = $("cardCanvas");
      const a = document.createElement("a");
      a.download = `KAI_${state.date}.png`;
      a.href = c.toDataURL("image/png");
      a.click();
      toast("Downloaded PNG.");
    }

    // ---------- History ----------
    function listSavedDays(){
      const keys = Object.keys(localStorage).filter(k=>k.startsWith("kai_day_") && k.endsWith("_v1"));
      const days = keys.map(k=>k.replace("kai_day_","").replace("_v1","")).sort().reverse();
      $("historyBox").textContent = days.length ? days.join("\n") : "(none yet)";
    }

    function nukeAll(){
      if(!confirm("Delete ALL KAI data on this device?")) return;
      Object.keys(localStorage).forEach(k=>{
        if(k.startsWith("kai_")) localStorage.removeItem(k);
      });
      state.profile = loadProfile();
      state.dailyRestrict = (localStorage.getItem(keyDailyRestrict) === "1");
      state.day = loadDay(state.date);
      hydrateUI();
      toast("All data deleted.");
    }

    // ---------- Init ----------
    (function init(){
      // Date chip
      state.date = todayISO();
      state.profile = loadProfile();
      state.dailyRestrict = (localStorage.getItem(keyDailyRestrict) === "1");
      state.day = loadDay(state.date);

      // tabs
      $("tabs").addEventListener("click", (e)=>{
        const t = e.target.closest(".tab");
        if(!t) return;
        setActiveTab(t.dataset.tab);
      });
      const last = localStorage.getItem("kai_last_tab_v1") || "start";
      setActiveTab(last);

      // toggles + inputs
      $("dailyRestrictToggle").addEventListener("change",(e)=> setDailyRestrict(e.target.checked));

      // buttons
      $("btnSave").onclick = doSave;
      $("btnResetDay").onclick = doResetDay;
      $("btnExport").onclick = doExport;
      $("btnCopy").onclick = ()=> copyText(buildShareText());
      $("btnShareText").onclick = ()=> copyText(buildShareText());
      $("btnLoadToday").onclick = ()=>{
        state.day = loadDay(state.date);
        hydrateUI();
        toast("Loaded today.");
      };
      $("btnListDays").onclick = listSavedDays;
      $("btnNukeAll").onclick = nukeAll;

      // share card
      $("btnRender").onclick = renderCard;
      $("btnDownload").onclick = downloadPNG;

      // library
      renderLibrary("");
      $("libSearch").addEventListener("input", (e)=> renderLibrary(e.target.value));
      $("btnUseToday").onclick = ()=>{
        if(!state.day.chosenName){ toast("Select a Name first."); return; }
        toast("Name set for today.");
        hydrateUI();
      };
      $("btnClearName").onclick = ()=>{
        state.day.chosenName = null;
        toast("Cleared Name.");
        hydrateUI();
      };

      // gematria
      const gemMap = {
        "◊ê":1,"◊ë":2,"◊í":3,"◊ì":4,"◊î":5,"◊ï":6,"◊ñ":7,"◊ó":8,"◊ò":9,
        "◊ô":10,"◊õ":20,"◊ö":20,"◊ú":30,"◊û":40,"◊ù":40,"◊†":50,"◊ü":50,
        "◊°":60,"◊¢":70,"◊§":80,"◊£":80,"◊¶":90,"◊•":90,
        "◊ß":100,"◊®":200,"◊©":300,"◊™":400
      };
      $("gText").addEventListener("input", ()=>{
        const s = ($("gText").value || "").trim();
        let total = 0;
        const parts = [];
        for(const ch of s){
          const v = gemMap[ch] || 0;
          if(v){
            total += v;
            parts.push(`${ch}=${v}`);
          }
        }
        $("gTotal").value = total ? String(total) : "‚Äî";
        $("gBreak").value = parts.length ? parts.join(" ‚Ä¢ ") : "‚Äî";
      });

      // modal close
      $("modalClose").onclick = closeCelebration;
      $("modalOk").onclick = closeCelebration;
      $("modalBackdrop").addEventListener("click",(e)=>{
        if(e.target.id==="modalBackdrop") closeCelebration();
      });

      // one taps
      renderOneTaps();
// Wire tab clicks
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const tab = btn.dataset.tab;
    setActiveTab(tab);
  });
});
      toast("tabs found: " + document.querySelectorAll(".tab").length);
      hydrateUI();
      renderCard();
    })();
  setTimeout(()=>toast("BOOT: end-of-script ‚úÖ"), 300);
  </script>
</body>
</html>
