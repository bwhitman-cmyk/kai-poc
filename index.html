<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA / iOS -->
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/kai-icon.png?v=1" />
  <link rel="icon" type="image/png" href="/kai-icon.png?v=1" />

  <!-- Manifest -->
  <link rel="manifest" href="/manifest.webmanifest?v=1" />

  <title>KAI</title>

  <style>
    :root{
      --bg:#070708;
      --panel:#0e0f12;
      --panel2:#0b0c0e;
      --line:rgba(255,255,255,.08);
      --text:#f3f3f4;
      --muted:#b3b3b7;
      --gold:#c8a24a;
      --gold2:#8f6f2a;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius:22px;
    }

    html,body{
      height:100%;
      background: var(--bg);
      color: var(--text);
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* Prevent iOS “double tap zoom” vibes on interactive UI */
    *{ -webkit-tap-highlight-color: transparent; }
    button, .tab, .btn { touch-action: manipulation; }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 28px;
    }

    .top{
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .brand h1{
      margin:0;
      font-size: 44px;
      letter-spacing:.04em;
      font-weight: 800;
    }
    .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 14px;
      letter-spacing:.03em;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
      max-width: 520px;
    }
    .chip{
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 13px;
    }
    .chip b{ color: var(--gold); font-weight: 700; }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin: 14px 0 16px;
    }

    /* REAL buttons = reliable taps on iPad */
    .tab{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .tab.active{
      border-color: rgba(200,162,74,.55);
      box-shadow: 0 0 0 1px rgba(200,162,74,.25) inset;
      background: radial-gradient(140px 70px at 30% 30%, rgba(200,162,74,.18), rgba(255,255,255,.02));
      color: #fff;
    }

    .panel{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px;
      background:
        radial-gradient(900px 420px at 30% 20%, rgba(200,162,74,.12), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      display:none;
    }
    .panel.active{ display:block; }

    h2{
      margin:0 0 12px;
      color: var(--gold);
      font-size: 18px;
      letter-spacing:.02em;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .chips{ justify-content:flex-start; }
    }

    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    label{
      color: var(--muted);
      font-size: 13px;
    }
    input, select, textarea{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(0,0,0,.35);
      color: var(--text);
      font-size: 16px;
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 14px;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn.gold{
      border-color: rgba(200,162,74,.55);
      box-shadow: 0 0 0 1px rgba(200,162,74,.18) inset;
    }
    .btn.danger{
      border-color: rgba(255,90,90,.35);
      color: #ffd5d5;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      display:none;
      z-index: 9999;
    }

    .mutedNote{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <h1>KAI</h1>
        <div class="sub">Kabbalah Always Illuminates • Alignment • Restriction • Witnessing</div>
      </div>

      <div class="chips">
        <div class="chip">Date: <b id="chipDate">—</b></div>
        <div class="chip">Profile: <b id="chipProfile">—</b></div>
        <div class="chip">Streak: <b id="chipStreak">—</b></div>
        <div class="chip">Daily Restrict: <b id="chipDailyRestrict">—</b></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <button type="button" class="tab active" data-tab="start">Start</button>
      <button type="button" class="tab" data-tab="morning">Morning</button>
      <button type="button" class="tab" data-tab="restriction">Restriction</button>
      <button type="button" class="tab" data-tab="evening">Evening</button>
      <button type="button" class="tab" data-tab="share">Share Card</button>
      <button type="button" class="tab" data-tab="library">Library</button>
      <button type="button" class="tab" data-tab="tools">Tools</button>
      <button type="button" class="tab" data-tab="history">History</button>
    </div>

    <!-- START -->
    <section class="panel active" data-pane="start">
      <h2>Profile and Intent</h2>
      <div class="grid">
        <div class="field">
          <label>Your name</label>
          <input id="name" placeholder="Bernard" />
        </div>

        <div class="field">
          <label>Birthdate (astrology layer)</label>
          <input id="birthdate" placeholder="YYYY-MM-DD" />
        </div>

        <div class="field">
          <label>Primary focus</label>
          <select id="focus">
            <option value="">Select…</option>
            <option>Certainty</option>
            <option>Restriction</option>
            <option>Relationship</option>
            <option>Leadership</option>
            <option>Health</option>
          </select>
        </div>

        <div class="field">
          <label>30-day outcome (one sentence)</label>
          <input id="outcome" placeholder="Increase certainty and reduce urgency" />
        </div>

        <div class="field">
          <label>Preferred intensity</label>
          <select id="intensity">
            <option>Simple + Powerful</option>
            <option>Deep + Precise</option>
            <option>Gentle + Consistent</option>
          </select>
        </div>

        <div class="field">
          <label>Enable</label>
          <select id="enable">
            <option>Core + Tools</option>
            <option>Core only</option>
            <option>Core + Tools + Library</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button class="btn gold" id="saveProfile">Save</button>
        <button class="btn" id="copyProfile">Copy</button>
        <button class="btn" id="exportProfile">Export</button>
      </div>

      <div class="mutedNote">If this page responds to taps and saves your fields, the app is alive ✅</div>
    </section>

    <!-- MORNING -->
    <section class="panel" data-pane="morning">
      <h2>Morning</h2>
      <div class="grid">
        <div class="field">
          <label>Certainty (0–10)</label>
          <input id="certainty" type="number" min="0" max="10" placeholder="0–10" />
        </div>
        <div class="field">
          <label>Energy (0–10)</label>
          <input id="energy" type="number" min="0" max="10" placeholder="0–10" />
        </div>
        <div class="field">
          <label>Intention (one line)</label>
          <input id="intention" placeholder="Today I choose…" />
        </div>
      </div>

      <div class="row">
        <button class="btn gold" id="saveMorning">Save</button>
        <button class="btn" id="resetMorning">Reset</button>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section class="panel" data-pane="restriction">
      <h2>Restriction</h2>
      <div class="grid">
        <div class="field" style="grid-column: 1 / -1;">
          <label>One restriction move (what + why)</label>
          <textarea id="restrictMove" placeholder="Example: Pause before responding. Restrict reactivity."></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn gold" id="saveRestrict">Save</button>
        <button class="btn" id="markDone">Mark done</button>
      </div>
    </section>

    <!-- EVENING -->
    <section class="panel" data-pane="evening">
      <h2>Evening</h2>
      <div class="grid">
        <div class="field" style="grid-column: 1 / -1;">
          <label>Witnessing (what did you notice?)</label>
          <textarea id="witness" placeholder="I noticed…"></textarea>
        </div>
      </div>
      <div class="row">
        <button class="btn gold" id="saveEvening">Save</button>
        <button class="btn" id="resetEvening">Reset</button>
      </div>
    </section>

    <!-- SHARE -->
    <section class="panel" data-pane="share">
      <h2>Share Card</h2>
      <div class="grid">
        <div class="field" style="grid-column: 1 / -1;">
          <label>Share text (auto-built)</label>
          <textarea id="shareText" readonly></textarea>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="copyShare">Copy</button>
        <button class="btn gold" id="nativeShare">Share</button>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="panel" data-pane="library">
      <h2>Library</h2>
      <div class="mutedNote">Placeholder. Later: 72 Names, Zohar bites, patterns.</div>
    </section>

    <!-- TOOLS -->
    <section class="panel" data-pane="tools">
      <h2>Tools</h2>
      <div class="mutedNote">Placeholder. Later: gematria, astrology, streak logic, export.</div>
    </section>

    <!-- HISTORY -->
    <section class="panel" data-pane="history">
      <h2>History</h2>
      <div class="field">
        <label>Raw saved JSON (for sanity checking)</label>
        <textarea id="historyDump" readonly></textarea>
      </div>
      <div class="row">
        <button class="btn" id="refreshHistory">Refresh</button>
        <button class="btn danger" id="nuke">Reset Day</button>
      </div>
    </section>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__tmo);
      window.__tmo = setTimeout(()=> t.style.display="none", 1800);
    }

    const todayISO = () => new Date().toISOString().slice(0,10);

    const KEY = "kai_state_v1";

    function readState(){
      try{ return JSON.parse(localStorage.getItem(KEY) || "{}"); }
      catch{ return {}; }
    }
    function writeState(patch){
      const s = readState();
      const next = { ...s, ...patch, updatedAt: new Date().toISOString() };
      localStorage.setItem(KEY, JSON.stringify(next));
      renderChips();
      renderShare();
      return next;
    }

    function renderChips(){
      const s = readState();
      $("chipDate").textContent = todayISO();
      $("chipProfile").textContent = s.name || "—";
      $("chipStreak").textContent = s.streak ?? "—";
      $("chipDailyRestrict").textContent = s.doneToday ? "✅" : "—";
    }

    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(el => {
        el.classList.toggle("active", el.dataset.tab === tab);
      });
      document.querySelectorAll("[data-pane]").forEach(p => {
        p.classList.toggle("active", p.dataset.pane === tab);
      });
      localStorage.setItem("kai_last_tab_v1", tab);
    }

    function hydrateUI(){
      const s = readState();
      $("name").value = s.name || "Bernard";
      $("birthdate").value = s.birthdate || "";
      $("focus").value = s.focus || "";
      $("outcome").value = s.outcome || "Increase certainty and reduce urgency";
      $("intensity").value = s.intensity || "Simple + Powerful";
      $("enable").value = s.enable || "Core + Tools";

      $("certainty").value = s.certainty ?? "";
      $("energy").value = s.energy ?? "";
      $("intention").value = s.intention ?? "";

      $("restrictMove").value = s.restrictMove || "";
      $("witness").value = s.witness || "";

      $("historyDump").value = JSON.stringify(s, null, 2);
    }

    function renderShare(){
      const s = readState();
      const lines = [];
      lines.push(`KAI • ${todayISO()}`);
      if(s.name) lines.push(`Name: ${s.name}`);
      if(s.focus) lines.push(`Focus: ${s.focus}`);
      if(s.outcome) lines.push(`30-day: ${s.outcome}`);
      if(s.intention) lines.push(`Intention: ${s.intention}`);
      if(s.restrictMove) lines.push(`Restriction: ${s.restrictMove}`);
      if(s.witness) lines.push(`Witness: ${s.witness}`);
      $("shareText").value = lines.join("\n");
    }

    function wireTabs(){
      // click + touchend to beat iOS weirdness
      document.querySelectorAll(".tab").forEach(btn => {
        const handler = (e) => {
          e.preventDefault();
          setActiveTab(btn.dataset.tab);
        };
        btn.addEventListener("click", handler, { passive:false });
        btn.addEventListener("touchend", handler, { passive:false });
      });
    }

    // ---------- actions ----------
    $("saveProfile").onclick = () => {
      writeState({
        name: $("name").value.trim(),
        birthdate: $("birthdate").value.trim(),
        focus: $("focus").value,
        outcome: $("outcome").value.trim(),
        intensity: $("intensity").value,
        enable: $("enable").value
      });
      toast("Saved ✅");
      hydrateUI();
    };

    $("copyProfile").onclick = async () => {
      const s = readState();
      const txt = `KAI Profile\nName: ${s.name||""}\nBirthdate: ${s.birthdate||""}\nFocus: ${s.focus||""}\n30-day: ${s.outcome||""}`;
      await navigator.clipboard.writeText(txt);
      toast("Copied ✅");
    };

    $("exportProfile").onclick = async () => {
      const s = readState();
      await navigator.clipboard.writeText(JSON.stringify(s, null, 2));
      toast("Export copied ✅");
    };

    $("saveMorning").onclick = () => {
      writeState({
        certainty: $("certainty").value === "" ? null : Number($("certainty").value),
        energy: $("energy").value === "" ? null : Number($("energy").value),
        intention: $("intention").value.trim()
      });
      toast("Saved ✅");
      hydrateUI();
    };
    $("resetMorning").onclick = () => {
      writeState({ certainty:null, energy:null, intention:"" });
      toast("Reset ✅");
      hydrateUI();
    };

    $("saveRestrict").onclick = () => {
      writeState({ restrictMove: $("restrictMove").value.trim() });
      toast("Saved ✅");
      hydrateUI();
    };

    $("markDone").onclick = () => {
      const s = readState();
      const nextStreak = (s.streak || 0) + 1;
      writeState({ doneToday:true, streak: nextStreak });
      toast("Done ✅");
      hydrateUI();
    };

    $("saveEvening").onclick = () => {
      writeState({ witness: $("witness").value.trim() });
      toast("Saved ✅");
      hydrateUI();
    };
    $("resetEvening").onclick = () => {
      writeState({ witness:"" });
      toast("Reset ✅");
      hydrateUI();
    };

    $("copyShare").onclick = async () => {
      await navigator.clipboard.writeText($("shareText").value);
      toast("Copied ✅");
    };

    $("nativeShare").onclick = async () => {
      const txt = $("shareText").value;
      if(navigator.share){
        try{
          await navigator.share({ text: txt });
          toast("Shared ✅");
        } catch(e){
          toast("Share canceled");
        }
      } else {
        await navigator.clipboard.writeText(txt);
        toast("No native share. Copied ✅");
      }
    };

    $("refreshHistory").onclick = () => {
      hydrateUI();
      toast("Refreshed ✅");
    };

    $("nuke").onclick = () => {
      localStorage.removeItem(KEY);
      localStorage.removeItem("kai_last_tab_v1");
      toast("Reset Day ✅");
      hydrateUI();
      renderChips();
      renderShare();
    };

    // ---------- boot ----------
    (function(){
      wireTabs();

      // restore last tab
      const last = localStorage.getItem("kai_last_tab_v1") || "start";
      setActiveTab(last);

      renderChips();
      hydrateUI();
      renderShare();

      // quick sanity ping (non-annoying)
      setTimeout(()=>toast("KAI live ✅"), 250);
    })();
  </script>
</body>
</html>
