<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KAI — Prototype (Stable)</title>

  <!-- PWA hooks (keep yours if already working) -->
  <link rel="manifest" href="./manifest.json?v=20260222a">
  <link rel="apple-touch-icon" href="./apple-touch-icon-v3.png?v=20260222a">
  <link rel="icon" href="./icon-192-v3.png?v=20260222a">

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#141416;
      --panel2:#101012;
      --line:#2a2a2f;
      --text:#f2f2f2;
      --muted:#a7a7ad;
      --gold:#f6d35a;
      --ok:#5bffb1;
      --danger:#ff5b5b;
      --chip:#1b1b1f;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:14px;
      --tap: 46px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% 0%, #161618 0%, var(--bg) 55%);
      color:var(--text);
      padding:18px 14px 24px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .title{
      text-align:center;
      letter-spacing:.8px;
      font-weight:800;
      font-size:34px;
      margin:8px 0 10px;
    }

    .chips{
      display:flex;flex-wrap:wrap;gap:10px;justify-content:center;
      margin:8px 0 14px;
    }
    .chip{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      display:flex;gap:8px;align-items:baseline;
      min-height:36px;
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
    }
    .chip b{color:var(--gold)}
    .chip small{color:var(--muted);font-size:12px}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
      margin: 12px 0 18px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius:999px;
      padding:10px 14px;
      min-height:var(--tap);
      cursor:pointer;
      user-select:none;
      font-weight:650;
    }
    .tab.active{
      background: rgba(246,211,90,.16);
      border-color: rgba(246,211,90,.5);
      color: var(--gold);
    }
    .tab:active{transform: translateY(1px)}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media(max-width:860px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h3{
      margin:0 0 10px;
      font-size:15px;
      color: var(--muted);
      font-weight:700;
      letter-spacing:.25px;
    }
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .spacer{height:10px}

    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input[type="text"], input[type="date"], textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline:none;
      min-height: var(--tap);
    }
    textarea{min-height:110px;resize:vertical}

    input[type="range"]{width:100%}

    .btn{
      min-height:var(--tap);
      border-radius: 14px;
      padding: 11px 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:750;
    }
    .btn.primary{
      background: rgba(91,255,177,.16);
      border-color: rgba(91,255,177,.35);
      color: var(--ok);
    }
    .btn.gold{
      background: rgba(246,211,90,.16);
      border-color: rgba(246,211,90,.45);
      color: var(--gold);
    }
    .btn.danger{
      background: rgba(255,91,91,.14);
      border-color: rgba(255,91,91,.35);
      color: var(--danger);
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .hint{color:var(--muted);font-size:12px;line-height:1.35}

    .section{display:none}
    .section.active{display:block}

    .list{
      display:flex;flex-direction:column;gap:10px;
      max-height: 420px; overflow:auto; padding-right:6px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:12px;
      cursor:pointer;
      user-select:none;
    }
    .item:hover{border-color: rgba(246,211,90,.35)}
    .item b{display:block}
    .item small{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.3);
      color: var(--muted);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
    }

    .detailTitle{
      display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;
    }
    .hebrew{font-size:22px;letter-spacing:1px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(0,0,0,.82);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--text);
      font-size: 13px;
      z-index: 9999;
      max-width: calc(100vw - 24px);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      display:none;
    }
    .errbox{
      display:none;
      background: rgba(255,91,91,.12);
      border: 1px solid rgba(255,91,91,.35);
      color: #ffd3d3;
      border-radius: 14px;
      padding: 12px;
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.35;
      margin: 12px 0;
    }

    canvas{max-width:100%;border-radius:14px;border:1px solid var(--line);background:#000}
    .foot{margin-top:14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>

<body>
<div class="wrap">
  <div class="title">KAI</div>

  <div id="errbox" class="errbox"></div>

  <div class="chips" aria-label="Top metrics">
    <div class="chip"><small>Pillars</small> <b id="chip_pillars">0</b><small>/100</small></div>
    <div class="chip"><small>Cycles</small> <b id="chip_cycles">0</b><small>/10</small></div>
    <div class="chip"><small>Certainty</small> <b id="chip_cert">5</b><small>/10</small></div>
    <div class="chip"><small>Energy</small> <b id="chip_energy">5</b><small>/10</small></div>
  </div>

  <div class="tabs" role="tablist" aria-label="Navigation">
    <button class="tab active" data-tab="home" type="button">Home</button>
    <button class="tab" data-tab="practice" type="button">Practice</button>
    <button class="tab" data-tab="names72" type="button">72 Names</button>
    <button class="tab" data-tab="gematria" type="button">Gematria</button>
    <button class="tab" data-tab="zohar" type="button">Zohar</button>
    <button class="tab" data-tab="share" type="button">Share Card</button>
    <button class="tab" data-tab="history" type="button">History</button>
    <button class="tab" data-tab="settings" type="button">Settings</button>
  </div>

  <!-- HOME -->
  <section id="sec_home" class="section active">
    <div class="grid">
      <div class="card">
        <h3>Daily Metrics</h3>

        <div class="row" style="gap:14px">
          <div style="flex:1">
            <label>Certainty</label>
            <input id="rng_cert" type="range" min="0" max="10" step="1" />
            <div class="hint">Set quickly. This is your Sinai clarity gauge.</div>
          </div>
          <div style="flex:1">
            <label>Energy</label>
            <input id="rng_energy" type="range" min="0" max="10" step="1" />
            <div class="hint">Simple and honest. No story, just data.</div>
          </div>
        </div>

        <div class="hr"></div>

        <h3>Quick Actions</h3>
        <div class="row wrap">
          <button id="btn_connect" class="btn primary" type="button">CONNECT (+pillar)</button>
          <button id="btn_cycle" class="btn" type="button">Run Full Cycle</button>
          <button id="btn_today72" class="btn gold" type="button">Today’s 72 Name</button>
        </div>

        <div class="spacer"></div>
        <div class="hint">
          “Pillars” = connection reps. “Cycles” = full 5-step CARES cycle completed.
        </div>
      </div>

      <div class="card">
        <h3>Profile</h3>
        <div class="row" style="gap:14px">
          <div style="flex:1">
            <label>Birthday</label>
            <input id="inp_bday" type="date" />
          </div>
          <div style="flex:1">
            <label>Astrological Sign</label>
            <input id="inp_sign" type="text" placeholder="Auto from birthday (basic)" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row" style="gap:14px">
          <div style="flex:1">
            <label>Tikkun (enter for now)</label>
            <input id="inp_tikkun" type="text" placeholder="e.g., (enter Centre method later)" />
          </div>
          <div style="flex:1">
            <label>Notes</label>
            <input id="inp_notes" type="text" placeholder="Optional…" />
          </div>
        </div>

        <div class="spacer"></div>
        <div class="hint">
          This build stays “Centre language” neutral: tool-first, not preachy. We can deepen once Eitan guides exact framing.
        </div>
      </div>
    </div>
  </section>

  <!-- PRACTICE -->
  <section id="sec_practice" class="section">
    <div class="grid">
      <div class="card">
        <h3>Cycle</h3>
        <div class="hint"><b class="mono">CONNECT → ALIGN → RESTRICT → ELEVATE → SEAL</b></div>
        <div class="spacer"></div>
        <div class="row wrap">
          <button class="btn primary" id="step_connect" type="button">CONNECT</button>
          <button class="btn" id="step_align" type="button">ALIGN</button>
          <button class="btn" id="step_restrict" type="button">RESTRICT</button>
          <button class="btn" id="step_elevate" type="button">ELEVATE</button>
          <button class="btn gold" id="step_seal" type="button">SEAL</button>
        </div>
        <div class="spacer"></div>
        <label>One-line note (optional)</label>
        <input id="inp_line" type="text" placeholder="One line: what I’m choosing now…" />
        <div class="spacer"></div>
        <button id="btn_save_line" class="btn" type="button">Save Line to History</button>
        <div class="spacer"></div>
        <div class="hint">
          “Line” = a single sentence of alignment you can revisit later. Not an essay. Not a manifesto.
        </div>
      </div>

      <div class="card">
        <h3>Today</h3>
        <div id="practice_today" class="hint">Loading…</div>
        <div class="hr"></div>
        <button id="btn_pick_random72" class="btn gold" type="button">Pick Random 72 Name</button>
        <div class="spacer"></div>
        <div class="hint">Tip: Use the 72 Names tab for titles, assessment, and saving reflections.</div>
      </div>
    </div>
  </section>

  <!-- 72 NAMES -->
  <section id="sec_names72" class="section">
    <div class="grid">
      <div class="card">
        <h3>Browse</h3>
        <div class="row">
          <input id="n72_search" type="text" placeholder="Search title/subtitle or “#48”" />
          <button id="n72_random" class="btn gold" type="button" style="min-width:140px">Random</button>
        </div>
        <div class="spacer"></div>
        <div id="n72_list" class="list"></div>
      </div>

      <div class="card">
        <h3>Detail</h3>
        <div id="n72_detail" class="hint">Select a Name…</div>
        <div class="hr"></div>

        <h3>Self-Assessment (72 statements)</h3>
        <div class="hint">Agree/Disagree. Save. Track over time.</div>
        <div class="spacer"></div>
        <div class="row wrap">
          <button id="assess_start" class="btn primary" type="button">Start / Continue</button>
          <button id="assess_save" class="btn gold" type="button">Save Snapshot</button>
          <button id="assess_reset" class="btn danger" type="button">Reset</button>
        </div>
        <div class="spacer"></div>
        <div id="assess_ui" class="list" style="max-height:320px"></div>
      </div>
    </div>
  </section>

  <!-- GEMATRIA -->
  <section id="sec_gematria" class="section">
    <div class="grid">
      <div class="card">
        <h3>Gematria</h3>
        <label>Enter Hebrew (preferred) or letters</label>
        <input id="gem_input" type="text" placeholder="Example: אהבה" />
        <div class="spacer"></div>
        <div class="row wrap">
          <button id="gem_calc" class="btn gold" type="button">Calculate</button>
          <button id="gem_clear" class="btn danger" type="button">Clear</button>
        </div>
        <div class="hr"></div>
        <div id="gem_out" class="hint">Enter a word and calculate.</div>
      </div>

      <div class="card">
        <h3>Insight Stub</h3>
        <div class="hint">
          You were right: calculation alone is not enough. This build keeps a clean slot for “Insight” so we can plug in Centre-aligned interpretation later (Eitan-approved language).
        </div>
        <div class="spacer"></div>
        <label>Insight (manual for now)</label>
        <textarea id="gem_insight" placeholder="Write a Centre-aligned insight here…"></textarea>
        <div class="spacer"></div>
        <button id="gem_save" class="btn primary" type="button">Save Insight to History</button>
      </div>
    </div>
  </section>

  <!-- ZOHAR -->
  <section id="sec_zohar" class="section">
    <div class="grid">
      <div class="card">
        <h3>Zohar Library</h3>
        <div class="hint">Seed passages now, expand later. Keep it practical: short excerpt + practice prompt.</div>
        <div class="spacer"></div>
        <div id="zohar_list" class="list"></div>
      </div>

      <div class="card">
        <h3>Add Passage</h3>
        <label>Title</label>
        <input id="z_title" type="text" placeholder="e.g., Atika Kadisha — sweetening Din" />
        <div class="spacer"></div>
        <label>Source (optional)</label>
        <input id="z_src" type="text" placeholder="e.g., Zohar, Parasha…, verse…" />
        <div class="spacer"></div>
        <label>Excerpt (short)</label>
        <textarea id="z_txt" placeholder="Keep it short. You can store longer study elsewhere."></textarea>
        <div class="spacer"></div>
        <label>Practice Prompt</label>
        <input id="z_prac" type="text" placeholder="One action: restriction / sharing / certainty…" />
        <div class="spacer"></div>
        <button id="z_add" class="btn gold" type="button">Add to Library</button>
      </div>
    </div>
  </section>

  <!-- SHARE -->
  <section id="sec_share" class="section">
    <div class="grid">
      <div class="card">
        <h3>Share Card</h3>
        <label>Title</label>
        <input id="sc_title" type="text" placeholder="72 Name #48 — Unity" />
        <div class="spacer"></div>
        <label>Hebrew Letters (optional)</label>
        <input id="sc_hebrew" type="text" placeholder="מ־י־ה" />
        <div class="spacer"></div>
        <label>Text</label>
        <textarea id="sc_text" placeholder="Short Centre-aligned text + one practice."></textarea>
        <div class="spacer"></div>
        <div class="row wrap">
          <button id="sc_make" class="btn gold" type="button">Generate Card</button>
          <button id="sc_download" class="btn primary" type="button">Download PNG</button>
        </div>
        <div class="spacer"></div>
        <div class="hint">On iOS, download saves the image. You can then message it to Eitan.</div>
      </div>

      <div class="card">
        <h3>Preview</h3>
        <canvas id="sc_canvas" width="1080" height="1350"></canvas>
        <div class="foot">KAI • <span id="sc_date"></span></div>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="sec_history" class="section">
    <div class="card">
      <h3>History</h3>
      <div class="row wrap">
        <button id="hist_clear" class="btn danger" type="button">Clear History</button>
        <button id="hist_export" class="btn gold" type="button">Export JSON</button>
      </div>
      <div class="spacer"></div>
      <div id="hist_list" class="list" style="max-height:520px"></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="sec_settings" class="section">
    <div class="grid">
      <div class="card">
        <h3>Data</h3>
        <div class="row wrap">
          <button id="btn_reset_all" class="btn danger" type="button">Reset ALL Data</button>
          <button id="btn_export_all" class="btn gold" type="button">Export ALL JSON</button>
        </div>
        <div class="spacer"></div>
        <label>Import JSON</label>
        <textarea id="inp_import" placeholder="Paste exported JSON here…"></textarea>
        <div class="spacer"></div>
        <button id="btn_import_all" class="btn primary" type="button">Import</button>
        <div class="spacer"></div>
        <div class="hint">This is for stabilizing builds across devices (iPhone/iPad) without weird partial state.</div>
      </div>

      <div class="card">
        <h3>Debug</h3>
        <div class="hint">
          If anything ever goes “static,” it should show a red error box at top and a toast with the exact error.
        </div>
        <div class="spacer"></div>
        <div class="row wrap">
          <button id="btn_smoke" class="btn" type="button">Run Smoke Test</button>
        </div>
        <div class="spacer"></div>
        <div class="hint mono" id="dbg_out"></div>
      </div>
    </div>
  </section>

  <div class="toast" id="toast"></div>
</div>

<script>
(function(){
  "use strict";

  // -------------------------
  // Utilities
  // -------------------------
  const $ = (sel)=> document.querySelector(sel);
  const $$ = (sel)=> Array.from(document.querySelectorAll(sel));

  const toastEl = $("#toast");
  let toastTimer = null;
  function toast(msg){
    try{
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.style.display = "none", 2200);
    }catch(_){}
  }

  const errBox = $("#errbox");
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }

  function safeParse(json, fallback){
    try{ return JSON.parse(json); }catch(_){ return fallback; }
  }
  function nowISO(){ return new Date().toISOString(); }
  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  // -------------------------
  // Storage Keys
  // -------------------------
  const KEY = {
    state: "kai_state_v1",
    history: "kai_history_v1",
    zohar: "kai_zohar_v1",
    assessAnswers: "kai_72_assess_answers_v1",
    assessSnapshots: "kai_72_assess_snapshots_v1",
    gemInsights: "kai_gem_insights_v1",
    today72: "kai_today72_v1"
  };

  function loadState(){
    return safeParse(localStorage.getItem(KEY.state), {
      pillars: 0,
      cycles: 0,
      certainty: 5,
      energy: 5,
      profile: { bday:"", sign:"", tikkun:"", notes:"" },
      practiceLine: ""
    });
  }
  function saveState(){
    localStorage.setItem(KEY.state, JSON.stringify(state));
  }

  function loadHistory(){
    return safeParse(localStorage.getItem(KEY.history), []);
  }
  function saveHistory(){
    localStorage.setItem(KEY.history, JSON.stringify(history));
  }
  function logEvent(type, detail){
    history.unshift({ at: nowISO(), type, detail: detail || "" });
    if(history.length > 400) history.length = 400;
    saveHistory();
    renderHistory();
  }

  // -------------------------
  // 72 Names Data (titles/subtitles from your screenshots)
  // Notes:
  // - This is the "topic index" layer.
  // - The Hebrew letters + detailed "meaning text" can be added per Name later.
  // -------------------------
  const N72_TITLES = [
    {id:1,  title:"Time Travel", subtitle:"How to fix the past"},
    {id:2,  title:"Recapturing the Sparks", subtitle:"Recharging when you are depleted"},
    {id:3,  title:"Miracle Making", subtitle:"A recipe"},
    {id:4,  title:"Eliminating Negative Thoughts", subtitle:"When and how"},
    {id:5,  title:"Healing", subtitle:"Meditation for yourself and others"},
    {id:6,  title:"Dream State", subtitle:"Activating messages from the subconscious"},
    {id:7,  title:"DNA of Soul", subtitle:"Restoring to their perfect state"},
    {id:8,  title:"Defusing Negative Energy and Stress", subtitle:"Releasing the pressure"},
    {id:9,  title:"Angelic Influences", subtitle:"Harnessing help from above"},
    {id:10, title:"Looks Can Kill", subtitle:"Protecting yourself from the evil-eye"},
    {id:11, title:"Banishing the Remnants of Evil", subtitle:"Purifying places and spaces"},
    {id:12, title:"Unconditional Love", subtitle:"How to awaken love, especially when you don’t want to"},
    {id:13, title:"Heaven on Earth", subtitle:"Creating harmony within and without"},
    {id:14, title:"Farewell to Arms", subtitle:"Diffusing conflict"},
    {id:15, title:"Long-Range Vision", subtitle:"Seeing the effect of decisions before you make them"},
    {id:16, title:"Dumping Depression", subtitle:"How to pick yourself up when you fall"},
    {id:17, title:"Great Escape", subtitle:"Breaking the limits of ego"},
    {id:18, title:"Fertility", subtitle:"When conception is difficult"},
    {id:19, title:"Dialing God", subtitle:"Receiving answers to your prayers"},
    {id:20, title:"Victory Over Addictions", subtitle:"Overcoming your negative self"},
    {id:21, title:"Eradicate Plague", subtitle:"Effecting change in the physical world"},
    {id:22, title:"Stop Fatal Attraction", subtitle:"How to stop drawing the wrong people into your life"},
    {id:23, title:"Sharing the Flame", subtitle:"Passing the wisdom along"},
    {id:24, title:"Jealousy", subtitle:"Undoing chaos resulting from jealousy before it is manifested"},
    {id:25, title:"Speak Your Mind", subtitle:"For those times when you need help expressing the truth"},
    {id:26, title:"Order from Chaos", subtitle:"Reversing Murphy’s Law"},
    {id:27, title:"Silent Partner", subtitle:"Choosing positivity as your partner"},
    {id:28, title:"Soul Mate", subtitle:"Attracting “The One”"},
    {id:29, title:"Removing Hatred", subtitle:"Drawing out the poison"},
    {id:30, title:"Building Bridges", subtitle:"Mending broken relationships"},
    {id:31, title:"Finish What You Start", subtitle:"Finding the power to finish what you start"},
    {id:32, title:"Memories", subtitle:"Breaking the cycle"},
    {id:33, title:"Revealing the Dark Side", subtitle:"Removing the obstacles you create"},
    {id:34, title:"Forget Thyself", subtitle:"Opening up to another view"},
    {id:35, title:"Sexual Energy", subtitle:"How to get more from your sexual experience"},
    {id:36, title:"Fear(less)", subtitle:"Overcoming the ties that bind"},
    {id:37, title:"The Big Picture", subtitle:"Seeing the opportunity for good hidden in every challenge"},
    {id:38, title:"Circuitry", subtitle:"Sharing so you can truly receive"},
    {id:39, title:"Diamond in the Rough", subtitle:"Turning the coal in your life into diamonds"},
    {id:40, title:"Speaking the Right Words", subtitle:"Using language to make good things happen"},
    {id:41, title:"Self-Esteem", subtitle:"Finding the power to lift yourself up"},
    {id:42, title:"Revealing the Concealed", subtitle:"Seeing the truth and handling it"},
    {id:43, title:"Defying Gravity", subtitle:"Achieving mind over matter"},
    {id:44, title:"Sweetening Judgment", subtitle:"Stop the judgment that is happening against you"},
    {id:45, title:"The Power of Prosperity", subtitle:"What to do when you need money"},
    {id:46, title:"Absolute Certainty", subtitle:"What to do when doubts creep in"},
    {id:47, title:"Global Transformation", subtitle:"Helping to bring about world peace"},
    {id:48, title:"Unity", subtitle:"When there is conflict and only togetherness will do"},
    {id:49, title:"Happiness", subtitle:"When you need the power to choose happiness"},
    {id:50, title:"Enough Is Never Enough", subtitle:"When you need the passion to keep from settling for less"},
    {id:51, title:"No Guilt", subtitle:"Removing negativity aspects of your nature while you repair the damage they cause"},
    {id:52, title:"Passion", subtitle:"Awaken the earning in your heart"},
    {id:53, title:"No Agenda", subtitle:"Giving with no strings attached"},
    {id:54, title:"The Death of Death", subtitle:"When things are good and you want them to stay that way"},
    {id:55, title:"Thought into Action", subtitle:"The power to make it happen"},
    {id:56, title:"Dispelling Anger", subtitle:"Overcoming it before it overcomes you"},
    {id:57, title:"Listen to Your Soul", subtitle:"Increasing the volume of the soft voice within"},
    {id:58, title:"Letting Go", subtitle:"When you need the power to walk away"},
    {id:59, title:"Umbilical Cord", subtitle:"Connecting to the Light Force"},
    {id:60, title:"Freedom", subtitle:"Passing the test and going to the next level"},
    {id:61, title:"Water", subtitle:"Removing negativity from the source of life"},
    {id:62, title:"Parent–Teacher, Not Preacher", subtitle:"When you need to teach your children"},
    {id:63, title:"Appreciation", subtitle:"How to keep what you have and get more"},
    {id:64, title:"Casting Yourself in a Favorable Light", subtitle:"Revealing the best you"},
    {id:65, title:"Fear of God", subtitle:"Remembering there is a system and how to work it"},
    {id:66, title:"Accountability", subtitle:"Taking accountability for your happiness and life"},
    {id:67, title:"Great Expectations", subtitle:"How to stop getting disappointed"},
    {id:68, title:"Contacting Departed Souls", subtitle:"Making positive connections with those who have passed on"},
    {id:69, title:"Lost and Found", subtitle:"What to do when you are lost and confused"},
    {id:70, title:"Recognizing Design Beneath Disorder", subtitle:"Finding the solution within the problem"},
    {id:71, title:"Prophecy and Parallel Universes", subtitle:"Switching your universe for a better one"},
    {id:72, title:"Spiritual Cleansing", subtitle:"Purging yourself of negativity"}
  ];

  // Minimal per-Name detail (letters & meaning can be expanded later)
  // You can later replace "hebrew" and "core/practice" per Name with Centre-approved text.
  const N72_MIN = N72_TITLES.map(x => ({
    id: x.id,
    title: x.title,
    subtitle: x.subtitle,
    hebrew: "",           // e.g., "מיה"
    core: "",             // core concept
    practice: ""          // one action prompt
  }));

  // Self-assessment statements (we store them as text; you can paste the full official set later if needed)
  // For now we seed a light placeholder set + one example you referenced (#48 theme).
  function buildAssessStatements(){
    const arr = [];
    for(let i=1;i<=72;i++){
      arr.push({ id:i, text:`Statement for Name #${i} (paste Centre statement here)` });
    }
    // Your example from screenshot context about #48 distance/division
    arr[47] = { id:48, text:"I tend to feel very distant from people who don’t agree with me." };
    return arr;
  }
  const ASSESS = buildAssessStatements();

  // -------------------------
  // App State
  // -------------------------
  let state = loadState();
  let history = loadHistory();

  // Zohar
  function loadZohar(){
    const seed = [
      { id: "z1", title:"Atika Kadisha — Sweetening Din", src:"Seed", txt:"Short excerpt placeholder.", prac:"One restriction: pause before reacting." },
      { id: "z2", title:"Building the Mishkan (Unity)", src:"Seed", txt:"Short excerpt placeholder.", prac:"Choose unity over division in one conversation today." }
    ];
    const z = safeParse(localStorage.getItem(KEY.zohar), seed);
    return Array.isArray(z) ? z : seed;
  }
  let zohar = loadZohar();
  function saveZohar(){ localStorage.setItem(KEY.zohar, JSON.stringify(zohar)); }

  // Assessment answers
  let assessAnswers = safeParse(localStorage.getItem(KEY.assessAnswers), {});
  let assessSnaps = safeParse(localStorage.getItem(KEY.assessSnapshots), []);

  // Gem insights
  let gemInsights = safeParse(localStorage.getItem(KEY.gemInsights), []);

  // Today 72 selection
  let today72 = safeParse(localStorage.getItem(KEY.today72), { date:"", id: null });

  // -------------------------
  // Rendering helpers
  // -------------------------
  function updateChips(){
    $("#chip_pillars").textContent = String(state.pillars || 0);
    $("#chip_cycles").textContent = String(state.cycles || 0);
    $("#chip_cert").textContent = String(state.certainty ?? 5);
    $("#chip_energy").textContent = String(state.energy ?? 5);
  }

  function zodiacSignFromDate(iso){
    if(!iso) return "";
    const d = new Date(iso + "T00:00:00");
    const m = d.getMonth()+1, day=d.getDate();
    // basic western zodiac ranges (approx)
    const z = [
      ["Capricorn",1,19], ["Aquarius",2,18], ["Pisces",3,20], ["Aries",4,19],
      ["Taurus",5,20], ["Gemini",6,20], ["Cancer",7,22], ["Leo",8,22],
      ["Virgo",9,22], ["Libra",10,22], ["Scorpio",11,21], ["Sagittarius",12,21],
      ["Capricorn",12,31]
    ];
    // Determine sign by cutoff day per month
    const cutoffs = {1:19,2:18,3:20,4:19,5:20,6:20,7:22,8:22,9:22,10:22,11:21,12:21};
    const signsBefore = {1:"Capricorn",2:"Aquarius",3:"Pisces",4:"Aries",5:"Taurus",6:"Gemini",7:"Cancer",8:"Leo",9:"Virgo",10:"Libra",11:"Scorpio",12:"Sagittarius"};
    const signsAfter  = {1:"Aquarius",2:"Pisces",3:"Aries",4:"Taurus",5:"Gemini",6:"Cancer",7:"Leo",8:"Virgo",9:"Libra",10:"Scorpio",11:"Sagittarius",12:"Capricorn"};
    return day <= cutoffs[m] ? signsBefore[m] : signsAfter[m];
  }

  function ensureToday72(){
    const t = todayKey();
    if(today72.date !== t || !today72.id){
      const idx = (new Date().getFullYear()*10000 + (new Date().getMonth()+1)*100 + new Date().getDate()) % 72;
      today72 = { date: t, id: idx+1 };
      localStorage.setItem(KEY.today72, JSON.stringify(today72));
    }
  }

  function renderPracticeToday(){
    ensureToday72();
    const obj = N72_MIN.find(x=>x.id===today72.id) || N72_MIN[0];
    $("#practice_today").innerHTML = `
      <div class="detailTitle">
        <span class="pill">Today</span>
        <b>#${obj.id} ${escapeHtml(obj.title)}</b>
      </div>
      <div class="hint">${escapeHtml(obj.subtitle || "")}</div>
      <div class="spacer"></div>
      <div class="hint">Practice: <b>Build your Mishkan</b> (placeholder prompt)</div>
    `;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // 72 Names UI
  function n72_renderList(list){
    const box = $("#n72_list");
    box.innerHTML = "";
    list.forEach(x=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `<b>#${x.id} ${escapeHtml(x.title)}</b><small>${escapeHtml(x.subtitle||"")}</small>`;
      el.addEventListener("click", ()=> n72_renderDetail(x.id));
      box.appendChild(el);
    });
  }

  function n72_renderDetail(id){
    const x = N72_MIN.find(n=>n.id===id);
    if(!x) return;
    const detail = $("#n72_detail");

    // If you later add hebrew/core/practice, it will show automatically.
    detail.innerHTML = `
      <div class="detailTitle">
        <span class="pill">72 Name</span>
        <b>#${x.id} ${escapeHtml(x.title)}</b>
      </div>
      <div class="hint">${escapeHtml(x.subtitle||"")}</div>
      <div class="spacer"></div>
      ${x.hebrew ? `<div class="hebrew">${escapeHtml(x.hebrew)}</div>` : `<div class="hint">Hebrew letters: <span class="mono">(add later)</span></div>`}
      <div class="spacer"></div>
      <div class="hint"><b>Core:</b> ${x.core ? escapeHtml(x.core) : "<span class='mono'>(add later)</span>"}</div>
      <div class="hint"><b>Practice:</b> ${x.practice ? escapeHtml(x.practice) : "<span class='mono'>(add later)</span>"}</div>
      <div class="spacer"></div>
      <button class="btn gold" type="button" id="btn_use_for_share">Use in Share Card</button>
    `;

    // Wire the share button
    setTimeout(()=>{
      const b = $("#btn_use_for_share");
      if(b){
        b.addEventListener("click", ()=>{
          $("#sc_title").value = `72 Name #${x.id} — ${x.title}`;
          $("#sc_text").value = (x.practice ? `Practice: ${x.practice}` : `Practice: ${x.subtitle || x.title}`);
          toast("Loaded into Share Card");
          switchTab("share");
        });
      }
    },0);
  }

  function n72_filter(q){
    q = (q||"").trim().toLowerCase();
    if(!q) return N72_MIN;
    if(q.startsWith("#")){
      const n = parseInt(q.slice(1),10);
      if(Number.isFinite(n)) return N72_MIN.filter(x=>x.id===n);
    }
    return N72_MIN.filter(x =>
      (x.title||"").toLowerCase().includes(q) ||
      (x.subtitle||"").toLowerCase().includes(q)
    );
  }

  // Assessment UI
  function renderAssessUI(){
    const box = $("#assess_ui");
    box.innerHTML = "";
    ASSESS.forEach(s=>{
      const v = assessAnswers[s.id] ?? null; // true/false/null
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between;gap:12px">
          <div style="flex:1">
            <b>#${s.id}</b>
            <small>${escapeHtml(s.text)}</small>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn ${v===true?'gold':''}" data-a="agree" data-id="${s.id}" type="button">Agree</button>
            <button class="btn ${v===false?'danger':''}" data-a="disagree" data-id="${s.id}" type="button">Disagree</button>
          </div>
        </div>
      `;
      box.appendChild(el);
    });

    // Wire agree/disagree
    box.querySelectorAll("button[data-id]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = parseInt(btn.getAttribute("data-id"),10);
        const a = btn.getAttribute("data-a");
        assessAnswers[id] = (a === "agree");
        localStorage.setItem(KEY.assessAnswers, JSON.stringify(assessAnswers));
        renderAssessUI();
      });
    });
  }

  function saveAssessSnapshot(){
    const snap = {
      at: nowISO(),
      date: todayKey(),
      answers: assessAnswers
    };
    assessSnaps.unshift(snap);
    if(assessSnaps.length > 80) assessSnaps.length = 80;
    localStorage.setItem(KEY.assessSnapshots, JSON.stringify(assessSnaps));
    logEvent("ASSESS_SNAPSHOT", `Saved 72-statement snapshot (${snap.date})`);
    toast("Assessment saved");
  }

  // Zohar UI
  function renderZoharList(){
    const box = $("#zohar_list");
    box.innerHTML = "";
    zohar.forEach(z=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <b>${escapeHtml(z.title)}</b>
        <small>${escapeHtml(z.src||"")}</small>
        <div class="spacer"></div>
        <div class="hint">${escapeHtml(z.txt||"")}</div>
        <div class="spacer"></div>
        <div class="hint"><b>Practice:</b> ${escapeHtml(z.prac||"")}</div>
      `;
      box.appendChild(el);
    });
  }

  // History UI
  function renderHistory(){
    const box = $("#hist_list");
    if(!box) return;
    box.innerHTML = "";
    if(!history.length){
      box.innerHTML = `<div class="hint">No history yet.</div>`;
      return;
    }
    history.forEach(h=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <b>${escapeHtml(h.type)}</b>
        <small>${escapeHtml(h.at)}</small>
        <div class="spacer"></div>
        <div class="hint">${escapeHtml(h.detail||"")}</div>
      `;
      box.appendChild(el);
    });
  }

  // Share card
  function drawShareCard(){
    const c = $("#sc_canvas");
    const ctx = c.getContext("2d");

    const W = c.width, H = c.height;
    const title = $("#sc_title").value.trim() || "KAI";
    const heb = $("#sc_hebrew").value.trim();
    const text = $("#sc_text").value.trim();

    // background
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#0b0b0c";
    ctx.fillRect(0,0,W,H);

    // gold bar
    ctx.fillStyle = "#f6d35a";
    ctx.fillRect(0,0,W,42);

    // title
    ctx.fillStyle = "#ffffff";
    ctx.font = "700 64px -apple-system, system-ui, Segoe UI, Roboto, Arial";
    wrapText(ctx, title, 70, 150, W-140, 74);

    // hebrew
    if(heb){
      ctx.fillStyle = "#d7d7db";
      ctx.font = "600 44px -apple-system, system-ui, Segoe UI, Roboto, Arial";
      ctx.fillText(heb, 70, 310);
    }

    // body text
    ctx.fillStyle = "#bdbdc4";
    ctx.font = "500 40px -apple-system, system-ui, Segoe UI, Roboto, Arial";
    wrapText(ctx, text, 70, heb ? 380 : 320, W-140, 56);

    // footer
    ctx.fillStyle = "rgba(255,255,255,.25)";
    ctx.font = "500 28px -apple-system, system-ui, Segoe UI, Roboto, Arial";
    ctx.fillText(`KAI • ${todayKey()}`, 70, H-90);

    $("#sc_date").textContent = todayKey();
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = String(text||"").split(/\s+/);
    let line = "";
    for(let n=0;n<words.length;n++){
      const testLine = line + words[n] + " ";
      const w = ctx.measureText(testLine).width;
      if(w > maxWidth && n > 0){
        ctx.fillText(line, x, y);
        line = words[n] + " ";
        y += lineHeight;
      } else {
        line = testLine;
      }
    }
    if(line) ctx.fillText(line, x, y);
  }

  function downloadCanvasPNG(){
    const c = $("#sc_canvas");
    const url = c.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = `KAI_${todayKey()}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Gematria
  const GEM = {
    "א":1,"ב":2,"ג":3,"ד":4,"ה":5,"ו":6,"ז":7,"ח":8,"ט":9,
    "י":10,"כ":20,"ך":20,"ל":30,"מ":40,"ם":40,"נ":50,"ן":50,"ס":60,
    "ע":70,"פ":80,"ף":80,"צ":90,"ץ":90,"ק":100,"ר":200,"ש":300,"ת":400
  };

  function gematriaValue(str){
    let sum = 0;
    const chars = Array.from(String(str||"").replace(/\s/g,""));
    for(const ch of chars){
      if(GEM[ch]) sum += GEM[ch];
    }
    return sum;
  }

  // -------------------------
  // Navigation
  // -------------------------
  function switchTab(name){
    $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    $$(".section").forEach(s => s.classList.remove("active"));
    const sec = $("#sec_"+name);
    if(sec) sec.classList.add("active");

    // tab-specific init refresh
    if(name==="practice") renderPracticeToday();
    if(name==="names72"){ n72_renderList(N72_MIN); renderAssessUI(); }
    if(name==="zohar") renderZoharList();
    if(name==="history") renderHistory();
    if(name==="share") drawShareCard();
  }

  // -------------------------
  // Wiring (no hidden invocations)
  // -------------------------
  function wire(){
    // tabs
    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=> switchTab(btn.dataset.tab));
    });

    // sliders
    $("#rng_cert").addEventListener("input", ()=>{
      state.certainty = parseInt($("#rng_cert").value,10);
      updateChips(); saveState();
    });
    $("#rng_energy").addEventListener("input", ()=>{
      state.energy = parseInt($("#rng_energy").value,10);
      updateChips(); saveState();
    });

    // home buttons
    $("#btn_connect").addEventListener("click", ()=>{
      state.pillars = (state.pillars||0) + 1;
      updateChips(); saveState();
      logEvent("CONNECT", "Pillar +1");
      toast("CONNECT +1");
    });

    $("#btn_cycle").addEventListener("click", ()=>{
      state.cycles = (state.cycles||0) + 1;
      updateChips(); saveState();
      logEvent("CYCLE", "Full cycle completed");
      toast("Cycle +1");
    });

    $("#btn_today72").addEventListener("click", ()=>{
      ensureToday72();
      const x = N72_MIN.find(n=>n.id===today72.id);
      if(x){
        switchTab("names72");
        n72_renderDetail(x.id);
        toast(`Today: #${x.id} ${x.title}`);
      }
    });

    // profile
    $("#inp_bday").addEventListener("change", ()=>{
      state.profile.bday = $("#inp_bday").value;
      const sign = zodiacSignFromDate(state.profile.bday);
      state.profile.sign = sign;
      $("#inp_sign").value = sign;
      saveState();
    });
    $("#inp_sign").addEventListener("input", ()=>{
      state.profile.sign = $("#inp_sign").value;
      saveState();
    });
    $("#inp_tikkun").addEventListener("input", ()=>{
      state.profile.tikkun = $("#inp_tikkun").value;
      saveState();
    });
    $("#inp_notes").addEventListener("input", ()=>{
      state.profile.notes = $("#inp_notes").value;
      saveState();
    });

    // practice cycle buttons
    $("#step_connect").addEventListener("click", ()=>{
      state.pillars = (state.pillars||0) + 1;
      updateChips(); saveState();
      logEvent("STEP_CONNECT", $("#inp_line").value.trim() || "");
      toast("CONNECT");
    });
    $("#step_align").addEventListener("click", ()=>{ logEvent("STEP_ALIGN", $("#inp_line").value.trim() || ""); toast("ALIGN"); });
    $("#step_restrict").addEventListener("click", ()=>{ logEvent("STEP_RESTRICT", $("#inp_line").value.trim() || ""); toast("RESTRICT"); });
    $("#step_elevate").addEventListener("click", ()=>{ logEvent("STEP_ELEVATE", $("#inp_line").value.trim() || ""); toast("ELEVATE"); });
    $("#step_seal").addEventListener("click", ()=>{
      state.cycles = (state.cycles||0) + 1;
      updateChips(); saveState();
      logEvent("STEP_SEAL", $("#inp_line").value.trim() || "");
      toast("SEAL + cycle");
    });

    $("#btn_save_line").addEventListener("click", ()=>{
      const line = $("#inp_line").value.trim();
      if(!line){ toast("Add a line first"); return; }
      logEvent("LINE", line);
      $("#inp_line").value = "";
      toast("Saved");
    });

    $("#btn_pick_random72").addEventListener("click", ()=>{
      const pick = N72_MIN[Math.floor(Math.random()*N72_MIN.length)];
      ensureToday72();
      $("#practice_today").innerHTML = `
        <div class="detailTitle"><span class="pill">Random</span><b>#${pick.id} ${escapeHtml(pick.title)}</b></div>
        <div class="hint">${escapeHtml(pick.subtitle||"")}</div>
      `;
      logEvent("RANDOM_72", `#${pick.id} ${pick.title}`);
      toast(`#${pick.id} ${pick.title}`);
    });

    // 72 names browse
    $("#n72_search").addEventListener("input", ()=>{
      const q = $("#n72_search").value;
      const filtered = n72_filter(q);
      n72_renderList(filtered);
    });
    $("#n72_random").addEventListener("click", ()=>{
      const pick = N72_MIN[Math.floor(Math.random()*N72_MIN.length)];
      n72_renderDetail(pick.id);
      toast(`#${pick.id} ${pick.title}`);
    });

    // assessment buttons
    $("#assess_start").addEventListener("click", ()=>{
      renderAssessUI();
      toast("Assessment ready");
    });
    $("#assess_save").addEventListener("click", ()=> saveAssessSnapshot());
    $("#assess_reset").addEventListener("click", ()=>{
      assessAnswers = {};
      localStorage.setItem(KEY.assessAnswers, JSON.stringify(assessAnswers));
      renderAssessUI();
      toast("Assessment reset");
    });

    // gematria
    $("#gem_calc").addEventListener("click", ()=>{
      const s = $("#gem_input").value.trim();
      const v = gematriaValue(s);
      $("#gem_out").innerHTML = `<div class="hint"><b>Value:</b> <span class="mono">${v}</span></div>`;
      logEvent("GEMATRIA", `${s} = ${v}`);
      toast("Calculated");
    });
    $("#gem_clear").addEventListener("click", ()=>{
      $("#gem_input").value = "";
      $("#gem_out").textContent = "Enter a word and calculate.";
      $("#gem_insight").value = "";
      toast("Cleared");
    });
    $("#gem_save").addEventListener("click", ()=>{
      const s = $("#gem_input").value.trim();
      const v = gematriaValue(s);
      const ins = $("#gem_insight").value.trim();
      if(!s){ toast("Enter a word first"); return; }
      gemInsights.unshift({ at: nowISO(), word:s, value:v, insight:ins });
      if(gemInsights.length>120) gemInsights.length=120;
      localStorage.setItem(KEY.gemInsights, JSON.stringify(gemInsights));
      logEvent("GEM_INSIGHT", `${s} (${v}) ${ins ? "saved" : "saved (no insight)"}`);
      toast("Saved");
      $("#gem_insight").value = "";
    });

    // zohar add
    $("#z_add").addEventListener("click", ()=>{
      const title = $("#z_title").value.trim();
      const src = $("#z_src").value.trim();
      const txt = $("#z_txt").value.trim();
      const prac = $("#z_prac").value.trim();
      if(!title || !txt){ toast("Need title + excerpt"); return; }
      zohar.unshift({ id:"z"+Date.now(), title, src, txt, prac });
      saveZohar();
      renderZoharList();
      logEvent("ZOHAR_ADD", title);
      $("#z_title").value=""; $("#z_src").value=""; $("#z_txt").value=""; $("#z_prac").value="";
      toast("Added");
    });

    // share card
    $("#sc_make").addEventListener("click", ()=>{
      drawShareCard();
      logEvent("SHARE_CARD", $("#sc_title").value.trim() || "Card");
      toast("Card generated");
    });
    $("#sc_download").addEventListener("click", ()=>{
      drawShareCard();
      downloadCanvasPNG();
      toast("Downloading…");
    });

    // history
    $("#hist_clear").addEventListener("click", ()=>{
      if(!confirm("Clear history?")) return;
      history = [];
      saveHistory();
      renderHistory();
      toast("Cleared");
    });
    $("#hist_export").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(history,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `kai_history_${todayKey()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1200);
      toast("Exported");
    });

    // settings
    $("#btn_reset_all").addEventListener("click", ()=>{
      if(!confirm("Reset ALL KAI data on this device?")) return;
      Object.values(KEY).forEach(k=> localStorage.removeItem(k));
      location.reload();
    });

    $("#btn_export_all").addEventListener("click", ()=>{
      const payload = {
        exportedAt: nowISO(),
        state,
        history,
        zohar,
        assessAnswers,
        assessSnaps,
        gemInsights,
        today72
      };
      const txt = JSON.stringify(payload,null,2);
      navigator.clipboard?.writeText(txt).catch(()=>{});
      $("#inp_import").value = txt;
      toast("Exported (copied if allowed)");
    });

    $("#btn_import_all").addEventListener("click", ()=>{
      const raw = $("#inp_import").value.trim();
      if(!raw){ toast("Paste JSON first"); return; }
      const data = safeParse(raw, null);
      if(!data){ toast("Invalid JSON"); return; }
      try{
        if(data.state) localStorage.setItem(KEY.state, JSON.stringify(data.state));
        if(data.history) localStorage.setItem(KEY.history, JSON.stringify(data.history));
        if(data.zohar) localStorage.setItem(KEY.zohar, JSON.stringify(data.zohar));
        if(data.assessAnswers) localStorage.setItem(KEY.assessAnswers, JSON.stringify(data.assessAnswers));
        if(data.assessSnaps) localStorage.setItem(KEY.assessSnapshots, JSON.stringify(data.assessSnaps));
        if(data.gemInsights) localStorage.setItem(KEY.gemInsights, JSON.stringify(data.gemInsights));
        if(data.today72) localStorage.setItem(KEY.today72, JSON.stringify(data.today72));
        toast("Imported. Reloading…");
        setTimeout(()=> location.reload(), 500);
      }catch(e){
        showErr("IMPORT ERROR: " + (e?.message || String(e)));
      }
    });

    $("#btn_smoke").addEventListener("click", ()=>{
      const out = $("#dbg_out");
      const checks = [];
      checks.push(["tabs", $$(".tab").length]);
      checks.push(["state", !!state]);
      checks.push(["N72", N72_MIN.length]);
      checks.push(["Zohar", zohar.length]);
      out.textContent = "SMOKE: " + checks.map(x=>`${x[0]}=${x[1]}`).join(" | ");
      toast("Smoke test ran");
    });
  }

  // -------------------------
  // Boot
  // -------------------------
  function boot(){
    // Seed UI from state
    $("#rng_cert").value = String(state.certainty ?? 5);
    $("#rng_energy").value = String(state.energy ?? 5);

    $("#inp_bday").value = state.profile?.bday || "";
    $("#inp_sign").value = state.profile?.sign || "";
    $("#inp_tikkun").value = state.profile?.tikkun || "";
    $("#inp_notes").value = state.profile?.notes || "";

    updateChips();
    renderPracticeToday();
    n72_renderList(N72_MIN);
    renderAssessUI();
    renderZoharList();
    renderHistory();

    // Default share card date
    $("#sc_date").textContent = todayKey();
    drawShareCard();

    wire();
    logEvent("BOOT", "KAI loaded (stable build)");
  }

  // Global crash visibility
  window.addEventListener("error", (e)=>{
    try{ showErr("JS ERROR: " + (e?.message || "unknown") + "\n" + (e?.error?.stack || "")); }catch(_){}
  });
  window.addEventListener("unhandledrejection", (e)=>{
    try{ showErr("PROMISE ERROR: " + (e?.reason?.message || e?.reason || "unknown")); }catch(_){}
  });

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ boot(); }
    catch(e){
      console.error("BOOT ERROR", e);
      showErr("BOOT ERROR: " + (e?.message || String(e)) + "\n" + (e?.stack || ""));
      toast("BOOT ERROR");
    }
  });

})();
</script>
</body>
</html>
