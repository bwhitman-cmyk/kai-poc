<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <!-- iOS Home Screen icon (must exist at site root) -->
  <link rel="apple-touch-icon" href="/kai-icon.png?v=10" />
  <!-- PWA manifest (must exist at site root) -->
  <link rel="manifest" href="/manifest.webmanifest?v=10" />

  <title>KAI</title>

  <style>
    :root{
      --bg:#070708;
      --panel:#0e0f12;
      --panel2:#0b0b0c;
      --text:#f3f3f4;
      --muted:#b3b3b7;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --gold1:#d8c27a;
      --gold2:#a8832a;
      --good:#1ecb74;
      --bad:#ff5b5b;
      --shadow:0 18px 70px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --pad:18px;
      --max:1180px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 25% -10%, rgba(216,194,122,.16), transparent 60%),
        radial-gradient(1100px 700px at 80% 10%, rgba(168,131,42,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 80%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:20px 18px 80px}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      padding:18px; border:1px solid var(--line); border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .brand{display:flex; flex-direction:column; gap:6px}
    .k{font-weight:800; letter-spacing:.10em}
    .sub{color:var(--muted); font-size:13px}
    .chips{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      font-size:13px; color:var(--muted);
      backdrop-filter: blur(6px);
    }
    .chip b{color:var(--text); font-weight:700}
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:14px 0 0;
    }
    .tab{
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:14px;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(216,194,122,.55);
      box-shadow:0 0 0 1px rgba(168,131,42,.25) inset;
    }

    section.panel{
      display:none;
      margin-top:14px;
      padding:18px;
      border-radius:var(--radius2);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    section.panel.active{display:block}

    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px}
    .card{
      grid-column:span 12;
      padding:16px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
    }
    .title{margin:0 0 10px; letter-spacing:.06em; font-weight:800; font-size:12px; color:var(--muted)}
    .miniTitle{margin:0 0 10px; font-weight:800; font-size:14px; color:var(--text)}
    .hint{color:var(--muted); font-size:12px; line-height:1.35}

    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.35);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    textarea{min-height:120px; resize:vertical}
    .bar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.24);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:700;
    }
    .btn.primary{
      border-color:rgba(216,194,122,.55);
      background:linear-gradient(180deg, rgba(216,194,122,.18), rgba(168,131,42,.10));
    }
    .btn:active{transform:translateY(1px)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .mono{font-family:var(--mono); font-size:13px; color:var(--muted)}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--muted); font-size:12px;
    }

    .libList{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .libItem{
      display:flex; justify-content:space-between; gap:12px;
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.20);
    }
    .libLeft{display:flex; flex-direction:column; gap:6px}
    .libName{font-weight:800}
    .libMeta{font-size:12px; color:var(--muted)}
    .libDesc{color:var(--text); font-size:14px; line-height:1.35}
    .libBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:9999;
      max-width:min(760px, 92vw);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.72);
      color:var(--text);
      display:none;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      font-size:14px;
    }

    @media (min-width: 860px){
      .card.span6{grid-column:span 6}
      .card.span4{grid-column:span 4}
      .card.span8{grid-column:span 8}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="k">KAI</div>
        <div class="sub">Align → Restrict → Witness → Illuminate → Seal</div>
      </div>

      <div class="chips">
        <div class="chip">Date: <b id="chipDate">—</b></div>
        <div class="chip">Profile: <b id="chipProfile">—</b></div>
        <div class="chip">Streak: <b id="chipStreak">—</b></div>
        <div class="chip">Daily Restrict: <b id="chipDailyRestrict">—</b></div>
        <div class="chip">72 Name: <b id="chipName">—</b></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="start">Start</div>
      <div class="tab" data-tab="morning">Morning</div>
      <div class="tab" data-tab="restriction">Restriction</div>
      <div class="tab" data-tab="evening">Evening</div>
      <div class="tab" data-tab="share">Share Card</div>
      <div class="tab" data-tab="library">Library</div>
      <div class="tab" data-tab="tools">Tools</div>
      <div class="tab" data-tab="history">History</div>
    </div>

    <!-- START -->
    <section class="panel active" data-pane="start">
      <div class="grid">
        <div class="card span6">
          <p class="title">ACTIVE DAY</p>
          <div class="field">
            <label for="activeDate">Working date (this drives all save/history)</label>
            <input id="activeDate" type="date" />
          </div>
          <div class="bar">
            <button class="btn primary" id="setTodayBtn" type="button">Set to today</button>
            <button class="btn" id="newDayBtn" type="button">New blank day</button>
          </div>
          <div class="hint" style="margin-top:10px">
            If anything feels “not saving”, check this date first. KAI saves per-day under the hood.
          </div>
        </div>

        <div class="card span6">
          <p class="title">PROFILE</p>
          <div class="grid">
            <div class="field" style="grid-column:span 6">
              <label for="pFirst">First</label>
              <input id="pFirst" placeholder="Bernard" />
            </div>
            <div class="field" style="grid-column:span 6">
              <label for="pLast">Last</label>
              <input id="pLast" placeholder="Whitman" />
            </div>
            <div class="field" style="grid-column:span 12">
              <label for="pFocus">Primary focus (today)</label>
              <input id="pFocus" placeholder="Atika Kadisha: certainty, unity, restriction, love" />
            </div>
          </div>
          <div class="bar">
            <button class="btn primary" id="saveProfileBtn" type="button">Save profile</button>
            <button class="btn" id="copyProfileBtn" type="button">Copy profile</button>
          </div>
        </div>

        <div class="card span12">
          <p class="title">META</p>
          <div class="hint">
            “72 Name” and “Pattern” are set automatically when you press <b>Use</b> in Library, or when you pick a suggestion.
          </div>
        </div>
      </div>
    </section>

    <!-- MORNING -->
    <section class="panel" data-pane="morning">
      <div class="grid">
        <div class="card span12">
          <p class="title">ALIGN</p>
          <div class="grid">
            <div class="field" style="grid-column:span 4">
              <label for="mCertainty">Certainty (0–10)</label>
              <input id="mCertainty" type="number" min="0" max="10" step="1" />
            </div>
            <div class="field" style="grid-column:span 4">
              <label for="mEnergy">Energy (0–10)</label>
              <input id="mEnergy" type="number" min="0" max="10" step="1" />
            </div>
            <div class="field" style="grid-column:span 4">
              <label for="mPattern">Pattern (auto or manual)</label>
              <input id="mPattern" placeholder="Fear → Faith / Urgency → Certainty / etc." />
            </div>
            <div class="field" style="grid-column:span 12">
              <label for="mIntention">Intention</label>
              <textarea id="mIntention" placeholder="Write your kavanah for the day..."></textarea>
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="saveMorningBtn" type="button">Save morning</button>
            <button class="btn" id="copyMorningBtn" type="button">Copy morning</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section class="panel" data-pane="restriction">
      <div class="grid">
        <div class="card span12">
          <p class="title">RESTRICT</p>
          <div class="grid">
            <div class="field" style="grid-column:span 6">
              <label for="rMove">Move (the restriction action)</label>
              <input id="rMove" placeholder="Pause. Breathe. Delay reaction. Choose Light." />
            </div>
            <div class="field" style="grid-column:span 6">
              <label for="rTrigger">Trigger</label>
              <input id="rTrigger" placeholder="What was the spark?" />
            </div>
            <div class="field" style="grid-column:span 12">
              <label for="rNote">Witness (what you observed)</label>
              <textarea id="rNote" placeholder="Describe the moment. What did you feel? Where did Din show up?"></textarea>
            </div>
            <div class="field" style="grid-column:span 6">
              <label for="rCompleted">Completed?</label>
              <select id="rCompleted">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          </div>
          <div class="bar">
            <button class="btn primary" id="saveRestrictionBtn" type="button">Save restriction</button>
            <button class="btn" id="copyRestrictionBtn" type="button">Copy restriction</button>
          </div>
        </div>
      </div>
    </section>

    <!-- EVENING -->
    <section class="panel" data-pane="evening">
      <div class="grid">
        <div class="card span12">
          <p class="title">WITNESS</p>
          <div class="grid">
            <div class="field" style="grid-column:span 12">
              <label for="eWin">Win</label>
              <textarea id="eWin" placeholder="Where did you win today?"></textarea>
            </div>
            <div class="field" style="grid-column:span 12">
              <label for="eLesson">Lesson</label>
              <textarea id="eLesson" placeholder="What did Light teach you?"></textarea>
            </div>
            <div class="field" style="grid-column:span 12">
              <label for="eSeal">Seal (final sentence)</label>
              <input id="eSeal" placeholder="I choose Light. I choose unity. I choose Atika." />
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="saveEveningBtn" type="button">Save evening</button>
            <button class="btn" id="copyEveningBtn" type="button">Copy evening</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SHARE -->
    <section class="panel" data-pane="share">
      <div class="grid">
        <div class="card span12">
          <p class="title">SHARE CARD</p>
          <div class="bar">
            <button class="btn primary" id="buildCardBtn" type="button">Build Card</button>
            <button class="btn" id="copyCardBtn" type="button">Copy Card</button>
            <button class="btn" id="saveCardBtn" type="button">Save Card</button>
          </div>
          <div class="field" style="margin-top:12px">
            <label for="cardOut">Share text</label>
            <textarea id="cardOut" placeholder="Build card to generate text..."></textarea>
          </div>
          <div class="hint" style="margin-top:10px">
            This is the “send to Eitan” artifact. Build → Copy → paste into text/email.
          </div>
        </div>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="panel" data-pane="library">
      <div class="grid">
        <div class="card span12">
          <p class="title">LIBRARY (THEMES, PATTERNS, 72 NAMES, ZOHAR-INSPIRED)</p>

          <div class="grid">
            <div class="field" style="grid-column:span 8">
              <label for="libSearch">Search (theme, tag, letters)</label>
              <input id="libSearch" placeholder="Try: Atika, certainty, protection, healing, אהבה..." />
            </div>
            <div class="field" style="grid-column:span 4">
              <label for="libPattern">Filter by pattern</label>
              <select id="libPattern">
                <option value="">All patterns</option>
                <option>Urgency → Certainty</option>
                <option>Reactivity → Restriction</option>
                <option>Judgment → Compassion</option>
                <option>Overthinking → Action</option>
                <option>Fear → Faith</option>
                <option>Control → Trust</option>
                <option>Isolation → Connection</option>
              </select>
            </div>
          </div>

          <div class="bar">
            <button class="btn primary" id="libPick" type="button">Pick for me</button>
            <button class="btn" id="libClear" type="button">Clear</button>
            <button class="btn" id="libCopySuggested" type="button">Copy suggestion</button>
          </div>

          <div class="field" style="margin-top:12px">
            <label for="libSuggested">Suggested practice</label>
            <textarea id="libSuggested" readonly placeholder="Tap 'Pick for me'..."></textarea>
          </div>

          <div class="hint" style="margin-top:8px">
            Notes: Zohar entries here are brief paraphrase/snippets, intended as prompts. Confirm “which Name” choices with a teacher.
          </div>

          <div class="libList" id="libResults"></div>
        </div>
      </div>
    </section>

    <!-- TOOLS -->
    <section class="panel" data-pane="tools">
      <div class="grid">
        <div class="card span12">
          <p class="title">GEMATRIA INSIGHT ENGINE</p>

          <div class="grid">
            <div class="field" style="grid-column:span 8">
              <label for="gText">Text (Hebrew or English)</label>
              <input id="gText" placeholder="Atika Kadisha / אחדות / אהבה / אמונה / וול ..." />
            </div>
            <div class="field" style="grid-column:span 4">
              <label for="gMode">Mode</label>
              <select id="gMode">
                <option value="hebrew">Hebrew (letters only)</option>
                <option value="english">English A1Z26</option>
              </select>
            </div>
            <div class="field" style="grid-column:span 12">
              <label for="gOut">Result + Insight</label>
              <textarea id="gOut" readonly placeholder="Type above..."></textarea>
            </div>
          </div>

          <div class="bar">
            <button class="btn" id="copyInsightBtn" type="button">Copy insight</button>
            <button class="btn" id="useNameBtn" type="button">Use as 72 Name (sets chip)</button>
          </div>

          <div class="hint" style="margin-top:10px">
            This is intentionally “practice-forward”: it gives a number + a short, actionable spiritual prompt.
          </div>
        </div>

        <div class="card span12">
          <p class="title">EXPORT / IMPORT</p>
          <div class="bar">
            <button class="btn" id="exportBtn" type="button">Download JSON</button>
            <button class="btn" id="copyExportBtn" type="button">Copy JSON</button>
            <button class="btn" id="resetTodayBtn" type="button">Reset today (blank)</button>
          </div>
          <div class="field" style="margin-top:12px">
            <label for="exportBox">Export box</label>
            <textarea id="exportBox" readonly placeholder="Export will appear here..."></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="panel" data-pane="history">
      <div class="grid">
        <div class="card span12">
          <p class="title">HISTORY</p>
          <div class="hint">
            Tap a date to load it as the active day. If history is empty, nothing has been saved under those day keys yet.
          </div>
          <div class="bar">
            <button class="btn" id="refreshHistoryBtn" type="button">Refresh history</button>
          </div>
          <div class="libList" id="historyList"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">Toast</div>

  <script>
    // ---------- Tiny helpers ----------
    const $ = (id) => document.getElementById(id);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = String(msg ?? "");
      t.style.display = "block";
      clearTimeout(window.__tmo);
      window.__tmo = setTimeout(()=> t.style.display="none", 2400);
    }

    // Crash visibility: makes "static photo" speak
    window.addEventListener("error", (e)=>{
      try { toast("JS error: " + (e?.message || "unknown")); }
      catch { /* ignore */ }
    });
    window.addEventListener("unhandledrejection", (e)=>{
      const msg = (e?.reason?.message || e?.reason || "unknown");
      try { toast("Promise error: " + msg); }
      catch { /* ignore */ }
    });

    function safeJSONParse(s, fallback){
      try {
        const v = JSON.parse(s);
        return (v && typeof v === "object") ? v : fallback;
      } catch(e){
        return fallback;
      }
    }

    function todayISO(){
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }

    // ---------- Storage keys ----------
    const keyProfile = "kai_profile_v3";
    const keyMeta    = "kai_meta_v3";
    const keyActiveDate = "kai_active_date_v1";
    const keyDay = (iso) => `kai_day_${iso}_v3`;

    // ---------- Defaults (NEVER return null) ----------
    function defaultProfile(){
      return { first:"", last:"", focus:"" };
    }
    function defaultMeta(){
      return { selectedPattern:"", selectedName:"", selectedTheme:"" };
    }
    function defaultDay(iso){
      return {
        date: iso,
        morning: { certainty:"", energy:"", intention:"", pattern:"" },
        restriction: { move:"", trigger:"", note:"", completed:false },
        evening: { win:"", lesson:"", seal:"" },
        shareCard: ""
      };
    }

    function getProfile(){
      return safeJSONParse(localStorage.getItem(keyProfile), defaultProfile());
    }
    function setProfile(p){
      const safe = (p && typeof p === "object") ? p : {};
      localStorage.setItem(keyProfile, JSON.stringify({ ...defaultProfile(), ...safe }));
    }

    function getMeta(){
      return safeJSONParse(localStorage.getItem(keyMeta), defaultMeta());
    }
    function setMeta(m){
      const safe = (m && typeof m === "object") ? m : {};
      localStorage.setItem(keyMeta, JSON.stringify({ ...defaultMeta(), ...safe }));
    }

    function getActiveDate(){
      return localStorage.getItem(keyActiveDate) || todayISO();
    }
    function setActiveDate(iso){
      const v = iso || todayISO();
      localStorage.setItem(keyActiveDate, v);
    }

    function getDay(iso = getActiveDate()){
      return safeJSONParse(localStorage.getItem(keyDay(iso)), defaultDay(iso));
    }
    function setDay(d){
      if(!d || !d.date) return;
      localStorage.setItem(keyDay(d.date), JSON.stringify(d));
    }

    function listSavedDays(){
      const days = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith("kai_day_") && k.endsWith("_v3")){
          const iso = k.replace("kai_day_","").replace("_v3","");
          days.push(iso);
        }
      }
      days.sort().reverse();
      return days;
    }

    // ---------- UI hydration ----------
    function hydrateChips(){
      const p = getProfile();
      const m = getMeta();
      const d = getDay();

      $("chipDate").textContent = d.date || "—";
      const full = `${p.first||""} ${p.last||""}`.trim();
      $("chipProfile").textContent = full || "—";
      $("chipName").textContent = m.selectedName || "—";

      // streak: consecutive saved days ending today
      const saved = new Set(listSavedDays());
      let streak = 0;
      let cur = todayISO();
      while(saved.has(cur)){
        streak++;
        const dt = new Date(cur+"T00:00:00");
        dt.setDate(dt.getDate()-1);
        cur = dt.toISOString().slice(0,10);
      }
      $("chipStreak").textContent = String(streak || 0);

      // daily restrict: on if any restriction content exists
      const on = (d.restriction?.move || d.restriction?.note || d.restriction?.trigger) ? "On" : "—";
      $("chipDailyRestrict").textContent = on;
    }

    function hydrateStart(){
      const p = getProfile();
      const iso = getActiveDate();
      const dateInput = $("activeDate");
      if(dateInput) dateInput.value = iso;

      $("pFirst").value = p.first || "";
      $("pLast").value  = p.last || "";
      $("pFocus").value = p.focus || "";
    }

    function hydrateMorning(){
      const d = getDay();
      $("mCertainty").value = d.morning?.certainty ?? "";
      $("mEnergy").value    = d.morning?.energy ?? "";
      $("mIntention").value = d.morning?.intention ?? "";
      $("mPattern").value   = d.morning?.pattern ?? "";
    }

    function hydrateRestriction(){
      const d = getDay();
      $("rMove").value = d.restriction?.move ?? "";
      $("rTrigger").value = d.restriction?.trigger ?? "";
      $("rNote").value = d.restriction?.note ?? "";
      $("rCompleted").value = d.restriction?.completed ? "yes" : "no";
    }

    function hydrateEvening(){
      const d = getDay();
      $("eWin").value = d.evening?.win ?? "";
      $("eLesson").value = d.evening?.lesson ?? "";
      $("eSeal").value = d.evening?.seal ?? "";
    }

    function hydrateShare(){
      const d = getDay();
      $("cardOut").value = d.shareCard || "";
    }

    function hydrateAll(){
      hydrateChips();
      hydrateStart();
      hydrateMorning();
      hydrateRestriction();
      hydrateEvening();
      hydrateShare();
      hydrateLibrary();
      hydrateHistory();
    }

    // ---------- Tabs ----------
    function setActiveTab(tab){
      $$(".tab").forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
      $$("section.panel").forEach(p=>p.classList.toggle("active", p.dataset.pane===tab));
    }
    function wireTabs(){
      $$(".tab").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          setActiveTab(btn.dataset.tab);
        }, {passive:false});
      });
    }

    // ---------- Collectors ----------
    function collectProfileFromUI(){
      return {
        first: $("pFirst").value.trim(),
        last:  $("pLast").value.trim(),
        focus: $("pFocus").value.trim()
      };
    }

    function collectMorningFromUI(){
      return {
        certainty: ($("mCertainty").value ?? "").toString(),
        energy: ($("mEnergy").value ?? "").toString(),
        intention: $("mIntention").value.trim(),
        pattern: $("mPattern").value.trim()
      };
    }

    function collectRestrictionFromUI(){
      return {
        move: $("rMove").value.trim(),
        trigger: $("rTrigger").value.trim(),
        note: $("rNote").value.trim(),
        completed: $("rCompleted").value === "yes"
      };
    }

    function collectEveningFromUI(){
      return {
        win: $("eWin").value.trim(),
        lesson: $("eLesson").value.trim(),
        seal: $("eSeal").value.trim()
      };
    }

    // ---------- Clipboard / download ----------
    function copyText(txt){
      const t = String(txt ?? "");
      (navigator.clipboard?.writeText(t) || Promise.resolve())
        .then(()=>toast("Copied ✅"))
        .catch(()=>toast("Copy blocked ⚠️"));
    }
    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
    }

    // ---------- SHARE CARD ----------
    function buildCardText(){
      const p = getProfile();
      const m = getMeta();
      const d = getDay();

      const fullName = `${p.first||""} ${p.last||""}`.trim() || "—";

      return (
`KAI • ${d.date}
Name: ${fullName}
Focus: ${p.focus || "—"}
Pattern: ${d.morning?.pattern || m.selectedPattern || "—"}
72 Name: ${m.selectedName || "—"}

ALIGN (Morning)
• Certainty: ${d.morning?.certainty || "—"}  Energy: ${d.morning?.energy || "—"}
• Intention: ${d.morning?.intention || "—"}

RESTRICT (Day)
• Move: ${d.restriction?.move || "—"}
• Witness: ${d.restriction?.note || "—"}
• Completed: ${d.restriction?.completed ? "Yes" : "No"}

WITNESS (Evening)
• Win: ${d.evening?.win || "—"}
• Lesson: ${d.evening?.lesson || "—"}

SEAL
• ${d.evening?.seal || "—"}`
      );
    }

    function wireShareCard(){
      const buildBtn = $("buildCardBtn");
      const copyBtn  = $("copyCardBtn");
      const saveBtn  = $("saveCardBtn");
      const outBox   = $("cardOut");

      if(buildBtn && outBox){
        buildBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          outBox.value = buildCardText();
          toast("Card built ✅");
        }, {passive:false});
      }
      if(copyBtn && outBox){
        copyBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText(outBox.value || "");
        }, {passive:false});
      }
      if(saveBtn && outBox){
        saveBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const d = getDay();
          d.shareCard = outBox.value || "";
          setDay(d);
          hydrateChips();
          hydrateHistory();
          toast("Card saved ✅");
        }, {passive:false});
      }
    }

    // ---------- LIBRARY DATA ----------
    const LIB = [
      // Themes / patterns
      { type:"theme", name:"Atika Kadisha", pattern:"Urgency → Certainty", tags:["atika","certainty","crown","keter"], desc:"Practice: slow the nervous system, choose certainty, anchor above circumstances." },
      { type:"theme", name:"Restriction", pattern:"Reactivity → Restriction", tags:["restriction","pause"], desc:"Practice: delay the impulse. One breath. One choice. One step toward Light." },
      { type:"theme", name:"Trust", pattern:"Control → Trust", tags:["trust","release"], desc:"Practice: loosen the grip. Ask: what would trust do with this exact moment?" },
      { type:"theme", name:"Compassion", pattern:"Judgment → Compassion", tags:["chesed","compassion"], desc:"Practice: soften Din into balance. Look for the hidden good." },
      { type:"theme", name:"Connection", pattern:"Isolation → Connection", tags:["unity","achdut"], desc:"Practice: bridge the gap. Reach out. Return to love as the operating system." },

      // 72 Names (light scaffolding, not authoritative)
      { type:"72", name:"#1 ווה (Vav-Heh-Vav)", pattern:"Fear → Faith", tags:["protection","clearing"], desc:"Protective clearing. Stabilize the body. Return to steadiness." },
      { type:"72", name:"#7 אלד (Alef-Lamed-Dalet)", pattern:"Overthinking → Action", tags:["clarity","decisive"], desc:"Cut fog. Choose one clean next step. Do it now, gently." },
      { type:"72", name:"#14 מהש (Mem-Heh-Shin)", pattern:"Urgency → Certainty", tags:["healing","repair"], desc:"Repair and restore. Treat the moment like a wound that deserves care." },
      { type:"72", name:"#20 פאח (Peh-Alef-Chet)", pattern:"Control → Trust", tags:["release","flow"], desc:"Let go without collapse. Flow with purpose." },
      { type:"72", name:"#45 סאל (Samekh-Alef-Lamed)", pattern:"Isolation → Connection", tags:["union","bond"], desc:"Reconnect. Speak truth. Choose love as the bridge." },

      // Zohar-inspired prompts (short paraphrase/snippet style)
      { type:"zohar", name:"Zohar Prompt: Atika Kadisha", pattern:"Urgency → Certainty", tags:["zohar","atika","keter"], desc:"Prompt: Act as if you’re already held by the highest mercy. What changes in your tone, pace, and choice?" },
      { type:"zohar", name:"Zohar Prompt: Unity", pattern:"Isolation → Connection", tags:["zohar","achdut","love"], desc:"Prompt: Seek the point of connection beneath the argument. Make one move that increases unity." },
      { type:"zohar", name:"Zohar Prompt: Restriction as Power", pattern:"Reactivity → Restriction", tags:["zohar","restriction"], desc:"Prompt: The strongest moment is the pause. In the pause, choose Light over impulse." },
      { type:"zohar", name:"Zohar Prompt: Sweeten Din", pattern:"Judgment → Compassion", tags:["zohar","din","sweeten"], desc:"Prompt: Name the judgment without feeding it. Then choose the merciful interpretation." },

      // Micro-practices aligned to your flow
      { type:"practice", name:"Atika Breath (60 seconds)", pattern:"Urgency → Certainty", tags:["breath","atika"], desc:"Inhale 4, hold 2, exhale 6. On exhale: ‘I choose certainty.’ Repeat 6 cycles." },
      { type:"practice", name:"Restriction Loop Breaker", pattern:"Reactivity → Restriction", tags:["pause","witness"], desc:"Ask: ‘What am I trying to control?’ Then: ‘What is the Light asking?’ Choose 1 small action." },
    ];

    function libMatch(item, q, pat){
      const qq = (q || "").trim().toLowerCase();
      const pp = (pat || "").trim().toLowerCase();

      const hay = [
        item.type, item.name, item.pattern,
        ...(item.tags||[]),
        item.desc
      ].join(" ").toLowerCase();

      const okQ = !qq || hay.includes(qq);
      const okP = !pp || (item.pattern||"").toLowerCase() === pp;
      return okQ && okP;
    }

    function libRenderResults(items){
      const box = $("libResults");
      if(!box) return;
      box.innerHTML = "";

      if(!items.length){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "No matches. Try a shorter keyword.";
        box.appendChild(empty);
        return;
      }

      items.slice(0, 60).forEach(it=>{
        const row = document.createElement("div");
        row.className = "libItem";

        const left = document.createElement("div");
        left.className = "libLeft";

        const nm = document.createElement("div");
        nm.className = "libName";
        nm.textContent = it.name;

        const meta = document.createElement("div");
        meta.className = "libMeta";
        meta.textContent = `${it.type.toUpperCase()}  •  ${it.pattern || "—"}  •  ${(it.tags||[]).slice(0,4).join(", ")}`;

        const desc = document.createElement("div");
        desc.className = "libDesc";
        desc.textContent = it.desc;

        left.appendChild(nm);
        left.appendChild(meta);
        left.appendChild(desc);

        const btns = document.createElement("div");
        btns.className = "libBtns";

        const use = document.createElement("button");
        use.className = "btn";
        use.type = "button";
        use.textContent = "Use";

        const copy = document.createElement("button");
        copy.className = "btn";
        copy.type = "button";
        copy.textContent = "Copy";

        use.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();

          // update meta safely
          const m = getMeta();
          m.selectedPattern = it.pattern || m.selectedPattern || "";
          if(it.type === "72") m.selectedName = it.name;
          if(it.type === "theme") m.selectedTheme = it.name;

          setMeta(m);

          // also drop pattern into morning field (gentle convenience)
          const d = getDay();
          d.morning = d.morning || {};
          if(it.pattern && !d.morning.pattern) d.morning.pattern = it.pattern;
          setDay(d);

          hydrateAll();
          toast("Applied ✅");
        }, {passive:false});

        copy.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          copyText(`${it.name}\n${it.pattern ? ("Pattern: "+it.pattern+"\n"):""}${it.desc}`);
        }, {passive:false});

        btns.appendChild(use);
        btns.appendChild(copy);

        row.appendChild(left);
        row.appendChild(btns);
        box.appendChild(row);
      });
    }

    function libFilterItems(q, pat){
      return LIB.filter(it => libMatch(it, q, pat));
    }

    function libPickForMe(pat){
      const items = libFilterItems("", pat);
      const pick = items[Math.floor(Math.random()*Math.max(1, items.length))];
      if(!pick) return "No matches.";
      return `${pick.name}\n${pick.pattern ? ("Pattern: "+pick.pattern+"\n"):""}\n${pick.desc}`;
    }

    function hydrateLibrary(){
      const search = $("libSearch");
      const pat = $("libPattern");
      if(!search || !pat) return;
      const items = libFilterItems(search.value, pat.value);
      libRenderResults(items);
    }

    function wireLibrary(){
      const search = $("libSearch");
      const pat = $("libPattern");
      const pick = $("libPick");
      const clr  = $("libClear");
      const sug  = $("libSuggested");
      const copySug = $("libCopySuggested");

      if(!search || !pat || !pick || !clr || !sug) return;

      const refresh = ()=>{
        hydrateLibrary();
      };

      search.addEventListener("input", refresh);
      pat.addEventListener("change", refresh);

      pick.addEventListener("click", ()=>{
        const txt = libPickForMe(pat.value);
        sug.value = txt;
        // if suggestion is a 72-name entry, try to set meta name by parsing prefix "#"
        toast("Suggested ✅");
      });

      clr.addEventListener("click", ()=>{
        search.value = "";
        pat.value = "";
        sug.value = "";
        refresh();
        toast("Cleared ✅");
      });

      if(copySug){
        copySug.addEventListener("click", ()=>{
          copyText(sug.value || "");
        });
      }

      // initial
      refresh();
    }

    // ---------- HISTORY ----------
    function hydrateHistory(){
      const box = $("historyList");
      if(!box) return;
      box.innerHTML = "";

      const days = listSavedDays();
      if(!days.length){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "No saved days yet. Save Morning/Restriction/Evening to create history.";
        box.appendChild(empty);
        return;
      }

      days.slice(0, 120).forEach(iso=>{
        const row = document.createElement("div");
        row.className = "libItem";

        const left = document.createElement("div");
        left.className = "libLeft";
        const nm = document.createElement("div");
        nm.className = "libName";
        nm.textContent = iso;

        const d = getDay(iso);
        const meta = document.createElement("div");
        meta.className = "libMeta";
        meta.textContent = [
          d.morning?.pattern ? ("Pattern: "+d.morning.pattern) : "",
          d.evening?.seal ? ("Seal: "+d.evening.seal) : ""
        ].filter(Boolean).join("  •  ") || "Saved day";

        left.appendChild(nm);
        left.appendChild(meta);

        const btns = document.createElement("div");
        btns.className = "libBtns";

        const load = document.createElement("button");
        load.className = "btn primary";
        load.type = "button";
        load.textContent = "Load";

        const copy = document.createElement("button");
        copy.className = "btn";
        copy.type = "button";
        copy.textContent = "Copy card";

        load.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          setActiveDate(iso);
          hydrateAll();
          toast("Loaded ✅");
        }, {passive:false});

        copy.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const prev = getActiveDate();
          const dd = getDay(iso);
          const txt = dd.shareCard || "(No saved share card for this day yet.)";
          copyText(txt);
          // keep active date unchanged
          setActiveDate(prev);
        }, {passive:false});

        btns.appendChild(load);
        btns.appendChild(copy);

        row.appendChild(left);
        row.appendChild(btns);
        box.appendChild(row);
      });
    }

    // ---------- GEMATRIA INSIGHT ENGINE ----------
    const HEB = {
      "א":1,"ב":2,"ג":3,"ד":4,"ה":5,"ו":6,"ז":7,"ח":8,"ט":9,
      "י":10,"כ":20,"ך":20,"ל":30,"מ":40,"ם":40,"נ":50,"ן":50,"ס":60,
      "ע":70,"פ":80,"ף":80,"צ":90,"ץ":90,"ק":100,"ר":200,"ש":300,"ת":400
    };

    function gematriaHebrew(s){
      let sum = 0;
      for(const ch of (s||"")){
        if(HEB[ch]) sum += HEB[ch];
      }
      return sum;
    }
    function gematriaEnglish(s){
      let sum = 0;
      for(const ch of (s||"").toUpperCase()){
        if(ch>="A" && ch<="Z") sum += (ch.charCodeAt(0)-64);
      }
      return sum;
    }

    function insightFor(n, txt){
      // A light-touch “engine”: consistent, actionable prompts.
      // We’ll map ranges + notable values and tie to Atika/Unity.
      const t = (txt||"").trim();
      const sparks = [];
      if(t.includes("Atika") || t.includes("עתיק") || t.includes("עתיקה") || t.includes("קדיש")) sparks.push("Atika: choose certainty above circumstance.");
      if(t.includes("אחד") || t.includes("אחדות") || /unity/i.test(t)) sparks.push("Unity: bridge separation with one concrete act.");
      if(t.includes("אהבה") || /love/i.test(t)) sparks.push("Love: soften judgment, increase connection.");

      let core = "";
      if(n === 26) core = "26: Y-H-V-H resonance. Practice: align speech with purpose.";
      else if(n === 72) core = "72: Names resonance. Practice: pick ONE Name and work it with restriction.";
      else if(n === 18) core = "18: Chai. Practice: choose the life-giving interpretation.";
      else if(n % 10 === 0) core = `${n}: Round number. Practice: simplify. One intention. One action.`;
      else if(n < 50) core = `${n}: Small number. Practice: precision. Tiny restriction, huge result.`;
      else if(n < 200) core = `${n}: Medium number. Practice: structure. Build a container for Light.`;
      else core = `${n}: Large number. Practice: humility. Reduce ego-noise, increase listening.`;

      const atika = "Atika Kadisha prompt: ‘What would certainty do right now?’";
      const extra = sparks.length ? ("Signals: " + sparks.join(" ")) : "";

      return [core, extra, atika].filter(Boolean).join("\n");
    }

    function renderGematriaInsights(){
      const inp = $("gText");
      const mode = $("gMode");
      const out = $("gOut");
      if(!inp || !mode || !out) return;

      const txt = inp.value || "";
      const n = (mode.value === "english") ? gematriaEnglish(txt) : gematriaHebrew(txt);
      out.value = `Value: ${n}\n\n${insightFor(n, txt)}`;
    }

    function wireGematria(){
      const inp = $("gText");
      const mode = $("gMode");
      const out = $("gOut");
      const copyBtn = $("copyInsightBtn");
      const useNameBtn = $("useNameBtn");

      if(inp) inp.addEventListener("input", renderGematriaInsights, {passive:true});
      if(mode) mode.addEventListener("change", renderGematriaInsights, {passive:true});
      if(copyBtn && out){
        copyBtn.addEventListener("click", ()=>copyText(out.value || ""), {passive:true});
      }
      if(useNameBtn && inp){
        useNameBtn.addEventListener("click", ()=>{
          const m = getMeta();
          m.selectedName = inp.value.trim() || m.selectedName || "";
          setMeta(m);
          hydrateChips();
          toast("Set as 72 Name ✅");
        }, {passive:true});
      }

      renderGematriaInsights();
    }

    // ---------- Buttons / Saves ----------
    function wireButtons(){
      const saveProfileBtn = $("saveProfileBtn");
      const copyProfileBtn = $("copyProfileBtn");

      if(saveProfileBtn){
        saveProfileBtn.addEventListener("click", ()=>{
          setProfile(collectProfileFromUI());
          hydrateChips();
          toast("Profile saved ✅");
        });
      }
      if(copyProfileBtn){
        copyProfileBtn.addEventListener("click", ()=>{
          const p = getProfile();
          const txt = `Profile\nName: ${(p.first||"")} ${(p.last||"")}\nFocus: ${p.focus || "—"}`.trim();
          copyText(txt);
        });
      }

      const activeDate = $("activeDate");
      if(activeDate){
        activeDate.addEventListener("change", ()=>{
          setActiveDate(activeDate.value);
          hydrateAll();
          toast("Date set ✅");
        });
      }

      const setTodayBtn = $("setTodayBtn");
      if(setTodayBtn){
        setTodayBtn.addEventListener("click", ()=>{
          setActiveDate(todayISO());
          hydrateAll();
          toast("Today ✅");
        });
      }

      const newDayBtn = $("newDayBtn");
      if(newDayBtn){
        newDayBtn.addEventListener("click", ()=>{
          const iso = getActiveDate();
          setDay(defaultDay(iso));
          hydrateAll();
          toast("Blank day ✅");
        });
      }

      const saveMorningBtn = $("saveMorningBtn");
      const copyMorningBtn = $("copyMorningBtn");
      if(saveMorningBtn){
        saveMorningBtn.addEventListener("click", ()=>{
          const d = getDay();
          d.morning = collectMorningFromUI();
          setDay(d);
          hydrateAll();
          toast("Morning saved ✅");
        });
      }
      if(copyMorningBtn){
        copyMorningBtn.addEventListener("click", ()=>{
          const d = getDay();
          const txt =
`Morning • ${d.date}
Certainty: ${d.morning?.certainty || "—"}
Energy: ${d.morning?.energy || "—"}
Pattern: ${d.morning?.pattern || "—"}
Intention: ${d.morning?.intention || "—"}`;
          copyText(txt);
        });
      }

      const saveRestrictionBtn = $("saveRestrictionBtn");
      const copyRestrictionBtn = $("copyRestrictionBtn");
      if(saveRestrictionBtn){
        saveRestrictionBtn.addEventListener("click", ()=>{
          const d = getDay();
          d.restriction = collectRestrictionFromUI();
          setDay(d);
          hydrateAll();
          toast("Restriction saved ✅");
        });
      }
      if(copyRestrictionBtn){
        copyRestrictionBtn.addEventListener("click", ()=>{
          const d = getDay();
          const txt =
`Restriction • ${d.date}
Move: ${d.restriction?.move || "—"}
Trigger: ${d.restriction?.trigger || "—"}
Witness: ${d.restriction?.note || "—"}
Completed: ${d.restriction?.completed ? "Yes" : "No"}`;
          copyText(txt);
        });
      }

      const saveEveningBtn = $("saveEveningBtn");
      const copyEveningBtn = $("copyEveningBtn");
      if(saveEveningBtn){
        saveEveningBtn.addEventListener("click", ()=>{
          const d = getDay();
          d.evening = collectEveningFromUI();
          setDay(d);
          hydrateAll();
          toast("Evening saved ✅");
        });
      }
      if(copyEveningBtn){
        copyEveningBtn.addEventListener("click", ()=>{
          const d = getDay();
          const txt =
`Evening • ${d.date}
Win: ${d.evening?.win || "—"}
Lesson: ${d.evening?.lesson || "—"}
Seal: ${d.evening?.seal || "—"}`;
          copyText(txt);
        });
      }

      // Tools export/import
      const exportBtn = $("exportBtn");
      const copyExportBtn = $("copyExportBtn");
      const exportBox = $("exportBox");
      const resetTodayBtn = $("resetTodayBtn");

      function buildExport(){
        const obj = {
          profile: getProfile(),
          meta: getMeta(),
          activeDate: getActiveDate(),
          days: listSavedDays().reduce((acc, iso)=>{
            acc[iso] = getDay(iso);
            return acc;
          }, {})
        };
        return obj;
      }

      if(exportBtn && exportBox){
        exportBtn.addEventListener("click", ()=>{
          const obj = buildExport();
          exportBox.value = JSON.stringify(obj, null, 2);
          downloadJSON(`kai-export-${todayISO()}.json`, obj);
          toast("Downloaded ✅");
        });
      }

      if(copyExportBtn && exportBox){
        copyExportBtn.addEventListener("click", ()=>{
          const obj = buildExport();
          exportBox.value = JSON.stringify(obj, null, 2);
          copyText(exportBox.value);
        });
      }

      if(resetTodayBtn){
        resetTodayBtn.addEventListener("click", ()=>{
          const iso = todayISO();
          setActiveDate(iso);
          setDay(defaultDay(iso));
          hydrateAll();
          toast("Today reset ✅");
        });
      }

      const refreshHistoryBtn = $("refreshHistoryBtn");
      if(refreshHistoryBtn){
        refreshHistoryBtn.addEventListener("click", ()=>{
          hydrateHistory();
          toast("History refreshed ✅");
        });
      }
    }

    // ---------- Boot ----------
    function boot(){
      // ensure meta/profile exist (kills null-crashes forever)
      setProfile(getProfile());
      setMeta(getMeta());
      setActiveDate(getActiveDate());

      wireTabs();
      wireButtons();
      wireShareCard();
      wireLibrary();
      wireGematria();

      hydrateAll();
      toast("KAI online ✅");
    }

    document.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
