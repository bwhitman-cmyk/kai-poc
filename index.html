<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KAI — Prototype (Clean 72)</title>

  <!-- PWA hooks (keep your filenames) -->
  <link rel="manifest" href="./manifest.webmanifest?v=20260222" />
  <link rel="apple-touch-icon" href="./apple-touch-icon-v3.png?v=20260222" />
  <link rel="icon" sizes="192x192" href="./icon-192-v3.png?v=20260222" />
  <link rel="icon" sizes="512x512" href="./icon-512-v3.png?v=20260222" />

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#131314;
      --panel2:#171719;
      --line:#262628;
      --text:#f2f2f2;
      --muted:#a6a6a9;
      --gold:#d8b24b;
      --green:#1f6f46;
      --red:#7c2e2e;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% 0%, rgba(255,255,255,.06), transparent 55%),
                  radial-gradient(800px 500px at 10% 20%, rgba(216,178,75,.10), transparent 55%),
                  var(--bg);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:22px 18px 70px}
    header{display:flex;align-items:center;justify-content:center;margin:10px 0 10px}
    .title{
      font-weight:800;
      letter-spacing:.16em;
      text-transform:uppercase;
      opacity:.95;
      font-size:30px;
    }

    /* top chips */
    .chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0 14px}
    .chip{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.07);
      padding:8px 12px;
      border-radius:999px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      font-size:13px;
      color:var(--muted);
    }
    .chip b{color:var(--gold);font-weight:800}

    /* tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0 18px}
    .tabbtn{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, border-color .12s ease, background .12s ease;
      font-size:14px;
    }
    .tabbtn:active{transform:scale(.98)}
    .tabbtn.active{
      background:rgba(216,178,75,.12);
      border-color:rgba(216,178,75,.35);
      color:var(--gold);
    }

    /* layout */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .card h3{margin:0 0 10px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}

    .sliderline{display:flex;align-items:center;justify-content:space-between;gap:12px}
    input[type="range"]{width:100%}

    .hint{color:var(--muted);font-size:13px;margin-top:6px}

    .btnrow{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    button{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 14px 35px rgba(0,0,0,.35);
      transition:transform .08s ease, background .12s ease, border-color .12s ease;
      font-weight:700;
    }
    button:active{transform:scale(.98)}
    button.primary{background:rgba(31,111,70,.35);border-color:rgba(31,111,70,.55);color:#b7f6d1}
    button.gold{background:rgba(216,178,75,.18);border-color:rgba(216,178,75,.35);color:var(--gold)}
    button.ghost{background:transparent;border-color:rgba(255,255,255,.12)}

    /* views */
    .view{display:none}
    .view.active{display:block}

    /* 72 list */
    .n72-top{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .n72-top input{
      flex:2;
      min-width:220px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
    }
    .n72-list{border-top:1px solid rgba(255,255,255,.08);margin-top:10px}
    .n72-item{
      display:flex;
      gap:12px;
      padding:12px 6px;
      border-bottom:1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    .n72-id{
      width:52px;
      color:var(--gold);
      font-weight:900;
      text-align:right;
      padding-right:8px;
    }
    .n72-meta{flex:1}
    .n72-title{font-weight:800}
    .n72-sub{color:var(--muted);font-size:13px;margin-top:2px}

    /* detail */
    .detailHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .detailHead h2{margin:0;font-size:22px}
    .hebrew{
      font-size:34px;
      letter-spacing:.15em;
      margin:10px 0 6px;
      color:var(--gold);
      direction:rtl;
    }
    .meaning{color:var(--text);line-height:1.45}
    .practice{color:var(--muted);margin-top:10px}

    /* share card */
    .shareWrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 900px){ .shareWrap{grid-template-columns:1fr} }
    canvas{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:#000}

    /* error overlay */
    .err{
      display:none;
      background:rgba(124,46,46,.40);
      border:1px solid rgba(255,120,120,.35);
      border-radius:18px;
      padding:14px 14px;
      margin:12px 0 10px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      white-space:pre-wrap;
      color:#ffd6d6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
    }

    /* tiny toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:12px;
      color:var(--text);
      display:none;
      z-index:50;
      max-width:92vw;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header><div class="title">KAI</div></header>

    <div id="errBox" class="err"></div>

    <div class="chips">
      <div class="chip">Pillars <b id="pillarsChip">0</b> /100</div>
      <div class="chip">Cycles <b id="cyclesChip">0</b> /10</div>
      <div class="chip">Certainty <b id="certaintyChip">5</b> /10</div>
      <div class="chip">Energy <b id="energyChip">5</b> /10</div>
    </div>

    <div class="tabs">
      <div class="tabbtn active" data-tab="home">Home</div>
      <div class="tabbtn" data-tab="names72">72 Names</div>
      <div class="tabbtn" data-tab="share">Share Card</div>
      <div class="tabbtn" data-tab="settings">Settings</div>
    </div>

    <!-- HOME -->
    <section id="view-home" class="view active">
      <div class="grid">
        <div class="card">
          <h3>Daily Metrics</h3>
<div id="gate" class="card" style="margin-bottom:14px;">
  <h3>Welcome</h3>
  <div class="hint" style="margin-bottom:10px;">
    One tap = one connection rep. Then you enter Study.
  </div>

  <div class="btnrow">
    <button id="btnGateConnect" class="primary">CONNECT ( +1 pillar )</button>
    <button id="btnGateEnter" class="gold">Enter Study</button>
  </div>

  <div class="hint" id="gateStatus" style="margin-top:10px; opacity:.9;"></div>
</div>
          <div class="sliderline">
            <div style="flex:1">
              <div class="row" style="margin-bottom:6px">
                <div style="flex:1;color:var(--muted);font-size:13px">Certainty</div>
                <div style="width:44px;text-align:right"><b id="certaintyVal" style="color:var(--gold)">5</b></div>
              </div>
              <input id="certainty" type="range" min="0" max="10" step="1" value="5" />
              <div class="hint">Set quickly. This is your Sinai clarity gauge.</div>
            </div>

            <div style="flex:1">
              <div class="row" style="margin-bottom:6px">
                <div style="flex:1;color:var(--muted);font-size:13px">Energy</div>
                <div style="width:44px;text-align:right"><b id="energyVal" style="color:var(--gold)">5</b></div>
              </div>
              <input id="energy" type="range" min="0" max="10" step="1" value="5" />
              <div class="hint">Simple and honest. No story, just data.</div>
            </div>
          </div>

          <div style="margin-top:14px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px">
            <h3 style="margin-bottom:8px">Quick Actions</h3>
            <div class="btnrow">
              <button id="btnConnect" class="primary">CONNECT (+pillar)</button>
              <button id="btnCycle">Run Full Cycle</button>
              <button id="btnToday" class="gold">Today’s 72 Name</button>
            </div>
            <div class="hint">“Pillars” = connection reps. “Cycles” = a full practice pass.</div>
          </div>
        </div>

        <div class="card">
          <h3>Profile</h3>
          <<div class="row">
  <div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:6px">Birthday</div>
    <input id="birthday" type="date"
      style="width:100%;background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;color:var(--text);" />
  </div>

  <div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:6px">Astrological Sign</div>
    <input id="sign" placeholder="Auto from birthday (basic)" readonly
      style="width:100%;background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;color:var(--text);opacity:.9;" />
  </div>
</div>
          <div class="row" style="margin-top:12px">
            <div>
              <div style="color:var(--muted);font-size:13px;margin-bottom:6px">Tikkun (enter for now)</div>
              <input id="tikkun" placeholder="e.g., (enter Centre method later)"
                style="width:100%;background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;color:var(--text);outline:none" />
            </div>
            <div>
              <div style="color:var(--muted);font-size:13px;margin-bottom:6px">Notes</div>
              <input id="notes" placeholder="Optional..."
                style="width:100%;background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;color:var(--text);outline:none" />
            </div>
          </div>

          <div class="hint" style="margin-top:10px">
            This build stays “Centre-language” neutral: tool-first, not preachy.
          </div>
        </div>
      </div>
    </section>

    <!-- 72 NAMES -->
    <section id="view-names72" class="view">
      <div class="card">
        <div class="detailHead">
          <h2 id="n72Header">The 72 Names</h2>
<div class="btnrow">
  <button id="btnBack" class="ghost" style="display:none">Back to list</button>
  <button id="btnRand" class="gold">Random</button>
  <button id="btnHowTo">How to Use</button>
  <button id="btnAssess">Self-Assessment</button>
</div>          </div>
        </div>

        <div id="n72ListPane">
          <div class="n72-top">
            <input id="n72Search" placeholder="Search by title, subtitle, or # (e.g., 48 or #48)" />
            <button id="btnAll">All</button>
          </div>
          <div id="n72List" class="n72-list"></div>
        </div>

        <div id="n72DetailPane" style="display:none">
          <div class="hebrew" id="n72Heb">—</div>
          <div class="meaning" id="n72Meaning"></div>
          <div class="practice" id="n72Practice"></div>
          <div class="btnrow" style="margin-top:14px">
            <button id="btnMakeCard" class="gold">Make Share Card</button>
            <button id="btnCopy" class="ghost">Copy Text</button>
          </div>
<div id="n72HowPane" style="display:none">
  <div class="meaning" id="n72HowText"></div>
</div>

<div id="n72AssessPane" style="display:none">
  <div class="meaning" id="n72AssessText"></div>
</div>
        </div>
      </div>
    </section>

    <!-- SHARE -->
    <section id="view-share" class="view">
      <div class="card">
        <h3>Share Card</h3>
        <div class="shareWrap">
          <div>
            <div class="hint" style="margin-bottom:10px">Pick a Name from “72 Names,” then generate a card.</div>
            <div class="btnrow">
              <button id="btnRenderCard" class="gold">Render Current Card</button>
              <button id="btnDownload" class="primary">Download PNG</button>
              <button id="btnClearCard" class="ghost">Clear</button>
            </div>
            <div class="hint" style="margin-top:10px" id="cardHint">No selection yet.</div>
          </div>
          <div>
            <canvas id="cardCanvas" width="1080" height="1350"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="view">
      <div class="card">
        <h3>Settings</h3>
        <div class="btnrow">
          <button id="btnReset72" class="ghost">Reset 72 storage only</button>
          <button id="btnResetAll" class="ghost">Reset ALL KAI storage</button>
        </div>
        <div class="hint" style="margin-top:10px">
          If anything ever goes weird: “Reset 72 storage only” is the safe move.
        </div>
      </div>
    </section>

  </div>

  <div id="toast" class="toast"></div>

<script>
/* ==========================
   KAI CLEAN 72 (SAFE BOOT)
   ========================== */

(() => {
  // ---------- helpers ----------
  function $(id){
  const el = document.getElementById(id);
  if(!el) throw new Error("Missing element id: " + id);
  return el;
}
function zodiacFromYMD(ymd){
  // expects "YYYY-MM-DD"
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec((ymd||"").trim());
  if(!m) return "";
  const month = parseInt(m[2],10);
  const day   = parseInt(m[3],10);

  // Western sun signs (tropical)
  if ((month===3 && day>=21) || (month===4 && day<=19)) return "Aries";
  if ((month===4 && day>=20) || (month===5 && day<=20)) return "Taurus";
  if ((month===5 && day>=21) || (month===6 && day<=20)) return "Gemini";
  if ((month===6 && day>=21) || (month===7 && day<=22)) return "Cancer";
  if ((month===7 && day>=23) || (month===8 && day<=22)) return "Leo";
  if ((month===8 && day>=23) || (month===9 && day<=22)) return "Virgo";
  if ((month===9 && day>=23) || (month===10 && day<=22)) return "Libra";
  if ((month===10 && day>=23) || (month===11 && day<=21)) return "Scorpio";
  if ((month===11 && day>=22) || (month===12 && day<=21)) return "Sagittarius";
  if ((month===12 && day>=22) || (month===1 && day<=19)) return "Capricorn";
  if ((month===1 && day>=20) || (month===2 && day<=18)) return "Aquarius";
  if ((month===2 && day>=19) || (month===3 && day<=20)) return "Pisces";

  return "";
}
  function updateSignFromBirthday(){
  // read birthday from input if present
  let ymd = "";
  try { ymd = $("birthday").value || ""; } catch(e){ return; }

  // compute sign and store it
  const sign = zodiacFromYMD(ymd) || "";
  if (!state.profile) state.profile = { birthday:"", sign:"", tikkun:"", notes:"" };

  state.profile.birthday = ymd;
  state.profile.sign = sign;

  // paint sign into UI if input exists
  try { $("sign").value = sign || ""; } catch(e){}

  // persist if saveState exists
  try { if (typeof saveState === "function") saveState(); } catch(e){}
}
  const errBox = $("errBox");
  const toastEl = $("toast");

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display="none", 2200);
  }

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  // ---------- storage (versioned + safe) ----------
  const KEY = {<div id="gate" class="card" style="margin-bottom:14px;">
  <h3>Welcome</h3>
  <div class="hint" style="margin-bottom:10px;">
    One tap = one connection rep. Then you enter Study.
  </div>

  <div class="btnrow">
    <button id="btnGateConnect" class="primary">CONNECT ( +1 pillar )</button>
    <button id="btnGateEnter" class="gold">Enter Study</button>
  </div>

  <div class="hint" id="gateStatus" style="margin-top:10px; opacity:.9;"></div>
</div><div id="gate" class="card" style="margin-bottom:14px;">
  <h3>Welcome</h3>
  <div class="hint" style="margin-bottom:10px;">
    One tap = one connection rep. Then you enter Study.
  </div>

  <div class="btnrow">
    <button id="btnGateConnect" class="primary">CONNECT ( +1 pillar )</button>
    <button id="btnGateEnter" class="gold">Enter Study</button>
  </div>

  <div class="hint" id="gateStatus" style="margin-top:10px; opacity:.9;"></div>
</div><div id="gate" class="card" style="margin-bottom:14px;">
  <h3>Welcome</h3>
  <div class="hint" style="margin-bottom:10px;">
    One tap = one connection rep. Then you enter Study.
  </div>

  <div class="btnrow">
    <button id="btnGateConnect" class="primary">CONNECT ( +1 pillar )</button>
    <button id="btnGateEnter" class="gold">Enter Study</button>
  </div>

  <div class="hint" id="gateStatus" style="margin-top:10px; opacity:.9;"></div>
</div><div id="gate" class="card" style="margin-bottom:14px;">
  <h3>Welcome</h3>
  <div class="hint" style="margin-bottom:10px;">
    One tap = one connection rep. Then you enter Study.
  </div>

  <div class="btnrow">
    <button id="btnGateConnect" class="primary">CONNECT ( +1 pillar )</button>
    <button id="btnGateEnter" class="gold">Enter Study</button>
  </div>

  <div class="hint" id="gateStatus" style="margin-top:10px; opacity:.9;"></div>
</div>
    state: "kai_state_v1",
    n72_selected: "kai_72_selected_v1",
    n72_notes: "kai_72_notes_v1"
  };

  const defaultState = {
entry: {
  lastGateAt: "",
  gateCountToday: 0,
  enteredToday: false
},
todayThread: {
  name72Id: 1,
  zoharId: "atika-001",
  restrictPrompt: "",
  sealLine: ""
},
zohar: {
  favorites: []
}
    
    pillars: 0,
    cycles: 0,
    certainty: 5,
    energy: 5,
    profile: { birthday:"", sign:"", tikkun:"", notes:"" }
  };

  function safeParse(s, fallback){
    try{
      const v = JSON.parse(s);
      return (v === null || v === undefined) ? fallback : v;
    } catch {
      return fallback;
    }
  }
  function loadState(){
    return safeParse(localStorage.getItem(KEY.state), structuredClone(defaultState));
  }
  function saveState(){
    localStorage.setItem(KEY.state, JSON.stringify(state));
  }

  // ---------- 72 data (titles/subtitles from your screenshots) ----------
  // Hebrew triples + full meaning text can be added later safely.
  const N72 = [
    {id:1,  title:"Time Travel", subtitle:"How to fix the past"},
    {id:2,  title:"Recapturing the Sparks", subtitle:"Recharging when you are depleted"},
    {id:3,  title:"Miracle Making", subtitle:"A recipe"},
    {id:4,  title:"Eliminating Negative Thoughts", subtitle:"When and how"},
    {id:5,  title:"Healing", subtitle:"Meditation for yourself and others"},
    {id:6,  title:"Dream State", subtitle:"Activating messages from the subconscious"},
    {id:7,  title:"DNA of Soul", subtitle:"Restoring to their perfect state"},
    {id:8,  title:"Defusing Negative Energy and Stress", subtitle:"Releasing the pressure"},
    {id:9,  title:"Angelic Influences", subtitle:"Harnessing help from above"},
    {id:10, title:"Looks Can Kill", subtitle:"Protecting yourself from the evil-eye"},
    {id:11, title:"Banishing the Remnants of Evil", subtitle:"Purifying places and spaces"},
    {id:12, title:"Unconditional Love", subtitle:"How to awaken love, especially when you don’t want to"},
    {id:13, title:"Heaven on Earth", subtitle:"Creating harmony within and without"},
    {id:14, title:"Farewell to Arms", subtitle:"Diffusing conflict"},
    {id:15, title:"Long-Range Vision", subtitle:"Seeing the effect of decisions before you make them"},
    {id:16, title:"Dumping Depression", subtitle:"How to pick yourself up when you fall"},
    {id:17, title:"Great Escape", subtitle:"Breaking the limits of ego"},
    {id:18, title:"Fertility", subtitle:"When conception is difficult"},
    {id:19, title:"Dialing God", subtitle:"Receiving answers to your prayers"},
    {id:20, title:"Victory Over Addictions", subtitle:"Overcoming your negative self"},
    {id:21, title:"Eradicate Plague", subtitle:"Effecting change in the physical world"},
    {id:22, title:"Stop Fatal Attraction", subtitle:"How to stop drawing the wrong people into your life"},
    {id:23, title:"Sharing the Flame", subtitle:"Passing the wisdom along"},
    {id:24, title:"Jealousy", subtitle:"Undoing chaos resulting from our jealousy before it is manifested"},
    {id:25, title:"Speak Your Mind", subtitle:"For those times when you need help expressing the truth"},
    {id:26, title:"Order from Chaos", subtitle:"Reversing Murphy’s Law"},
    {id:27, title:"Silent Partner", subtitle:"Choosing positivity as your partner"},
    {id:28, title:"Soul Mate", subtitle:"Attracting “The One”"},
    {id:29, title:"Removing Hatred", subtitle:"Drawing out the poison"},
    {id:30, title:"Building Bridges", subtitle:"Mending broken relationships"},
    {id:31, title:"Finish What You Start", subtitle:"Finding the power to finish what you start"},
    {id:32, title:"Memories", subtitle:"Breaking the cycle"},
    {id:33, title:"Revealing the Dark Side", subtitle:"Removing the obstacles you create"},
    {id:34, title:"Forget Thyself", subtitle:"Opening up to another view"},
    {id:35, title:"Sexual Energy", subtitle:"How to get more from your sexual experience"},
    {id:36, title:"Fear(less)", subtitle:"Overcoming the ties that bind"},
    {id:37, title:"The Big Picture", subtitle:"Seeing the opportunity for good hidden in every challenge"},
    {id:38, title:"Circuitry", subtitle:"Sharing so you can truly receive"},
    {id:39, title:"Diamond in the Rough", subtitle:"Turning the coal in your life into diamonds"},
    {id:40, title:"Speaking the Right Words", subtitle:"Using language to make good things happen"},
    {id:41, title:"Self-Esteem", subtitle:"Finding the power to lift yourself up"},
    {id:42, title:"Revealing the Concealed", subtitle:"Seeing the truth and handling it"},
    {id:43, title:"Defying Gravity", subtitle:"Achieving mind over matter"},
    {id:44, title:"Sweetening Judgment", subtitle:"Ducking the boomerang you send out there—stop the judgment that is happening against you"},
    {id:45, title:"The Power of Prosperity", subtitle:"What to do when you need money"},
    {id:46, title:"Absolute Certainty", subtitle:"What to do when doubts creep in"},
    {id:47, title:"Global Transformation", subtitle:"Helping to bring about world peace"},
    {id:48, title:"Unity", subtitle:"When there is conflict and only togetherness will do"},
    {id:49, title:"Happiness", subtitle:"When you need the power to choose happiness"},
    {id:50, title:"Enough Is Never Enough", subtitle:"When you need the passion to keep from settling for less"},
    {id:51, title:"No Guilt", subtitle:"Removing negativity aspects of your nature while you repair the damage they cause"},
    {id:52, title:"Passion", subtitle:"Awaken the earning in your heart"},
    {id:53, title:"No Agenda", subtitle:"Giving with no strings attached"},
    {id:54, title:"The Death of Death", subtitle:"When things are good and you want them to stay that way"},
    {id:55, title:"Thought into Action", subtitle:"The power to make it happen"},
    {id:56, title:"Dispelling Anger", subtitle:"Overcoming it before it overcomes you"},
    {id:57, title:"Listen to Your Soul", subtitle:"Increasing the volume of the soft voice within"},
    {id:58, title:"Letting Go", subtitle:"When you need the power to walk away"},
    {id:59, title:"Umbilical Cord", subtitle:"Connecting to the Light Force"},
    {id:60, title:"Freedom", subtitle:"Passing the test and going to the next level"},
    {id:61, title:"Water", subtitle:"Removing negativity from the source of life"},
    {id:62, title:"Parent–Teacher, Not Preacher", subtitle:"When you need to teach your children"},
    {id:63, title:"Appreciation", subtitle:"How to keep what you have and get more"},
    {id:64, title:"Casting Yourself in a Favorable Light", subtitle:"Revealing the best you"},
    {id:65, title:"Fear of God", subtitle:"When you need to remember that there is a system, and how to work it"},
    {id:66, title:"Accountability", subtitle:"The power to take accountability for your happiness and life"},
    {id:67, title:"Great Expectations", subtitle:"How to stop getting disappointed"},
    {id:68, title:"Contacting Departed Souls", subtitle:"Making positive connections with people that have passed on"},
    {id:69, title:"Lost and Found", subtitle:"What to do when you are lost and confused"},
    {id:70, title:"Recognizing Design Beneath Disorder", subtitle:"Finding the solution within the problem"},
    {id:71, title:"Prophecy and Parallel Universes", subtitle:"Switching your universe for a better one"},
    {id:72, title:"Spiritual Cleansing", subtitle:"Purging yourself of negativity"},
  ];
// ---------- 72 Names content layers ----------

const N72_HEB = {};
const N72_MEANINGS = {};
const N72_PRACTICE = {};

const N72_HOWTO = [
  "Pick a Name based on the challenge, not the mood.",
  "Read the Hebrew slowly. Intention matters.",
  "Visualize the letters as a channel for Light.",
  "Pair the Name with one restriction that day.",
  "Seal it with an action."
];

const N72_ASSESS = [
  { id:"focus",   q:"When I choose a Name, I set a clear intention." },
  { id:"letters", q:"I engage the Hebrew letters as a tool." },
  { id:"restrict",q:"I pair the Name with restriction." },
  { id:"action",  q:"I translate insight into action within 24 hours." }
];

const KEY72 = {
  assess: "kai_72_assess_answers_v1"
};

function loadAssess(){
  const a = safeParse(localStorage.getItem(KEY72.assess), {}) || {};
  return (a && typeof a === "object") ? a : {};
}
function saveAssess(obj){
  localStorage.setItem(KEY72.assess, JSON.stringify(obj || {}));
}function n72_showHow(){
  $("n72Header").textContent = "How to Use the 72 Names";
  $("n72ListPane").style.display = "none";
  $("n72DetailPane").style.display = "none";
  $("n72AssessPane").style.display = "none";
  $("n72HowPane").style.display = "block";
  $("btnBack").style.display = "inline-block";
  $("n72HowText").textContent = "Using the 72 Names:\n\n• " + N72_HOWTO.join("\n• ");
}

function n72_showAssess(){
  $("n72Header").textContent = "Self-Assessment";
  $("n72ListPane").style.display = "none";
  $("n72DetailPane").style.display = "none";
  $("n72HowPane").style.display = "none";
  $("n72AssessPane").style.display = "block";
  $("btnBack").style.display = "inline-block";

  const ans = loadAssess();

  let out = "Rate 0–3 (tap to cycle):\n\n";
  N72_ASSESS.forEach((s, i)=>{
    const v = (ans[s.id] ?? 0);
    out += `${i+1}. ${s.q}\n   Current: ${v}\n\n`;
  });
  $("n72AssessText").textContent = out;

  $("n72AssessPane").onclick = ()=>{
    const idx = Math.floor(Math.random() * N72_ASSESS.length);
    const item = N72_ASSESS[idx];
    ans[item.id] = ((ans[item.id] ?? 0) + 1) % 4;
    saveAssess(ans);
    n72_showAssess();
  };
}

$("btnHowTo").addEventListener("click", n72_showHow);
$("btnAssess").addEventListener("click", n72_showAssess);
  // Optional: small Hebrew placeholders (you can replace later with true triples)
  function hebrewFor(id){
    // minimal placeholder so layout works
    return "—";
  }

  function meaningFor(n){
    // Keep it neutral. You can paste Centre meanings later.
    return `Name #${n.id} — ${n.title}\n\nFocus: ${n.subtitle}\n\nMeaning text can be added next (Centre-authentic).`;
  }

  function practiceFor(n){
    // Clean "practice" line (no over-the-top)
    return `Practice: Choose one small restriction today aligned to "${n.title}".`;
  }

  // ---------- runtime ----------
  let state = loadState();
  state.profile = Object.assign({ birthday:"", sign:"", tikkun:"", notes:"" }, state.profile || {});
  let current72 = null;

  function updateChips(){
    $("pillarsChip").textContent = String(state.pillars);
    $("cyclesChip").textContent = String(state.cycles);
    $("certaintyChip").textContent = String(state.certainty);
    $("energyChip").textContent = String(state.energy);
    $("certaintyVal").textContent = String(state.certainty);
    $("energyVal").textContent = String(state.energy);
  }

  function setTab(name){
    document.querySelectorAll(".tabbtn").forEach(b => {
      b.classList.toggle("active", b.dataset.tab === name);
    });
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    $("view-" + name).classList.add("active");
    if (name === "names72") n72_init();
    if (name === "share") renderCardPreview();
  }

  // ---------- 72 rendering ----------
  function n72_init(){
    // list view by default unless current72 is set
    $("btnBack").style.display = current72 ? "inline-block" : "none";
    if (!current72) n72_showList();
    else n72_showDetail(current72);

    // ensure list is populated if it isn't
    if ($("n72List").children.length === 0) n72_renderList(N72);
  }

  function n72_filter(q){
    q = (q || "").trim().toLowerCase();
    if (!q) return N72;

    // allow "#48" or "48"
    let num = q.startsWith("#") ? parseInt(q.slice(1),10) : parseInt(q,10);
    if (!Number.isNaN(num)) return N72.filter(x => x.id === num);

    return N72.filter(x =>
      (x.title || "").toLowerCase().includes(q) ||
      (x.subtitle || "").toLowerCase().includes(q)
    );
  }

  function n72_renderList(list){
    const host = $("n72List");
    host.innerHTML = "";
    list.forEach(n => {
      const row = document.createElement("div");
      row.className = "n72-item";
      row.innerHTML = `
        <div class="n72-id">${n.id}</div>
        <div class="n72-meta">
          <div class="n72-title">${escapeHtml(n.title)}</div>
          <div class="n72-sub">${escapeHtml(n.subtitle)}</div>
        </div>
      `;
      row.addEventListener("click", () => n72_showDetail(n));
      host.appendChild(row);
    });
  }

  function n72_showList(){
    $("n72Header").textContent = "The 72 Names";
    $("n72ListPane").style.display = "block";
    $("n72DetailPane").style.display = "none";
    $("btnBack").style.display = "none";
  }

  function n72_showDetail(n){
    current72 = n;
    localStorage.setItem(KEY.n72_selected, JSON.stringify({id:n.id}));
    $("n72Header").textContent = `#${n.id} — ${n.title}`;
    $("n72ListPane").style.display = "none";
    $("n72DetailPane").style.display = "block";
    $("btnBack").style.display = "inline-block";

    $("n72Heb").textContent = hebrewFor(n.id);
    $("n72Meaning").textContent = meaningFor(n);
    $("n72Practice").textContent = practiceFor(n);

    $("cardHint").textContent = `Selected: #${n.id} — ${n.title}`;
  }

  function pickRandom72(){
    return N72[Math.floor(Math.random()*N72.length)];
  }

  function todayIndex(){
    // stable day-based selection 1..72
    const d = new Date();
    const key = Number(String(d.getFullYear()) + String(d.getMonth()+1).padStart(2,"0") + String(d.getDate()).padStart(2,"0"));
    return (key % 72) + 1;
  }

  function get72ById(id){
    return N72.find(x => x.id === id) || N72[0];
  }

  // ---------- share card ----------
  function renderCardPreview(){
    const canvas = $("cardCanvas");
    const ctx = canvas.getContext("2d");
    const n = current72 || restoreSelected72();

    // clear
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if (!n){
      // draw blank
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      $("cardHint").textContent = "No selection yet.";
      return;
    }

    drawCard(ctx, canvas.width, canvas.height, n);
    $("cardHint").textContent = `Selected: #${n.id} — ${n.title}`;
  }

  function drawCard(ctx, W, H, n){
    // background
    ctx.fillStyle = "#0a0a0b";
    ctx.fillRect(0,0,W,H);

    // top gold bar
    ctx.fillStyle = "rgba(216,178,75,.95)";
    ctx.fillRect(0,0,W,22);

    // title
    ctx.fillStyle = "#f2f2f2";
    ctx.font = "800 72px -apple-system,system-ui,Segoe UI,Roboto,Arial";
    ctx.textBaseline = "top";
    ctx.fillText(`72 Name #${n.id} — ${n.title}`, 70, 110);

    // Hebrew
    ctx.fillStyle = "rgba(216,178,75,.95)";
    ctx.font = "700 56px -apple-system,system-ui,Segoe UI,Roboto,Arial";
    ctx.fillText(hebrewFor(n.id), 70, 230);

    // body
    ctx.fillStyle = "rgba(242,242,242,.92)";
    ctx.font = "500 40px -apple-system,system-ui,Segoe UI,Roboto,Arial";
    const body = `${n.subtitle}\n\n${practiceFor(n)}`;
    wrapText(ctx, body, 70, 320, W-140, 56);

    // footer
    ctx.fillStyle = "rgba(166,166,169,.8)";
    ctx.font = "600 28px -apple-system,system-ui,Segoe UI,Roboto,Arial";
    const d = new Date();
    const stamp = `KAI • ${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    ctx.fillText(stamp, 70, H-70);
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const paragraphs = String(text).split("\n");
    let yy = y;
    paragraphs.forEach(p => {
      const words = p.split(" ");
      let line = "";
      words.forEach((w, i) => {
        const test = line ? line + " " + w : w;
        const m = ctx.measureText(test).width;
        if (m > maxWidth && line){
          ctx.fillText(line, x, yy);
          yy += lineHeight;
          line = w;
        } else {
          line = test;
        }
      });
      if (line){
        ctx.fillText(line, x, yy);
        yy += lineHeight;
      }
      yy += Math.floor(lineHeight/2);
    });
  }

  function downloadCard(){
    const a = document.createElement("a");
    a.download = "kai-share-card.png";
    a.href = $("cardCanvas").toDataURL("image/png");
    a.click();
  }

  // ---------- restore selection ----------
  function restoreSelected72(){
    const obj = safeParse(localStorage.getItem(KEY.n72_selected), null);
    if (obj && obj.id) {
      current72 = get72ById(obj.id);
      return current72;
    }
    return null;
  }

  // ---------- zodiac (basic) ----------
  function zodiacFromBirthday(str){
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(str || "");
    if (!m) return "";
    const month = parseInt(m[2],10);
    const day = parseInt(m[3],10);
    const z = [
      ["Capricorn", 1, 19],
      ["Aquarius",  2, 18],
      ["Pisces",    3, 20],
      ["Aries",     4, 19],
      ["Taurus",    5, 20],
      ["Gemini",    6, 20],
      ["Cancer",    7, 22],
      ["Leo",       8, 22],
      ["Virgo",     9, 22],
      ["Libra",     10,22],
      ["Scorpio",   11,21],
      ["Sagittarius",12,21],
      ["Capricorn", 12,31],
    ];
    for (const [name, mo, endDay] of z){
      if (month === mo && day <= endDay) return name;
    }
    return "";
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- wiring ----------
  function wire(){
    // tabs
    document.querySelectorAll(".tabbtn").forEach(b => {
      b.addEventListener("click", () => setTab(b.dataset.tab));
    });

    // home sliders
    $("certainty").addEventListener("input", (e)=>{
      state.certainty = parseInt(e.target.value,10);
      saveState(); updateChips();
    });
    $("energy").addEventListener("input", (e)=>{
      state.energy = parseInt(e.target.value,10);
      saveState(); updateChips();
    });

    // home buttons
    $("btnConnect").addEventListener("click", ()=>{
      state.pillars = Math.min(100, (state.pillars||0) + 1);
      saveState(); updateChips();
      toast("Connection +1");
    });
    $("btnCycle").addEventListener("click", ()=>{
      state.cycles = Math.min(10, (state.cycles||0) + 1);
      saveState(); updateChips();
      toast("Cycle +1");
    });
    $("btnToday").addEventListener("click", ()=>{
      const id = todayIndex();
      const n = get72ById(id);
      setTab("names72");
      n72_showDetail(n);
    });

    // profile fields
    $("birthday").addEventListener("change", (e)=>{
  if(!state.profile) state.profile = { birthday:"", sign:"", tikkun:"", notes:"" };
  state.profile.birthday = e.target.value || "";
  updateSignFromBirthday();
  saveState(state);
});
    $("sign").addEventListener("input", (e)=>{
      state.profile.sign = e.target.value.trim();
      saveState();
    });
    $("tikkun").addEventListener("input", (e)=>{
      state.profile.tikkun = e.target.value;
      saveState();
    });
    $("notes").addEventListener("input", (e)=>{
      state.profile.notes = e.target.value;
      saveState();
    });

    // 72 events
    $("n72Search").addEventListener("input", (e)=>{
      n72_renderList(n72_filter(e.target.value));
    });
    $("btnAll").addEventListener("click", ()=>{
      $("n72Search").value = "";
      n72_renderList(N72);
    });
    $("btnRand").addEventListener("click", ()=>{
      setTab("names72");
      n72_showDetail(pickRandom72());
    });
    $("btnBack").addEventListener("click", ()=>{
      current72 = null;
      localStorage.removeItem(KEY.n72_selected);
      n72_showList();
    });
    $("btnMakeCard").addEventListener("click", ()=>{
      setTab("share");
      renderCardPreview();
      toast("Card ready");
    });
    $("btnCopy").addEventListener("click", async ()=>{
      if (!current72) return;
      const txt = `72 Name #${current72.id} — ${current72.title}\n${current72.subtitle}\n\n${practiceFor(current72)}`;
      try{
        await navigator.clipboard.writeText(txt);
        toast("Copied");
      } catch {
        toast("Copy blocked");
      }
function n72_showHow(){
  $("n72Header").textContent = "How to Use the 72 Names";
  $("n72ListPane").style.display = "none";
  $("n72DetailPane").style.display = "none";
  $("n72AssessPane").style.display = "none";
  $("n72HowPane").style.display = "block";
  $("btnBack").style.display = "inline-block";
  $("n72HowText").textContent = "Using the 72 Names:\n\n• " + N72_HOWTO.join("\n• ");
}

function n72_showAssess(){
  $("n72Header").textContent = "Self-Assessment";
  $("n72ListPane").style.display = "none";
  $("n72DetailPane").style.display = "none";
  $("n72HowPane").style.display = "none";
  $("n72AssessPane").style.display = "block";
  $("btnBack").style.display = "inline-block";

  const ans = loadAssess();

  let out = "Rate 0–3 (tap to cycle):\n\n";
  N72_ASSESS.forEach((s, i)=>{
    const v = (ans[s.id] ?? 0);
    out += `${i+1}. ${s.q}\n   Current: ${v}\n\n`;
  });
  $("n72AssessText").textContent = out;

  $("n72AssessPane").onclick = ()=>{
    const idx = Math.floor(Math.random() * N72_ASSESS.length);
    const item = N72_ASSESS[idx];
    ans[item.id] = ((ans[item.id] ?? 0) + 1) % 4;
    saveAssess(ans);
    n72_showAssess();
  };
}

$("btnHowTo").addEventListener("click", n72_showHow);
$("btnAssess").addEventListener("click", n72_showAssess);
    
    });

    // share
    $("btnRenderCard").addEventListener("click", renderCardPreview);
    $("btnDownload").addEventListener("click", ()=>{
      renderCardPreview();
      downloadCard();
    });
    $("btnClearCard").addEventListener("click", ()=>{
      const ctx = $("cardCanvas").getContext("2d");
      ctx.clearRect(0,0,$("cardCanvas").width,$("cardCanvas").height);
      toast("Cleared");
    });

    // settings
    $("btnReset72").addEventListener("click", ()=>{
      localStorage.removeItem(KEY.n72_selected);
      localStorage.removeItem(KEY.n72_notes);
      current72 = null;
      toast("72 storage reset");
    });
    $("btnResetAll").addEventListener("click", ()=>{
      localStorage.clear();
      state = structuredClone(defaultState);
      saveState();
      updateChips();
      toast("All storage reset");
      location.reload();
    });
  }

  // ---------- boot ----------
  function boot(){
    clearErr();

    // crash visibility
    window.addEventListener("error", (e)=>{
      showErr("JS ERROR: " + (e?.message || "unknown") + "\n" + (e?.error?.stack || ""));
    });
    window.addEventListener("unhandledrejection", (e)=>{
      showErr("PROMISE ERROR: " + (e?.reason?.message || String(e?.reason || "unknown")));
    });

    // load + hydrate ui
    state = loadState();
    $("certainty").value = String(state.certainty ?? 5);
    $("energy").value = String(state.energy ?? 5);
    $("birthday").value = state.profile?.birthday || "";
    $("sign").value = state.profile?.sign || "";
    $("tikkun").value = state.profile?.tikkun || "";
    $("notes").value = state.profile?.notes || "";
    updateChips();

    // initial list
    n72_renderList(N72);
    restoreSelected72();

    // wire UI
    wire();

    toast("KAI loaded");
    console.log("KAI CLEAN 72 booted");
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ boot(); }
    catch(e){
      console.error("BOOT ERROR", e);
      showErr("BOOT ERROR: " + (e?.message || String(e)) + "\n" + (e?.stack || ""));
      alert("KAI boot error (shown on-screen).");
    }
  });

})();
</script>
</body>
</html>
