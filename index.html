<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KAI" />

  <!-- iOS Home Screen icon (must exist at site root) -->
  <link rel="apple-touch-icon" href="/kai-icon.png?v=10" />
  <!-- PWA manifest (must exist at site root) -->
  <link rel="manifest" href="/manifest.webmanifest?v=10" />

  <title>KAI</title>

  <style>
    :root{
      --bg:#070708;
      --panel:#0e0f12;
      --panel2:#0b0b0c;
      --text:#f3f3f4;
      --muted:#b3b3b7;
      --line:rgba(255,255,255,.09);
      --line2:rgba(255,255,255,.14);
      --gold:#c8a24a;
      --gold2:#8f6f2a;
      --good:#2ad07f;
      --warn:#ffcc66;
      --bad:#ff5b5b;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 22px;
      --pad: 18px;
      --max: 1200px;
    }

    * { box-sizing: border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 18% 14%, rgba(200,162,74,.18), transparent 58%),
        radial-gradient(900px 520px at 85% 10%, rgba(200,162,74,.08), transparent 55%),
        var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
    }

    /* iOS ‚Äúfeels like a photo‚Äù fix helpers */
    button, .tabBtn, .chipBtn, .btn{
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 20px 16px 110px;
    }

    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin: 10px 0 18px;
    }

    .brand h1{
      margin:0;
      letter-spacing:.08em;
      font-size: 34px;
      font-weight: 800;
    }
    .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 13px;
      letter-spacing:.02em;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .chip{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color: var(--muted);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 8px 26px rgba(0,0,0,.25);
      user-select:none;
    }
    .chip b{ color: var(--text); font-weight: 700; }

    .tabs{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 16px;
    }
    .tabBtn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .tabBtn:active{ transform: scale(.98); }
    .tabBtn.active{
      border-color: rgba(200,162,74,.45);
      background: rgba(200,162,74,.08);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .panel{
      background:
        radial-gradient(900px 420px at 30% 20%, rgba(200,162,74,.10), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)),
        rgba(10,10,12,.65);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .top{ flex-direction: column; align-items:flex-start; }
      .chips{ justify-content:flex-start; }
    }

    .sectionTitle{
      color: var(--gold);
      font-weight: 800;
      letter-spacing:.02em;
      margin: 0 0 10px;
      font-size: 16px;
    }

    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 7px;
      letter-spacing:.02em;
    }
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.35);
      border: 1px solid var(--line2);
      border-radius: 14px;
      padding: 12px 12px;
      color: var(--text);
      font-size: 15px;
      outline: none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(200,162,74,.45);
      box-shadow: 0 0 0 3px rgba(200,162,74,.08);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .row2{ grid-template-columns: 1fr; }
    }

    .bar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .btn{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 14px;
      user-select:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      border-color: rgba(200,162,74,.55);
      background: rgba(200,162,74,.09);
    }
    .btn.good{
      border-color: rgba(42,208,127,.45);
      background: rgba(42,208,127,.07);
    }
    .btn.bad{
      border-color: rgba(255,91,91,.45);
      background: rgba(255,91,91,.07);
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .split{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.25);
      padding: 14px;
    }

    .miniTitle{
      font-weight: 800;
      color: rgba(255,255,255,.92);
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing:.01em;
    }

    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      margin-top: 10px;
    }
    .toggleRow .label{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.25;
    }
    .switch{
      width: 48px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.06);
      position: relative;
      cursor:pointer;
      flex: none;
    }
    .switch .dot{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      position:absolute;
      top: 2px;
      left: 2px;
      transition: left .16s ease, background .16s ease;
    }
    .switch.on{
      border-color: rgba(200,162,74,.55);
      background: rgba(200,162,74,.12);
    }
    .switch.on .dot{ left: 24px; background: rgba(200,162,74,.95); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      z-index: 9999;
      max-width: min(92vw, 680px);
      text-align:center;
      user-select:none;
    }

    /* Celebration modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 99999;
    }
    .modal{
      width: min(760px, 100%);
      background:
        radial-gradient(900px 420px at 30% 20%, rgba(200,162,74,.20), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(200,162,74,.35);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .modal h3{ margin: 0 0 6px; font-size: 20px; }
    .modal p{ margin: 0 0 14px; color: var(--muted); }
    .xClose{
      position:absolute;
      right:12px;
      top:10px;
      background: transparent;
      border: 1px solid var(--line);
      color: #fff;
      border-radius: 999px;
      width: 38px;
      height: 38px;
      cursor:pointer;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 10px;
    }
    .item{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      padding: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .item .date{
      font-weight: 800;
      color: rgba(255,255,255,.92);
      letter-spacing:.01em;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.3;
      white-space: pre-wrap;
    }
    .pill{
      font-size: 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 7px 10px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      user-select:none;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>KAI</h1>
        <div class="sub">Kabbalah Always Illuminates ‚Ä¢ Alignment ‚Ä¢ Restriction ‚Ä¢ Witnessing</div>
      </div>

      <div class="chips" aria-label="status">
        <div class="chip">Date: <b id="chipDate">‚Äî</b></div>
        <div class="chip">Profile: <b id="chipProfile">‚Äî</b></div>
        <div class="chip">Streak: <b id="chipStreak">‚Äî</b></div>
        <div class="chip">Daily Restrict: <b id="chipDailyRestrict">‚Äî</b></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <button class="tabBtn active" data-tab="start" type="button">Start</button>
      <button class="tabBtn" data-tab="morning" type="button">Morning</button>
      <button class="tabBtn" data-tab="restriction" type="button">Restriction</button>
      <button class="tabBtn" data-tab="evening" type="button">Evening</button>
      <button class="tabBtn" data-tab="share" type="button">Share Card</button>
      <button class="tabBtn" data-tab="library" type="button">Library</button>
      <button class="tabBtn" data-tab="tools" type="button">Tools</button>
      <button class="tabBtn" data-tab="history" type="button">History</button>
    </div>

    <!-- START -->
    <section class="panel" data-pane="start">
      <div class="sectionTitle">Profile and Intent</div>

      <div class="grid">
        <div class="field">
          <label for="pName">Your name</label>
          <input id="pName" placeholder="Bernard" />
        </div>

        <div class="field">
          <label for="pBirth">Birthdate (astrology layer)</label>
          <input id="pBirth" type="date" />
        </div>

        <div class="field">
          <label for="pFocus">Primary focus</label>
          <select id="pFocus">
            <option value="">Select‚Ä¶</option>
            <option>Certainty</option>
            <option>Restriction (Reactivity)</option>
            <option>Love (Ahavah)</option>
            <option>Unity (Achdut)</option>
            <option>Faith (Emunah)</option>
            <option>Discipline</option>
            <option>Leadership</option>
            <option>Health / Strength</option>
            <option>Relationships</option>
          </select>
        </div>

        <div class="field">
          <label for="pOutcome">30-day outcome (one sentence)</label>
          <input id="pOutcome" placeholder="Increase certainty and reduce urgency" />
        </div>

        <div class="field">
          <label for="pIntensity">Preferred intensity</label>
          <select id="pIntensity">
            <option>Simple + Powerful</option>
            <option>Deep + Detailed</option>
            <option>Fast + Tactical</option>
            <option>Gentle + Grounding</option>
          </select>
        </div>

        <div class="field">
          <label for="pEnable">Enable</label>
          <select id="pEnable">
            <option>Core + Tools</option>
            <option>Core Only</option>
            <option>Core + Tools + Library</option>
          </select>
        </div>
      </div>

      <div class="toggleRow" style="margin-top:16px;">
        <div class="label">
          <b style="color:var(--gold);">Daily Restrict Mode</b><br/>
          One restriction per day, celebrated + streak tracked. üî•
        </div>
        <div class="switch" id="dailyRestrictSwitch" role="switch" aria-checked="false" tabindex="0">
          <div class="dot"></div>
        </div>
      </div>

      <div class="split">
        <div class="card">
          <div class="miniTitle">Daily Guidance Preview</div>
          <div class="row2">
            <div class="field">
              <label for="gPattern">Pattern (choose in Morning)</label>
              <input id="gPattern" placeholder="Pattern: ‚Äî" disabled />
            </div>
            <div class="field">
              <label for="gRestrict">Suggested restriction</label>
              <input id="gRestrict" placeholder="Choose one restriction move and witness the effect" disabled />
            </div>
          </div>
          <div class="hint">
            This POC keeps Zohar references high-level on purpose. Exact citations can be teacher-attached later.
          </div>
        </div>

        <div class="card">
          <div class="miniTitle">Quick Controls</div>
          <div class="bar">
            <button class="btn primary" id="saveAllBtn" type="button">Save</button>
            <button class="btn" id="copySummaryBtn" type="button">Copy</button>
            <button class="btn" id="exportBtn" type="button">Export</button>
            <button class="btn bad" id="resetDayBtn" type="button">Reset Day</button>
          </div>
          <div class="hint">
            Save persists: profile, today‚Äôs entries, streak + history. Reset clears today only.
          </div>
        </div>
      </div>
    </section>

    <!-- MORNING -->
    <section class="panel" data-pane="morning" style="display:none;">
      <div class="sectionTitle">Morning</div>

      <div class="row2">
        <div class="field">
          <label for="mCertainty">Certainty (0‚Äì10)</label>
          <input id="mCertainty" type="number" min="0" max="10" step="1" placeholder="0‚Äì10" />
        </div>
        <div class="field">
          <label for="mEnergy">Energy (0‚Äì10)</label>
          <input id="mEnergy" type="number" min="0" max="10" step="1" placeholder="0‚Äì10" />
        </div>
      </div>

      <div class="row2" style="margin-top:14px;">
        <div class="field">
          <label for="mIntention">Intention (one sentence)</label>
          <input id="mIntention" placeholder="Today I choose‚Ä¶" />
        </div>
        <div class="field">
          <label for="mPattern">Pattern</label>
          <select id="mPattern">
            <option value="">Select‚Ä¶</option>
            <option>Urgency ‚Üí Certainty</option>
            <option>Reactivity ‚Üí Restriction</option>
            <option>Judgment ‚Üí Compassion</option>
            <option>Overthinking ‚Üí Action</option>
            <option>Fear ‚Üí Faith</option>
            <option>Control ‚Üí Trust</option>
            <option>Isolation ‚Üí Connection</option>
          </select>
        </div>
      </div>

      <div class="field" style="margin-top:14px;">
        <label for="mWitness">What would ‚Äúwitnessing‚Äù look like today?</label>
        <textarea id="mWitness" placeholder="If I‚Äôm being honest‚Ä¶"></textarea>
      </div>

      <div class="bar">
        <button class="btn primary" id="saveMorningBtn" type="button">Save Morning</button>
        <button class="btn" id="copyMorningBtn" type="button">Copy Morning</button>
      </div>
    </section>

    <!-- RESTRICTION -->
    <section class="panel" data-pane="restriction" style="display:none;">
      <div class="sectionTitle">Restriction</div>

      <div class="row2">
        <div class="field">
          <label for="rMove">One restriction move</label>
          <input id="rMove" placeholder="Example: pause before responding‚Ä¶" />
        </div>
        <div class="field">
          <label for="rTrigger">Primary trigger</label>
          <input id="rTrigger" placeholder="What would normally set you off?" />
        </div>
      </div>

      <div class="field" style="margin-top:14px;">
        <label for="rNote">Witnessing note (what happened, what changed?)</label>
        <textarea id="rNote" placeholder="I felt the surge‚Ä¶ I restricted‚Ä¶ the result was‚Ä¶"></textarea>
      </div>

      <div class="toggleRow">
        <div class="label">
          <b style="color:var(--gold);">Mark today‚Äôs restriction as completed</b><br/>
          This increments streak once per day in Daily Restrict Mode.
        </div>
        <button class="btn good" id="completeRestrictBtn" type="button">Complete ‚úÖ</button>
      </div>

      <div class="bar">
        <button class="btn primary" id="saveRestrictionBtn" type="button">Save Restriction</button>
        <button class="btn" id="copyRestrictionBtn" type="button">Copy Restriction</button>
      </div>
    </section>

    <!-- EVENING -->
    <section class="panel" data-pane="evening" style="display:none;">
      <div class="sectionTitle">Evening</div>

      <div class="row2">
        <div class="field">
          <label for="eResult">Result (one sentence)</label>
          <input id="eResult" placeholder="Today I learned‚Ä¶" />
        </div>
        <div class="field">
          <label for="eGrade">Integrity grade (0‚Äì10)</label>
          <input id="eGrade" type="number" min="0" max="10" step="1" placeholder="0‚Äì10" />
        </div>
      </div>

      <div class="field" style="margin-top:14px;">
        <label for="eRepair">Repair (one thing to fix tomorrow)</label>
        <textarea id="eRepair" placeholder="Tomorrow I‚Äôll repair by‚Ä¶"></textarea>
      </div>

      <div class="bar">
        <button class="btn primary" id="saveEveningBtn" type="button">Save Evening</button>
        <button class="btn" id="copyEveningBtn" type="button">Copy Evening</button>
      </div>
    </section>

    <!-- SHARE -->
    <section class="panel" data-pane="share" style="display:none;">
      <div class="sectionTitle">Share Card</div>

      <div class="split">
        <div class="card">
          <div class="miniTitle">KAI Card (shareable text)</div>
          <textarea id="shareCard" placeholder="Tap 'Build Card'‚Ä¶"></textarea>

          <div class="bar">
            <button class="btn primary" id="buildCardBtn" type="button">Build Card</button>
            <button class="btn" id="copyCardBtn" type="button">Copy</button>
            <button class="btn" id="shareTextBtn" type="button">Share Text</button>
          </div>

          <div class="hint">
            On iOS: Share Text opens the system share sheet (when supported).
          </div>
        </div>

        <div class="card">
          <div class="miniTitle">What gets included</div>
          <div class="hint mono" id="includedList">
‚Ä¢ Name + Focus + Pattern
‚Ä¢ Restriction move + result note
‚Ä¢ One-line intention
‚Ä¢ Streak (if enabled)
          </div>
        </div>
      </div>
    </section>

<!-- LIBRARY -->
<section class="panel" data-pane="library" style="display:none;">
  <div class="sectionTitle">Library</div>

  <div class="split">
    <div class="card">
      <div class="miniTitle">72 Names Library</div>

      <div class="row2">
        <div class="field">
          <label for="libSearch">Search (theme, tag, letters)</label>
          <input id="libSearch" placeholder="Try: certainty, protection, healing, ◊ê◊î◊ë◊î‚Ä¶" />
        </div>

        <div class="field">
          <label for="libPattern">Filter by your Pattern</label>
          <select id="libPattern">
            <option value="">All patterns‚Ä¶</option>
            <option>Urgency ‚Üí Certainty</option>
            <option>Reactivity ‚Üí Restriction</option>
            <option>Judgment ‚Üí Compassion</option>
            <option>Overthinking ‚Üí Action</option>
            <option>Fear ‚Üí Faith</option>
            <option>Control ‚Üí Trust</option>
            <option>Isolation ‚Üí Connection</option>
          </select>
        </div>
      </div>

      <div class="bar">
        <button class="btn primary" id="libPick" type="button">Pick for me</button>
        <button class="btn" id="libClear" type="button">Clear</button>
      </div>

      <div class="hint">
        Notes: themes are common associations used in practice. Final ‚Äúwhich Name‚Äù choices should be confirmed with a teacher when stakes are high.
      </div>
    </div>

    <div class="card">
      <div class="miniTitle">Suggested Practice</div>
      <textarea id="libSuggested" placeholder="Tap 'Pick for me'‚Ä¶" readonly></textarea>
      <div class="bar">
        <button class="btn" id="libCopySuggested" type="button">Copy</button>
      </div>
    </div>
  </div>

  <div style="margin-top:14px;" class="card">
    <div class="miniTitle">Results</div>
    <div class="list" id="libResults"></div>
  </div>
</section>
    <!-- TOOLS -->
    <section class="panel" data-pane="tools" style="display:none;">
      <div class="sectionTitle">Tools</div>

      <div class="split">
        <div class="card">
          <div class="miniTitle">Gematria</div>
          <div class="field">
            <label for="gText">Enter Hebrew (basic mapping)</label>
            <input id="gText" placeholder="◊ê◊î◊ë◊î" />
          </div>
          <div class="row2" style="margin-top:12px;">
            <div class="field">
              <label for="gTotal">Total</label>
              <input id="gTotal" disabled />
            </div>
            <div class="field">
              <label for="gBreak">Breakdown</label>
              <input id="gBreak" disabled />
            </div>
          </div>
          <div class="hint">Basic values included. Final forms mapped to standard values.</div>
        </div>

        <div class="card">
          <div class="miniTitle">72 Name lookup (placeholder)</div>
          <div class="field">
            <label for="nQuery">Search</label>
            <input id="nQuery" placeholder="Type: protection, certainty, healing‚Ä¶" />
          </div>
          <div class="hint">
            Next: attach a JSON library + simple search index. (I‚Äôll do that once this foundation is locked.)
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="panel" data-pane="history" style="display:none;">
      <div class="sectionTitle">History</div>
      <div class="card">
        <div class="miniTitle">Saved days</div>
        <div class="hint">Tap ‚ÄúLoad‚Äù on any day to bring it into the app view (read/write).</div>
        <div class="list" id="historyList"></div>
      </div>
    </section>

  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="xClose" id="modalClose" aria-label="Close">√ó</button>
      <h3 id="modalTitle">üî• Streak!</h3>
      <p id="modalBody">You completed today‚Äôs restriction. Light recorded. Keep going.</p>
      <div class="bar">
        <button class="btn primary" id="modalOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ======= Helpers =======
    const $ = (id)=>document.getElementById(id);
    const todayISO = ()=> new Date().toISOString().slice(0,10);

    const keyProfile = "kai_profile_v2";
    const keyStreak  = "kai_streak_v2";
    const keyDailyRestrict = "kai_daily_restrict_v2";
    const dayKey = (d)=> `kai_day_${d}_v2`;
    const keyLastTab = "kai_last_tab_v2";

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__tmo);
      window.__tmo = setTimeout(()=> t.style.display="none", 2200);
    }

    function wireMorning(){
  const save = $("saveMorningBtn");
  if (save) save.addEventListener("click", ()=>{
    setProfile(collectProfileFromUI());
    setDay(collectDayFromUI());
    hydrateUI();
    toast("Morning saved ‚úÖ");
  });

  const copy = $("copyMorningBtn");
  if (copy) copy.addEventListener("click", ()=>{
    const d = getDay();
    const txt =
`Morning ‚Ä¢ ${d.date}
Certainty: ${d.morning?.certainty || "‚Äî"}
Energy: ${d.morning?.energy || "‚Äî"}
Intention: ${d.morning?.intention || "‚Äî"}
Pattern: ${d.morning?.pattern || "‚Äî"}
Witness: ${d.morning?.witness || "‚Äî"}`;

    navigator.clipboard?.writeText(txt);
    toast("Copied ‚úÖ");
  });
}
// ===== Library v1 (72 Names starter) =====
// IMPORTANT: This is a starter library with "common themes" for practice.
// Meanings and usage vary across traditions; teacher guidance is recommended.

const KAI_72_LIBRARY = [
  // Format: { name: "###", tags:[...], patterns:[...], use:"...", practice:"..." }

  { name:"◊ï◊î◊ï", tags:["certainty","calm","clarity"], patterns:["Urgency ‚Üí Certainty","Overthinking ‚Üí Action"],
    use:"Return to certainty, reduce spinning mind.", practice:"Breathe 4-4-6. Visualize letters above the heart. Ask: What is the next right action?" },

  { name:"◊°◊ê◊ú", tags:["healing","stability","repair"], patterns:["Fear ‚Üí Faith","Control ‚Üí Trust"],
    use:"Support healing and inner repair.", practice:"Three breaths. On exhale, release tension. On inhale, invite restorative light." },

  { name:"◊û◊î◊©", tags:["healing","compassion","softening"], patterns:["Judgment ‚Üí Compassion","Reactivity ‚Üí Restriction"],
    use:"Soften harshness; open compassion.", practice:"Name the judgment. Restrict it. Replace with one compassionate sentence." },

  { name:"◊û◊ë◊î", tags:["protection","boundaries","safety"], patterns:["Fear ‚Üí Faith","Control ‚Üí Trust"],
    use:"Strengthen spiritual boundaries.", practice:"Imagine a quiet gold boundary around you. Speak: 'Only what serves Light may enter'." },

  { name:"◊ê◊õ◊ê", tags:["forgiveness","release","repair"], patterns:["Judgment ‚Üí Compassion","Isolation ‚Üí Connection"],
    use:"Release resentment; open repair.", practice:"Write: 'I release __.' Then: one concrete repair action within 24 hours." },

  { name:"◊î◊î◊¢", tags:["clarity","truth","discernment"], patterns:["Overthinking ‚Üí Action","Urgency ‚Üí Certainty"],
    use:"Discern signal from noise.", practice:"Ask: What is true right now? What is story? Choose one move aligned to truth." },

  { name:"◊ú◊î◊ó", tags:["love","connection","unity"], patterns:["Isolation ‚Üí Connection","Fear ‚Üí Faith"],
    use:"Open the heart; strengthen connection.", practice:"Send one message of appreciation. No agenda. Just light." },

  { name:"◊ê◊ï◊ù", tags:["discipline","restraint","restriction"], patterns:["Reactivity ‚Üí Restriction","Control ‚Üí Trust"],
    use:"Support restriction and restraint.", practice:"Before speaking/acting: pause 2 seconds. Feel the impulse. Choose restriction." },

  { name:"◊û◊†◊ì", tags:["balance","tiferet","integration"], patterns:["Judgment ‚Üí Compassion","Urgency ‚Üí Certainty"],
    use:"Balance extremes; return to center.", practice:"Place attention on spine/center line. Repeat: 'Center. Balance. Presence.' 7 times." },

  { name:"◊†◊†◊ê", tags:["protection","sleep","calm"], patterns:["Fear ‚Üí Faith","Urgency ‚Üí Certainty"],
    use:"Calm nervous system; protection for rest.", practice:"3-minute downshift: inhale 4, hold 2, exhale 8. Visualize letters like a soft veil." },

  { name:"◊î◊ß◊ù", tags:["confidence","courage","action"], patterns:["Overthinking ‚Üí Action","Fear ‚Üí Faith"],
    use:"Move from thought to action.", practice:"Pick one action that takes < 5 minutes. Do it now. Then witness: did fear shrink?" },

  { name:"◊ô◊ñ◊ú", tags:["abundance","flow","support"], patterns:["Control ‚Üí Trust","Overthinking ‚Üí Action"],
    use:"Allow flow; reduce gripping.", practice:"Choose one place you‚Äôre gripping. Release 10%. Take one aligned step, not ten." },

  { name:"◊ú◊ï◊ï", tags:["truth","integrity","alignment"], patterns:["Urgency ‚Üí Certainty","Control ‚Üí Trust"],
    use:"Align actions with truth.", practice:"Ask: What would integrity do today? Then choose one uncomfortable honest action." },

  { name:"◊õ◊ê◊¢", tags:["humility","ego","restriction"], patterns:["Reactivity ‚Üí Restriction","Judgment ‚Üí Compassion"],
    use:"Reduce ego noise; increase humility.", practice:"Replace 'I must be right' with 'I choose connection.' Act accordingly once today." },

  { name:"◊§◊î◊ú", tags:["breakthrough","new path","opening"], patterns:["Overthinking ‚Üí Action","Isolation ‚Üí Connection"],
    use:"Open a new possibility.", practice:"Write 3 new options. Circle 1. Take the first micro-step in 2 minutes." },

  { name:"◊û◊ô◊ß", tags:["order","structure","stabilize"], patterns:["Urgency ‚Üí Certainty","Control ‚Üí Trust"],
    use:"Bring order and stability.", practice:"Make a 3-item list. Only 3. Complete #1 before adding anything else." },

  { name:"◊°◊ô◊ò", tags:["protection","remove negativity","shield"], patterns:["Fear ‚Üí Faith","Reactivity ‚Üí Restriction"],
    use:"Reduce negative influence; strengthen shield.", practice:"Visualize a gold shield. Restrict gossip/doomscrolling for 1 hour." },

  { name:"◊ó◊ú◊ë", tags:["gratitude","joy","lightness"], patterns:["Isolation ‚Üí Connection","Urgency ‚Üí Certainty"],
    use:"Shift heaviness into gratitude.", practice:"List 3 gratitudes. Send 1 gratitude outward to another person." },

  { name:"◊ß◊ú◊ô", tags:["clarity","simplicity","focus"], patterns:["Overthinking ‚Üí Action","Urgency ‚Üí Certainty"],
    use:"Cut through complexity.", practice:"Ask: What is the ONE thing? Then do only that for 20 minutes." },

  { name:"◊®◊õ◊ë", tags:["healing","support","endurance"], patterns:["Fear ‚Üí Faith","Control ‚Üí Trust"],
    use:"Support endurance through challenge.", practice:"Choose perseverance: one small act of strength, repeated daily." },

  { name:"◊©◊ê◊î", tags:["compassion","mercy","soften"], patterns:["Judgment ‚Üí Compassion"],
    use:"Shift Din toward mercy.", practice:"When judging: replace with one curious question. Stay present for the answer." },

  { name:"◊ì◊†◊ô", tags:["boundaries","discernment","clean"], patterns:["Reactivity ‚Üí Restriction","Control ‚Üí Trust"],
    use:"Discern + hold boundaries without drama.", practice:"Say no once kindly. No explanation spiral. Witness the freedom." }
];

// Map Pattern -> preferred tags (simple heuristic)
const KAI_PATTERN_TAGS = {
  "Urgency ‚Üí Certainty": ["certainty","clarity","calm","structure"],
  "Reactivity ‚Üí Restriction": ["restriction","discipline","boundaries","ego"],
  "Judgment ‚Üí Compassion": ["compassion","forgiveness","softening"],
  "Overthinking ‚Üí Action": ["action","clarity","focus","breakthrough"],
  "Fear ‚Üí Faith": ["protection","calm","courage","healing"],
  "Control ‚Üí Trust": ["trust","flow","release","stability"],
  "Isolation ‚Üí Connection": ["love","connection","gratitude","forgiveness"]
};

function libNormalize(s){ return (s || "").toLowerCase().trim(); }

function libFilterItems(query, pattern){
  const q = libNormalize(query);
  const p = (pattern || "").trim();

  return KAI_72_LIBRARY.filter(it=>{
    const matchesQuery = !q || (
      libNormalize(it.name).includes(q) ||
      it.tags.some(t=>libNormalize(t).includes(q)) ||
      libNormalize(it.use).includes(q) ||
      libNormalize(it.practice).includes(q)
    );

    const matchesPattern = !p || (it.patterns || []).includes(p);

    return matchesQuery && matchesPattern;
  });
}

function libRenderResults(items){
  const root = document.getElementById("libResults");
  if (!root) return;
  root.innerHTML = "";

  if (!items.length){
    root.innerHTML = `<div class="hint">No matches. Try a broader search (e.g., ‚Äúclarity‚Äù or ‚Äúprotection‚Äù).</div>`;
    return;
  }

  items.forEach(it=>{
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="left">
        <div class="date">72 Name: <span class="mono">${it.name}</span></div>
        <div class="meta"><b>Themes:</b> ${it.tags.join(", ")}\n<b>When:</b> ${it.use}\n<b>Practice:</b> ${it.practice}</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
        <div class="pill">${it.tags[0] || "practice"}</div>
        <button class="btn" type="button" data-libcopy="1">Copy</button>
      </div>
    `;

    el.querySelector('[data-libcopy="1"]').addEventListener("click", ()=>{
      const txt =
`72 Name: ${it.name}
Themes: ${it.tags.join(", ")}
When: ${it.use}
Practice: ${it.practice}`;
      navigator.clipboard?.writeText(txt);
      toast("Copied ‚úÖ");
    });

    root.appendChild(el);
  });
}

function libPickForMe(pattern){
  const tags = KAI_PATTERN_TAGS[pattern] || [];
  const pool = KAI_72_LIBRARY
    .filter(it => !pattern || (it.patterns || []).includes(pattern))
    .sort((a,b)=>0.5 - Math.random());

  // pick 3 with tag overlap
  const picks = [];
  for (const it of pool){
    const overlap = it.tags.some(t=>tags.includes(t));
    if (overlap || tags.length === 0){
      picks.push(it);
    }
    if (picks.length >= 3) break;
  }

  const lines = [];
  lines.push(`Suggested Practice${pattern ? " ‚Ä¢ " + pattern : ""}`);
  lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  picks.forEach((it, i)=>{
    lines.push(`${i+1}) ${it.name}  (${it.tags.join(", ")})`);
    lines.push(`   When: ${it.use}`);
    lines.push(`   Do: ${it.practice}`);
    lines.push("");
  });
  lines.push("Note: confirm high-stakes guidance with a teacher.");

  const box = document.getElementById("libSuggested");
  if (box) box.value = lines.join("\n");

  libRenderResults(picks.length ? picks : pool.slice(0,6));
}
    function safeJSONParse(s, fallback){
      try { return JSON.parse(s); } catch { return fallback; }
    }

    function setActiveTab(tab){
      // Buttons
      document.querySelectorAll(".tabBtn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      // Panels
      document.querySelectorAll("[data-pane]").forEach(p=>{
        p.style.display = (p.dataset.pane === tab) ? "" : "none";
      });
      localStorage.setItem(keyLastTab, tab);
    }

    function getProfile(){
      return safeJSONParse(localStorage.getItem(keyProfile), {
        name:"", birth:"", focus:"", outcome:"", intensity:"Simple + Powerful", enable:"Core + Tools"
      });
    }
    function setProfile(p){
      localStorage.setItem(keyProfile, JSON.stringify(p));
    }

    function getDay(d = todayISO()){
      return safeJSONParse(localStorage.getItem(dayKey(d)), {
        date: d,
        morning: { certainty:"", energy:"", intention:"", pattern:"", witness:"" },
        restriction: { move:"", trigger:"", note:"", completed:false, completedAt:"" },
        evening: { result:"", grade:"", repair:"" }
      });
    }
    function setDay(data){
      localStorage.setItem(dayKey(data.date), JSON.stringify(data));
    }

    function getStreak(){
      return safeJSONParse(localStorage.getItem(keyStreak), { count:0, lastCompleted:"" });
    }
    function setStreak(s){
      localStorage.setItem(keyStreak, JSON.stringify(s));
    }

    function getDailyRestrict(){
      return localStorage.getItem(keyDailyRestrict) === "1";
    }
    function setDailyRestrict(on){
      localStorage.setItem(keyDailyRestrict, on ? "1" : "0");
    }

    function updateChips(){
      const d = todayISO();
      const p = getProfile();
      const s = getStreak();
      const dr = getDailyRestrict();

      $("chipDate").textContent = d;
      $("chipProfile").textContent = p.name ? p.name : "‚Äî";
      $("chipStreak").textContent = String(s.count ?? 0);
      $("chipDailyRestrict").textContent = dr ? "On" : "Off";
    }

    function hydrateUI(){
      // Profile
      const p = getProfile();
      $("pName").value = p.name || "";
      $("pBirth").value = p.birth || "";
      $("pFocus").value = p.focus || "";
      $("pOutcome").value = p.outcome || "";
      $("pIntensity").value = p.intensity || "Simple + Powerful";
      $("pEnable").value = p.enable || "Core + Tools";

      // Daily restrict switch
      const dr = getDailyRestrict();
      const sw = $("dailyRestrictSwitch");
      sw.classList.toggle("on", dr);
      sw.setAttribute("aria-checked", dr ? "true" : "false");

      // Day
      const day = getDay();
      $("mCertainty").value = day.morning.certainty ?? "";
      $("mEnergy").value = day.morning.energy ?? "";
      $("mIntention").value = day.morning.intention ?? "";
      $("mPattern").value = day.morning.pattern ?? "";
      $("mWitness").value = day.morning.witness ?? "";

      $("rMove").value = day.restriction.move ?? "";
      $("rTrigger").value = day.restriction.trigger ?? "";
      $("rNote").value = day.restriction.note ?? "";

      $("eResult").value = day.evening.result ?? "";
      $("eGrade").value = day.evening.grade ?? "";
      $("eRepair").value = day.evening.repair ?? "";

      // Preview fields
      $("gPattern").value = day.morning.pattern ? `Pattern: ${day.morning.pattern}` : "Pattern: ‚Äî";
      $("gRestrict").value = day.restriction.move ? day.restriction.move : "Choose one restriction move and witness the effect";

      updateChips();
      renderHistory();
    }

    function collectProfileFromUI(){
      return {
        name: $("pName").value.trim(),
        birth: $("pBirth").value,
        focus: $("pFocus").value,
        outcome: $("pOutcome").value.trim(),
        intensity: $("pIntensity").value,
        enable: $("pEnable").value
      };
    }

    function collectDayFromUI(d = todayISO()){
      const existing = getDay(d);
      return {
        ...existing,
        date: d,
        morning: {
          certainty: $("mCertainty").value,
          energy: $("mEnergy").value,
          intention: $("mIntention").value.trim(),
          pattern: $("mPattern").value,
          witness: $("mWitness").value.trim()
        },
        restriction: {
          ...existing.restriction,
          move: $("rMove").value.trim(),
          trigger: $("rTrigger").value.trim(),
          note: $("rNote").value.trim()
        },
        evening: {
          result: $("eResult").value.trim(),
          grade: $("eGrade").value,
          repair: $("eRepair").value.trim()
        }
      };
    }

    function saveAll(){
      const p = collectProfileFromUI();
      const d = collectDayFromUI();
      setProfile(p);
      setDay(d);
      hydrateUI();
      toast("Saved ‚úÖ");
    }

    function resetToday(){
      const d = todayISO();
      localStorage.removeItem(dayKey(d));
      hydrateUI();
      toast("Today reset üßº");
    }

    function copyText(text){
      navigator.clipboard?.writeText(text).then(
        ()=>toast("Copied ‚úÖ"),
        ()=>toast("Copy blocked (iOS permission) ‚ö†Ô∏è")
      );
    }

    function buildShareCard(){
      const p = getProfile();
      const d = getDay();
      const s = getStreak();
      const dr = getDailyRestrict();

      const lines = [];
      lines.push(`KAI ‚Ä¢ ${d.date}`);
      if (p.name) lines.push(`Name: ${p.name}`);
      if (p.focus) lines.push(`Focus: ${p.focus}`);
      if (d.morning.pattern) lines.push(`Pattern: ${d.morning.pattern}`);
      if (d.morning.intention) lines.push(`Intention: ${d.morning.intention}`);
      if (d.restriction.move) lines.push(`Restriction: ${d.restriction.move}`);
      if (d.restriction.note) lines.push(`Witness: ${d.restriction.note}`);
      if (dr) lines.push(`Streak: ${s.count}`);

      $("shareCard").value = lines.join("\n");
      toast("Card built ‚ú®");
    }

    async function shareText(text){
      try{
        if (navigator.share){
          await navigator.share({ text });
        } else {
          copyText(text);
          toast("Share not supported here, copied instead ‚úÖ");
        }
      }catch{
        toast("Share canceled");
      }
    }

    function showModal(title, body){
      $("modalTitle").textContent = title;
      $("modalBody").textContent = body;
      $("modalBackdrop").style.display = "flex";
    }
    function closeModal(){
      $("modalBackdrop").style.display = "none";
    }

    function completeRestriction(){
      const dr = getDailyRestrict();
      const d = getDay();
      const iso = d.date;

      // mark complete
      if (!d.restriction.completed){
        d.restriction.completed = true;
        d.restriction.completedAt = new Date().toISOString();
        setDay(d);
      }

      if (!dr){
        toast("Completed ‚úÖ (Daily Restrict Mode is Off)");
        hydrateUI();
        return;
      }

      // streak rules: only increment once/day
      const s = getStreak();
      if (s.lastCompleted === iso){
        toast("Already counted for today ‚úÖ");
        hydrateUI();
        return;
      }

      s.count = (s.count || 0) + 1;
      s.lastCompleted = iso;
      setStreak(s);
      hydrateUI();
      showModal("üî• Streak!", "You completed today‚Äôs restriction. Light recorded. Keep going.");
    }

    function exportData(){
      const p = getProfile();
      const s = getStreak();
      const dr = getDailyRestrict();

      // gather all saved days
      const days = [];
      for (let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if (k && k.startsWith("kai_day_") && k.endsWith("_v2")){
          const obj = safeJSONParse(localStorage.getItem(k), null);
          if (obj) days.push(obj);
        }
      }
      days.sort((a,b)=> (a.date || "").localeCompare(b.date || ""));

      const payload = {
        exportedAt: new Date().toISOString(),
        profile: p,
        dailyRestrict: dr,
        streak: s,
        days
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `kai-export-${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported JSON ‚úÖ");
    }

    function renderHistory(){
      const list = $("historyList");
      if (!list) return;
      list.innerHTML = "";

      const keys = [];
      for (let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if (k && k.startsWith("kai_day_") && k.endsWith("_v2")) keys.push(k);
      }
      keys.sort();

      if (keys.length === 0){
        list.innerHTML = `<div class="hint">No saved days yet.</div>`;
        return;
      }

      keys.reverse().forEach(k=>{
        const d = safeJSONParse(localStorage.getItem(k), null);
        if (!d) return;

        const meta = [];
        if (d.morning?.pattern) meta.push(`Pattern: ${d.morning.pattern}`);
        if (d.restriction?.move) meta.push(`Restriction: ${d.restriction.move}`);
        if (d.evening?.result) meta.push(`Result: ${d.evening.result}`);
        const done = d.restriction?.completed ? "Completed" : "‚Äî";

        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div class="left">
            <div class="date">${d.date || "‚Äî"}</div>
            <div class="meta">${meta.join("\n") || "‚Äî"}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
            <div class="pill">${done}</div>
            <button class="btn" type="button" data-load="${d.date}">Load</button>
          </div>
        `;
        list.appendChild(row);
      });

      list.querySelectorAll("[data-load]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const date = btn.getAttribute("data-load");
          if (!date) return;
          // load day into UI by copying into today slot? NO: better to just hydrate fields from that day
          const d = getDay(date);
          // push values into UI inputs (without overwriting stored date)
          $("mCertainty").value = d.morning.certainty ?? "";
          $("mEnergy").value = d.morning.energy ?? "";
          $("mIntention").value = d.morning.intention ?? "";
          $("mPattern").value = d.morning.pattern ?? "";
          $("mWitness").value = d.morning.witness ?? "";

          $("rMove").value = d.restriction.move ?? "";
          $("rTrigger").value = d.restriction.trigger ?? "";
          $("rNote").value = d.restriction.note ?? "";

          $("eResult").value = d.evening.result ?? "";
          $("eGrade").value = d.evening.grade ?? "";
          $("eRepair").value = d.evening.repair ?? "";

          $("gPattern").value = d.morning.pattern ? `Pattern: ${d.morning.pattern}` : "Pattern: ‚Äî";
          $("gRestrict").value = d.restriction.move ? d.restriction.move : "Choose one restriction move and witness the effect";

          toast(`Loaded ${date} (edit + Save will save as TODAY)`);
          setActiveTab("start");
        });
      });
    }

    // ======= Gematria =======
    const gemMap = {
      "◊ê":1,"◊ë":2,"◊í":3,"◊ì":4,"◊î":5,"◊ï":6,"◊ñ":7,"◊ó":8,"◊ò":9,
      "◊ô":10,"◊õ":20,"◊ö":20,"◊ú":30,"◊û":40,"◊ù":40,"◊†":50,"◊ü":50,
      "◊°":60,"◊¢":70,"◊§":80,"◊£":80,"◊¶":90,"◊•":90,"◊ß":100,"◊®":200,
      "◊©":300,"◊™":400
    };

    function wireGematria(){
      $("gText").addEventListener("input", ()=>{
        const s = ($("gText").value || "").trim();
        let total = 0;
        const parts = [];
        for (const ch of s){
          const v = gemMap[ch] || 0;
          if (v){
            total += v;
            parts.push(`${ch}=${v}`);
          }
        }
        $("gTotal").value = total ? String(total) : "‚Äî";
        $("gBreak").value = parts.length ? parts.join(" ‚Ä¢ ") : "‚Äî";
      });
    }

    // ======= Wire events =======
    function wireTabs(){
      document.querySelectorAll(".tabBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          setActiveTab(btn.dataset.tab);
        });
      });
    }

    function wireButtons(){
      $("saveAllBtn").addEventListener("click", saveAll);
      $("exportBtn").addEventListener("click", exportData);
      $("resetDayBtn").addEventListener("click", resetToday);
      $("copySummaryBtn").addEventListener("click", ()=>{
        const p = getProfile();
        const d = getDay();
        const s = getStreak();
        const dr = getDailyRestrict();
        const txt =
`KAI ‚Ä¢ ${d.date}
Name: ${p.name || "‚Äî"}
Focus: ${p.focus || "‚Äî"}
Pattern: ${d.morning.pattern || "‚Äî"}
Restriction: ${d.restriction.move || "‚Äî"}
Streak: ${dr ? s.count : "Off"}`;
        copyText(txt);
      });
function wireLibrary(){
  const search = document.getElementById("libSearch");
  const pat = document.getElementById("libPattern");
  const pick = document.getElementById("libPick");
  const clr = document.getElementById("libClear");
  const copySug = document.getElementById("libCopySuggested");

  if (!search || !pat || !pick || !clr || !copySug) return;

  function refresh(){
    const items = libFilterItems(search.value, pat.value);
    libRenderResults(items);
  }

  search.addEventListener("input", refresh);
  pat.addEventListener("change", refresh);

  pick.addEventListener("click", ()=>{
    libPickForMe(pat.value);
    
  });

  clr.addEventListener("click", ()=>{
    search.value = "";
    pat.value = "";
    const box = document.getElementById("libSuggested");
    if (box) box.value = "";
    refresh();
  });

  if (copySug){
    copySug.addEventListener("click", ()=>{
      const box = document.getElementById("libSuggested");
      if (!box) return;
      navigator.clipboard?.writeText(box.value || "");
      toast("Copied ‚úÖ");
    });
  }

  // initial render
  refresh(); toast("Library wired ‚úÖ");
}
      $("saveMorningBtn").addEventListener("click", ()=>{
        setProfile(collectProfileFromUI());
        setDay(collectDayFromUI());
        hydrateUI();
        toast("Morning saved ‚úÖ");
      });
      $("copyMorningBtn").addEventListener("click", ()=>{
        const d = getDay();
        const txt =
`Morning ‚Ä¢ ${d.date}
Certainty: ${d.morning.certainty || "‚Äî"}
Energy: ${d.morning.energy || "‚Äî"}
Intention: ${d.morning.intention || "‚Äî"}
Pattern: ${d.morning.pattern || "‚Äî"}
Witness: ${d.morning.witness || "‚Äî"}`;
        copyText(txt);
      });

      $("saveRestrictionBtn").addEventListener("click", ()=>{
        setProfile(collectProfileFromUI());
        setDay(collectDayFromUI());
        hydrateUI();
        toast("Restriction saved ‚úÖ");
      });
      $("copyRestrictionBtn").addEventListener("click", ()=>{
        const d = getDay();
        const txt =
`Restriction ‚Ä¢ ${d.date}
Move: ${d.restriction.move || "‚Äî"}
Trigger: ${d.restriction.trigger || "‚Äî"}
Witness: ${d.restriction.note || "‚Äî"}
Completed: ${d.restriction.completed ? "Yes" : "No"}`;
        copyText(txt);
      });

      $("saveEveningBtn").addEventListener("click", ()=>{
        setProfile(collectProfileFromUI());
        setDay(collectDayFromUI());
        hydrateUI();
        toast("Evening saved ‚úÖ");
      });
      $("copyEveningBtn").addEventListener("click", ()=>{
        const d = getDay();
        const txt =
`Evening ‚Ä¢ ${d.date}
Result: ${d.evening.result || "‚Äî"}
Integrity: ${d.evening.grade || "‚Äî"}
Repair: ${d.evening.repair || "‚Äî"}`;
        copyText(txt);
      });

      $("completeRestrictBtn").addEventListener("click", completeRestriction);

      $("buildCardBtn").addEventListener("click", buildShareCard);
      $("copyCardBtn").addEventListener("click", ()=> copyText($("shareCard").value || ""));
      $("shareTextBtn").addEventListener("click", ()=> shareText($("shareCard").value || ""));

      $("modalClose").addEventListener("click", closeModal);
      $("modalOk").addEventListener("click", closeModal);
      $("modalBackdrop").addEventListener("click", (e)=>{
        if (e.target.id === "modalBackdrop") closeModal();
      });

      // Live preview updates
      ["mPattern","rMove"].forEach(id=>{
        $(id).addEventListener("input", ()=>{
          const d = collectDayFromUI();
          $("gPattern").value = d.morning.pattern ? `Pattern: ${d.morning.pattern}` : "Pattern: ‚Äî";
          $("gRestrict").value = d.restriction.move ? d.restriction.move : "Choose one restriction move and witness the effect";
        });
      });
    }

    function wireDailyRestrictSwitch(){
      const sw = $("dailyRestrictSwitch");
      function toggle(){
        const on = !getDailyRestrict();
        setDailyRestrict(on);
        hydrateUI();
        toast(`Daily Restrict ${on ? "On" : "Off"}`);
      }
      sw.addEventListener("click", toggle);
      sw.addEventListener("keydown", (e)=>{
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          toggle();
        }
      });
    }

    // ======= Boot =======
    (function boot(){
      wireTabs();
      wireButtons();
      wireDailyRestrictSwitch();
      wireGematria();
      wireLibrary(); // ‚úÖ ADD THIS
      
      hydrateUI();

      // restore last tab
      const last = localStorage.getItem(keyLastTab);
      if (last) setActiveTab(last);

      toast("KAI JS is alive ‚úÖ");
    })();
  </script>
</body>
</html>
